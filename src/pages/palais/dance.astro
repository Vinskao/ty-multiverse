---
declare global {
  interface Window {
    TY_MULTIVERSE_CONFIG?: {
      tymbUrl: string;
      apiBaseUrl: string;
    };
  }
}

import BaseLayout from "../../layouts/BaseLayout.astro";
import Hero from "../../components/Hero.astro";

const url = new URL(Astro.request.url);
const username = url.searchParams.get('username');
const token = url.searchParams.get('token');

const isLoggedIn = !!username && !!token;

if (!isLoggedIn) {
  return Astro.redirect(`/tymultiverse/login?redirect=${encodeURIComponent(Astro.url.pathname + Astro.url.search)}`);
}

const tymbUrl = import.meta.env.PUBLIC_TYMB_URL;
const apiBaseUrl = import.meta.env.PUBLIC_API_BASE_URL;
---

<!DOCTYPE html>
<meta charset="UTF-8" />
<html>
  <head>
    <script async src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script async defer src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>
    <link rel="stylesheet" href="/src/styles/dance.css">
    <script define:vars={{ tymbUrl, apiBaseUrl }}>
      window.TY_MULTIVERSE_CONFIG = {
        tymbUrl: tymbUrl,
        apiBaseUrl: apiBaseUrl
      };
    </script>
  </head>
  <body>
    <BaseLayout title="Dance | TY Multiverse" description="Dance video collection">
      <div class="stack gap-20">
        <main class="wrapper stack gap-8">
          <Hero
            title="Dance"
            tagline="Enjoy the dance performances."
            align="start"
          />

          <div id="loading-status" class="loading-status">
            <div class="loading-spinner"></div>
            <span>正在載入角色和影片資料...</span>
          </div>
          <div id="videos-grid" class="videos-grid">
            <!-- 影片內容將動態載入 -->
          </div>

          <!-- 清除緩存按鈕 -->
          <button id="cache-clear-btn" class="cache-clear-btn" type="button">
            清除緩存並重新載入
          </button>
        </main>
      </div>
    </BaseLayout>
  </body>
</html>

<script src="/src/scripts/dance.ts"></script>
