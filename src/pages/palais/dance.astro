---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Hero from "../../components/Hero.astro";

const url = new URL(Astro.request.url);
const username = url.searchParams.get('username');
const token = url.searchParams.get('token');

// æª¢æŸ¥ç™»å…¥ç‹€æ…‹
const isLoggedIn = !!username && !!token;

// å¦‚æœæœªç™»å…¥ï¼Œé‡å®šå‘åˆ°ç™»å…¥é é¢
if (!isLoggedIn) {
  return Astro.redirect(`/tymultiverse/login?redirect=${encodeURIComponent(Astro.url.pathname + Astro.url.search)}`);
}

// å½±ç‰‡åˆ†çµ„åˆ—è¡¨
const videoGroups = [
  // å–®ç¨è§’è‰²
  {
    character: "Chiaki",
    videos: [
      {
        src: "https://peoplesystem.tatdvsonorth.com/images/people/Chiaki.mp4",
        title: "Chiaki"
      }
    ]
  },
  // Sayuri ç³»åˆ—
  {
    character: "Sayuri",
    videos: [
      {
        src: "https://peoplesystem.tatdvsonorth.com/images/people/Sayuri.mp4",
        title: "Sayuri"
      },
      {
        src: "https://peoplesystem.tatdvsonorth.com/images/people/Sayuri2.mp4",
        title: "Sayuri 2"
      }
    ]
  },
  // å–®ç¨è§’è‰²
  {
    character: "Sorane",
    videos: [
      {
        src: "https://peoplesystem.tatdvsonorth.com/images/people/Sorane.mp4",
        title: "Sorane"
      }
    ]
  },
  // Medicis ç³»åˆ—
  {
    character: "Medicis",
    videos: [
      {
        src: "https://peoplesystem.tatdvsonorth.com/images/people/Medicis.mp4",
        title: "Medicis"
      },
      {
        src: "https://peoplesystem.tatdvsonorth.com/images/people/Medicis2.mp4",
        title: "Medicis 2"
      }
    ]
  },
  // å–®ç¨è§’è‰²
  {
    character: "Etsuko",
    videos: [
      {
        src: "https://peoplesystem.tatdvsonorth.com/images/people/Etsuko.mp4",
        title: "Etsuko"
      }
    ]
  },
  {
    character: "Maya",
    videos: [
      {
        src: "https://peoplesystem.tatdvsonorth.com/images/people/Maya.mp4",
        title: "Maya"
      }
    ]
  },
  {
    character: "Hitomi",
    videos: [
      {
        src: "https://peoplesystem.tatdvsonorth.com/images/people/Hitomi.mp4",
        title: "Hitomi"
      }
    ]
  },
  {
    character: "Samui",
    videos: [
      {
        src: "https://peoplesystem.tatdvsonorth.com/images/people/Samui.mp4",
        title: "Samui"
      }
    ]
  }
];
---

<!DOCTYPE html>
<meta charset="UTF-8" />
<html>
  <head>
    <script
      async
      src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"
    ></script>
    <script
      async
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js">
    </script>
  </head>
  <body>
    <BaseLayout title="Dance | TY Multiverse" description="Dance video collection">
      <div class="stack gap-20">
        <main class="wrapper stack gap-8">
          <Hero
            title="Dance"
            tagline="Enjoy the dance performances."
            align="start"
          />



          <!-- å½±ç‰‡ç¶²æ ¼ -->
          <div class="videos-grid">
            {videoGroups.map((group, groupIndex) => (
              <div class="video-item" data-character={group.character} data-group-index={groupIndex}>
                <div class="video-container">
                  {group.videos.map((video, videoIndex) => (
                    <video
                      id={`video-${group.character}-${videoIndex}`}
                      class={`dance-video ${videoIndex === 0 ? 'active' : ''}`}
                      muted
                      preload={videoIndex === 0 ? "auto" : "none"}
                      playsinline
                      data-character={group.character}
                      data-video-index={videoIndex}
                    >
                      <source src={video.src} type="video/mp4">
                      Your browser does not support the video tag.
                    </video>
                  ))}
                  <div class="video-overlay">
                    <div class="video-title">{group.character}</div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </main>
      </div>
    </BaseLayout>
  </body>
</html>

<style>
  .videos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 8px 0px; /* ä¸Šä¸‹8pxé–“è·ï¼Œå·¦å³0pxé–“è· */
    padding: 20px;
    width: 100%;
    max-width: none;
    margin: 0;
  }

  .video-item {
    position: relative;
    background: transparent;
    border-radius: 0px;
    overflow: hidden;
    box-shadow: none;
    /* è¨­å®š 480:832 çš„å¯¬é«˜æ¯” (ç´„ 0.577:1) */
    aspect-ratio: 480 / 832;
    width: 100%;
  }

  .video-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .video-container {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .dance-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 0px;
    background: #000;
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
    /* å„ªåŒ–æ¸²æŸ“æ€§èƒ½ */
    will-change: opacity; /* æå‰å®£å‘Šå°‡è¦æ”¹è®Šçš„å±¬æ€§ */
  }

  .dance-video.loading {
    /* å„ªé›…çš„è¼‰å…¥å‹•ç•« - æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(20,20,20,0.9) 50%, rgba(0,0,0,0.9) 100%);
    animation: smooth-loading 2s ease-in-out infinite;
    position: relative;
  }

  .dance-video.loading::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255,255,255,0.3);
    border-top: 3px solid rgba(255,255,255,0.8);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes smooth-loading {
    0%, 100% {
      background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(20,20,20,0.9) 50%, rgba(0,0,0,0.9) 100%);
    }
    50% {
      background: linear-gradient(135deg, rgba(10,10,10,0.9) 0%, rgba(30,30,30,0.9) 50%, rgba(10,10,10,0.9) 100%);
    }
  }

  @keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
  }

  .dance-video.active {
    opacity: 1;
  }

  .video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.3), transparent);
    padding: 8px 12px;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0.9;
    /* ç§»é™¤éæ¸¡æ•ˆæœï¼Œå¯¦ç¾ç¬é–“åˆ‡æ› */
    backdrop-filter: blur(1px);
  }

  .video-item:hover .video-overlay {
    opacity: 1;
    background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.4), transparent);
  }

  .video-title {
    color: white;
    font-size: 14px;
    font-weight: bold;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.9);
    text-align: center;
    letter-spacing: 0.5px;
  }



  /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
  @media (max-width: 768px) {
    .videos-grid {
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 6px 0px; /* å¹³æ¿ç‰ˆä¸Šä¸‹6pxï¼Œå·¦å³0px */
      padding: 15px;
      width: 100%;
      max-width: none;
      margin: 0;
    }
  }

  @media (max-width: 480px) {
    .videos-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 4px 0px; /* æ‰‹æ©Ÿç‰ˆä¸Šä¸‹4pxï¼Œå·¦å³0px */
      padding: 10px;
      width: 100%;
      max-width: none;
      margin: 0;
    }
  }




</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log('ğŸ¬ Dance é é¢è¼‰å…¥å®Œæˆ - è§’è‰²åˆ†çµ„è¼ªæµæ’­æ”¾æ¨¡å¼');

    // å½±ç‰‡è³‡æºç®¡ç†å™¨ - æ§åˆ¶åŒæ™‚è¼‰å…¥çš„å½±ç‰‡æ•¸é‡
    const videoResourceManager = {
      maxConcurrentLoads: 3, // æœ€å¤šåŒæ™‚è¼‰å…¥3å€‹å½±ç‰‡
      loadingVideos: new Set(),
      preloadQueue: [], // é è¼‰å…¥éšŠåˆ—
      preloadedVideos: new Set(), // å·²é è¼‰å…¥çš„å½±ç‰‡

      canLoadVideo(video) {
        return this.loadingVideos.size < this.maxConcurrentLoads;
      },

      startLoading(video) {
        this.loadingVideos.add(video);
        console.log(`ğŸ“Š ç•¶å‰è¼‰å…¥å½±ç‰‡æ•¸: ${this.loadingVideos.size}/${this.maxConcurrentLoads}`);
      },

      finishLoading(video) {
        this.loadingVideos.delete(video);
        this.preloadedVideos.add(video);
        console.log(`âœ… å½±ç‰‡é è¼‰å…¥å®Œæˆ: ${video.getAttribute('data-character')}-${video.getAttribute('data-video-index')}`);
        this.processPreloadQueue();
      },

      // æ·»åŠ åˆ°é è¼‰å…¥éšŠåˆ—
      queuePreload(video) {
        if (!this.preloadedVideos.has(video) && !this.loadingVideos.has(video)) {
          this.preloadQueue.push(video);
          console.log(`ğŸ“‹ åŠ å…¥é è¼‰å…¥éšŠåˆ—: ${video.getAttribute('data-character')}-${video.getAttribute('data-video-index')}`);
          this.processPreloadQueue();
        }
      },

      // è™•ç†é è¼‰å…¥éšŠåˆ—
      processPreloadQueue() {
        while (this.preloadQueue.length > 0 && this.canLoadVideo(null)) {
          const video = this.preloadQueue.shift();
          if (video && !this.preloadedVideos.has(video) && !this.loadingVideos.has(video)) {
            console.log(`ğŸš€ é–‹å§‹é è¼‰å…¥: ${video.getAttribute('data-character')}-${video.getAttribute('data-video-index')}`);
            video.preload = 'auto';
            video.load();
          }
        }
      }
    };

    // å…¨åŸŸå½±ç‰‡äº‹ä»¶ç›£æ§å™¨ - ç¢ºä¿ä¸æœƒéŒ¯éä»»ä½•äº‹ä»¶
    const globalVideoMonitor = {
      videoEvents: new Map(),

      logEvent(character, videoIndex, eventType, details = '') {
        const key = `${character}-${videoIndex}`;
        if (!this.videoEvents.has(key)) {
          this.videoEvents.set(key, []);
        }
        const events = this.videoEvents.get(key);
        events.push({ type: eventType, time: Date.now(), details });
        console.log(`ğŸ“Š å…¨åŸŸç›£æ§: ${character} å½±ç‰‡ ${videoIndex} - ${eventType} ${details}`);
      }
    };

    // å„²å­˜æ¯å€‹è§’è‰²çš„ç•¶å‰å½±ç‰‡ç´¢å¼•
    const characterStates = new Map();

    // åˆå§‹åŒ–è§’è‰²ç‹€æ…‹
    const items = document.querySelectorAll('.video-item');
    items.forEach(item => {
      const character = item.getAttribute('data-character');
      if (character) {
        characterStates.set(character, {
          currentIndex: 0,
          playDirection: 'forward', // 'forward' æˆ– 'backward'
          hasPlayedForward: false,  // æ˜¯å¦å·²ç¶“æ­£å‘æ’­æ”¾é
          hasPlayedBackward: false  // æ˜¯å¦å·²ç¶“åå‘æ’­æ”¾é
        });
      }
    });

    // å½±ç‰‡è¼‰å…¥äº‹ä»¶ç›£è½
    const videos = Array.from(document.querySelectorAll('.dance-video')) as HTMLVideoElement[];
    videos.forEach((video) => {
      const character = video.getAttribute('data-character');
      const videoIndex = parseInt(video.getAttribute('data-video-index') || '0');

      video.addEventListener('loadstart', function () {
        videoResourceManager.startLoading(video);
        video.classList.add('loading'); // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'loadstart');
        console.log(`ğŸ¬ ${character} - å½±ç‰‡ ${videoIndex + 1} é–‹å§‹è¼‰å…¥`);
      });

      video.addEventListener('canplay', function () {
        videoResourceManager.finishLoading(video);
        video.classList.remove('loading'); // ç§»é™¤è¼‰å…¥å‹•ç•«
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'canplay', `readyState: ${video.readyState}`);
        console.log(`âœ… ${character} - å½±ç‰‡ ${videoIndex + 1} å¯ä»¥æ’­æ”¾ (readyState: ${video.readyState})`);

        // å¦‚æœæ˜¯ç¬¬ä¸€å€‹å½±ç‰‡ä¸”æ˜¯æ´»èºçš„ï¼Œè‡ªå‹•æ’­æ”¾
        if (videoIndex === 0 && video.classList.contains('active')) {
          video.play().catch(e => console.log(`æ’­æ”¾å¤±æ•— ${character}:`, e));
        }

        // ç•¶å½±ç‰‡è¼‰å…¥å®Œæˆå¾Œï¼Œé è¼‰å…¥ä¸‹ä¸€å€‹å½±ç‰‡
        setTimeout(() => {
          preloadNextVideo(character, videoIndex);
        }, 100); // ç¨å¾®å»¶é²ä¸€ä¸‹é¿å…è³‡æºç«¶çˆ­
      });

      video.addEventListener('error', function (e) {
        videoResourceManager.finishLoading(video);
        video.classList.remove('loading'); // ç§»é™¤è¼‰å…¥å‹•ç•«
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'error');
        console.error(`âŒ ${character} - å½±ç‰‡ ${videoIndex + 1} è¼‰å…¥å¤±æ•—:`, e);
      });

      video.addEventListener('canplaythrough', function () {
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'canplaythrough');
        console.log(`ğŸ¯ ${character} - å½±ç‰‡ ${videoIndex + 1} å®Œå…¨è¼‰å…¥å®Œæˆ`);
      });

      video.addEventListener('play', function () {
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'play');
        console.log(`â–¶ï¸ ${character} - å½±ç‰‡ ${videoIndex + 1} é–‹å§‹æ’­æ”¾`);
      });

      // ç•¶å½±ç‰‡çµæŸæ™‚ï¼Œè™•ç†æ’­æ”¾é‚è¼¯ï¼ˆåªæœ‰æ´»å‹•çš„å½±ç‰‡æ‰æœƒè§¸ç™¼ï¼‰
      video.addEventListener('ended', function () {
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'ended', `active: ${video.classList.contains('active')}`);
        console.log(`ğŸ ${character} - å½±ç‰‡ ${videoIndex + 1} ended äº‹ä»¶è§¸ç™¼`);

        // ç¢ºä¿åªæœ‰ç•¶å‰æ´»å‹•çš„å½±ç‰‡æ‰æœƒè§¸ç™¼åˆ‡æ›
        if (!video.classList.contains('active')) {
          console.log(`âš ï¸ ${character} - å½±ç‰‡ ${videoIndex + 1} ä¸æ˜¯æ´»èºç‹€æ…‹ï¼Œè·³éè™•ç†`);
          return;
        }

        const state = characterStates.get(character);
        if (!state) {
          console.log(`âš ï¸ ${character} - æ‰¾ä¸åˆ°ç‹€æ…‹ä¿¡æ¯`);
          return;
        }

        console.log(`ğŸ”„ ${character} - å½±ç‰‡ ${videoIndex + 1} ${state.playDirection} æ’­æ”¾çµæŸï¼Œæº–å‚™è™•ç†ä¸‹ä¸€æ­¥`);

        // ğŸ­ æ’­æ”¾æ¨¡å¼é¸æ“‡
        // true = æ¨¡å¼2 (æ¯å€‹å½±ç‰‡éƒ½å…ˆæ­£å‘å†åå‘): æ­£1å1æ­£2å2æ­£1å1æ­£2å2...
        // false = æ¨¡å¼1 (å…ˆå…¨éƒ¨æ­£å‘ï¼Œå†å…¨éƒ¨åå‘): æ­£1æ­£2æ­£3å1å2å3æ­£1æ­£2...
        const USE_MODE_2 = true;

        if (USE_MODE_2) {
          // æ¨¡å¼2ï¼šæ¯å€‹å½±ç‰‡éƒ½å…ˆæ­£å‘æ’­æ”¾å†åå‘æ’­æ”¾ï¼Œç„¶å¾Œåˆ‡æ›åˆ°ä¸‹ä¸€å€‹å½±ç‰‡
          // æ­£1å1æ­£2å2æ­£1å1æ­£2å2...
          if (state.playDirection === 'forward') {
            // æ­£å‘æ’­æ”¾çµæŸï¼Œé–‹å§‹åå‘æ’­æ”¾
            console.log(`ğŸ”„ ${character} - é–‹å§‹åå‘æ’­æ”¾å½±ç‰‡ ${videoIndex + 1}`);
            state.playDirection = 'backward';
            state.hasPlayedForward = true;

            // ä½¿ç”¨æ‰‹å‹•åå‘æ’­æ”¾ï¼ˆé¿å… playbackRate = -1 çš„éŒ¯èª¤ï¼‰
            console.log(`âª ${character} - ä½¿ç”¨æ‰‹å‹•åå‘æ’­æ”¾`);
            manualReversePlayback(video, character);
          } else if (state.playDirection === 'backward') {
            // åå‘æ’­æ”¾çµæŸï¼Œåˆ‡æ›åˆ°ä¸‹ä¸€å€‹å½±ç‰‡
            console.log(`ğŸ”„ ${character} - åå‘æ’­æ”¾çµæŸï¼Œæº–å‚™åˆ‡æ›åˆ°ä¸‹ä¸€å€‹å½±ç‰‡`);
            state.playDirection = 'forward';
            state.hasPlayedForward = false;
            state.hasPlayedBackward = false;
            switchToNextVideo(character);
          }
        } else {
          // æ¨¡å¼1ï¼šæ‰€æœ‰å½±ç‰‡æŒ‰é †åºæ­£å‘æ’­æ”¾ä¸€æ¬¡ï¼Œç„¶å¾Œæ‰€æœ‰å½±ç‰‡æŒ‰é †åºåå‘æ’­æ”¾ä¸€æ¬¡
          // æ­£åæ­£å... (å½±ç‰‡1æ­£å‘ â†’ å½±ç‰‡2æ­£å‘ â†’ å½±ç‰‡3æ­£å‘ â†’ å½±ç‰‡1åå‘ â†’ å½±ç‰‡2åå‘ â†’ å½±ç‰‡3åå‘ â†’ é‡è¤‡)

          // æª¢æŸ¥é€™å€‹è§’è‰²æœ‰å¤šå°‘å€‹å½±ç‰‡
          const characterVideos = document.querySelectorAll(`.dance-video[data-character="${character}"]`);
          const totalVideos = characterVideos.length;

          if (state.playDirection === 'forward') {
            // æ­£å‘æ’­æ”¾çµæŸ
            if (videoIndex < totalVideos - 1) {
              // é‚„æœ‰å…¶ä»–å½±ç‰‡è¦æ­£å‘æ’­æ”¾ï¼Œåˆ‡æ›åˆ°ä¸‹ä¸€å€‹å½±ç‰‡
              console.log(`â–¶ï¸ ${character} - æ­£å‘æ’­æ”¾å½±ç‰‡ ${videoIndex + 1} å®Œæˆï¼Œæº–å‚™æ’­æ”¾ä¸‹ä¸€å€‹å½±ç‰‡çš„æ­£å‘`);
              state.currentIndex = (videoIndex + 1) % totalVideos;
              switchToNextVideo(character);
            } else {
              // æ‰€æœ‰å½±ç‰‡éƒ½æ­£å‘æ’­æ”¾å®Œäº†ï¼Œé–‹å§‹åå‘æ’­æ”¾ç¬¬ä¸€å€‹å½±ç‰‡
              console.log(`ğŸ”„ ${character} - æ‰€æœ‰å½±ç‰‡æ­£å‘æ’­æ”¾å®Œæˆï¼Œé–‹å§‹åå‘æ’­æ”¾æ¨¡å¼`);
              state.playDirection = 'backward';
              state.currentIndex = 0; // å¾ç¬¬ä¸€å€‹å½±ç‰‡é–‹å§‹åå‘æ’­æ”¾
              switchToNextVideo(character);
            }
          } else if (state.playDirection === 'backward') {
            // åå‘æ’­æ”¾çµæŸ
            if (videoIndex < totalVideos - 1) {
              // é‚„æœ‰å…¶ä»–å½±ç‰‡è¦åå‘æ’­æ”¾ï¼Œåˆ‡æ›åˆ°ä¸‹ä¸€å€‹å½±ç‰‡
              console.log(`âª ${character} - åå‘æ’­æ”¾å½±ç‰‡ ${videoIndex + 1} å®Œæˆï¼Œæº–å‚™æ’­æ”¾ä¸‹ä¸€å€‹å½±ç‰‡çš„åå‘`);
              state.currentIndex = (videoIndex + 1) % totalVideos;
              switchToNextVideo(character);
            } else {
              // æ‰€æœ‰å½±ç‰‡éƒ½åå‘æ’­æ”¾å®Œäº†ï¼Œé‡æ–°é–‹å§‹æ­£å‘æ’­æ”¾
              console.log(`ğŸ”„ ${character} - æ‰€æœ‰å½±ç‰‡åå‘æ’­æ”¾å®Œæˆï¼Œé‡æ–°é–‹å§‹æ­£å‘æ’­æ”¾æ¨¡å¼`);
              state.playDirection = 'forward';
              state.currentIndex = 0; // å¾ç¬¬ä¸€å€‹å½±ç‰‡é–‹å§‹æ­£å‘æ’­æ”¾
              switchToNextVideo(character);
            }
          }
        }
      });
    });

    // é è¼‰å…¥ä¸‹ä¸€å€‹å½±ç‰‡çš„å‡½æ•¸
    function preloadNextVideo(character, currentVideoIndex) {
      const characterVideos = document.querySelectorAll(`.dance-video[data-character="${character}"]`);
      if (characterVideos.length <= 1) return; // å¦‚æœåªæœ‰ä¸€å€‹å½±ç‰‡ï¼Œä¸éœ€è¦é è¼‰å…¥

      // è¨ˆç®—ä¸‹ä¸€å€‹è¦é è¼‰å…¥çš„å½±ç‰‡ç´¢å¼•
      const nextIndex = (currentVideoIndex + 1) % characterVideos.length;
      const nextVideo = characterVideos[nextIndex] as HTMLVideoElement;

      // å¦‚æœä¸‹ä¸€å€‹å½±ç‰‡é‚„æ²’é è¼‰å…¥ï¼ŒåŠ å…¥é è¼‰å…¥éšŠåˆ—
      if (nextVideo && !videoResourceManager.preloadedVideos.has(nextVideo)) {
        videoResourceManager.queuePreload(nextVideo);
      }
    }

    // æ‰‹å‹•åå‘æ’­æ”¾å‡½æ•¸ - é¿å…ä½¿ç”¨ä¸æ”¯æŒçš„ playbackRate = -1
    function manualReversePlayback(video, character) {
      // å¦‚æœå·²ç¶“æœ‰åå‘æ’­æ”¾å‹•ç•«ï¼Œå…ˆåœæ­¢å®ƒ
      if (video.dataset.reverseAnimationId) {
        cancelAnimationFrame(parseInt(video.dataset.reverseAnimationId));
      }

      globalVideoMonitor.logEvent(character, video.getAttribute('data-video-index') || '0', 'reverse_start');
      console.log(`ğŸ¬ ${character} - é–‹å§‹æ‰‹å‹•åå‘æ’­æ”¾ (duration: ${video.duration}s)`);

      // é‡ç½®æ’­æ”¾é€Ÿåº¦
      video.playbackRate = 1;
      video.currentTime = video.duration;
      video.pause(); // å…ˆæš«åœï¼Œæº–å‚™åå‘æ’­æ”¾

      const reverseSpeed = 1/30; // æ¯å¹€æ¸›å°‘çš„æ™‚é–“ï¼ˆç§’ï¼‰ï¼Œ1å€é€Ÿ
      let isReversing = true;
      let frameCount = 0;

      function reverseFrame() {
        if (!video.classList.contains('active') || !isReversing) {
          console.log(`ğŸ›‘ ${character} - åå‘æ’­æ”¾å·²åœæ­¢`);
          if (video.dataset.reverseAnimationId) {
            video.dataset.reverseAnimationId = '';
          }
          return;
        }

        // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ’­æ”¾åˆ°é–‹é ­
        if (video.currentTime <= 0.1) {
          // åå‘æ’­æ”¾çµæŸ
          globalVideoMonitor.logEvent(character, video.getAttribute('data-video-index') || '0', 'reverse_end', `frames: ${frameCount}`);
          console.log(`ğŸ”„ ${character} - åå‘æ’­æ”¾å®Œæˆ (ç¸½å¹€æ•¸: ${frameCount})`);
          isReversing = false;
          video.dataset.reverseAnimationId = '';

          // è§¸ç™¼ ended äº‹ä»¶ï¼Œé€²å…¥ä¸‹ä¸€éšæ®µ
          const endEvent = new Event('ended');
          video.dispatchEvent(endEvent);
          return;
        }

        // æ¸›å°‘ currentTime ä¾†å¯¦ç¾åå‘æ’­æ”¾
        video.currentTime = Math.max(0, video.currentTime - reverseSpeed);
        frameCount++;

        // æ¯100å¹€è¼¸å‡ºä¸€æ¬¡é€²åº¦
        if (frameCount % 100 === 0) {
          const progress = ((video.duration - video.currentTime) / video.duration * 100).toFixed(1);
          console.log(`âª ${character} - åå‘æ’­æ”¾é€²åº¦: ${progress}% (å¹€: ${frameCount})`);
        }

        // ç¹¼çºŒä¸‹ä¸€å¹€
        video.dataset.reverseAnimationId = requestAnimationFrame(reverseFrame).toString();
      }

      // é–‹å§‹åå‘æ’­æ”¾å‹•ç•«
      video.dataset.reverseAnimationId = requestAnimationFrame(reverseFrame).toString();
    }

    // åˆ‡æ›åˆ°ä¸‹ä¸€å€‹å½±ç‰‡çš„å‡½æ•¸
    function switchToNextVideo(character) {
      const characterVideos = document.querySelectorAll(`.dance-video[data-character="${character}"]`);
      const state = characterStates.get(character);

      if (!characterVideos.length || !state) {
        console.log(`âš ï¸ ${character} æ²’æœ‰æ‰¾åˆ°å½±ç‰‡æˆ–ç‹€æ…‹`);
        return;
      }

      console.log(`ğŸ”„ ${character} é–‹å§‹åˆ‡æ›å½±ç‰‡ï¼Œç•¶å‰ç´¢å¼•: ${state.currentIndex}`);

      // è¨ˆç®—ä¸‹ä¸€å€‹å½±ç‰‡çš„ç´¢å¼•
      const nextIndex = (state.currentIndex + 1) % characterVideos.length;
      const currentVideo = characterVideos[state.currentIndex] as HTMLVideoElement;
      const nextVideo = characterVideos[nextIndex] as HTMLVideoElement;

      if (!nextVideo) {
        console.log(`âš ï¸ ${character} æ‰¾ä¸åˆ°ä¸‹ä¸€å€‹å½±ç‰‡`);
        return;
      }

      // ç«‹å³åœæ­¢ç•¶å‰å½±ç‰‡
      if (currentVideo) {
        currentVideo.pause();
        currentVideo.currentTime = 0;
        currentVideo.playbackRate = 1; // é‡ç½®æ’­æ”¾é€Ÿåº¦

        // åœæ­¢ä»»ä½•å¯èƒ½çš„åå‘æ’­æ”¾å‹•ç•«
        if (currentVideo.dataset.reverseAnimationId) {
          cancelAnimationFrame(parseInt(currentVideo.dataset.reverseAnimationId));
          currentVideo.dataset.reverseAnimationId = '';
          console.log(`ğŸ›‘ ${character} åœæ­¢åå‘æ’­æ”¾å‹•ç•«`);
        }

        // å¦‚æœå½±ç‰‡è¼‰å…¥ç‹€æ…‹å¤ªä½ï¼Œæ¸…ç†è³‡æº
        if (currentVideo.readyState < 2) { // HAVE_CURRENT_DATA or lower
          console.log(`ğŸ§¹ ${character} æ¸…ç†å½±ç‰‡ ${state.currentIndex + 1} è³‡æº`);
          currentVideo.preload = 'none';
          // æ³¨æ„ï¼šä¸è¦æ¸…ç† srcï¼Œå› ç‚ºæˆ‘å€‘å¯èƒ½é‚„éœ€è¦å®ƒ
        }

        console.log(`â¸ï¸ ${character} åœæ­¢å½±ç‰‡ ${state.currentIndex + 1}`);
      }

      // åŒæ™‚é€²è¡Œåˆ‡æ›ï¼Œç¢ºä¿æ²’æœ‰ç©ºéš™
      // 1. å…ˆç§»é™¤ç•¶å‰å½±ç‰‡çš„activeç‹€æ…‹
      if (currentVideo) {
        currentVideo.classList.remove('active');
      }

      // 2. é‡ç½®æ–°å½±ç‰‡çš„ç‹€æ…‹
      nextVideo.classList.add('active');
      nextVideo.currentTime = 0;
      nextVideo.playbackRate = 1; // ç¢ºä¿æ­£å‘æ’­æ”¾

      // 3. æª¢æŸ¥ä¸‹ä¸€å€‹å½±ç‰‡æ˜¯å¦å·²ç¶“é è¼‰å…¥
      if (videoResourceManager.preloadedVideos.has(nextVideo)) {
        console.log(`âš¡ ${character} å½±ç‰‡ ${nextIndex + 1} å·²é è¼‰å…¥ï¼Œå¯ä»¥ç«‹å³åˆ‡æ›`);
      } else if (nextVideo.readyState >= 3) { // HAVE_FUTURE_DATA or higher
        console.log(`âœ… ${character} å½±ç‰‡ ${nextIndex + 1} å·²æº–å‚™å¥½`);
      } else {
        // å½±ç‰‡é‚„æ²’æº–å‚™å¥½ï¼Œå˜—è©¦å¿«é€Ÿè¼‰å…¥
        console.log(`ğŸ“¥ ${character} å½±ç‰‡ ${nextIndex + 1} éœ€è¦è¼‰å…¥...`);
        if (videoResourceManager.canLoadVideo(nextVideo)) {
          nextVideo.preload = 'auto';
          nextVideo.load();
        } else {
          console.log(`â³ ${character} å½±ç‰‡ ${nextIndex + 1} ç­‰å¾…è³‡æºç®¡ç†å™¨å…è¨±è¼‰å…¥...`);
        }
      }

      // 4. ç­‰å¾…å½±ç‰‡æº–å‚™å¥½å¾Œæ‰æ’­æ”¾
      const tryPlayVideo = () => {
        if (nextVideo.readyState >= 3) { // HAVE_FUTURE_DATA
          const playPromise = nextVideo.play();
          if (playPromise !== undefined) {
            playPromise.catch(e => {
              console.log(`æ’­æ”¾å¤±æ•— ${character}:`, e);
              // å¦‚æœé‚„æ²’æº–å‚™å¥½ï¼Œç¨ç­‰å†è©¦
              if (nextVideo.readyState < 3) {
                setTimeout(tryPlayVideo, 100);
              }
            });
          }
        } else {
          // å½±ç‰‡é‚„æ²’æº–å‚™å¥½ï¼Œç¨ç­‰å†è©¦
          setTimeout(tryPlayVideo, 50);
        }
      };

      tryPlayVideo();

      // 5. æ›´æ–°ç‹€æ…‹ï¼Œç¢ºä¿æ–°å½±ç‰‡å¾æ­£å‘æ’­æ”¾é–‹å§‹
      state.currentIndex = nextIndex;
      state.playDirection = 'forward';
      state.hasPlayedForward = false;
      state.hasPlayedBackward = false;
      console.log(`ğŸ¯ ${character} åˆ‡æ›åˆ°å½±ç‰‡ ${state.currentIndex + 1}ï¼Œé‡ç½®ç‚ºæ­£å‘æ’­æ”¾`);

      // 6. é è¼‰å…¥ä¸‹ä¸‹å€‹å½±ç‰‡ï¼ˆå¦‚æœæœ‰çš„è©±ï¼Œä¸”è³‡æºå…è¨±ï¼‰
      const preloadIndex = (nextIndex + 1) % characterVideos.length;
      if (preloadIndex !== nextIndex) { // ç¢ºä¿ä¸æ˜¯åŒä¸€å€‹å½±ç‰‡
        const preloadVideo = characterVideos[preloadIndex] as HTMLVideoElement;
        if (preloadVideo && preloadVideo.readyState < 2) { // HAVE_CURRENT_DATA or lower
          if (videoResourceManager.canLoadVideo(preloadVideo)) {
            console.log(`ğŸ”® ${character} é è¼‰å…¥ä¸‹å€‹å½±ç‰‡ ${preloadIndex + 1}`);
            preloadVideo.preload = 'metadata'; // åªè¼‰å…¥metadataï¼Œç¯€çœè³‡æº
          } else {
            console.log(`â¸ï¸ ${character} å½±ç‰‡ ${preloadIndex + 1} è³‡æºä¸è¶³ï¼Œè·³éé è¼‰å…¥`);
          }
        }
      }
    }

    // ç‚ºæ¯å€‹è§’è‰²è¨­ç½®å‚™ç”¨å®šæ™‚å™¨ï¼Œç¢ºä¿å½±ç‰‡æœƒè¼ªæµæ’­æ”¾
    function setupBackupTimer(character) {
      const characterVideos = document.querySelectorAll(`.dance-video[data-character="${character}"]`);
      if (characterVideos.length <= 1) return; // å¦‚æœåªæœ‰ä¸€å€‹å½±ç‰‡ï¼Œä¸éœ€è¦è¼ªæµæ’­æ”¾

      setInterval(() => {
        const state = characterStates.get(character);
        if (state && characterVideos.length > 1) {
          const currentVideo = characterVideos[state.currentIndex] as HTMLVideoElement;
          if (currentVideo && currentVideo.classList.contains('active')) {
            // æª¢æŸ¥å½±ç‰‡æ˜¯å¦å·²ç¶“å®Œæˆæ­£å‘å’Œåå‘æ’­æ”¾çš„å®Œæ•´å¾ªç’°
            // å¦‚æœå½±ç‰‡åœä½äº†å¤ªä¹…ï¼ˆè¶…é10ç§’ï¼‰ï¼Œå¼·åˆ¶åˆ‡æ›
            if (currentVideo.paused && !currentVideo.seeking) {
              // æª¢æŸ¥æ˜¯å¦åœç•™å¤ªä¹…
              const now = Date.now();
              if (!currentVideo.dataset.lastActiveTime) {
                currentVideo.dataset.lastActiveTime = now.toString();
              } else {
                const lastActiveTime = parseInt(currentVideo.dataset.lastActiveTime);
                if (now - lastActiveTime > 10000) { // 10ç§’
                  console.log(`â° ${character} å‚™ç”¨å®šæ™‚å™¨è§¸ç™¼ï¼Œå½±ç‰‡åœç•™å¤ªä¹…ï¼Œå¼·åˆ¶åˆ‡æ›`);
                  switchToNextVideo(character);
                }
              }
            } else {
              // å½±ç‰‡é‚„åœ¨æ’­æ”¾ï¼Œæ›´æ–°æœ€å¾Œæ´»èºæ™‚é–“
              currentVideo.dataset.lastActiveTime = Date.now().toString();
            }
          }
        }
      }, 5000); // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡ï¼ˆæ›´é »ç¹çš„æª¢æŸ¥ï¼‰
    }

    // ç‚ºæ‰€æœ‰æœ‰å¤šå€‹å½±ç‰‡çš„è§’è‰²è¨­ç½®å‚™ç”¨å®šæ™‚å™¨
    items.forEach(item => {
      const character = item.getAttribute('data-character');
      if (character) {
        setupBackupTimer(character);
      }
    });

    console.log(`ğŸ¬ å·²è¼‰å…¥ ${items.length} å€‹è§’è‰²çµ„çš„è¼ªæµæ’­æ”¾å½±ç‰‡`);
    console.log('è§’è‰²åˆ†çµ„:', Array.from(characterStates.keys()));

    // åˆå§‹åŒ–é è¼‰å…¥ç³»çµ±
    setTimeout(() => {
      console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–å½±ç‰‡é è¼‰å…¥ç³»çµ±...');
      initializePreloading();
    }, 1000); // ç­‰å¾…1ç§’è®“åˆå§‹å½±ç‰‡é–‹å§‹æ’­æ”¾

    // åˆå§‹åŒ–é è¼‰å…¥å‡½æ•¸
    function initializePreloading() {
      const allVideos = document.querySelectorAll('.dance-video');
      console.log(`ğŸ“‹ ç¸½å…±æœ‰ ${allVideos.length} å€‹å½±ç‰‡éœ€è¦é è¼‰å…¥`);

      // å…ˆé è¼‰å…¥æ‰€æœ‰ç¬¬ä¸€å€‹å½±ç‰‡ï¼ˆæ´»èºçš„ï¼‰
      const firstVideos = document.querySelectorAll('.dance-video[data-video-index="0"]');
      firstVideos.forEach(video => {
        if (!videoResourceManager.preloadedVideos.has(video)) {
          videoResourceManager.queuePreload(video);
        }
      });

      // ç„¶å¾Œé è¼‰å…¥å…¶ä»–å½±ç‰‡
      setTimeout(() => {
        allVideos.forEach(video => {
          if (!videoResourceManager.preloadedVideos.has(video) && !video.classList.contains('active')) {
            videoResourceManager.queuePreload(video);
          }
        });
      }, 2000); // 2ç§’å¾Œé–‹å§‹é è¼‰å…¥å…¶ä»–å½±ç‰‡
    }

    // è¨ºæ–·å‡½æ•¸ - é¡¯ç¤ºæ‰€æœ‰å½±ç‰‡çš„äº‹ä»¶æ—¥èªŒ
    (window as any).diagnoseVideoEvents = function() {
      console.log('ğŸ” ===== å½±ç‰‡äº‹ä»¶è¨ºæ–·å ±å‘Š =====');
      globalVideoMonitor.videoEvents.forEach((events, videoKey) => {
        console.log(`ğŸ“¹ ${videoKey}:`);
        events.forEach(event => {
          const timeStr = new Date(event.time).toLocaleTimeString();
          console.log(`  ${timeStr} - ${event.type} ${event.details}`);
        });
      });
      console.log('ğŸ” ===== è¨ºæ–·å ±å‘ŠçµæŸ =====');
    };

    // è‡ªå‹•è¨ºæ–·å’Œé è¼‰å…¥ç‹€æ…‹å ±å‘Š
    setTimeout(() => {
      console.log('ğŸ” ===== ç³»çµ±ç‹€æ…‹å ±å‘Š =====');

      // é è¼‰å…¥ç‹€æ…‹
      const totalVideos = document.querySelectorAll('.dance-video').length;
      const preloadedCount = videoResourceManager.preloadedVideos.size;
      const loadingCount = videoResourceManager.loadingVideos.size;
      const queuedCount = videoResourceManager.preloadQueue.length;

      console.log('ğŸš€ ===== é è¼‰å…¥ç‹€æ…‹ =====');
      console.log(`ğŸ“Š ç¸½å½±ç‰‡æ•¸: ${totalVideos}`);
      console.log(`âœ… å·²é è¼‰å…¥: ${preloadedCount}`);
      console.log(`â³ æ­£åœ¨è¼‰å…¥: ${loadingCount}`);
      console.log(`ğŸ“‹ ç­‰å¾…éšŠåˆ—: ${queuedCount}`);
      console.log(`ğŸ“ˆ é è¼‰å…¥é€²åº¦: ${Math.round((preloadedCount / totalVideos) * 100)}%`);

      // æ’­æ”¾è¨ºæ–·
      console.log('ğŸ¬ ===== æ’­æ”¾è¨ºæ–· =====');
      const videosWithEnded = Array.from(globalVideoMonitor.videoEvents.entries())
        .filter(([key, events]) => events.some(e => e.type === 'ended')).length;

      const videosWithReverse = Array.from(globalVideoMonitor.videoEvents.entries())
        .filter(([key, events]) => events.some(e => e.type === 'reverse_start')).length;

      console.log(`ğŸ æœ‰çµæŸäº‹ä»¶çš„å½±ç‰‡: ${videosWithEnded}`);
      console.log(`âª æœ‰åå‘æ’­æ”¾çš„å½±ç‰‡: ${videosWithReverse}`);

      // å•é¡Œå½±ç‰‡
      globalVideoMonitor.videoEvents.forEach((events, videoKey) => {
        const hasEnded = events.some(e => e.type === 'ended');
        const hasReverse = events.some(e => e.type === 'reverse_start');

        if (!hasEnded) {
          console.log(`âš ï¸ ${videoKey} - æ²’æœ‰ ended äº‹ä»¶`);
        }
        if (hasReverse) {
          console.log(`âœ… ${videoKey} - æœ‰åå‘æ’­æ”¾`);
        } else if (hasEnded) {
          console.log(`âŒ ${videoKey} - æœ‰ ended ä½†æ²’æœ‰åå‘æ’­æ”¾`);
        }
      });

      console.log('ğŸ’¡ æç¤º: è¼¸å…¥ diagnoseVideoEvents() æŸ¥çœ‹è©³ç´°æ—¥èªŒ');
      console.log('ğŸ” ===== ç³»çµ±ç‹€æ…‹çµæŸ =====');
    }, 3000); // 3ç§’å¾Œé¡¯ç¤ºç‹€æ…‹
  });
</script>
