---
declare global {
  interface Window {
    TY_MULTIVERSE_CONFIG?: {
      tymbUrl: string;
      apiBaseUrl: string;
    };
  }
}

import BaseLayout from "../../layouts/BaseLayout.astro";
import Hero from "../../components/Hero.astro";

const url = new URL(Astro.request.url);
const username = url.searchParams.get('username');
const token = url.searchParams.get('token');

const isLoggedIn = !!username && !!token;

if (!isLoggedIn) {
  return Astro.redirect(`/tymultiverse/login?redirect=${encodeURIComponent(Astro.url.pathname + Astro.url.search)}`);
}

const tymbUrl = import.meta.env.PUBLIC_TYMB_URL;
const apiBaseUrl = import.meta.env.PUBLIC_API_BASE_URL;
---

<!DOCTYPE html>
<meta charset="UTF-8" />
<html>
  <head>
    <script async src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script async defer src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>
    <link rel="stylesheet" href="/src/styles/dance.css">
    <script define:vars={{ tymbUrl, apiBaseUrl }}>
      window.TY_MULTIVERSE_CONFIG = {
        tymbUrl: tymbUrl,
        apiBaseUrl: apiBaseUrl
      };
    </script>
  </head>
  <body>
    <BaseLayout title="Dance | TY Multiverse" description="Dance video collection">
      <div class="stack gap-20">
        <main class="wrapper stack gap-8">
          <Hero
            title="Dance"
            tagline="Enjoy the dance performances."
            align="start"
          />

          <div id="loading-status" class="loading-status">
            <div class="loading-spinner"></div>
            <span>æ­£åœ¨è¼‰å…¥è§’è‰²å’Œå½±ç‰‡è³‡æ–™...</span>
          </div>
          <div id="videos-grid" class="videos-grid">
            <!-- å½±ç‰‡å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
          </div>

          <!-- æ¸…é™¤ç·©å­˜æŒ‰éˆ• -->
          <button id="cache-clear-btn" class="cache-clear-btn" type="button">
          </button>
        </main>
      </div>
    </BaseLayout>
  </body>
</html>

<script>
  document.addEventListener("DOMContentLoaded", async function () {
    const MAX_NUMBERED_INDEX = 50;
    let videoGroups: Array<{character: string, videos: Array<{src: string, title: string}>}> = [];
    let characterStates = new Map();

    // å‹•æ…‹è¼‰å…¥è§’è‰²å’Œå½±ç‰‡ï¼ˆåˆ†æ‰¹è¼‰å…¥ä»¥æå‡æ•ˆèƒ½ï¼‰
    async function loadDanceContent() {
      const tymbUrl = window.TY_MULTIVERSE_CONFIG?.tymbUrl;
      const apiBaseUrl = window.TY_MULTIVERSE_CONFIG?.apiBaseUrl || import.meta.env.PUBLIC_PEOPLE_IMAGE_URL;

      try {
        updateLoadingStatus('loading', 'æ­£åœ¨ç²å–è§’è‰²åˆ—è¡¨...');

        const namesResponse = await fetch(`${tymbUrl}/people/names`);
        if (!namesResponse.ok) {
          throw new Error('ç„¡æ³•ç²å–è§’è‰²åˆ—è¡¨');
        }

        const characterNames = await namesResponse.json() as string[];
        console.log(`å¾ç·©å­˜è¼‰å…¥çš„é …ç›®æ•¸: ${videoResourceManager.videoCache.size}`);
        console.log(`APIè¿”å›è§’è‰²ç¸½æ•¸: ${characterNames.length}`);

        // å¦‚æœç·©å­˜ä¸­çš„è§’è‰²æ•¸é‡èˆ‡APIè¿”å›çš„è§’è‰²æ•¸é‡å·®ç•°éå¤§ï¼Œæ¸…é™¤èˆŠç·©å­˜
        const cacheSize = videoResourceManager.videoCache.size;
        const apiSize = characterNames.length;
        console.log(`ç·©å­˜è§’è‰²æ•¸: ${cacheSize}, APIè§’è‰²æ•¸: ${apiSize}`);
        
        if (cacheSize > 0 && Math.abs(apiSize - cacheSize) > 10) {
          console.log(`æª¢æ¸¬åˆ°è§’è‰²æ•¸é‡å·®ç•°éå¤§ (ç·©å­˜: ${cacheSize}, API: ${apiSize})ï¼Œæ¸…é™¤èˆŠç·©å­˜`);
          videoResourceManager.clearCache();
        }

        // å¦‚æœç·©å­˜è¢«æ¸…é™¤äº†ï¼Œæª¢æŸ¥æ‰€æœ‰è§’è‰²ï¼›å¦å‰‡ä½¿ç”¨æ™ºèƒ½éæ¿¾
        let charactersToCheck;
        if (videoResourceManager.videoCache.size === 0) {
          // ç·©å­˜è¢«æ¸…é™¤äº†ï¼Œæª¢æŸ¥æ‰€æœ‰è§’è‰²
          charactersToCheck = characterNames;
          console.log(`ç·©å­˜å·²æ¸…é™¤ï¼Œæª¢æŸ¥æ‰€æœ‰ ${charactersToCheck.length} å€‹è§’è‰²`);
        } else {
          // ä½¿ç”¨æ™ºèƒ½éæ¿¾
          charactersToCheck = characterNames.filter((character: string) => {
            const cached = videoResourceManager.getCachedVideoExists(character);
            // å°æ–¼å·²çŸ¥æ²’æœ‰å½±ç‰‡çš„è§’è‰²ï¼Œçµ¦äºˆ20%çš„é‡æ–°æª¢æŸ¥æ©Ÿæœƒ
            if (cached === false) {
              return Math.random() < 0.2; // 20%çš„æ©Ÿç‡é‡æ–°æª¢æŸ¥
            }
            // å°æ–¼æœªçŸ¥æˆ–å·²çŸ¥æœ‰å½±ç‰‡çš„è§’è‰²ï¼Œéƒ½æª¢æŸ¥
            return cached === undefined || cached === true;
          });
          console.log(`ä½¿ç”¨æ™ºèƒ½éæ¿¾ï¼Œå¯¦éš›æª¢æŸ¥ ${charactersToCheck.length} å€‹è§’è‰²`);
        }

        updateLoadingStatus('loading', `æª¢æŸ¥ ${charactersToCheck.length} å€‹è§’è‰²çš„å½±ç‰‡ç‹€æ…‹...`);

        // é€å€‹è™•ç†è§’è‰²ï¼Œç¢ºä¿æ¯å€‹è§’è‰²çš„æ‰€æœ‰å½±ç‰‡éƒ½èƒ½è¢«ç™¼ç¾
        const validCharacters: Array<{character: string, videos: Array<{src: string, title: string}>}> = [];

        for (let i = 0; i < charactersToCheck.length; i++) {
          const character = charactersToCheck[i];

          if (!character || typeof character !== 'string') continue; // è·³éç„¡æ•ˆçš„è§’è‰²åç¨±

          // æª¢æŸ¥é€™å€‹è§’è‰²çš„æ‰€æœ‰å½±ç‰‡
          const videos = await getCharacterVideos(apiBaseUrl!, character as string);

          if (videos.length > 0) {
            validCharacters.push({ character, videos });
            console.log(`âœ“ ${character}: æ‰¾åˆ° ${videos.length} å€‹å½±ç‰‡`);
          } else {
            // è¨˜éŒ„æ²’æœ‰å½±ç‰‡çš„è§’è‰²
            videoResourceManager.cacheVideoExists(character, false);
            console.log(`âœ— ${character}: æ²’æœ‰å½±ç‰‡`);
          }

          // æ›´æ–°é€²åº¦
          updateLoadingStatus('loading', `å·²è™•ç† ${i + 1}/${charactersToCheck.length} å€‹è§’è‰²...`);

          // åœ¨è§’è‰²é–“ä¼‘æ¯ä¸€ä¸‹ï¼Œé¿å…éåº¦è² è¼‰
          if (i < charactersToCheck.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 20));
          }
        }

        videoGroups = validCharacters;

        updateLoadingStatus('loading', `æ¸²æŸ“ ${videoGroups.length} å€‹è§’è‰²çš„å½±ç‰‡...`);

        renderVideos();

        // é¡¯ç¤ºç·©å­˜çµ±è¨ˆä¿¡æ¯
        const cacheStats = {
          total: videoResourceManager.videoCache.size,
          withVideos: Array.from(videoResourceManager.videoCache.entries()).filter(([_, hasVideo]) => hasVideo).length,
          withoutVideos: Array.from(videoResourceManager.videoCache.entries()).filter(([_, hasVideo]) => !hasVideo).length
        };

        console.log(`å½±ç‰‡ç·©å­˜çµ±è¨ˆ: ç¸½å…± ${cacheStats.total} å€‹è§’è‰²æª¢æŸ¥éï¼Œå…¶ä¸­ ${cacheStats.withVideos} å€‹æœ‰å½±ç‰‡ï¼Œ${cacheStats.withoutVideos} å€‹æ²’æœ‰å½±ç‰‡`);

        updateLoadingStatus('complete', `âœ… æˆåŠŸè¼‰å…¥ ${videoGroups.length} å€‹è§’è‰²çš„å½±ç‰‡è³‡æ–™`);

        // é–‹å§‹åˆå§‹åŒ–å½±ç‰‡é‚è¼¯
        initializeVideos();
        setupVideoEvents();

      } catch (error) {
        console.error('è¼‰å…¥å½±ç‰‡å…§å®¹å¤±æ•—:', error);
        updateLoadingStatus('error', 'âŒ è¼‰å…¥å½±ç‰‡å…§å®¹å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
      }
    }

    async function checkVideoExists(baseUrl: string, videoName: string): Promise<boolean> {
      try {
        // å¦‚æœbaseUrlå·²ç¶“åŒ…å«images/peopleè·¯å¾‘ï¼Œç›´æ¥æ‹¼æ¥å½±ç‰‡åç¨±
        // å¦å‰‡æ·»åŠ å®Œæ•´çš„è·¯å¾‘
        const url = baseUrl.includes('/images/people')
          ? `${baseUrl}/${videoName}.mp4`
          : `${baseUrl}/images/people/${videoName}.mp4`;

        const response = await fetch(url, {
          method: 'HEAD',
        });
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    function constructVideoUrl(baseUrl: string, videoName: string): string {
      // å¦‚æœbaseUrlå·²ç¶“åŒ…å«images/peopleè·¯å¾‘ï¼Œç›´æ¥æ‹¼æ¥å½±ç‰‡åç¨±
      // å¦å‰‡æ·»åŠ å®Œæ•´çš„è·¯å¾‘
      return baseUrl.includes('/images/people')
        ? `${baseUrl}/${videoName}.mp4`
        : `${baseUrl}/images/people/${videoName}.mp4`;
    }

    async function getCharacterVideos(baseUrl: string, character: string): Promise<Array<{src: string, title: string}>> {
      const videos: Array<{src: string, title: string}> = [];

      // æª¢æŸ¥ä¸»è¦å½±ç‰‡
      const mainVideoName = character;
      const hasMain = await checkVideoExists(baseUrl, mainVideoName);
      if (hasMain) {
        videos.push({
          src: constructVideoUrl(baseUrl, mainVideoName),
          title: mainVideoName
        });
        console.log(`æ‰¾åˆ°å½±ç‰‡: ${mainVideoName}.mp4`);
      }

      // æª¢æŸ¥ç·¨è™Ÿå½±ç‰‡ (1, 2, 3, ...)
      let consecutiveFailures = 0;
      const maxConsecutiveFailures = 3; // å…è¨±æœ€å¤š3å€‹é€£çºŒå¤±æ•—

      for (let index = 1; index <= MAX_NUMBERED_INDEX; index++) {
        const numberedVideoName = `${character}${index}`;
        try {
          const exists = await checkVideoExists(baseUrl, numberedVideoName);
          if (exists) {
            videos.push({
              src: constructVideoUrl(baseUrl, numberedVideoName),
              title: `${character} ${index}`
            });
            console.log(`æ‰¾åˆ°å½±ç‰‡: ${numberedVideoName}.mp4`);
            consecutiveFailures = 0; // é‡ç½®é€£çºŒå¤±æ•—è¨ˆæ•¸
          } else {
            consecutiveFailures++;
            console.log(`å½±ç‰‡ä¸å­˜åœ¨: ${numberedVideoName}.mp4`);

            // å¦‚æœé€£çºŒ3å€‹å½±ç‰‡ä¸å­˜åœ¨ï¼Œåœæ­¢æª¢æŸ¥
            if (consecutiveFailures >= maxConsecutiveFailures) {
              console.log(`é€£çºŒ ${consecutiveFailures} å€‹å½±ç‰‡ä¸å­˜åœ¨ï¼Œåœæ­¢æª¢æŸ¥ ${character} çš„å¾ŒçºŒå½±ç‰‡`);
              break;
            }
          }
        } catch (error) {
          consecutiveFailures++;
          console.log(`æª¢æŸ¥å½±ç‰‡å¤±æ•—: ${numberedVideoName}.mp4`, error);

          // å¦‚æœé€£çºŒ3å€‹å½±ç‰‡æª¢æŸ¥å¤±æ•—ï¼Œåœæ­¢æª¢æŸ¥
          if (consecutiveFailures >= maxConsecutiveFailures) {
            console.log(`é€£çºŒ ${consecutiveFailures} å€‹å½±ç‰‡æª¢æŸ¥å¤±æ•—ï¼Œåœæ­¢æª¢æŸ¥ ${character} çš„å¾ŒçºŒå½±ç‰‡`);
            break;
          }
        }
      }

      console.log(`${character} ç¸½å…±æ‰¾åˆ° ${videos.length} å€‹å½±ç‰‡`);
      return videos;
    }

    function renderVideos() {
      const videosGrid = document.getElementById('videos-grid');
      if (!videosGrid) return;

      videosGrid.innerHTML = '';

      videoGroups.forEach((group, groupIndex) => {
        const videoItem = document.createElement('div');
        videoItem.className = 'video-item';
        videoItem.setAttribute('data-character', group.character);
        videoItem.setAttribute('data-group-index', groupIndex.toString());

        const videoContainer = document.createElement('div');
        videoContainer.className = 'video-container';

        group.videos.forEach((video, videoIndex) => {
          const videoElement = document.createElement('video');
          videoElement.id = `video-${group.character}-${videoIndex}`;
          videoElement.className = `dance-video ${videoIndex === 0 ? 'active' : ''}`;
          videoElement.muted = true;
          videoElement.preload = videoIndex <= 1 ? 'auto' : 'metadata'; // é è¼‰å…¥å‰å…©å€‹å½±ç‰‡
          videoElement.playsInline = true;
          videoElement.setAttribute('data-character', group.character);
          videoElement.setAttribute('data-video-index', videoIndex.toString());

          const source = document.createElement('source');
          source.src = video.src;
          source.type = 'video/mp4';

          videoElement.appendChild(source);
          videoContainer.appendChild(videoElement);

          console.log(`æ¸²æŸ“å½±ç‰‡: ${group.character} - å½±ç‰‡ ${videoIndex} (${video.src})`);
        });

        const videoOverlay = document.createElement('div');
        videoOverlay.className = 'video-overlay';

        const videoTitle = document.createElement('div');
        videoTitle.className = 'video-title';
        videoTitle.textContent = group.character;

        videoOverlay.appendChild(videoTitle);
        videoContainer.appendChild(videoOverlay);
        videoItem.appendChild(videoContainer);
        videosGrid.appendChild(videoItem);
      });
    }

    function updateLoadingStatus(status, message) {
      const loadingStatus = document.getElementById('loading-status');
      if (loadingStatus) {
        const text = loadingStatus.querySelector('span');
        if (text) {
          text.textContent = message;
        }

        loadingStatus.classList.remove('loading-complete', 'loading-error', 'hidden');

        if (status === 'complete') {
          loadingStatus.classList.add('loading-complete');
          setTimeout(() => {
            loadingStatus.classList.add('hidden');
          }, 3000);
        } else if (status === 'error') {
          loadingStatus.classList.add('loading-error');
        }
      }
    }

    const videoResourceManager = {
      maxConcurrentLoads: 3,
      loadingVideos: new Set(),
      preloadQueue: [],
      preloadedVideos: new Set(),
      videoCache: new Map(),
      cacheExpiryDays: 7, // ç·©å­˜æœ‰æ•ˆæœŸ 7 å¤©

      canLoadVideo(video) {
        return this.loadingVideos.size < this.maxConcurrentLoads;
      },

      startLoading(video) {
        this.loadingVideos.add(video);
      },

      finishLoading(video) {
        this.loadingVideos.delete(video);
        this.preloadedVideos.add(video);
        this.processPreloadQueue();
      },

      queuePreload(video) {
        if (!this.preloadedVideos.has(video) && !this.loadingVideos.has(video)) {
          this.preloadQueue.push(video);
          this.processPreloadQueue();
        }
      },

      processPreloadQueue() {
        while (this.preloadQueue.length > 0 && this.canLoadVideo(null)) {
          const video = this.preloadQueue.shift();
          if (video && !this.preloadedVideos.has(video) && !this.loadingVideos.has(video)) {
            video.preload = 'auto';
            video.load();
          }
        }
      },

      // æŒä¹…åŒ–ç·©å­˜åˆ° localStorage
      saveCacheToStorage() {
        try {
          const cacheData = {
            timestamp: Date.now(),
            data: Array.from(this.videoCache.entries()),
            version: '1.0'
          };
          localStorage.setItem('dance_video_cache', JSON.stringify(cacheData));
          console.log(`ğŸ’¾ å·²ä¿å­˜ ${this.videoCache.size} å€‹å½±ç‰‡ç·©å­˜é …ç›®åˆ° localStorage`);
        } catch (error) {
          console.warn('ç„¡æ³•ä¿å­˜å½±ç‰‡ç·©å­˜åˆ° localStorage:', error);
        }
      },

      // å¾ localStorage è¼‰å…¥ç·©å­˜
      loadCacheFromStorage() {
        try {
          const stored = localStorage.getItem('dance_video_cache');
          if (!stored) {
            console.log('ğŸ“‚ æ²’æœ‰æ‰¾åˆ°æœ¬åœ°å½±ç‰‡ç·©å­˜');
            return;
          }

          const cacheData = JSON.parse(stored);
          const now = Date.now();
          const expiryTime = this.cacheExpiryDays * 24 * 60 * 60 * 1000; // 7 å¤©

          // æª¢æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§
          if (cacheData.version !== '1.0') {
            console.log('ğŸ“… ç·©å­˜ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæ¸…é™¤èˆŠç·©å­˜');
            localStorage.removeItem('dance_video_cache');
            return;
          }

          // æª¢æŸ¥ç·©å­˜æ˜¯å¦éæœŸ
          if (now - cacheData.timestamp > expiryTime) {
            console.log('â° å½±ç‰‡ç·©å­˜å·²éæœŸï¼Œæ¸…é™¤èˆŠç·©å­˜');
            localStorage.removeItem('dance_video_cache');
            return;
          }

          // è¼‰å…¥ç·©å­˜æ•¸æ“š
          cacheData.data.forEach(([key, value]) => {
            this.videoCache.set(key, value);
          });

          console.log(`ğŸ“¥ å·²è¼‰å…¥ ${this.videoCache.size} å€‹å½±ç‰‡ç·©å­˜é …ç›®`);
        } catch (error) {
          console.warn('âŒ ç„¡æ³•å¾ localStorage è¼‰å…¥å½±ç‰‡ç·©å­˜:', error);
          localStorage.removeItem('dance_video_cache'); // æ¸…é™¤æå£çš„ç·©å­˜
        }
      },

      // æ¸…é™¤æ‰€æœ‰ç·©å­˜
      clearCache() {
        this.videoCache.clear();
        localStorage.removeItem('dance_video_cache');
        console.log('å·²æ¸…é™¤æ‰€æœ‰å½±ç‰‡å­˜åœ¨æ€§ç·©å­˜');
      },

      cacheVideoExists(videoName, exists) {
        const previousValue = this.videoCache.get(videoName);
        this.videoCache.set(videoName, exists);

        // å¦‚æœå€¼ç™¼ç”Ÿè®ŠåŒ–æˆ–ç·©å­˜é …ç›®è¼ƒå°‘ï¼Œç«‹å³ä¿å­˜
        if (previousValue !== exists || this.videoCache.size <= 20) {
          this.saveCacheToStorage();
        }
        // å¦å‰‡æ¯ 5 æ¬¡æ“ä½œä¿å­˜ä¸€æ¬¡
        else if (this.videoCache.size % 5 === 0) {
          this.saveCacheToStorage();
        }
      },

      getCachedVideoExists(videoName) {
        return this.videoCache.get(videoName);
      },

      async checkVideoExists(videoName, baseUrl) {
        const cached = this.getCachedVideoExists(videoName);
        if (cached !== undefined) {
          return cached;
        }

        try {
          const response = await fetch(`${baseUrl}/images/people/${videoName}.mp4`, {
            method: 'HEAD',
          });
          const exists = response.ok;
          this.cacheVideoExists(videoName, exists);
          return exists;
        } catch (error) {
          this.cacheVideoExists(videoName, false);
          return false;
        }
      }
    };

    const globalVideoMonitor = {
      videoEvents: new Map(),

      logEvent(character, videoIndex, eventType, details = '') {
        const key = `${character}-${videoIndex}`;
        if (!this.videoEvents.has(key)) {
          this.videoEvents.set(key, []);
        }
        const events = this.videoEvents.get(key);
        events.push({ type: eventType, time: Date.now(), details });
      }
    };

    function initializeVideos() {
      const items = document.querySelectorAll('.video-item');
      items.forEach(item => {
        const character = item.getAttribute('data-character');
        if (character) {
          characterStates.set(character, {
            currentIndex: 0,
            playDirection: 'forward',
            hasPlayedForward: false,
            hasPlayedBackward: false
          });
        }
      });
    }

    function setupVideoEvents() {
      const videos = Array.from(document.querySelectorAll('.dance-video')) as HTMLVideoElement[];
      videos.forEach((video) => {
      const character = video.getAttribute('data-character');
      const videoIndex = parseInt(video.getAttribute('data-video-index') || '0');

      video.addEventListener('loadstart', function () {
        videoResourceManager.startLoading(video);
        video.classList.add('loading');
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'loadstart');
      });

      video.addEventListener('canplay', function () {
        videoResourceManager.finishLoading(video);
        video.classList.remove('loading');
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'canplay', `readyState: ${video.readyState}`);

        // è®“æ‰€æœ‰å½±ç‰‡éƒ½èƒ½æ’­æ”¾ï¼Œåªè¦æ˜¯activeç‹€æ…‹æˆ–è€…å³å°‡æˆç‚ºactiveç‹€æ…‹
        // å°æ–¼å¤šå½±ç‰‡è§’è‰²ï¼Œç¬¬ä¸€å€‹å½±ç‰‡ç¸½æ˜¯å˜—è©¦æ’­æ”¾
        // å°æ–¼å–®å½±ç‰‡è§’è‰²ï¼Œæ‰€æœ‰å½±ç‰‡éƒ½å˜—è©¦æ’­æ”¾
        const characterVideos = document.querySelectorAll(`.dance-video[data-character="${character}"]`);
        const shouldTryPlay = video.classList.contains('active') ||
                              video.dataset.pendingActive ||
                              (characterVideos.length === 1) || // å–®å½±ç‰‡è§’è‰²
                              (videoIndex === 0); // å¤šå½±ç‰‡è§’è‰²çš„ç¬¬ä¸€å€‹å½±ç‰‡

        if (shouldTryPlay && !video.dataset.playAttempted) {
          video.dataset.playAttempted = 'true';

          const tryPlayVideo = () => {
            // å¦‚æœå½±ç‰‡ä¸å†æ˜¯activeç‹€æ…‹ï¼Œå–æ¶ˆæ’­æ”¾å˜—è©¦
            if (!video.classList.contains('active') && !video.dataset.pendingActive && videoIndex !== 0) {
              delete video.dataset.playAttempted;
              return;
            }

            if (video.readyState >= 3) { // HAVE_FUTURE_DATA æˆ–æ›´é«˜
              video.play().then(() => {
                // æ’­æ”¾æˆåŠŸï¼Œæ¸…é™¤pendingæ¨™è¨˜
                delete video.dataset.pendingActive;
                globalVideoMonitor.logEvent(character, videoIndex + 1, 'play_success');
              }).catch(e => {
                // åªè¨˜éŒ„éé æœŸçš„éŒ¯èª¤
                if (e.name !== 'AbortError' && e.name !== 'NotAllowedError') {
                  console.log(`æ’­æ”¾å¤±æ•— ${character}:`, e);
                  globalVideoMonitor.logEvent(character, videoIndex + 1, 'play_error', e.message);
                }
                delete video.dataset.playAttempted;
                delete video.dataset.pendingActive;
              });
            } else if (video.readyState >= 2) { // HAVE_CURRENT_DATA
              // æ•¸æ“šé‚„åœ¨è¼‰å…¥ä¸­ï¼Œç¨ç­‰ä¸€ä¸‹å†è©¦
              setTimeout(tryPlayVideo, 100);
            } else {
              // æ•¸æ“šé‚„æ²’æº–å‚™å¥½ï¼Œç­‰å¾…æ›´å¤šæ•¸æ“š
              setTimeout(tryPlayVideo, 200);
            }
          };

          tryPlayVideo();
        }

        setTimeout(() => {
          preloadNextVideo(character, videoIndex);
        }, 100);
      });

      video.addEventListener('error', function (e) {
        videoResourceManager.finishLoading(video);
        video.classList.remove('loading');
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'error');

        // æ¸…é™¤æ’­æ”¾å˜—è©¦æ¨™è¨˜ï¼Œå…è¨±é‡æ–°å˜—è©¦
        delete video.dataset.playAttempted;
      });

      video.addEventListener('canplaythrough', function () {
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'canplaythrough');
      });

      video.addEventListener('play', function () {
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'play');
      });

      video.addEventListener('ended', function () {
        globalVideoMonitor.logEvent(character, videoIndex + 1, 'ended', `active: ${video.classList.contains('active')}`);

        // æ¸…é™¤æ’­æ”¾å˜—è©¦æ¨™è¨˜ï¼Œç‚ºä¸‹æ¬¡æ’­æ”¾åšæº–å‚™
        delete video.dataset.playAttempted;

        if (!video.classList.contains('active')) {
          return;
        }

        // é˜²æ­¢é‡è¤‡è™•ç† ended äº‹ä»¶
        if (video.dataset.processingEnded) {
          return;
        }
        video.dataset.processingEnded = 'true';

        const state = characterStates.get(character);
        if (!state) {
          delete video.dataset.processingEnded;
          return;
        }

        const USE_MODE_2 = true;

        if (USE_MODE_2) {
          if (state.playDirection === 'forward') {
            // æ­£æ”¾çµæŸï¼Œé–‹å§‹å€’æ”¾
            state.playDirection = 'backward';
            state.hasPlayedForward = true;
            // æ¸…é™¤è™•ç†æ¨™è¨˜ï¼Œç„¶å¾Œé–‹å§‹å€’æ”¾
            delete video.dataset.processingEnded;
            manualReversePlayback(video, character);
          } else if (state.playDirection === 'backward') {
            // å€’æ”¾çµæŸï¼Œåˆ‡æ›åˆ°ä¸‹ä¸€å€‹å½±ç‰‡
            state.playDirection = 'forward';
            state.hasPlayedBackward = true;

            const characterVideos = document.querySelectorAll(`.dance-video[data-character="${character}"]`);
            const totalVideos = characterVideos.length;

            // æ›´æ–°currentIndexåˆ°ä¸‹ä¸€å€‹å½±ç‰‡
            state.currentIndex = (videoIndex + 1) % totalVideos;

            // å¦‚æœæ˜¯æœ€å¾Œä¸€å€‹å½±ç‰‡å¾ªç’°åˆ°ç¬¬ä¸€å€‹ï¼Œé‡ç½®ç‹€æ…‹
            if (videoIndex === totalVideos - 1) {
              state.playDirection = 'forward';
              state.hasPlayedForward = false;
              state.hasPlayedBackward = false;
            }

            // æ¸…é™¤è™•ç†æ¨™è¨˜ï¼Œç„¶å¾Œåˆ‡æ›å½±ç‰‡
            delete video.dataset.processingEnded;
            setTimeout(() => {
              switchToNextVideo(character);
            }, 10);
          }
        } else {
          const characterVideos = document.querySelectorAll(`.dance-video[data-character="${character}"]`);
          const totalVideos = characterVideos.length;

          if (state.playDirection === 'forward') {
            if (videoIndex < totalVideos - 1) {
              state.currentIndex = (videoIndex + 1) % totalVideos;
              delete video.dataset.processingEnded;
              switchToNextVideo(character);
            } else {
              state.playDirection = 'backward';
              state.currentIndex = 0;
              delete video.dataset.processingEnded;
              switchToNextVideo(character);
            }
          } else if (state.playDirection === 'backward') {
            if (videoIndex < totalVideos - 1) {
              state.currentIndex = (videoIndex + 1) % totalVideos;
              delete video.dataset.processingEnded;
              switchToNextVideo(character);
            } else {
              state.playDirection = 'forward';
              state.currentIndex = 0;
              delete video.dataset.processingEnded;
              switchToNextVideo(character);
            }
          }
        }
      });
          });
    }

    function preloadNextVideo(character, currentVideoIndex) {
      const characterVideos = document.querySelectorAll(`.dance-video[data-character="${character}"]`);
      if (characterVideos.length <= 1) return;

      const nextIndex = (currentVideoIndex + 1) % characterVideos.length;
      const nextVideo = characterVideos[nextIndex] as HTMLVideoElement;

      if (nextVideo && !videoResourceManager.preloadedVideos.has(nextVideo)) {
        videoResourceManager.queuePreload(nextVideo);
      }
    }

    function manualReversePlayback(video, character) {
      if (video.dataset.reverseAnimationId) {
        cancelAnimationFrame(parseInt(video.dataset.reverseAnimationId));
      }

      globalVideoMonitor.logEvent(character, video.getAttribute('data-video-index') || '0', 'reverse_start');

      video.playbackRate = 1;
      video.currentTime = video.duration;
      video.pause();

      const reverseSpeed = 1/30;
      let isReversing = true;
      let frameCount = 0;

      function reverseFrame() {
        if (!video.classList.contains('active') || !isReversing) {
          if (video.dataset.reverseAnimationId) {
            video.dataset.reverseAnimationId = '';
          }
          return;
        }

        if (video.currentTime <= 0.1) {
          globalVideoMonitor.logEvent(character, video.getAttribute('data-video-index') || '0', 'reverse_end', `frames: ${frameCount}`);
          isReversing = false;
          video.dataset.reverseAnimationId = '';

          // ç¢ºä¿ç•¶å‰å½±ç‰‡ä»ç„¶æ˜¯ active çš„
          if (!video.classList.contains('active')) {
            return;
          }

          // ç›´æ¥åˆ‡æ›åˆ°ä¸‹ä¸€å€‹å½±ç‰‡ï¼Œè€Œä¸æ˜¯è§¸ç™¼ ended äº‹ä»¶
          const state = characterStates.get(character);
          if (state) {
            console.log(`${character} å½±ç‰‡ ${video.getAttribute('data-video-index')} å€’æ”¾çµæŸï¼Œæº–å‚™åˆ‡æ›åˆ°ä¸‹ä¸€å€‹å½±ç‰‡`);
            // ä¸è¦åœ¨é€™è£¡é‡ç½®ç‹€æ…‹ï¼Œè®“switchToNextVideoå‡½æ•¸è™•ç†
            // state.playDirection = 'forward';
            // state.hasPlayedForward = false;
            // state.hasPlayedBackward = false;
            // å»¶é²ä¸€é»é»åŸ·è¡Œï¼Œç¢ºä¿ç‹€æ…‹æ¸…ç†å®Œæˆ
            setTimeout(() => {
              switchToNextVideo(character);
            }, 10);
          }
          return;
        }

        video.currentTime = Math.max(0, video.currentTime - reverseSpeed);
        frameCount++;

        video.dataset.reverseAnimationId = requestAnimationFrame(reverseFrame).toString();
      }

      video.dataset.reverseAnimationId = requestAnimationFrame(reverseFrame).toString();
    }

    function switchToNextVideo(character) {
      const characterVideos = document.querySelectorAll(`.dance-video[data-character="${character}"]`);
      const state = characterStates.get(character);

      if (!characterVideos.length || !state) {
        return;
      }

      // å¦‚æœåªæœ‰ä¸€å€‹å½±ç‰‡ï¼Œé‡æ–°æ’­æ”¾ç•¶å‰å½±ç‰‡
      if (characterVideos.length === 1) {
        const singleVideo = characterVideos[0] as HTMLVideoElement;
        singleVideo.currentTime = 0;
        singleVideo.playbackRate = 1;

        // æ¸…é™¤ç‹€æ…‹æ¨™è¨˜
        delete singleVideo.dataset.processingEnded;
        delete singleVideo.dataset.playAttempted;

        // é‡æ–°é–‹å§‹æ’­æ”¾
        if (singleVideo.readyState >= 3) {
          singleVideo.dataset.playAttempted = 'true';
          singleVideo.play().catch(e => {
            if (e.name !== 'AbortError' && e.name !== 'NotAllowedError') {
              console.log(`å–®ä¸€å½±ç‰‡é‡æ’­å¤±æ•— ${character}:`, e);
            }
            delete singleVideo.dataset.playAttempted;
          });
        }

        // é‡ç½®ç‹€æ…‹
        state.playDirection = 'forward';
        state.hasPlayedForward = false;
        state.hasPlayedBackward = false;
        return;
      }

      // ç¢ºä¿currentIndexåœ¨æœ‰æ•ˆç¯„åœå…§
      if (state.currentIndex >= characterVideos.length) {
        state.currentIndex = 0;
      }

      // ä½¿ç”¨ç•¶å‰è¨­å®šçš„currentIndexä½œç‚ºä¸‹ä¸€å€‹è¦æ’­æ”¾çš„å½±ç‰‡
      const nextIndex = state.currentIndex;
      const currentVideo = characterVideos[(nextIndex - 1 + characterVideos.length) % characterVideos.length] as HTMLVideoElement;
      const nextVideo = characterVideos[nextIndex] as HTMLVideoElement;

      console.log(`${character}: åˆ‡æ›åˆ°å½±ç‰‡ ${nextIndex}`);

      if (!nextVideo) {
        console.error(`${character}: æ‰¾ä¸åˆ°ä¸‹ä¸€å€‹å½±ç‰‡ (ç´¢å¼•: ${nextIndex})`);
        return;
      }

      if (currentVideo) {
        currentVideo.pause();
        currentVideo.currentTime = 0;
        currentVideo.playbackRate = 1;

        if (currentVideo.dataset.reverseAnimationId) {
          cancelAnimationFrame(parseInt(currentVideo.dataset.reverseAnimationId));
          currentVideo.dataset.reverseAnimationId = '';
        }

        // æ¸…é™¤ç‹€æ…‹æ¨™è¨˜
        delete currentVideo.dataset.processingEnded;
        delete currentVideo.dataset.playAttempted;

        if (currentVideo.readyState < 2) {
          currentVideo.preload = 'none';
        }
      }

      if (currentVideo) {
        currentVideo.classList.remove('active');
      }

      // å…ˆæ¸…é™¤ç‹€æ…‹æ¨™è¨˜ï¼Œç„¶å¾Œè¨­ç½®activeç‹€æ…‹
      delete nextVideo.dataset.playAttempted;
      delete nextVideo.dataset.processingEnded;

      // å¦‚æœå½±ç‰‡é‚„æ²’æœ‰è¼‰å…¥å®Œæˆï¼Œè¨­ç½®pendingæ¨™è¨˜
      if (nextVideo.readyState < 3) {
        nextVideo.dataset.pendingActive = 'true';
      }

      nextVideo.classList.add('active');
      nextVideo.currentTime = 0;
      nextVideo.playbackRate = 1;

      const tryPlayVideo = () => {
        if (!nextVideo.classList.contains('active')) {
          return;
        }

        if (nextVideo.readyState >= 3) {
          if (!nextVideo.dataset.playAttempted) {
            nextVideo.dataset.playAttempted = 'true';
            const playPromise = nextVideo.play();
            if (playPromise !== undefined) {
              playPromise.then(() => {
                globalVideoMonitor.logEvent(character, nextVideo.getAttribute('data-video-index') || '0', 'switch_play_success');
              }).catch(e => {
                if (e.name !== 'AbortError' && e.name !== 'NotAllowedError') {
                  console.log(`åˆ‡æ›æ’­æ”¾å¤±æ•— ${character}:`, e);
                  globalVideoMonitor.logEvent(character, nextVideo.getAttribute('data-video-index') || '0', 'switch_play_error', e.message);
                }
                delete nextVideo.dataset.playAttempted;
                if (nextVideo.readyState < 3) {
                  setTimeout(tryPlayVideo, 100);
                }
              });
            }
          }
        } else {
          setTimeout(tryPlayVideo, 50);
        }
      };

      tryPlayVideo();

      // æ›´æ–°ç•¶å‰ç´¢å¼•ï¼Œä½†ä¿æŒæ’­æ”¾æ–¹å‘ï¼Œé™¤éæ˜¯å¾å€’æ”¾åˆ‡æ›éä¾†çš„
      state.currentIndex = nextIndex;

      // å¦‚æœé€™æ˜¯å¾å€’æ”¾åˆ‡æ›éä¾†çš„ï¼Œä¿æŒç•¶å‰çš„æ’­æ”¾ç‹€æ…‹
      // åªæœ‰åœ¨æ­£å¸¸æ’­æ”¾çµæŸæ™‚æ‰é‡ç½®ç‹€æ…‹
      const isFromReverse = state.playDirection === 'forward' &&
                           state.hasPlayedForward === false &&
                           state.hasPlayedBackward === false;

      if (!isFromReverse) {
        state.playDirection = 'forward';
        state.hasPlayedForward = false;
        state.hasPlayedBackward = false;
      }

      const preloadIndex = (nextIndex + 1) % characterVideos.length;
      if (preloadIndex !== nextIndex) {
        const preloadVideo = characterVideos[preloadIndex] as HTMLVideoElement;
        if (preloadVideo && preloadVideo.readyState < 2) {
          if (videoResourceManager.canLoadVideo(preloadVideo)) {
            preloadVideo.preload = 'metadata';
          }
        }
      }
    }

    function setupBackupTimer(character) {
      const characterVideos = document.querySelectorAll(`.dance-video[data-character="${character}"]`);
      if (characterVideos.length <= 1) return;

      setInterval(() => {
        const state = characterStates.get(character);
        if (state && characterVideos.length > 1) {
          const currentVideo = characterVideos[state.currentIndex] as HTMLVideoElement;
          if (currentVideo && currentVideo.classList.contains('active')) {
            if (currentVideo.paused && !currentVideo.seeking) {
              const now = Date.now();
              if (!currentVideo.dataset.lastActiveTime) {
                currentVideo.dataset.lastActiveTime = now.toString();
              } else {
                const lastActiveTime = parseInt(currentVideo.dataset.lastActiveTime);
                if (now - lastActiveTime > 10000) {
                  switchToNextVideo(character);
                }
              }
            } else {
              currentVideo.dataset.lastActiveTime = Date.now().toString();
            }
          }
        }
      }, 5000);
    }

    const items = document.querySelectorAll('.video-item');
    items.forEach(item => {
      const character = item.getAttribute('data-character');
      if (character) {
        setupBackupTimer(character);
      }
    });

    async function refreshVideoAvailability() {
      const tymbUrl = window.TY_MULTIVERSE_CONFIG?.tymbUrl || 'http://localhost:8080/tymb';
      const apiBaseUrl = window.TY_MULTIVERSE_CONFIG?.apiBaseUrl || 'https://peoplesystem.tatdvsonorth.com';

      try {
        const namesResponse = await fetch(`${tymbUrl}/people/names`);
        if (!namesResponse.ok) {
          updateLoadingStatus('error', 'âŒ ç„¡æ³•ç²å–è§’è‰²åç¨±åˆ—è¡¨');
          return;
        }

        const characterNames = await namesResponse.json();
        let newVideosFound = 0;

        for (const character of characterNames) {
          const mainVideoExists = await videoResourceManager.checkVideoExists(character, apiBaseUrl);
          if (mainVideoExists) {
            const existingVideo = document.querySelector(`.dance-video[data-character="${character}"][data-video-index="0"]`);
            if (!existingVideo) {
              newVideosFound++;
            }

            let index = 1;
            while (true) {
              const numberedVideoName = `${character}${index}`;
              const numberedVideoExists = await videoResourceManager.checkVideoExists(numberedVideoName, apiBaseUrl);
              if (numberedVideoExists) {
                const existingNumberedVideo = document.querySelector(`.dance-video[data-character="${character}"][data-video-index="${index}"]`);
                if (!existingNumberedVideo) {
                  newVideosFound++;
                }
                index++;
              } else {
                break;
              }
            }
          }
        }

        if (newVideosFound > 0) {
          updateLoadingStatus('complete', `ğŸ‰ ç™¼ç¾ ${newVideosFound} å€‹æ–°å½±ç‰‡ï¼å»ºè­°é‡æ–°æ•´ç†é é¢ä»¥è¼‰å…¥æ–°å…§å®¹ã€‚`);
        } else {
          updateLoadingStatus('complete', 'âœ… æ‰€æœ‰å½±ç‰‡éƒ½æ˜¯æœ€æ–°çš„');
        }

      } catch (error) {
        updateLoadingStatus('error', 'âŒ æª¢æŸ¥å½±ç‰‡å¯ç”¨æ€§æ™‚ç™¼ç”ŸéŒ¯èª¤');
      }
    }

    setTimeout(() => {
      initializePreloading();
    }, 1000);

    setInterval(refreshVideoAvailability, 5 * 60 * 1000);

    setTimeout(refreshVideoAvailability, 3000);

    function initializePreloading() {
      const allVideos = document.querySelectorAll('.dance-video');

      const firstVideos = document.querySelectorAll('.dance-video[data-video-index="0"]');
      firstVideos.forEach(video => {
        if (!videoResourceManager.preloadedVideos.has(video)) {
          videoResourceManager.queuePreload(video);
        }
      });

      setTimeout(() => {
        allVideos.forEach(video => {
          if (!videoResourceManager.preloadedVideos.has(video) && !video.classList.contains('active')) {
            videoResourceManager.queuePreload(video);
          }
        });
      }, 2000);
    }

    (window as any).diagnoseVideoEvents = function() {
      globalVideoMonitor.videoEvents.forEach((events, videoKey) => {
        events.forEach(event => {
          const timeStr = new Date(event.time).toLocaleTimeString();
        });
      });
    };

    // å…¨åŸŸæ¸…é™¤ç·©å­˜å‡½æ•¸ - ç”¨æˆ¶å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°åŸ·è¡Œ clearDanceCache() ä¾†æ¸…é™¤ç·©å­˜
    (window as any).clearDanceCache = function() {
      videoResourceManager.clearCache();
      console.log('å·²æ¸…é™¤æ‰€æœ‰å½±ç‰‡å­˜åœ¨æ€§ç·©å­˜ï¼Œé‡æ–°æ•´ç†é é¢å°‡é‡æ–°æª¢æŸ¥æ‰€æœ‰è§’è‰²çš„å½±ç‰‡ç‹€æ…‹ã€‚');
      alert('å·²æ¸…é™¤æ‰€æœ‰å½±ç‰‡å­˜åœ¨æ€§ç·©å­˜ï¼Œé‡æ–°æ•´ç†é é¢å°‡é‡æ–°æª¢æŸ¥æ‰€æœ‰è§’è‰²çš„å½±ç‰‡ç‹€æ…‹ã€‚');
    };

    // ç«‹å³é‡æ–°è¼‰å…¥æ‰€æœ‰è§’è‰² - ç”¨æˆ¶å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°åŸ·è¡Œ reloadAllCharacters()
    (window as any).reloadAllCharacters = function() {
      console.log('ç«‹å³é‡æ–°è¼‰å…¥æ‰€æœ‰è§’è‰²...');
      // æ¸…é™¤ç·©å­˜
      videoResourceManager.clearCache();
      // ç«‹å³é‡æ–°è¼‰å…¥é é¢
      window.location.reload(); // å¼·åˆ¶å¾æœå‹™å™¨é‡æ–°è¼‰å…¥
    };

    // å¼·åˆ¶é‡æ–°æª¢æŸ¥æ‰€æœ‰è§’è‰² - ç”¨æˆ¶å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°åŸ·è¡Œ forceRefreshAllCharacters()
    (window as any).forceRefreshAllCharacters = function() {
      console.log('å¼·åˆ¶é‡æ–°æª¢æŸ¥æ‰€æœ‰è§’è‰²...');
      // æ¸…é™¤ç·©å­˜
      videoResourceManager.clearCache();
      // é‡æ–°è¼‰å…¥é é¢
      window.location.reload();
    };

    // æš´éœ²ç·©å­˜çµ±è¨ˆå‡½æ•¸ä¾›èª¿è©¦ä½¿ç”¨
    (window as any).getDanceCacheStats = function() {
      const cache = videoResourceManager.videoCache;
      const stats = {
        total: cache.size,
        withVideos: Array.from(cache.entries()).filter(([_, hasVideo]) => hasVideo).length,
        withoutVideos: Array.from(cache.entries()).filter(([_, hasVideo]) => !hasVideo).length,
        entries: Array.from(cache.entries())
      };
      console.log('ğŸ“Š å½±ç‰‡ç·©å­˜çµ±è¨ˆ:');
      console.log(`   ç¸½é …ç›®æ•¸: ${stats.total}`);
      console.log(`   æœ‰å½±ç‰‡: ${stats.withVideos}`);
      console.log(`   ç„¡å½±ç‰‡: ${stats.withVideos}`);
      console.table(stats.entries);
      return stats;
    };

    // å¼·åˆ¶ä¿å­˜ç·©å­˜åˆ°æœ¬åœ°å­˜å„²
    (window as any).saveDanceCache = function() {
      videoResourceManager.saveCacheToStorage();
      console.log('âœ… ç·©å­˜å·²æ‰‹å‹•ä¿å­˜åˆ° localStorage');
    };

    setTimeout(() => {
      const totalVideos = document.querySelectorAll('.dance-video').length;
      const preloadedCount = videoResourceManager.preloadedVideos.size;
      const loadingCount = videoResourceManager.loadingVideos.size;
      const queuedCount = videoResourceManager.preloadQueue.length;

      const videosWithEnded = Array.from(globalVideoMonitor.videoEvents.entries())
        .filter(([key, events]) => events.some(e => e.type === 'ended')).length;

      const videosWithReverse = Array.from(globalVideoMonitor.videoEvents.entries())
        .filter(([key, events]) => events.some(e => e.type === 'reverse_start')).length;

      globalVideoMonitor.videoEvents.forEach((events, videoKey) => {
        const hasEnded = events.some(e => e.type === 'ended');
        const hasReverse = events.some(e => e.type === 'reverse_start');
      });
    }, 3000);

    // å…ˆè¼‰å…¥å½±ç‰‡å­˜åœ¨æ€§ç·©å­˜ï¼Œç„¶å¾Œå†é–‹å§‹è¼‰å…¥å…§å®¹
    videoResourceManager.loadCacheFromStorage();

    // ç¢ºä¿ç·©å­˜è¼‰å…¥å®Œæˆå¾Œå†é–‹å§‹è¼‰å…¥å½±ç‰‡å…§å®¹
    setTimeout(() => {
      console.log(`ğŸ¯ ç·©å­˜è¼‰å…¥å®Œæˆï¼Œç¸½å…± ${videoResourceManager.videoCache.size} å€‹ç·©å­˜é …ç›®`);

      // æ·»åŠ éµç›¤å¿«æ·éµ
      document.addEventListener('keydown', function(event) {
        // Ctrl+F5 æˆ– Ctrl+R å¼·åˆ¶é‡æ–°è¼‰å…¥æ‰€æœ‰è§’è‰²
        if ((event.ctrlKey || event.metaKey) && (event.key === 'F5' || event.key === 'r')) {
          event.preventDefault();
          console.log('æª¢æ¸¬åˆ°å¼·åˆ¶åˆ·æ–°å¿«æ·éµ (Ctrl+F5/Ctrl+R)');
          (window as any).forceRefreshAllCharacters();
        }
        // F5 å–®ç¨æŒ‰ä¸‹ä¹Ÿå¼·åˆ¶åˆ·æ–°
        else if (event.key === 'F5') {
          event.preventDefault();
          console.log('æª¢æ¸¬åˆ°F5åˆ·æ–°');
          (window as any).forceRefreshAllCharacters();
        }
      });

      // åœ¨é é¢è¼‰å…¥å®Œæˆå¾Œé¡¯ç¤ºæç¤ºä¿¡æ¯
      setTimeout(() => {
        console.log('ğŸ’¡ æç¤º: æŒ‰ Ctrl+F5 æˆ– F5 å¼·åˆ¶é‡æ–°æª¢æŸ¥æ‰€æœ‰è§’è‰²');
        console.log('ğŸ’¡ æˆ–è€…åœ¨æ§åˆ¶å°åŸ·è¡Œ: forceRefreshAllCharacters()');
      }, 2000);

          // é–‹å§‹è¼‰å…¥å½±ç‰‡å…§å®¹
    loadDanceContent();

    // è¨­ç½®æ¸…é™¤ç·©å­˜æŒ‰éˆ•äº‹ä»¶
    setupCacheClearButton();
  }, 100);

  // æ¸…é™¤ç·©å­˜æŒ‰éˆ•è¨­ç½®å‡½æ•¸
  function setupCacheClearButton() {
    const cacheClearBtn = document.getElementById('cache-clear-btn') as HTMLButtonElement;
    if (cacheClearBtn) {
      cacheClearBtn.addEventListener('click', async function() {
        // ç¢ºèªç”¨æˆ¶æ˜¯å¦çœŸçš„è¦æ¸…é™¤ç·©å­˜
        const confirmed = confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å½±ç‰‡ç·©å­˜ä¸¦é‡æ–°è¼‰å…¥å—ï¼Ÿ\né€™å°‡æœƒé‡æ–°æª¢æŸ¥æ‰€æœ‰è§’è‰²çš„å½±ç‰‡ç‹€æ…‹ï¼Œå¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ã€‚');

        if (!confirmed) {
          return;
        }

        console.log('ç”¨æˆ¶ç¢ºèªæ¸…é™¤ç·©å­˜ä¸¦é‡æ–°è¼‰å…¥');

        // è¨­ç½®æŒ‰éˆ•ç‚ºè™•ç†ä¸­ç‹€æ…‹
        cacheClearBtn.classList.add('processing');
        cacheClearBtn.textContent = 'æ­£åœ¨æ¸…é™¤ç·©å­˜...';
        cacheClearBtn.disabled = true;

        try {
          // æ¸…é™¤ç·©å­˜
          videoResourceManager.clearCache();

          // é¡¯ç¤ºæ¸…é™¤ç·©å­˜çš„ç‹€æ…‹
          updateLoadingStatus('loading', 'ç·©å­˜å·²æ¸…é™¤ï¼Œæ­£åœ¨é‡æ–°è¼‰å…¥...');

          // ç­‰å¾…ä¸€ä¸‹è®“ç”¨æˆ¶çœ‹åˆ°ç‹€æ…‹è®ŠåŒ–
          await new Promise(resolve => setTimeout(resolve, 1000));

          // æ¸…é™¤ç¾æœ‰çš„å½±ç‰‡å…ƒç´ 
          const videosGrid = document.getElementById('videos-grid');
          if (videosGrid) {
            videosGrid.innerHTML = '';
          }

          // é‡ç½®æ‰€æœ‰ç‹€æ…‹
          videoGroups = [];
          characterStates.clear();

          // é‡æ–°é–‹å§‹è¼‰å…¥å…§å®¹
          await loadDanceContent();

          // é¡¯ç¤ºå®Œæˆç‹€æ…‹
          updateLoadingStatus('complete', 'âœ… ç·©å­˜å·²æ¸…é™¤ï¼Œæ‰€æœ‰å½±ç‰‡å·²é‡æ–°è¼‰å…¥');

        } catch (error) {
          console.error('æ¸…é™¤ç·©å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
          updateLoadingStatus('error', 'âŒ æ¸…é™¤ç·©å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        } finally {
          // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
          cacheClearBtn.classList.remove('processing');
          cacheClearBtn.textContent = 'æ¸…é™¤ç·©å­˜ä¸¦é‡æ–°è¼‰å…¥';
          cacheClearBtn.disabled = false;
        }
      });
    }
  }
    window.addEventListener('beforeunload', () => {
      try {
        videoResourceManager.saveCacheToStorage();
        console.log('ğŸ’¾ é é¢å¸è¼‰å‰å·²ä¿å­˜å½±ç‰‡ç·©å­˜');
      } catch (error) {
        console.warn('âš ï¸ é é¢å¸è¼‰æ™‚ä¿å­˜ç·©å­˜å¤±æ•—:', error);
      }
    });

    // é é¢ç²å–ç„¦é»æ™‚æª¢æŸ¥ç·©å­˜å®Œæ•´æ€§
    window.addEventListener('focus', () => {
      // ç¢ºä¿ç·©å­˜æ²’æœ‰æå£
      if (videoResourceManager.videoCache.size > 0) {
        console.log(`ğŸ” é é¢é‡æ–°ç²å¾—ç„¦é»ï¼Œç•¶å‰ç·©å­˜é …ç›®: ${videoResourceManager.videoCache.size}`);
      }
    });
  });
</script>
