---
import BaseLayout from "../layouts/BaseLayout.astro";
import Hero from "../components/Hero.astro";
import Gallery from  "../components/Gallery.html";

// 檢查登入狀態
const url = new URL(Astro.request.url);
const username = url.searchParams.get('username');
const token = url.searchParams.get('token');

// 如果未登入，重定向到登入頁面
if (!username || !token) {
  return Astro.redirect(`/tymultiverse/login?redirect=${encodeURIComponent(Astro.url.pathname + Astro.url.search)}`);
}

// 檢查用戶是否有特殊權限
const TYMB_URL = import.meta.env.PUBLIC_TYMB_URL;
let hasAccess = false;

try {
  // 構建 API URL
  const apiUrl = new URL(`${TYMB_URL}/keycloak/introspect`);
  apiUrl.searchParams.set('token', token);
  
  // 使用 fetch 同步檢查權限
  const response = await fetch(apiUrl.toString(), {
    method: 'GET',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'Accept': 'application/json',
    },
    credentials: 'include',
    mode: 'cors'
  });

  if (response.ok) {
    const data = await response.json();
    // 檢查 preferred_username 是否為 chiaki 或 sorane
    hasAccess = data.preferred_username === 'chiaki' || data.preferred_username === 'sorane';
  }
} catch (error) {
  console.error('Token verification failed:', error);
}

// 如果用戶沒有特殊權限，重定向到首頁
if (!hasAccess) {
  return Astro.redirect('/tymultiverse/');
}
---

<!DOCTYPE html>
<meta charset="UTF-8" />
<html>
  <head>
    <style>
      #system {
        text-align: center;
      }
      #settle {
        font-size: 100px;
        font-weight: bold;
        color: rgb(81, 167, 247);
      }
    </style>
  </head>
  <body>
    <BaseLayout
      title="Palais | Wavo Yuropha"
      description="Learn about TY's most recent projects"
    >
      <div class="stack gap-20">
        <main class="wrapper stack gap-8">
          <Hero
            title="Palais"
            tagline="Designed by Tianyi in Taipei."
            align="start"
          />
          <Gallery />
        </main>
      </div>
    </BaseLayout>
  </body>
</html>
