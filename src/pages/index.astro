---
import { getCollection } from 'astro:content';

// Layout import — provides basic page elements: <head>, <nav>, <footer> etc.
import BaseLayout from '../layouts/BaseLayout.astro';

// Component Imports
import CallToAction from '../components/CallToAction.astro';
import Grid from '../components/Grid.astro';
import Hero from '../components/Hero.astro';
import { Icon } from '../components/Icon';
import Pill from '../components/Pill.astro';
import PortfolioPreview from '../components/PortfolioPreview.astro';

// Page section components
import ContactCTA from '../components/ContactCTA.astro';
import Skills from '../components/Skills.astro';
import '../styles/index.css';
// Content Fetching: List four most recent work projects
const projects = (await getCollection('work'))
	.sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
	.slice(0, 4);

// 修改服務器啟動時間的處理
let serverStartTime = new Date().toISOString();
try {
    // 使用環境變量或默認值
    serverStartTime = import.meta.env.SERVER_START_TIME || serverStartTime;
} catch (error) {
    console.error('Error getting server start time:', error);
}

// 檢查是否需要顯示登入提示
const showLoginAlert = Astro.url.searchParams.get('showLoginAlert') === 'true';

const algorithmsUsed = [
    { name: "Kadane's Algorithm", explanation: "在一次掃描中找到一維數組中具有最大和的連續子數組。它會追蹤當前子數組的最大和以及目前為止找到的全局最大和。" }
    // Add more algorithms here in the future, e.g.:
    // { name: "Dijkstra's Algorithm", explanation: "迪杰斯特拉算法：計算圖中單源最短路徑。" }
];

// Full Astro Component Syntax:
// https://docs.astro.build/core-concepts/astro-components/
---
<meta charset="UTF-8" />
<head>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Kalam&display=swap">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css">
          
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js" async></script>

</head>

<body>
<!-- Messenger Chat Plugin Code -->
<div id="fb-root"></div>

<!-- Your Chat Plugin code -->
<div id="fb-customer-chat" class="fb-customerchat">
</div>
<BaseLayout>
	{showLoginAlert && 
		<script is:inline>
			document.addEventListener('DOMContentLoaded', function() {
				window.Swal.fire({
					title: '請先登入',
					icon: 'info',
					timer: 1000,
					showConfirmButton: false
				});
			});
		</script>
	}
	<div class="stack gap-20 lg:gap-48">
		
		<div class="wrapper stack gap-20 lg:gap-50">
			
			<header class="hero stack hero-layout">
				<div class="hero-main">
					<div class="hero-header">
						<h1>TY's Outerspace</h1>
						<p>The Future is Now</p>
					</div>
					<div class="hero-content">
						<div class="github-stats">
							<div class="roles-image">
								<img src="https://github-readme-stats.vercel.app/api?username=vinskao&show_icons=true&theme=light" alt="GitHub Stats">
							</div>
							<div class="roles-image">
								<img src="https://github-readme-stats.vercel.app/api/top-langs/?username=vinskao&layout=compact&hide=astro" alt="Top Languages">
							</div>
						</div>

						<div class="categories">
							<div class="category">
								<h5>Backend</h5>
								<div class="pills-container">
									<span class="pill pill1 shade1">Java</span>
									<span class="pill pill1 shade3">Python</span>
									<span class="pill pill1 shade3">Node.js</span>
									<span class="pill pill1 shade3">PHP</span>
									<span class="pill pill1 shade5">Rust</span>
									<span class="pill pill1 shade3">Spring</span>
									<span class="pill pill1 shade3">Quarkus</span>
									<span class="pill pill1 shade2">Spring Boot</span>
									<span class="pill pill1 shade4">Django Rest</span>
									<span class="pill pill1 shade1">JPA</span>
									<span class="pill pill1 shade1">Mybatis</span>
									<span class="pill pill1 shade1">JDBCTemplate</span>
									<span class="pill pill1 shade1">Java Keystore</span>
									<span class="pill pill1 shade1">Swagger</span>
									<span class="pill pill1 shade2">JUnit</span>
									<span class="pill pill1 shade3">Mokito</span>
									<span class="pill pill1 shade4">Mongoose.js</span>
									<span class="pill pill1 shade4">Express.js</span>
								</div>
							</div>
						
							<!-- 項目 2 -->
							<div class="category">
								<h5>Frontend</h5>
								<div class="pills-container">
									<span class="pill pill2 shade1">JavaScript</span>
									<span class="pill pill2 shade2">Vue.js</span>
									<span class="pill pill2 shade3">React.js</span>
									<span class="pill pill2 shade1">jQuery</span>
									<span class="pill pill2 shade1">AJAX</span>
									<span class="pill pill2 shade5">Jest</span>
									<span class="pill pill2 shade2">Astro</span>
									<span class="pill pill2 shade2">Handlebars</span>
									<span class="pill pill2 shade2">Thymeleaf</span>
									<span class="pill pill2 shade2">CKEditor</span>
								</div>
							</div>
						
							<!-- 項目 3 -->
							<div class="category">
								<h5>AI</h5>
								<div class="pills-container">
									<span class="pill pill3 shade5">LangChain</span>
									<span class="pill pill3 shade5">Ollama</span>
									<span class="pill pill3 shade4">OpenAI API</span>
								</div>
							</div>
						
							<!-- 項目 4 -->
							<div class="category">
								<h5>DB</h5>
								<div class="pills-container">
									<span class="pill pill4 shade4">Firebase</span>
									<span class="pill pill4 shade4">MongoDB</span>
									<span class="pill pill4 shade1">PostgreSQL</span>
									<span class="pill pill4 shade1">MSSQL</span>
									<span class="pill pill4 shade1">SQLite</span>
								</div>
							</div>
						
							<!-- 項目 5 -->
							<div class="category">
								<h5>Infra</h5>
								<div class="pills-container">
									<span class="pill pill5 shade1">Docker</span>
									<span class="pill pill5 shade1">Podman</span>
									<span class="pill pill5 shade1">Linux</span>
									<span class="pill pill5 shade2">JBoss</span>
									<span class="pill pill5 shade4">Terraform</span>
									<span class="pill pill5 shade2">Bare Metal K8S</span>
									<span class="pill pill5 shade5">OCP K8S</span>
									<span class="pill pill5 shade4">Ansible</span>
									<span class="pill pill5 shade3">Tomcat</span>
									<span class="pill pill5 shade4">Grafana</span>
									<span class="pill pill5 shade4">Prometheus</span>
									<span class="pill pill5 shade4">Kiali</span>
									<span class="pill pill5 shade3">Jolokia</span>
								</div>
							</div>

							<!-- 項目 10 -->
							<div class="category">
								<h5>CICD</h5>
								<div class="pills-container">
									<span class="pill pill10 shade3">Jenkins</span>
									<span class="pill pill10 shade5">Docker BuildKit</span>
								</div>
							</div>
						
							<!-- 項目 6 -->
							<div class="category">
								<h5>Network</h5>
								<div class="pills-container">
									<span class="pill pill6 shade4">Istio</span>
									<span class="pill pill6 shade1">Ingress</span>
									<span class="pill pill6 shade2">Nginx Ingress Controller</span>
									<span class="pill pill6 shade3">Nginx Static File Server</span>
									<span class="pill pill6 shade3">WebSocket</span>
								</div>
							</div>

							<!-- 項目 7 -->
							<div class="category">
								<h5>Cloud</h5>
								<div class="pills-container">
									<span class="pill pill7 shade3">OCI</span>
									<span class="pill pill7 shade5">GCP</span>
								</div>
							</div>

							<!-- 項目 8 -->
							<div class="category">
								<h5>Tool</h5>
								<div class="pills-container">
									<span class="pill pill8 shade2">WordPress</span>
								</div>
							</div>

							<!-- 項目 9 -->
							<div class="category">
								<h5>Security</h5>
								<div class="pills-container">
									<span class="pill pill9 shade2">Keycloak</span>
									<span class="pill pill9 shade4">Keycloak SPI</span>
									<span class="pill pill9 shade3">RedHat SSO</span>
									<span class="pill pill9 shade2">Authorization Code Flow</span>
									<span class="pill pill9 shade2 jwt">JWT</span>
									<span class="pill pill9 shade3 spring-security">Spring Security</span>
									<span class="pill pill9 shade3">Digital Signature</span>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="hero-side">
					<div class="video-container">
						<div class="roles">
							<Pill><Icon icon="code" size="1.33em" /> Backend</Pill>
							<Pill><Icon icon="code" size="1.33em" /> Frontend</Pill>
							<Pill><Icon icon="pencil-line" size="1.33em" /> DevOps</Pill>
							<Pill><Icon icon="microphone-stage" size="1.33em" /> PM</Pill>
						</div>
						<div class="github-graph">
							<h5>Github Contributions</h5>
							<div>
								<img src="https://ghchart.rshah.org/VinsKao" alt="VinsKao's Github chart" />
							</div>
						</div>

						<video autoplay loop muted playsinline>
							<source src="/tymultiverse/assets/protrait.mp4" type="video/mp4">
							Your browser does not support the video tag.
						</video>
						<div class="leetcode-graph">
							<h5>LeetCode Stats</h5>
							<div id="leetcode-stats" class="leetcode-container">
								<div class="leetcode-card">
									<h6>Total Solved</h6>
									<p id="total-solved">Loading...</p>
									<div class="progress-bar">
										<div id="total-progress"></div>
									</div>
								</div>
								<div class="leetcode-card">
									<h6>Easy</h6>
									<p id="easy-solved">Loading...</p>
									<div class="progress-bar">
										<div id="easy-progress"></div>
									</div>
								</div>
								<div class="leetcode-card">
									<h6>Medium</h6>
									<p id="medium-solved">Loading...</p>
									<div class="progress-bar">
										<div id="medium-progress"></div>
									</div>
								</div>
								<div class="leetcode-card">
									<h6>Hard</h6>
									<p id="hard-solved">Loading...</p>
									<div class="progress-bar">
										<div id="hard-progress"></div>
									</div>
								</div>
							</div>
						</div>

                        <div class="algorithms-section">
                            <h5>Algorithms Used</h5>
                            <div class="algorithms-list">
                                {algorithmsUsed.map((algo) => (
                                    <span class="pill algo-pill" data-explanation={algo.explanation}>{algo.name}</span>
                                ))}
                            </div>
                        </div>
					</div>
				</div>

				
			</header>

			<Skills />

		</div>

		<main class="wrapper stack gap-20 lg:gap-48">
			<section class="section with-background with-cta">
				<header class="section-header stack gap-2 lg:gap-4">
					<h5>Collections</h5>
					<p>Recent Notes</p>
				</header>

				<div class="gallery">
					<Grid variant="offset">
						{
							projects.map((project) => (
								<li>
									<PortfolioPreview project={project} />
								</li>
							))
						}
					</Grid>
				</div>

				<div class="cta">
					<CallToAction href="/tymultiverse/work/">
						View All
						<Icon icon="arrow-right" size="1.2em" />
					</CallToAction>
				</div>
			</section>

			<section class="section with-background bg-variant">
				<header class="section-header stack gap-2 lg:gap-4">
					<h5>Mentions</h5>
					<p>
						To be Continued...
					</p>
				</header>

				<div class="gallery">
					<Grid variant="small">
						{
							['Who', 'Am', 'I'].map((brand) => (
								<li class="mention-card">
									<p>{brand}</p>
								</li>
							))
						}
					</Grid>
				</div>
			</section>
		</main>

		<ContactCTA />
	</div>
</BaseLayout>



</body>
<script>

// 加上tooltip
document.addEventListener("DOMContentLoaded", () => {
    // 定義提示文字
    const shadeDescriptions = {
        shade1: "Score 5 Strong",
        shade2: "Score 4 Sufficient",
        shade3: "Score 3 Understood",
        shade4: "Score 2 Applicable",
        shade5: "Score 1 Basic",
    };

    // 分數映射
    const shadeScores = {
        shade1: 5,
        shade2: 4,
        shade3: 3,
        shade4: 2,
        shade5: 1,
    };

    // 計算每個類別的總分數
    function calculateCategoryScores() {
        const categories = document.querySelectorAll('.category');
        
        categories.forEach((category) => {
            const pills = category.querySelectorAll('.pill');
            let totalScore = 0;
            
            pills.forEach((pill) => {
                const shadeClass = [...pill.classList].find((cls) => cls.startsWith("shade"));
                if (shadeClass && shadeScores[shadeClass]) {
                    totalScore += shadeScores[shadeClass];
                }
            });
            
            // 找到類別標題
            const title = category.querySelector('h5');
            if (title) {
                // 添加總分 - 改為小字格式
                title.innerHTML = `${title.textContent} <sup style="font-size: 0.65em; color: #888; margin-left: 4px;">${totalScore}</sup>`;
            }
        });
    }

    // 建立提示框元素
    const tooltip = document.createElement("div");
    tooltip.style.position = "absolute";
    tooltip.style.padding = "5px 10px";
    tooltip.style.backgroundColor = "#333";
    tooltip.style.color = "#fff";
    tooltip.style.borderRadius = "4px";
    tooltip.style.fontSize = "12px";
    tooltip.style.display = "none";
    tooltip.style.zIndex = "1000";
    tooltip.style.pointerEvents = "none";
    document.body.appendChild(tooltip);

    // 處理 hover 事件
    const pills = document.querySelectorAll(".pill");
    pills.forEach((pill) => {
        let tooltipTextValue: string | null = null;
        if (pill.hasAttribute('data-explanation')) {
            tooltipTextValue = pill.getAttribute('data-explanation');
        } else {
            const shadeClass = [...pill.classList].find((cls) => cls.startsWith("shade"));
            if (shadeClass && shadeDescriptions[shadeClass]) {
                tooltipTextValue = shadeDescriptions[shadeClass];
            }
        }

        if (tooltipTextValue !== null) {
            const finalTooltipText = tooltipTextValue; // Ensures non-null string for closure
            // 滑鼠進入
            pill.addEventListener("mouseenter", (e) => {
                tooltip.textContent = finalTooltipText;
                tooltip.style.display = "block";
                const rect = (e.target as HTMLElement).getBoundingClientRect();
                tooltip.style.left = `${rect.left + window.scrollX}px`;
                tooltip.style.top = `${rect.top + window.scrollY - tooltip.offsetHeight - 5}px`;
            });

            // 滑鼠移動
            pill.addEventListener("mousemove", (e: any) => {
                tooltip.style.left = `${e.pageX}px`;
                tooltip.style.top = `${e.pageY - tooltip.offsetHeight - 5}px`;
            });

            // 滑鼠離開
            pill.addEventListener("mouseleave", () => {
                tooltip.style.display = "none";
            });
        }
    });

    // 計算並顯示分數
    calculateCategoryScores();
});


// HEX to RGB 顏色轉換
function hexToRgb(hex: string): { r: number; g: number; b: number } {
    const bigint = parseInt(hex.slice(1), 16);
    return {
        r: (bigint >> 16) & 255,
        g: (bigint >> 8) & 255,
        b: bigint & 255,
    };
}

// RGB to HSL 顏色轉換
function rgbToHsl(r: number, g: number, b: number): { h: number; s: number; l: number } {
    r /= 255;
    g /= 255;
    b /= 255;

    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    const delta = max - min;

    let h = 0;
    let s = 0;
    const l = (max + min) / 2;

    if (delta !== 0) {
        s = delta / (1 - Math.abs(2 * l - 1));
        switch (max) {
            case r:
                h = ((g - b) / delta + (g < b ? 6 : 0)) % 6;
                break;
            case g:
                h = (b - r) / delta + 2;
                break;
            case b:
                h = (r - g) / delta + 4;
                break;
        }
        h *= 60;
    }

    return { h, s: s * 100, l: l * 100 };
}

// HSL to HEX 顏色轉換
function hslToHex(h: number, s: number, l: number): string {
    s /= 100;
    l /= 100;

    const c = (1 - Math.abs(2 * l - 1)) * s;
    const x = c * (1 - Math.abs((h / 60) % 2 - 1));
    const m = l - c / 2;

    let r = 0,
        g = 0,
        b = 0;

    if (h >= 0 && h < 60) {
        r = c;
        g = x;
        b = 0;
    } else if (h >= 60 && h < 120) {
        r = x;
        g = c;
        b = 0;
    } else if (h >= 120 && h < 180) {
        r = 0;
        g = c;
        b = x;
    } else if (h >= 180 && h < 240) {
        r = 0;
        g = x;
        b = c;
    } else if (h >= 240 && h < 300) {
        r = x;
        g = 0;
        b = c;
    } else if (h >= 300 && h < 360) {
        r = c;
        g = 0;
        b = x;
    }

    r = Math.round((r + m) * 255);
    g = Math.round((g + m) * 255);
    b = Math.round((b + m) * 255);

    return `#${((1 << 24) | (r << 16) | (g << 8) | b).toString(16).slice(1)}`;
}

// 調整顏色的函數 (從原色到黑色漸層)
function adjustColorToBlack(hex, shadeLevel) {
    const rgb = hexToRgb(hex);
    
    // 計算漸層比例 (shade1 = 0%, shade5 = 100%)
    const factor = (shadeLevel - 1) / 4;
    
    // 將顏色向黑色漸變
    return {
        r: Math.round(rgb.r * (1 - factor)),
        g: Math.round(rgb.g * (1 - factor)),
        b: Math.round(rgb.b * (1 - factor))
    };
}

// 初始化 shade 與 pill 顏色
function applyShadesToPills() {
    const pills = document.querySelectorAll('.pill') as NodeListOf<HTMLElement>;

    pills.forEach((pill) => {
        const baseColor = getComputedStyle(pill).backgroundColor;
        const shadeClass = [...pill.classList].find((cls) => cls.startsWith('shade'));
        if (shadeClass) {
            const shadeLevel = parseInt(shadeClass.replace('shade', ''), 10);
            const adjustedColor = adjustColorToBlack(rgbToHex(baseColor), shadeLevel);
            pill.style.backgroundColor = `rgb(${adjustedColor.r}, ${adjustedColor.g}, ${adjustedColor.b})`;
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    applyShadesToPills();
});

// 將 RGB 顏色轉為 HEX 的輔助函數
function rgbToHex(rgb: string): string {
    const match = rgb.match(/\d+/g);
    if (!match) throw new Error('Invalid RGB color');
    const [r, g, b] = match.map(Number);
    return (
        '#' +
        ((1 << 24) + (r << 16) + (g << 8) + b)
            .toString(16)
            .slice(1)
            .toUpperCase()
    );
}

// LeetCode API Integration
async function fetchLeetCodeStats() {
    const username = 'Vinskao';
    try {
        const response = await fetch(`https://leetcode-stats-api.herokuapp.com/${username}`);
        const data = await response.json();
        
        // Update the stats in the DOM with null checks
        const totalSolved = document.getElementById('total-solved');
        const easySolved = document.getElementById('easy-solved');
        const mediumSolved = document.getElementById('medium-solved');
        const hardSolved = document.getElementById('hard-solved');
        
        const totalProgress = document.getElementById('total-progress');
        const easyProgress = document.getElementById('easy-progress');
        const mediumProgress = document.getElementById('medium-progress');
        const hardProgress = document.getElementById('hard-progress');
        
        if (totalSolved) totalSolved.textContent = data.totalSolved;
        if (easySolved) easySolved.textContent = data.easySolved;
        if (mediumSolved) mediumSolved.textContent = data.mediumSolved;
        if (hardSolved) hardSolved.textContent = data.hardSolved;
        
        // Update progress bars
        if (totalProgress) totalProgress.style.width = `${(data.totalSolved / 2000) * 100}%`;
        if (easyProgress) easyProgress.style.width = `${(data.easySolved / 1000) * 100}%`;
        if (mediumProgress) mediumProgress.style.width = `${(data.mediumSolved / 800) * 100}%`;
        if (hardProgress) hardProgress.style.width = `${(data.hardSolved / 200) * 100}%`;
        
        // Add some animation
        const cards = document.querySelectorAll('.leetcode-card');
        cards.forEach((card, index) => {
            const element = card as HTMLElement;
            element.style.opacity = '0';
            element.style.transform = 'translateY(20px)';
            setTimeout(() => {
                element.style.transition = 'all 0.5s ease';
                element.style.opacity = '1';
                element.style.transform = 'translateY(0)';
            }, index * 200);
        });
    } catch (error) {
        console.error('Error fetching LeetCode stats:', error);
        const leetcodeStats = document.getElementById('leetcode-stats');
        if (leetcodeStats) {
            leetcodeStats.innerHTML = '<p style="text-align: center; color: var(--gray-300);">Failed to load LeetCode stats</p>';
        }
    }
}

// Call the function when the page loads
document.addEventListener('DOMContentLoaded', () => {
    fetchLeetCodeStats();
    // ... existing code ...
});
</script>