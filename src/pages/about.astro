---
import BaseLayout from "../layouts/BaseLayout.astro";

import ContactCTA from "../components/ContactCTA.astro";
import Hero from "../components/Hero.astro";
import ResumePreview from "../components/ResumePreview.astro";
import Briefing from "../components/Briefing.astro";
import '../styles/about.css';

// Import the JSON data
import aboutData from '../storages/about.json';
import skillsData from '../storages/skills.json';

type LangKey = 'en' | 'zh';
type LangText = { en: string[]; zh: string[] };
interface ExperienceItem {
  title: string;
  company: string;
  period: string;
  projectExperience?: LangText;
  responsibilities?: LangText;
}

const lang = (Astro.url.searchParams.get('lang') ?? 'en') as LangKey;
const experienceData = aboutData.experience as unknown as ExperienceItem[];

// Function to highlight dates in project descriptions
function highlightDates(text: string): string {
  const dateRegex = /(\d{4}\/\d{1,2}(?:\s*~\s*(?:\d{4}\/\d{1,2}|Present))?)/g;
  return text.replace(dateRegex, '<span class="date-highlight">$1</span>');
}

function parseProject(project: string, lang: LangKey): {
  head: string;
  bullets: string[];
  dataModuleName?: string;
  dataModuleDetails: string[];
} {
  const isZh = lang === 'zh';
  const respMarker = isZh ? '；主要負責：' : ' — Responsibilities:';
  const dmMarker = isZh ? '；資料模組：' : ' — Data Module:';

  const respIdx = project.indexOf(respMarker);
  if (respIdx === -1) {
    return { head: project, bullets: [], dataModuleDetails: [] };
  }

  const head = project.substring(0, respIdx).trim();
  const rest = project.substring(respIdx + respMarker.length).trim();

  let dataModule: string | undefined;
  let respPart = rest;
  const dmIdx = rest.indexOf(dmMarker);
  if (dmIdx !== -1) {
    respPart = rest.substring(0, dmIdx).trim();
    dataModule = rest.substring(dmIdx + dmMarker.length).trim();
  }

  const bullets = (isZh
    ? respPart.split(/；+/)
    : respPart.split(/\s*,\s*/))
    .map((s) => s.trim())
    .filter((s) => s.length > 0);

  let dataModuleName: string | undefined;
  let dataModuleDetails: string[] = [];
  if (dataModule) {
    // Extract name and details inside parentheses (both half/full width)
    const openIdx = dataModule.indexOf('(') !== -1 ? dataModule.indexOf('(') : dataModule.indexOf('（');
    const closeIdx = dataModule.lastIndexOf(')') !== -1 ? dataModule.lastIndexOf(')') : dataModule.lastIndexOf('）');
    if (openIdx !== -1 && closeIdx !== -1 && closeIdx > openIdx) {
      dataModuleName = dataModule.substring(0, openIdx).trim();
      const inner = dataModule.substring(openIdx + 1, closeIdx).trim();
      dataModuleDetails = (isZh ? inner.split(/；+/) : inner.split(/\s*,\s*/))
        .map((s) => s.trim())
        .filter((s) => s.length > 0);
    } else {
      dataModuleName = dataModule.trim();
    }
  }

  return { head, bullets, dataModuleName, dataModuleDetails };
}

---

<BaseLayout title="About | Tianyi Kao" description="About Tianyi Kao">
    <div class="stack gap-20">
      <main class="wrapper about">
        <div class="lang-toggle" style="text-align:right;margin-bottom:1rem;">
          <a id="langEnLink" href="?lang=en" class={lang === 'en' ? 'active' : ''}>EN</a> |
          <a id="langZhLink" href="?lang=zh" class={lang === 'zh' ? 'active' : ''}>中文</a>
        </div>
        <div class="hero-section">
          <Hero
            title="About"
            tagline="KTY's Journey"
          >

          </Hero>
          <div class="work-photo-wrapper" style="position:relative; width:100%;">
            <!-- Mask overlay with slogan -->
            <div class="work-photo-overlay" aria-hidden="true">
              <div class="mask-text">To Make a Difference.</div>
            </div>
            <img
              width="1553"
              height="873"
              src="/tymultiverse/assets/zen-landscape.svg"
              alt="Zen landscape with mountains, clouds, and tai chi symbol representing contemplation and balance"
              class="work-photo"
            />
          </div>
        </div>

        <section>
          <h2 class="section-title">Background</h2>
          <div class="content background-content">
            <div class="name-section">
              <h1 class="majestic-name">{lang === 'zh' ? '高天逸' : 'KAO TIAN YI'}</h1>
              <p class="email">tianyikao@gmail.com</p>
            </div>
            <p set:html={aboutData.background[lang].replace(/\n/g, '<br>')}>
            </p>
          </div>
        </section>

        <!-- Briefing Section -->
        <Briefing />

        <section>
          <h2 class="section-title">Project Experience</h2>
          <div class="content">
            {experienceData.map((job) => (
              job.projectExperience && job.projectExperience[lang] && job.projectExperience[lang].length > 0 && (
                <div class="experience-item">
                  <div class="job-header">
                    <h3>{job.title}</h3>
                    <div class="job-meta">
                      <span class="company">{job.company}</span>
                      <span class="period"><span class="date-highlight">{job.period}</span></span>
                    </div>
                  </div>
                  <div class="project-experience">
                    <ul>
                      {job.projectExperience[lang].map((project) => {
                        const parsed = parseProject(project, lang);
                        // highlight dates only in the head text
                        const dateHighlightedHead = highlightDates(parsed.head);
                        return (
                          <li>
                            <span set:html={dateHighlightedHead}></span>
                            {(parsed.bullets.length > 0 || parsed.dataModuleName || parsed.dataModuleDetails.length > 0) && (
                              <ul class="sub-bullets">
                                {parsed.bullets.map((b) => (
                                  <li>{b}</li>
                                ))}
                                {parsed.dataModuleName && (
                                  <li>
                                    {parsed.dataModuleName}
                                    {parsed.dataModuleDetails.length > 0 && (
                                      <ul class="sub-bullets">
                                        {parsed.dataModuleDetails.map((d) => (
                                          <li>{d}</li>
                                        ))}
                                      </ul>
                                    )}
                                  </li>
                                )}
                              </ul>
                            )}
                          </li>
                        );
                      })}
                    </ul>
                  </div>
                </div>
              )
            ))}
          </div>
        </section>
        
        <section>
          <h2 class="section-title">Education</h2>
          <div class="content education-container">
            {aboutData.education.map((item) => (
              <div class="education-item" id={item.institution === "iSpan" ? "iSpan" : ""}>
                <div class="education-header">
                  <h3>{item.institution}</h3>
                  <span class="education-period"><span class="date-highlight">{item.period}</span></span>
                </div>
                <ul>
                  {item.programs.map((program) => (
                    <li>{program}</li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        </section>

        <section>
          <h2 class="section-title">Tech Experience</h2>
          <div class="content">
            {experienceData
              .filter((job) => !["Macro Associate", "Fintech PM, MA Program", "Auditor"].includes(job.title))
              .map((job) => (
              <div class="experience-item">
                <div class="job-header">
                  <h3>{job.title}</h3>
                  <div class="job-meta">
                    <span class="company">{job.company}</span>
                    <span class="period">{job.period}</span>
                  </div>
                </div>
                
                {job.responsibilities && (job.responsibilities as any)[lang] && (job.responsibilities as any)[lang].length > 0 && (
                  <div class="responsibilities">
                    <ul>
                      {(job.responsibilities as any)[lang].map((responsibility: string) => (
                        <li>{responsibility}</li>
                      ))}
                    </ul>
                  </div>
                )}
                
                {job.title === "Open Source Backend Engineer" && (
                  <div class="skills-section">
                    {skillsData.categories.map((category) => (
                      <div class="skill-category">
                        <h5>{category.name}</h5>
                        {category.subcategories ? (
                          category.subcategories.map((subcategory) => (
                            <div class="skill-subcategory">
                              <h6>{subcategory.name}</h6>
                              <div class="skill-tags">
                                {subcategory.skills.map((skill) => {
                                  const gradeMap = {
                                    'shade1': 'S',
                                    'shade2': 'A', 
                                    'shade3': 'B',
                                    'shade4': 'C',
                                    'shade5': 'D'
                                  };
                                  return (
                                    <span class={`pill ${category.pillClass} ${skill.level} ${(skill as any).specialClass || ''}`} 
                                          data-tooltip={`Level: ${gradeMap[skill.level] || skill.level}`}>
                                      {skill.name}
                                    </span>
                                  );
                                })}
                              </div>
                              {(subcategory as any).description && (subcategory as any).description[lang] && (subcategory as any).description[lang].length > 0 && (
                                <ul class="skill-subdescription">
                                  {(subcategory as any).description[lang].map((desc: string, index: number) => (
                                    <li set:html={desc.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')}>
                                    </li>
                                  ))}
                                </ul>
                              )}
                              {subcategory.name === "Frameworks & Libraries" && (
                                <>
                                  {/* --- Updated Backend Architecture Diagrams --- */}
                                  <div class="mermaid-diagram margin-top">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          %% Application Layer
                                          class TYMBackendApplication {
                                              +@EnableWebSocket
                                              +@EnableRetry
                                              +@EnableAsync
                                              +@EnableScheduling
                                              +@EnableCaching
                                              +@EnableRedisHttpSession
                                              +@EnableWebSecurity
                                              +@EnableMethodSecurity
                                          }
                                          
                                          %% Security Layer
                                          class SecurityConfig {
                                              +@EnableWebSecurity
                                              +@EnableMethodSecurity
                                              +JWT Authentication
                                              +OAuth2 Resource Server
                                              +CORS Configuration
                                          }
                                          
                                          class KeycloakController {
                                              +OAuth2 Redirect
                                              +Token Exchange
                                              +User Info
                                              +Token Introspect
                                          }
                                          
                                          class Guardian {
                                              +User Management
                                              +Admin Operations
                                              +Token Validation
                                          }
                                          
                                          %% Configuration Layer
                                          class RedisConfig {
                                              +@EnableCaching
                                              +RedisConnectionFactory
                                              +RedisTemplate
                                              +TTL Management
                                              +damage-calculations
                                              +tymb:sessions
                                              +Distributed Lock
                                              +Lua Scripts
                                          }
                                          
                                          class PrimaryDataSourceConfig {
                                              +PrimaryHikariCP
                                              +HikariCP Connection Pool
                                              +Connection Management
                                              +Connection Timeout
                                              +Leak Detection
                                          }
                                          
                                          class PeopleDataSourceConfig {
                                              +PeopleHikariCP
                                              +HikariCP Connection Pool
                                              +Connection Management
                                              +Connection Timeout
                                              +Leak Detection
                                          }
                                          
                                          class SessionConfig {
                                              +@EnableRedisHttpSession
                                              +Redis Session Store
                                              +Session Timeout
                                              +Session Fixation
                                              +Session Security
                                              +Concurrent Session Control
                                          }
                                          
                                          %% Infrastructure Layer
                                          class Database {
                                              +PostgreSQL Primary
                                              +PostgreSQL People
                                              +Indexed Queries
                                              +Batch Operations
                                          }
                                          
                                          class Redis {
                                              +Cache Storage
                                              +Session Store
                                              +Distributed Lock
                                              +Concurrency Control
                                          }
                                          
                                          %% Layer Relationships
                                          TYMBackendApplication --> SecurityConfig
                                          TYMBackendApplication --> RedisConfig
                                          TYMBackendApplication --> PrimaryDataSourceConfig
                                          TYMBackendApplication --> PeopleDataSourceConfig
                                          TYMBackendApplication --> SessionConfig
                                          
                                          SecurityConfig --> KeycloakController
                                          SecurityConfig --> Guardian
                                          SecurityConfig --> SessionConfig
                                          
                                          SessionConfig --> RedisConfig
                                          RedisConfig --> Redis
                                          
                                          PrimaryDataSourceConfig --> Database
                                          PeopleDataSourceConfig --> Database`}
                                    </pre>
                                  </div>


                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class SecurityConfig {
                                              +@EnableWebSecurity
                                              +@EnableMethodSecurity
                                              +JWT Authentication
                                              +OAuth2 Resource Server
                                              +CORS Configuration
                                              +Stateless Keycloak Endpoints
                                          }
                                          
                                          class JWTValidation {
                                              +OAuth2ResourceServer
                                              +JwtDecoder
                                              +CustomJwtGrantedAuthoritiesConverter
                                              +Bearer Token Resolver
                                          }
                                          
                                          class Authorization {
                                              +ROLE_GUEST
                                              +ROLE_MANAGE_USERS
                                              +ROLE_ADMIN
                                              +ROLE_USER
                                              +permitAll() for /people/names
                                              +authenticated() for protected endpoints
                                          }
                                          
                                          class SessionManagement {
                                              +Redis Session Storage
                                              +Session Timeout
                                              +Session Fixation
                                              +@EnableRedisHttpSession
                                              +tymb:sessions namespace
                                          }
                                          
                                          class KeycloakController {
                                              +OAuth2 Redirect
                                              +Token Exchange
                                              +User Info
                                              +Token Introspect
                                              +Dynamic redirectUri
                                          }
                                          
                                          SecurityConfig --> JWTValidation
                                          SecurityConfig --> Authorization
                                          SecurityConfig --> SessionManagement
                                          SecurityConfig --> KeycloakController`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class GlobalExceptionHandler {
                                              +Chain of Responsibility
                                              +Error Response Builder
                                          }
                                          
                                          class BusinessApiExceptionHandler {
                                              +@Order(0)
                                              +BusinessException
                                          }
                                          
                                          class DataIntegrityApiExceptionHandler {
                                              +@Order(1)
                                              +DataIntegrityViolationException
                                          }
                                          
                                          class ValidationApiExceptionHandler {
                                              +@Order(2)
                                              +MethodArgumentNotValidException
                                          }
                                          
                                          class DefaultApiExceptionHandler {
                                              +@Order(Integer.MAX_VALUE)
                                              +Generic Exception
                                          }
                                          
                                          GlobalExceptionHandler --> BusinessApiExceptionHandler
                                          GlobalExceptionHandler --> DataIntegrityApiExceptionHandler
                                          GlobalExceptionHandler --> ValidationApiExceptionHandler
                                          GlobalExceptionHandler --> DefaultApiExceptionHandler`}
                                    </pre>
                                  </div>
                                </>
                              )}

                              {subcategory.name === "Platforms" && (
                                <div class="mermaid-diagram">
                                  <pre class="mermaid">
                                    flowchart LR
                                      user["User"] -->|SSH 22| bastion["Bastion (Public Subnet)"]

                                      subgraph OCI VCN
                                        direction LR

                                        subgraph Public["Public Subnets"]
                                          bastion
                                          pubLB["Public LB Subnet (OCI LB - Reserved IP)"]
                                        end

                                        subgraph Private["Private Subnets"]
                                          operator["Operator VM"]
                                          cp["OKE Control Plane (Private Endpoint)"]
                                          workers["Worker Nodes (NodePool size=2, A1.Flex 1c/8GB/50GB)"]
                                          intLB["Internal LB Subnet"]
                                        end

                                        subgraph Gateways["Network Gateways"]
                                          ig["Internet Gateway"]:::net
                                          nat["NAT Gateway"]:::net
                                          sg["Service Gateway"]:::net
                                        end

                                        pubRT["Public Route Table"]:::net --> ig
                                        privRT["Private Route Table"]:::net --> nat
                                        privRT --> sg

                                        bastion -.-> pubRT
                                        pubLB -.-> pubRT

                                        operator -.-> privRT
                                        workers -.-> privRT
                                        intLB -.-> privRT
                                      end

                                      bastion -->|SSH Proxy| operator
                                      operator -->|kubectl 6443| cp
                                      pubLB --> workers
                                      intLB --> workers

                                      classDef net fill:#eee,stroke:#999;
                                  </pre>
                                </div>
                              )}
                              {subcategory.name === "NoSQL" && (
                                <div class="mermaid-diagram">
                                  <pre class="mermaid">
                                    graph LR
    A[Backend<br/>Spring Boot<br/>REST Endpoints] --> B[RabbitMQ<br/>Message Queue]
    B --> C[Consumer<br/>Spring Boot<br/>JDBC Processing]
    C --> D[PostgreSQL<br/>Database]
    
    classDef producer fill:#e1f5fe
    classDef mq fill:#f3e5f5
    classDef consumer fill:#e8f5e8
    classDef database fill:#ffebee
    
    class A producer
    class B mq
    class C consumer
    class D database
                                  </pre>
                                </div>
                              )}
                              {subcategory.name === "Frameworks & APIs" && (
                                <>
                                  {/* --- AI Frameworks & APIs Architecture Diagrams --- */}
                                  <br />
                                  <a href="https://github.com/Vinskao/maya-sawa" target="_blank">Maya Sawa V1</a>
                                  <div class="mermaid-diagram margin-top">
                                    <pre class="mermaid">
                                      {`graph TD
    A["User Request</br>(/qa/query)"] --> B{FastAPI Router};
    B --> C["qa_chain.get_answer(query)"];
    C --> D{"Detect names in query"};
    
    %% Name Detection Branch
    D -- "Names found" --> E["Fetch character profiles</br>from DB"];
    E --> F{"Profile found?"};
    F -- "Yes" --> G["Create prompt with</br>character profile"];
    F -- "No" --> H["Respond 'not found'"];
    
    %% No Names Branch
    D -- "No names found" --> I{"Semantic search for people"};
    I -- "People found" --> J["Generate answer from</br>search results"];
    I -- "No one found" --> K["Similarity search</br>in Vector Store"];
    K --> L["Create prompt with</br>document context"];
    
    %% Unified Processing
    G --> M["Invoke LLM"];
    J --> M;
    L --> M;
    H --> N["Return final answer"];
    M --> N;
    N --> O["Save chat history"];
    O --> P["Return AI answer"];
    P --> B;`}
                                    </pre>
                                  </div>
                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`flowchart TD
    subgraph "API Layer"
        APIRouter["FastAPI Router<br/>(maya_sawa/api/qa.py)"]
    end

    subgraph "Q&A Layer"
        QAChain["QAChain"]
        PageAnalyzer["PageAnalyzer"]
    end

    subgraph "Support Layer"
        NameDetector["NameDetector"]
        ProfileManager["ProfileManager"]
        PeopleWeaponManager["PeopleWeaponManager"]
        PersonalityPromptBuilder["PersonalityPromptBuilder"]
        NameAdapter["NameAdapter"]
        VectorStore["PostgresVectorStore"]
        ChatHistoryManager["ChatHistoryManager"]
        ConfigManager["ConfigManager"]
        ConnectionPoolManager["ConnectionPoolManager"]
        Scheduler["ArticleSyncScheduler"]
    end

    subgraph "External Services"
        OpenAIAPI["OpenAI API<br/>Chat & Embeddings"]
        PeopleAPI["People System API<br/>/tymb/people/*"]
        ArticleAPI["Public Article API<br/>/paprika/articles"]
        PostgresDB["PostgreSQL"]
        RedisDB["Redis"]
    end

    Client["Client / Frontend"] --> APIRouter
    APIRouter --> QAChain
    APIRouter --> PageAnalyzer
    APIRouter --> VectorStore
    APIRouter --> ChatHistoryManager
    APIRouter --> Scheduler

    ChatHistoryManager --> RedisDB

    QAChain --> NameDetector
    QAChain --> ProfileManager
    QAChain --> PeopleWeaponManager
    QAChain --> PersonalityPromptBuilder
    QAChain --> NameAdapter
    QAChain --> VectorStore

    PageAnalyzer --> QAChain

    NameDetector --> OpenAIAPI
    QAChain --> OpenAIAPI

    ProfileManager --> PeopleAPI
    PeopleWeaponManager --> PeopleAPI

    VectorStore --> PostgresDB
    VectorStore --> ArticleAPI

    PeopleWeaponManager --> PostgresDB

    ConfigManager --> PostgresDB
    ConnectionPoolManager --> PostgresDB
    Scheduler --> ArticleAPI`}
                                    </pre>
                                  </div>
                                  <br />
                                  <a href="https://github.com/Vinskao/maya-sawa-v2" target="_blank">Maya Sawa V2</a>
                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`graph TD
  %% User and Entry
  U["User"] --> Q["ask-with-model API<br/>question"]
  Q --> P["Full-text Retrieval Pipeline"]

  %% Retrieval Process
  subgraph "Pipeline"
    P --> N["Normalize/Lowercase<br/>trim punctuation"]
    N --> E{"Compute Embedding?"}
    E -- Yes --> EM["OpenAI Embeddings<br/>(text-embedding-3-small) → qvec"]
    E -- No --> SKIP["Skip vector branch"]

    %% PostgreSQL Retrieval (Trigram & Vector)
    subgraph "PostgreSQL"
      direction LR
      PG1["Trigram Search<br/>content % :query<br/>similarity(content, :query) as text_sim"]:::trgm
      PG2["Vector Search<br/>1 - (embedding <=> :qvec) as vec_sim"]:::vec
      IDX1["GIN Index<br/>idx_articles_content_trgm<br/>(content gin_trgm_ops)"]:::idx
      IDX2["IVFFlat Index<br/>idx_articles_embedding_ivfcos<br/>(embedding vector_cosine_ops)"]:::idx
      EXT1["EXTENSION pg_trgm<br/>set_limit(:min_sim)"]:::ext
      EXT2["EXTENSION pgvector"]:::ext
    end

    EM --> PG2
    SKIP -.-> PG1
    N --> PG1
    PG1 --> MRG["Merge & Rank<br/>score = 0.6*text_sim + 0.4*vec_sim"]
    PG2 --> MRG
    MRG --> TOPK["Top-K Articles"]
  end

  %% Post-processing and Response
  TOPK --> CTX["Build Context from Articles<br/>(title + snippet)"]
  CTX --> AI["LLM Call (OpenAI/Gemini/Qwen/Mock)"]
  AI --> RESP["Answer + Citations/No Knowledge Notice"]
  RESP --> RDS["Redis ChatHistory<br/>chat:session:{sid}"]
  RESP --> OUT["API Response"]

  %% Database Table and Indexes
  subgraph "articles schema"
    TBL["articles<br/>- id BIGSERIAL PK<br/>- file_path VARCHAR(500) UNIQUE<br/>- content TEXT NOT NULL<br/>- file_date TIMESTAMP NOT NULL<br/>- embedding vector"]:::tbl
  end
  TBL -. indexed by .-> IDX1
  TBL -. indexed by .-> IDX2

  %% Styles
  classDef trgm fill:#e3f2fd,stroke:#1e88e5,stroke-width:1px
  classDef vec fill:#fce4ec,stroke:#d81b60,stroke-width:1px
  classDef idx fill:#fff3e0,stroke:#fb8c00,stroke-width:1px
  classDef ext fill:#ede7f6,stroke:#5e35b1,stroke-width:1px
  classDef tbl fill:#f1f8e9,stroke:#43a047,stroke-width:1px`}
                                    </pre>
                                  </div>

                                                                     <div class="mermaid-diagram">
                                     <pre class="mermaid">
                                       {`graph TB
    subgraph "Frontend Layer"
        A[User Interface] --> B[API Client]
    end

    subgraph "API Layer"
        B --> A1[ask-with-model<br/>Async Processing]
        B --> A2[task-status<br/>Task Status Query]
        B --> A3[available-models<br/>Available Models List]
        B --> A4[add-model<br/>Add Model]
        B --> A5[chat-history<br/>Chat History]
        B --> A6[legacy-chat-history<br/>Legacy Chat History]
        B --> A7[healthz<br/>Health Check]
    end

    subgraph "Processing Layer"
        P1[Async Processing<br/>Celery Task]
        P2[Task Status Management<br/>Redis/Celery]
    end

    subgraph "Agent Service Layer"
        AS[MayaAgentService<br/>Unified Service Entry]
    end

    subgraph "Workflow Layer"
        WF[MayaAgentWorkflow<br/>Graphical Workflow]
        N1[Intent Classification Node<br/>FilterChain]
        N2[Knowledge Retrieval Node<br/>KMSourceManager]
        N3[Tool Selection Node<br/>Smart Tool Selection]
        N4[Tool Execution Node<br/>PDF/OCR/Calculation/Search]
        N5[AI Response Generation Node<br/>LLM Call]
        N6[Result Saving Node<br/>Data Persistence]
        N7[Error Handling Node<br/>Exception Handling]
    end

    subgraph "Capability Support Layer"
        LLM[LLM Capability<br/>OpenAI/Gemini/Qwen]
        TOOLS[Tool Capability<br/>PDF/OCR/Calculation/Search]
        MEMORY[Memory Capability<br/>Redis/Vector Memory]
        RAG[RAG Capability<br/>pgvector/Hybrid Retrieval]
    end

    subgraph "Data Layer"
        D1[(PostgreSQL<br/>Conversations/Articles)]
        D2[(Redis<br/>Cache/Memory/Celery)]
        D3[(RabbitMQ<br/>Celery Broker)]
    end

    subgraph "External Systems"
        E1[Paprika API<br/>Knowledge Base Content]
        E2[OpenAI API<br/>GPT-4o/GPT-4.1]
        E3[Google Gemini API<br/>Gemini Pro/Flash]
        E4[Qwen API<br/>Qwen Turbo/Plus]
    end

    %% API to Processing Layer
    A1 --> P1
    A2 --> P2

    %% Processing Layer to Agent Service Layer
    P1 --> AS

    %% Agent Service Layer to Workflow Layer
    AS --> WF

    %% Workflow Node Connections
    WF --> N1
    WF --> N2
    WF --> N3
    WF --> N4
    WF --> N5
    WF --> N6
    WF --> N7

    %% Workflow Nodes to Capability Layer
    N1 --> LLM
    N2 --> RAG
    N3 --> TOOLS
    N4 --> TOOLS
    N5 --> LLM
    N6 --> MEMORY

    %% Capability Layer to Data Layer
    LLM --> D1
    TOOLS --> D1
    MEMORY --> D2
    RAG --> D1

    %% Celery Tasks to Data Layer
    P1 --> D3
    P2 --> D2

    %% External System Connections
    LLM --> E2
    LLM --> E3
    LLM --> E4
    RAG --> E1

    %% Style Definitions
    classDef api fill:#e8f5e8,stroke:#4caf50,stroke-width:3px,color:#000000
    classDef process fill:#fff8e1,stroke:#ffa000,stroke-width:3px,color:#000000
    classDef agent fill:#e3f2fd,stroke:#2196f3,stroke-width:3px,color:#000000
    classDef workflow fill:#fff3e0,stroke:#ff9800,stroke-width:3px,color:#000000
    classDef capability fill:#fce4ec,stroke:#e91e63,stroke-width:3px,color:#000000
    classDef data fill:#f1f8e9,stroke:#43a047,stroke-width:3px,color:#000000
    classDef external fill:#f3e5f5,stroke:#9c27b0,stroke-width:3px,color:#000000

    class A1,A2,A3,A4,A5,A6,A7 api
    class P1,P2 process
    class AS agent
    class WF,N1,N2,N3,N4,N5,N6,N7 workflow
    class LLM,TOOLS,MEMORY,RAG capability
    class D1,D2,D3 data
    class E1,E2,E3,E4 external`}
                                     </pre>
                                   </div>

                                   <div class="mermaid-diagram">
                                     <pre class="mermaid">
                                       {`sequenceDiagram
    participant U as User
    participant F as Frontend
    participant A as API
    participant C as Celery Worker
    participant DB as Database

    U->>F: Send Question
    F->>A: POST /maya-v2/ask-with-model/
    A->>DB: Create Task Record
    A->>C: Send Processing Task
    A-->>F: Return task_id
    F-->>U: Show Processing

    loop Poll Status
        F->>A: GET /maya-v2/task-status/{task_id}
        A->>C: Query Task Status
        C-->>A: Return Status

        alt Task Complete
            A-->>F: Return AI Response
            F-->>U: Display Result
        else Processing
            F-->>U: Show Processing
        end
    end`}
                                     </pre>
                                   </div>
                                </>
                              )}
                            </div>
                          ))
                        ) : (
                          <div class="skill-tags">
                            {category.skills.map((skill) => {
                              const gradeMap = {
                                'shade1': 'S',
                                'shade2': 'A', 
                                'shade3': 'B',
                                'shade4': 'C',
                                'shade5': 'D'
                              };
                              return (
                                <span class={`pill ${category.pillClass} ${skill.level} ${(skill as any).specialClass || ''}`} 
                                      data-tooltip={`Level: ${gradeMap[skill.level] || skill.level}`}>
                                  {skill.name}
                                </span>
                              );
                            })}
                          </div>
                        )}
                        {(category as any).description && (category as any).description[lang] && (category as any).description[lang].length > 0 && (
                          <ul class="skill-description">
                            {(category as any).description[lang].map((desc: string, index: number) => (
                              <li set:html={desc.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')}>
                              </li>
                            ))}
                          </ul>
                        )}
                        
                        {category.name === "CI/CD" && (
                          <div class="mermaid-diagram">
                            <pre class="mermaid">
                              graph LR
                                  A[GitHub Repository] --> B[Clone and Setup]
                                  B --> C[Build with Node.js]
                                  C --> D[Build Docker Image with BuildKit]
                                  D --> E[Push to Docker Hub]
                                  E --> F[Deploy to Kubernetes]
                            </pre>
                          </div>
                        )}
                        
                        {category.name === "Security & Authentication" && (
                          <div class="mermaid-diagram">
                            <pre class="mermaid">
                              sequenceDiagram
                                  participant User as User
                                  participant App as Application
                                  participant Auth as Authorization Server
                                  participant API as Resource Server
                                  
                                  User->>App: 1. Access Application
                                  App->>Auth: 2. Redirect to Authorization Page
                                  User->>Auth: 3. Login and Authorize
                                  Auth->>App: 4. Return Authorization Code
                                  App->>Auth: 5. Exchange Code for Token
                                  Auth->>App: 6. Return Access Token
                                  App->>API: 7. Access Resources with Token
                                  API->>App: 8. Return Protected Resources
                            </pre>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        </section>
      </main>
    <!-- Global language manager -->
    <script src="/tymultiverse/scripts/lang.js" is:inline></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Initialize from global AppLang if available
        try {
          // Wait for AppLang to be available (since it's loaded asynchronously)
          const initLanguage = () => {
            if (!(window as any).AppLang) {
              setTimeout(initLanguage, 50); // Retry after 50ms
              return;
            }

            const current = (window as any).AppLang.get();
            const urlParam = new URLSearchParams(window.location.search).get('lang');
            const normalizedUrl = urlParam && urlParam.toLowerCase().startsWith('zh') ? 'zh' : (urlParam ? 'en' : null);

            // If URL param exists but differs from global state, update global to match URL
            if (normalizedUrl && normalizedUrl !== current) {
              (window as any).AppLang.set(normalizedUrl);
            } else if (!urlParam) {
              // No URL param → add it to match global state
              const target = current === 'zh' ? '?lang=zh' : '?lang=en';
              window.history.replaceState({}, '', target);
            }

            // Update toggle active state
            document.getElementById('langEnLink')?.classList.toggle('active', current === 'en');
            document.getElementById('langZhLink')?.classList.toggle('active', current === 'zh');
          };

          initLanguage();

          // Click handlers to set global language, keep UI same
          const en = document.getElementById('langEnLink');
          const zh = document.getElementById('langZhLink');
          en && en.addEventListener('click', (e) => {
            e.preventDefault();
            (window as any).AppLang && (window as any).AppLang.set('en');
            const url = new URL(window.location.href);
            url.searchParams.set('lang', 'en');
            window.location.href = url.toString();
          });
          zh && zh.addEventListener('click', (e) => {
            e.preventDefault();
            (window as any).AppLang && (window as any).AppLang.set('zh');
            const url = new URL(window.location.href);
            url.searchParams.set('lang', 'zh');
            window.location.href = url.toString();
          });

          // React to language changes from other pages/components
          (window as any).AppLang && (window as any).AppLang.onChange(({ code }) => {
            const url = new URL(window.location.href);
            url.searchParams.set('lang', code);
            // Use replaceState to avoid adding to history stack and prevent loops
            window.history.replaceState({}, '', url.toString());

            // Update toggle active state without causing re-render
            document.getElementById('langEnLink')?.classList.toggle('active', code === 'en');
            document.getElementById('langZhLink')?.classList.toggle('active', code === 'zh');
          });
        } catch (_) {}
      });
    </script>

      <ResumePreview />
      <ContactCTA />
    </div>
    
    <!-- Mermaid.js for on-page diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const mermaidLib = window['mermaid'];
        if (mermaidLib) {
          // 根據當前主題設定 Mermaid 主題
          const isDarkMode = document.documentElement.classList.contains('theme-dark');
          mermaidLib.initialize({
            startOnLoad: true,
            theme: isDarkMode ? 'dark' : 'default',
            themeVariables: isDarkMode ? {
              background: '#2a2a2a',
              primaryColor: '#00d4ff',
              primaryTextColor: '#ffffff',
              primaryBorderColor: '#00d4ff',
              lineColor: '#cccccc',
              secondaryColor: '#ff6b6b',
              tertiaryColor: '#4ecdc4',
              textColor: '#ffffff',
              mainBkg: '#333333',
              secondBkg: '#444444',
              border1: '#666666',
              border2: '#888888'
            } : {
              background: '#ffffff',
              primaryColor: '#1f5bff',
              primaryTextColor: '#0b1a33',
              primaryBorderColor: '#1f5bff',
              lineColor: '#2e3a59',
              secondaryColor: '#ff3b30',
              tertiaryColor: '#00b894',
              textColor: '#0b1a33',
              mainBkg: '#f7f9fc',
              secondBkg: '#eef3fb',
              border1: '#cfd8ea',
              border2: '#b7c4df'
            }
          });
        }

        // 監聽主題變化，重新初始化 Mermaid
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              const isDarkMode = document.documentElement.classList.contains('theme-dark');
              if (mermaidLib) {
                mermaidLib.initialize({
                  startOnLoad: true,
                  theme: isDarkMode ? 'dark' : 'default',
                  themeVariables: isDarkMode ? {
                    background: '#2a2a2a',
                    primaryColor: '#00d4ff',
                    primaryTextColor: '#ffffff',
                    primaryBorderColor: '#00d4ff',
                    lineColor: '#cccccc',
                    secondaryColor: '#ff6b6b',
                    tertiaryColor: '#4ecdc4',
                    textColor: '#ffffff',
                    mainBkg: '#333333',
                    secondBkg: '#444444',
                    border1: '#666666',
                    border2: '#888888'
                  } : {
                    background: '#ffffff',
                    primaryColor: '#1f5bff',
                    primaryTextColor: '#0b1a33',
                    primaryBorderColor: '#1f5bff',
                    lineColor: '#2e3a59',
                    secondaryColor: '#ff3b30',
                    tertiaryColor: '#00b894',
                    textColor: '#0b1a33',
                    mainBkg: '#f7f9fc',
                    secondBkg: '#eef3fb',
                    border1: '#cfd8ea',
                    border2: '#b7c4df'
                  }
                });
                // 重新渲染所有圖表
                mermaidLib.init();
              }
            }
          });
        });

        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['class']
        });

        // Work photo hover to show briefing
        // Overlay handled purely by CSS hover on wrapper to avoid flicker
      });
    </script>

    <!-- Styles for export button live in ResumePreview component -->
