---
import BaseLayout from "../layouts/BaseLayout.astro";

import ContactCTA from "../components/ContactCTA.astro";
import Hero from "../components/Hero.astro";
import ResumePreview from "../components/ResumePreview.astro";
import '../styles/about.css';

// Import the JSON data
import aboutData from '../storages/about.json';
import skillsData from '../storages/skills.json';

const lang = Astro.url.searchParams.get('lang') ?? 'en';

---

<meta charset="UTF-8" />

<body>
  <BaseLayout title="About | Tianyi Kao" description="About Tianyi Kao">
    <div class="stack gap-20">
      <main class="wrapper about">
        <div class="lang-toggle" style="text-align:right;margin-bottom:1rem;">
          <a href="?lang=en" class={lang === 'en' ? 'active' : ''}>EN</a> |
          <a href="?lang=zh" class={lang === 'zh' ? 'active' : ''}>中文</a>
        </div>
        <div class="hero-section">
          <Hero
            title="About"
            tagline="Memories"
          >

          </Hero>
          <img
            width="1553"
            height="873"
            src="/tymultiverse/assets/at-work.jpg"
            alt="Tianyi Kao at work with a colleague"
            class="work-photo"
          />
        </div>

        <section>
          <h2 class="section-title">Background</h2>
          <div class="content background-content">
            <div class="name-section">
              <h1 class="majestic-name">KAO TIAN YI</h1>
              <p class="email">tianyikao@gmail.com</p>
            </div>
            <p set:html={aboutData.background[lang].replace(/\n/g, '<br>')}>
            </p>
          </div>
        </section>
        
        <section>
          <h2 class="section-title">Education</h2>
          <div class="content education-container">
            {aboutData.education.map((item) => (
              <div class="education-item" id={item.institution === "iSpan" ? "iSpan" : ""}>
                <div class="education-header">
                  <h3>{item.institution}</h3>
                  <span class="education-period">{item.period}</span>
                </div>
                <ul>
                  {item.programs.map((program) => (
                    <li>{program}</li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        </section>
        
        <section>
          <h2 class="section-title">Experience</h2>
          <div class="content">
            {aboutData.experience.map((job) => (
              <div class="experience-item">
                <div class="job-header">
                  <h3>{job.title}</h3>
                  <div class="job-meta">
                    <span class="company">{job.company}</span>
                    <span class="period">{job.period}</span>
                  </div>
                </div>
                
                {job.projectExperience && job.projectExperience[lang] && job.projectExperience[lang].length > 0 && (
                  <div class="project-experience">
                    <h4>Project Experience</h4>
                    <ul>
                      {job.projectExperience[lang].map((project) => (
                        <li>{project}</li>
                      ))}
                    </ul>
                  </div>
                )}
                
                {job.responsibilities && job.responsibilities[lang] && job.responsibilities[lang].length > 0 && (
                  <div class="responsibilities">
                    <ul>
                      {job.responsibilities[lang].map((responsibility) => (
                        <li>{responsibility}</li>
                      ))}
                    </ul>
                  </div>
                )}
                
                {job.title === "Open Source Backend Engineer" && (
                  <div class="skills-section">
                    {skillsData.categories.map((category) => (
                      <div class="skill-category">
                        <h5>{category.name}</h5>
                        {category.subcategories ? (
                          category.subcategories.map((subcategory) => (
                            <div class="skill-subcategory">
                              <h6>{subcategory.name}</h6>
                              <div class="skill-tags">
                                {subcategory.skills.map((skill) => {
                                  const gradeMap = {
                                    'shade1': 'S',
                                    'shade2': 'A', 
                                    'shade3': 'B',
                                    'shade4': 'C',
                                    'shade5': 'D'
                                  };
                                  return (
                                    <span class={`pill ${category.pillClass} ${skill.level} ${(skill as any).specialClass || ''}`} 
                                          data-tooltip={`Level: ${gradeMap[skill.level] || skill.level}`}>
                                      {skill.name}
                                    </span>
                                  );
                                })}
                              </div>
                              {(subcategory as any).description && (subcategory as any).description[lang] && (subcategory as any).description[lang].length > 0 && (
                                <ul class="skill-subdescription">
                                  {(subcategory as any).description[lang].map((desc: string, index: number) => (
                                    <li set:html={desc.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')}>
                                    </li>
                                  ))}
                                </ul>
                              )}
                              {subcategory.name === "Frameworks & Libraries" && (
                                <>
                                                                  <div class="mermaid-diagram margin-top">
                                  <pre class="mermaid">
                                    sequenceDiagram
                                          participant Client
                                          participant Controller
                                        participant Service
                                        participant Repository
                                          participant Exception
                                          participant GlobalExceptionHandler
                                          participant ErrorResponse
                                          participant Logger

                                          Client->>Controller: HTTP Request
                                          Controller->>Service: 調用服務方法
                                          Service->>Repository: 數據庫操作
                                          Repository-->>Service: 返回結果/異常
                                          alt 發生異常
                                              Service->>Exception: 拋出業務異常
                                              Exception-->>Controller: 異常傳播
                                              Controller->>GlobalExceptionHandler: 捕獲異常
                                              GlobalExceptionHandler->>Logger: 記錄異常
                                              GlobalExceptionHandler->>ErrorResponse: 創建錯誤響應
                                              GlobalExceptionHandler-->>Client: 返回錯誤響應
                                          else 正常流程
                                              Service-->>Controller: 返回結果
                                              Controller-->>Client: 返回成功響應
                                          end
                                    </pre>
                                  </div>
                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      flowchart TD
                                          subgraph "API Layer"
                                              APIRouter["FastAPI Router<br/>(maya_sawa/api/qa.py)"]
                                          end

                                          subgraph "Q&A Layer"
                                              QAEngine["QAEngine"]
                                              QAChain["QAChain"]
                                          end

                                          subgraph "Support Layer"
                                              NameDetector["NameDetector"]
                                              ProfileManager["ProfileManager"]
                                              PeopleWeaponManager["PeopleWeaponManager"]
                                              PersonalityPromptBuilder["PersonalityPromptBuilder"]
                                              NameAdapter["NameAdapter"]
                                              VectorStore["PostgresVectorStore"]
                                              ChatHistoryManager["ChatHistoryManager"]
                                          end

                                          subgraph "External Services"
                                              OpenAIAPI["OpenAI API<br/>Chat & Embeddings"]
                                              PeopleAPI["People System API<br/>/tymb/people/*"]
                                              ArticleAPI["Public Article API<br/>/paprika/articles"]
                                              PostgresDB["PostgreSQL"]
                                          end

                                          Client["Client / Frontend"] --> APIRouter
                                          APIRouter --> QAEngine
                                          QAEngine --> QAChain
                                          APIRouter --> VectorStore
                                          APIRouter --> ChatHistoryManager

                                          ChatHistoryManager --> PostgresDB

                                          QAChain --> NameDetector
                                          QAChain --> ProfileManager
                                          QAChain --> PeopleWeaponManager
                                          QAChain --> PersonalityPromptBuilder
                                          QAChain --> NameAdapter
                                          QAChain --> VectorStore

                                          NameDetector --> OpenAIAPI
                                          QAChain --> OpenAIAPI

                                          ProfileManager --> PeopleAPI
                                          PeopleWeaponManager --> PeopleAPI

                                          VectorStore --> PostgresDB
                                          VectorStore --> ArticleAPI

                                          PeopleWeaponManager --> PostgresDB
                                  </pre>
                                </div>
                                </>
                              )}
                              {subcategory.name === "Platforms" && (
                                <div class="mermaid-diagram">
                                  <pre class="mermaid">
                                    graph TB
                                        Internet[Internet]
                                        
                                        subgraph OCI_VCN_10_0_0_0_16["OCI VCN (10.0.0.0/16)"]
                                            subgraph Public_Subnet_10_0_0_0_24["Public Subnet (10.0.0.0/24)"]
                                                node1[node1\nControlPlane\n10.0.0.11\n+ Public IP]
                                                node2[node2\nWorker\n10.0.0.12\n+ Public IP]
                                                node3[node3\nWorker\n10.0.0.13\n+ Public IP]
                                                node4[node4\nWorker\n10.0.0.14\n+ Public IP]
                                            end

                                            IG[Internet Gateway]
                                            SL[Security List\nIngress: 0.0.0.0/0\nEgress: 0.0.0.0/0]
                                        end

                                        Internet --> IG
                                        IG --> SL
                                        SL --> node1
                                        SL --> node2
                                        SL --> node3
                                        SL --> node4
                                  </pre>
                                </div>
                              )}
                              {subcategory.name === "NoSQL" && (
                                <div class="mermaid-diagram">
                                  <pre class="mermaid">
                                    sequenceDiagram
                                        participant Frontend as Frontend
                                        participant Django as Django API
                                        participant Redis as Redis Queue
                                        participant Consumer as Consumer Service
                                        participant Mongo as MongoDB

                                        Frontend->>Django: 1. Call Push API
                                        Django->>Redis: 2. Push to Redis List
                                        Consumer->>Redis: 3. Pop from Redis List
                                        Consumer->>Mongo: 4. Update Increment in Document
                                        Frontend->>Django: 5. Call Count API
                                        Django->>Mongo: 6. Query Count from Document
                                        Mongo-->>Django: Return Count
                                        Django-->>Frontend: Return Count

                                        Note over Frontend,Mongo: Asynchronous Visit Count Processing
                                        Note over Redis,Consumer: Using Consumer YAML Configuration
                                  </pre>
                                </div>
                              )}
                            </div>
                          ))
                        ) : (
                          <div class="skill-tags">
                            {category.skills.map((skill) => {
                              const gradeMap = {
                                'shade1': 'S',
                                'shade2': 'A', 
                                'shade3': 'B',
                                'shade4': 'C',
                                'shade5': 'D'
                              };
                              return (
                                <span class={`pill ${category.pillClass} ${skill.level} ${(skill as any).specialClass || ''}`} 
                                      data-tooltip={`Level: ${gradeMap[skill.level] || skill.level}`}>
                                  {skill.name}
                                </span>
                              );
                            })}
                          </div>
                        )}
                        {(category as any).description && (category as any).description[lang] && (category as any).description[lang].length > 0 && (
                          <ul class="skill-description">
                            {(category as any).description[lang].map((desc: string, index: number) => (
                              <li set:html={desc.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')}>
                              </li>
                            ))}
                          </ul>
                        )}
                        
                        {category.name === "CI/CD" && (
                          <div class="mermaid-diagram">
                            <pre class="mermaid">
                              graph LR
                                  A[GitHub Repository] --> B[Clone and Setup]
                                  B --> C[Build with Node.js]
                                  C --> D[Build Docker Image with BuildKit]
                                  D --> E[Push to Docker Hub]
                                  E --> F[Deploy to Kubernetes]
                            </pre>
                          </div>
                        )}
                        
                        {category.name === "Security & Authentication" && (
                          <div class="mermaid-diagram">
                            <pre class="mermaid">
                              sequenceDiagram
                                  participant User as User
                                  participant App as Application
                                  participant Auth as Authorization Server
                                  participant API as Resource Server
                                  
                                  User->>App: 1. Access Application
                                  App->>Auth: 2. Redirect to Authorization Page
                                  User->>Auth: 3. Login and Authorize
                                  Auth->>App: 4. Return Authorization Code
                                  App->>Auth: 5. Exchange Code for Token
                                  Auth->>App: 6. Return Access Token
                                  App->>API: 7. Access Resources with Token
                                  API->>App: 8. Return Protected Resources
                            </pre>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        </section>
      </main>

      <ResumePreview />
      <ContactCTA />
    </div>
    
    <!-- Mermaid.js for on-page diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const mermaidLib = window['mermaid'];
        if (mermaidLib) {
          mermaidLib.initialize({ startOnLoad: true, theme: 'default' });
        }
      });
    </script>

    <!-- Styles for export button live in ResumePreview component -->
</body>