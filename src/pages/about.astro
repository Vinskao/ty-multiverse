---
import BaseLayout from "../layouts/BaseLayout.astro";

import ContactCTA from "../components/ContactCTA.astro";
import Hero from "../components/Hero.astro";
import ResumePreview from "../components/ResumePreview.astro";
import '../styles/about.css';

// Import the JSON data
import aboutData from '../storages/about.json';
import skillsData from '../storages/skills.json';

type LangKey = 'en' | 'zh';
type LangText = { en: string[]; zh: string[] };
interface ExperienceItem {
  title: string;
  company: string;
  period: string;
  projectExperience?: LangText;
  responsibilities?: LangText;
}

const lang = (Astro.url.searchParams.get('lang') ?? 'en') as LangKey;
const experienceData = aboutData.experience as unknown as ExperienceItem[];

---

<meta charset="UTF-8" />

<body>
  <BaseLayout title="About | Tianyi Kao" description="About Tianyi Kao">
    <div class="stack gap-20">
      <main class="wrapper about">
        <div class="lang-toggle" style="text-align:right;margin-bottom:1rem;">
          <a href="?lang=en" class={lang === 'en' ? 'active' : ''}>EN</a> |
          <a href="?lang=zh" class={lang === 'zh' ? 'active' : ''}>中文</a>
        </div>
        <div class="hero-section">
          <Hero
            title="About"
            tagline="Memories"
          >

          </Hero>
          <img
            width="1553"
            height="873"
            src="/tymultiverse/assets/at-work.jpg"
            alt="Tianyi Kao at work with a colleague"
            class="work-photo"
          />
        </div>

        <section>
          <h2 class="section-title">Background</h2>
          <div class="content background-content">
            <div class="name-section">
              <h1 class="majestic-name">KAO TIAN YI</h1>
              <p class="email">tianyikao@gmail.com</p>
            </div>
            <p set:html={aboutData.background[lang].replace(/\n/g, '<br>')}>
            </p>
          </div>
        </section>
        
        <section>
          <h2 class="section-title">Education</h2>
          <div class="content education-container">
            {aboutData.education.map((item) => (
              <div class="education-item" id={item.institution === "iSpan" ? "iSpan" : ""}>
                <div class="education-header">
                  <h3>{item.institution}</h3>
                  <span class="education-period">{item.period}</span>
                </div>
                <ul>
                  {item.programs.map((program) => (
                    <li>{program}</li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        </section>
        
        <section>
          <h2 class="section-title">Project Experience</h2>
          <div class="content">
            {experienceData.map((job) => (
              job.projectExperience && job.projectExperience[lang] && job.projectExperience[lang].length > 0 && (
                <div class="experience-item">
                  <div class="job-header">
                    <h3>{job.title}</h3>
                    <div class="job-meta">
                      <span class="company">{job.company}</span>
                      <span class="period">{job.period}</span>
                    </div>
                  </div>
                  <div class="project-experience">
                    <ul>
                      {job.projectExperience[lang].map((project) => (
                        <li>{project}</li>
                      ))}
                    </ul>
                  </div>
                </div>
              )
            ))}
          </div>
        </section>

        <section>
          <h2 class="section-title">Tech Experience</h2>
          <div class="content">
            {experienceData
              .filter((job) => !["Macro Associate", "Fintech PM, MA Program", "Auditor"].includes(job.title))
              .map((job) => (
              <div class="experience-item">
                <div class="job-header">
                  <h3>{job.title}</h3>
                  <div class="job-meta">
                    <span class="company">{job.company}</span>
                    <span class="period">{job.period}</span>
                  </div>
                </div>
                
                {job.responsibilities && (job.responsibilities as any)[lang] && (job.responsibilities as any)[lang].length > 0 && (
                  <div class="responsibilities">
                    <ul>
                      {(job.responsibilities as any)[lang].map((responsibility: string) => (
                        <li>{responsibility}</li>
                      ))}
                    </ul>
                  </div>
                )}
                
                {job.title === "Open Source Backend Engineer" && (
                  <div class="skills-section">
                    {skillsData.categories.map((category) => (
                      <div class="skill-category">
                        <h5>{category.name}</h5>
                        {category.subcategories ? (
                          category.subcategories.map((subcategory) => (
                            <div class="skill-subcategory">
                              <h6>{subcategory.name}</h6>
                              <div class="skill-tags">
                                {subcategory.skills.map((skill) => {
                                  const gradeMap = {
                                    'shade1': 'S',
                                    'shade2': 'A', 
                                    'shade3': 'B',
                                    'shade4': 'C',
                                    'shade5': 'D'
                                  };
                                  return (
                                    <span class={`pill ${category.pillClass} ${skill.level} ${(skill as any).specialClass || ''}`} 
                                          data-tooltip={`Level: ${gradeMap[skill.level] || skill.level}`}>
                                      {skill.name}
                                    </span>
                                  );
                                })}
                              </div>
                              {(subcategory as any).description && (subcategory as any).description[lang] && (subcategory as any).description[lang].length > 0 && (
                                <ul class="skill-subdescription">
                                  {(subcategory as any).description[lang].map((desc: string, index: number) => (
                                    <li set:html={desc.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')}>
                                    </li>
                                  ))}
                                </ul>
                              )}
                              {subcategory.name === "Frameworks & Libraries" && (
                                <>
                                  {/* --- Updated Backend Architecture Diagrams --- */}
                                  <div class="mermaid-diagram margin-top">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class SpringBootApplication {
                                              +@SpringBootApplication
                                              +@EnableCaching
                                              +@EnableJpaRepositories
                                          }
                                          
                                          class HikariCP {
                                              +PrimaryHikariCP (50 connections)
                                              +PeopleHikariCP (15 connections)
                                              +Connection Pool Management
                                          }
                                          
                                          class RedisCache {
                                              +@Cacheable
                                              +damage-calculations
                                              +Session Storage
                                              +Distributed Lock
                                          }
                                          
                                          class Database {
                                              +PostgreSQL Primary
                                              +PostgreSQL People
                                              +Indexed Queries
                                              +Batch Operations
                                          }
                                          
                                          SpringBootApplication --> HikariCP
                                          SpringBootApplication --> RedisCache
                                          HikariCP --> Database
                                          RedisCache --> Database`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class PeopleModule {
                                              +PeopleController
                                              +PeopleService
                                              +WeaponDamageService
                                              +PeopleRepository
                                              +People.java
                                          }
                                          
                                          class WeaponModule {
                                              +WeaponController
                                              +WeaponService
                                              +WeaponRepository
                                              +Weapon.java
                                          }
                                          
                                          class GalleryModule {
                                              +GalleryController
                                              +GalleryService
                                              +GalleryRepository
                                              +Gallery.java
                                          }
                                          
                                          class LivestockModule {
                                              +LivestockController
                                              +LivestockService
                                              +LivestockRepository
                                              +Livestock.java
                                          }
                                          
                                          class CKEditorModule {
                                              +FileUploadController
                                              +EditContentService
                                              +EditContentRepository
                                              +EditContentVO.java
                                          }
                                          
                                          PeopleModule --> WeaponModule
                                          PeopleModule --> GalleryModule
                                          PeopleModule --> LivestockModule
                                          PeopleModule --> CKEditorModule`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class CacheStrategy {
                                              +@Cacheable
                                              +Redis Storage
                                              +TTL Management
                                              +Cache Eviction
                                          }
                                          
                                          class DamageCache {
                                              +damage-calculations::name
                                              +Weapon Damage Results
                                              +People Attributes
                                          }
                                          
                                          class SessionCache {
                                              +tymb:sessions
                                              +CKEditor Drafts
                                              +Game States
                                          }
                                          
                                          class DistributedLock {
                                              +lock:content:save
                                              +lock:metrics:export
                                              +lock:livestock:query
                                          }
                                          
                                          CacheStrategy --> DamageCache
                                          CacheStrategy --> SessionCache
                                          CacheStrategy --> DistributedLock`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class RedisCommands {
                                              +String Commands
                                              +Hash Commands
                                              +Script Commands
                                              +Key Commands
                                          }
                                          
                                          class StringCommands {
                                              +SET (快取存儲)
                                              +GET (快取讀取)
                                              +SETNX (分布式鎖)
                                              +EXPIRE (過期時間)
                                          }
                                          
                                          class HashCommands {
                                              +HSET (Session 存儲)
                                              +HGET (Session 讀取)
                                              +HDEL (Session 刪除)
                                              +HGETALL (完整讀取)
                                          }
                                          
                                          class ScriptCommands {
                                              +EVAL (Lua 腳本)
                                              +GET (腳本內)
                                              +DEL (腳本內)
                                          }
                                          
                                          class KeyCommands {
                                              +EXISTS (鍵檢查)
                                              +TTL (剩餘時間)
                                          }
                                          
                                          RedisCommands --> StringCommands
                                          RedisCommands --> HashCommands
                                          RedisCommands --> ScriptCommands
                                          RedisCommands --> KeyCommands`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`sequenceDiagram
                                          participant App as 應用層
                                          participant Redis as Redis 伺服器
                                          participant Lua as Lua 腳本引擎
                                          
                                          App->>Redis: 執行 Lua 腳本
                                          Note over Redis: 分布式鎖釋放腳本
                                          Redis->>Lua: 載入腳本
                                          Lua->>Redis: redis.call('get', KEYS[1])
                                          Redis-->>Lua: 返回鎖值
                                          Lua->>Lua: 比較鎖值
                                          alt 鎖值匹配
                                              Lua->>Redis: redis.call('del', KEYS[1])
                                              Redis-->>Lua: 刪除成功
                                              Lua-->>App: 返回 1
                                          else 鎖值不匹配
                                              Lua-->>App: 返回 0
                                          end`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`graph TB
                                          subgraph "String 類型"
                                              A[分布式鎖] --> A1[SETNX lock:key value]
                                              A --> A2[GET lock:key]
                                              A --> A3[DEL lock:key]
                                              B[快取機制] --> B1[SET cache:key value]
                                              B --> B2[GET cache:key]
                                              B --> B3[EXPIRE cache:key time]
                                          end
                                          
                                          subgraph "Hash 類型"
                                              C[Session 存儲] --> C1[HSET session:id field value]
                                              C --> C2[HGET session:id field]
                                              C --> C3[HDEL session:id field]
                                              C --> C4[HGETALL session:id]
                                          end
                                          
                                          subgraph "腳本執行"
                                              D[Lua 腳本] --> D1[EVAL script keys args]
                                              D --> D2[原子性操作]
                                              D --> D3[複雜邏輯處理]
                                          end`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class HikariCPConfig {
                                              +PrimaryHikariCP
                                              +PeopleHikariCP
                                              +Connection Management
                                          }
                                          
                                          class PrimaryPool {
                                              +maximum-pool-size: 50
                                              +minimum-idle: 10
                                              +connection-timeout: 30s
                                              +leak-detection-threshold: 60s
                                          }
                                          
                                          class PeoplePool {
                                              +maximum-pool-size: 15
                                              +minimum-idle: 5
                                              +connection-timeout: 30s
                                              +leak-detection-threshold: 60s
                                          }
                                          
                                          class PoolMonitoring {
                                              +ActiveConnections
                                              +IdleConnections
                                              +WaitingThreads
                                              +ConnectionTimeout
                                          }
                                          
                                          HikariCPConfig --> PrimaryPool
                                          HikariCPConfig --> PeoplePool
                                          HikariCPConfig --> PoolMonitoring`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class SecurityConfig {
                                              +@EnableWebSecurity
                                              +@EnableMethodSecurity
                                              +JWT Authentication
                                              +Session Management
                                          }
                                          
                                          class JWTValidation {
                                              +OAuth2ResourceServer
                                              +JwtDecoder
                                              +CustomJwtGrantedAuthoritiesConverter
                                          }
                                          
                                          class Authorization {
                                              +ROLE_GUEST
                                              +ROLE_MANAGE_USERS
                                              +ROLE_ADMIN
                                              +ROLE_USER
                                          }
                                          
                                          class SessionManagement {
                                              +Redis Session Storage
                                              +Session Timeout
                                              +Session Fixation
                                          }
                                          
                                          SecurityConfig --> JWTValidation
                                          SecurityConfig --> Authorization
                                          SecurityConfig --> SessionManagement`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class GlobalExceptionHandler {
                                              +Chain of Responsibility
                                              +Error Response Builder
                                          }
                                          
                                          class BusinessApiExceptionHandler {
                                              +@Order(0)
                                              +BusinessException
                                          }
                                          
                                          class DataIntegrityApiExceptionHandler {
                                              +@Order(1)
                                              +DataIntegrityViolationException
                                          }
                                          
                                          class ValidationApiExceptionHandler {
                                              +@Order(2)
                                              +MethodArgumentNotValidException
                                          }
                                          
                                          class DefaultApiExceptionHandler {
                                              +@Order(Integer.MAX_VALUE)
                                              +Generic Exception
                                          }
                                          
                                          GlobalExceptionHandler --> BusinessApiExceptionHandler
                                          GlobalExceptionHandler --> DataIntegrityApiExceptionHandler
                                          GlobalExceptionHandler --> ValidationApiExceptionHandler
                                          GlobalExceptionHandler --> DefaultApiExceptionHandler`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class ActuatorEndpoints {
                                              +/health
                                              +/metrics
                                              +/prometheus
                                              +/info
                                              +/loggers
                                              +/env
                                          }
                                          
                                          class MetricsConfig {
                                              +MeterRegistry
                                              +HikariCP Metrics
                                              +Custom Metrics
                                          }
                                          
                                          class MetricsWSController {
                                              +@Scheduled
                                              +WebSocket Broadcast
                                              +Distributed Lock
                                          }
                                          
                                          class HealthChecks {
                                              +Database Health
                                              +Redis Health
                                              +Application Health
                                          }
                                          
                                          ActuatorEndpoints --> MetricsConfig
                                          MetricsConfig --> MetricsWSController
                                          MetricsConfig --> HealthChecks`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class PerformanceOptimization {
                                              +Database Indexing
                                              +Connection Pooling
                                              +Caching Strategy
                                              +N+1 Query Fix
                                          }
                                          
                                          class DatabaseOptimization {
                                              +B-Tree Indexes
                                              +Composite Indexes
                                              +Vector Indexes
                                              +Batch Queries
                                          }
                                          
                                          class CacheOptimization {
                                              +Redis Caching
                                              +@Cacheable
                                              +TTL Management
                                          }
                                          
                                          class QueryOptimization {
                                              +IN Clause
                                              +Selective Columns
                                              +Batch Operations
                                          }
                                          
                                          PerformanceOptimization --> DatabaseOptimization
                                          PerformanceOptimization --> CacheOptimization
                                          PerformanceOptimization --> QueryOptimization`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`classDiagram
                                          class DockerBuild {
                                              +Multi-stage Build
                                              +BuildKit Optimization
                                              +Security Scan
                                          }
                                          
                                          class KubernetesDeploy {
                                              +Deployment
                                              +Service
                                              +ConfigMap
                                              +Secret
                                          }
                                          
                                          class CI_CD {
                                              +Jenkins Pipeline
                                              +Maven Build
                                              +Docker Build
                                              +K8s Deploy
                                          }
                                          
                                          class Monitoring {
                                              +Prometheus
                                              +Grafana
                                              +Logging
                                          }
                                          
                                          DockerBuild --> KubernetesDeploy
                                          CI_CD --> DockerBuild
                                          CI_CD --> KubernetesDeploy
                                          KubernetesDeploy --> Monitoring`}
                                    </pre>
                                  </div>
                                </>
                              )}
                              {subcategory.name === "Relational" && (
                                <div class="mermaid-diagram">
                                  <pre class="mermaid">
                                    {`classDiagram
                                        class DatabaseOptimization {
                                            +B-Tree Indexes
                                            +Composite Indexes
                                            +Vector Indexes (pgvector)
                                            +Batch Queries
                                        }
                                        
                                        class PeopleTable {
                                            +idx_people_name (Primary)
                                            +idx_people_race
                                            +idx_people_gender
                                            +idx_people_faction
                                            +idx_people_embedding
                                        }
                                        
                                        class WeaponTable {
                                            +idx_weapon_owner
                                            +idx_weapon_base_damage
                                            +idx_weapon_bonus_damage
                                            +idx_weapon_embedding
                                        }
                                        
                                        class QueryOptimization {
                                            +IN Clause (N+1 Fix)
                                            +Batch Operations
                                            +Selective Columns
                                            +Caching Strategy
                                        }
                                        
                                        DatabaseOptimization --> PeopleTable
                                        DatabaseOptimization --> WeaponTable
                                        DatabaseOptimization --> QueryOptimization`}
                                  </pre>
                                </div>
                              )}
                              {subcategory.name === "Platforms" && (
                                <div class="mermaid-diagram">
                                  <pre class="mermaid">
                                    flowchart LR
                                      user["User"] -->|SSH 22| bastion["Bastion (Public Subnet)"]

                                      subgraph OCI VCN
                                        direction LR

                                        subgraph Public["Public Subnets"]
                                          bastion
                                          pubLB["Public LB Subnet (OCI LB - Reserved IP)"]
                                        end

                                        subgraph Private["Private Subnets"]
                                          operator["Operator VM"]
                                          cp["OKE Control Plane (Private Endpoint)"]
                                          workers["Worker Nodes (NodePool size=2, A1.Flex 1c/8GB/50GB)"]
                                          intLB["Internal LB Subnet"]
                                        end

                                        subgraph Gateways["Network Gateways"]
                                          ig["Internet Gateway"]:::net
                                          nat["NAT Gateway"]:::net
                                          sg["Service Gateway"]:::net
                                        end

                                        pubRT["Public Route Table"]:::net --> ig
                                        privRT["Private Route Table"]:::net --> nat
                                        privRT --> sg

                                        bastion -.-> pubRT
                                        pubLB -.-> pubRT

                                        operator -.-> privRT
                                        workers -.-> privRT
                                        intLB -.-> privRT
                                      end

                                      bastion -->|SSH Proxy| operator
                                      operator -->|kubectl 6443| cp
                                      pubLB --> workers
                                      intLB --> workers

                                      classDef net fill:#eee,stroke:#999;
                                  </pre>
                                </div>
                              )}
                              {subcategory.name === "NoSQL" && (
                                <div class="mermaid-diagram">
                                  <pre class="mermaid">
                                    sequenceDiagram
                                        participant Frontend as Frontend
                                        participant Django as Django API
                                        participant Redis as Redis Queue
                                        participant Consumer as Consumer Service
                                        participant Mongo as MongoDB

                                        Frontend->>Django: 1. Call Push API
                                        Django->>Redis: 2. Push to Redis List
                                        Consumer->>Redis: 3. Pop from Redis List
                                        Consumer->>Mongo: 4. Update Increment in Document
                                        Frontend->>Django: 5. Call Count API
                                        Django->>Mongo: 6. Query Count from Document
                                        Mongo-->>Django: Return Count
                                        Django-->>Frontend: Return Count

                                        Note over Frontend,Mongo: Asynchronous Visit Count Processing
                                        Note over Redis,Consumer: Using Consumer YAML Configuration
                                  </pre>
                                </div>
                              )}
                              {subcategory.name === "Frameworks & APIs" && (
                                <>
                                  {/* --- AI Frameworks & APIs Architecture Diagrams --- */}
                                  <br />
                                  <p>Maya Sawa V1</p><a href="https://github.com/Vinskao/maya-sawa" target="_blank">maya-sawa</a>
                                  <div class="mermaid-diagram margin-top">
                                    <pre class="mermaid">
                                      {`graph TD
    A["User Request</br>(/qa/query)"] --> B{FastAPI Router};
    B --> C["qa_chain.get_answer(query)"];
    C --> D{"Detect names in query"};
    
    %% 名稱檢測分支
    D -- "Names found" --> E["Fetch character profiles</br>from DB"];
    E --> F{"Profile found?"};
    F -- "Yes" --> G["Create prompt with</br>character profile"];
    F -- "No" --> H["Respond 'not found'"];
    
    %% 無名稱分支
    D -- "No names found" --> I{"Semantic search for people"};
    I -- "People found" --> J["Generate answer from</br>search results"];
    I -- "No one found" --> K["Similarity search</br>in Vector Store"];
    K --> L["Create prompt with</br>document context"];
    
    %% 統一處理
    G --> M["Invoke LLM"];
    J --> M;
    L --> M;
    H --> N["Return final answer"];
    M --> N;
    N --> O["Save chat history"];
    O --> P["Return AI answer"];
    P --> B;`}
                                    </pre>
                                  </div>
                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`flowchart TD
    subgraph "API Layer"
        APIRouter["FastAPI Router<br/>(maya_sawa/api/qa.py)"]
    end

    subgraph "Q&A Layer"
        QAChain["QAChain"]
        PageAnalyzer["PageAnalyzer"]
    end

    subgraph "Support Layer"
        NameDetector["NameDetector"]
        ProfileManager["ProfileManager"]
        PeopleWeaponManager["PeopleWeaponManager"]
        PersonalityPromptBuilder["PersonalityPromptBuilder"]
        NameAdapter["NameAdapter"]
        VectorStore["PostgresVectorStore"]
        ChatHistoryManager["ChatHistoryManager"]
        ConfigManager["ConfigManager"]
        ConnectionPoolManager["ConnectionPoolManager"]
        Scheduler["ArticleSyncScheduler"]
    end

    subgraph "External Services"
        OpenAIAPI["OpenAI API<br/>Chat & Embeddings"]
        PeopleAPI["People System API<br/>/tymb/people/*"]
        ArticleAPI["Public Article API<br/>/paprika/articles"]
        PostgresDB["PostgreSQL"]
        RedisDB["Redis"]
    end

    Client["Client / Frontend"] --> APIRouter
    APIRouter --> QAChain
    APIRouter --> PageAnalyzer
    APIRouter --> VectorStore
    APIRouter --> ChatHistoryManager
    APIRouter --> Scheduler

    ChatHistoryManager --> RedisDB

    QAChain --> NameDetector
    QAChain --> ProfileManager
    QAChain --> PeopleWeaponManager
    QAChain --> PersonalityPromptBuilder
    QAChain --> NameAdapter
    QAChain --> VectorStore

    PageAnalyzer --> QAChain

    NameDetector --> OpenAIAPI
    QAChain --> OpenAIAPI

    ProfileManager --> PeopleAPI
    PeopleWeaponManager --> PeopleAPI

    VectorStore --> PostgresDB
    VectorStore --> ArticleAPI

    PeopleWeaponManager --> PostgresDB

    ConfigManager --> PostgresDB
    ConnectionPoolManager --> PostgresDB
    Scheduler --> ArticleAPI`}
                                    </pre>
                                  </div>
                                  <br />
                                  <p>Maya Sawa V2</p><a href="https://github.com/Vinskao/maya-sawa-v2" target="_blank">maya-sawa-v2</a>
                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`graph TD
  %% 使用者與入口
  U["User"] --> Q["ask-with-model API<br/>question"]
  Q --> P["Full-text Retrieval Pipeline"]

  %% 檢索流程
  subgraph "Pipeline"
    P --> N["Normalize/Lowercase<br/>trim punctuation"]
    N --> E{"Compute Embedding?"}
    E -- Yes --> EM["OpenAI Embeddings<br/>(text-embedding-3-small) → qvec(1536)"]
    E -- No --> SKIP["Skip vector branch"]

    %% Postgres 檢索（Trigram 與 Vector）
    subgraph "PostgreSQL"
      direction LR
      PG1["Trigram Search<br/>content % :query<br/>similarity(content, :query) as text_sim"]:::trgm
      PG2["Vector Search<br/>1 - (embedding <=> :qvec) as vec_sim"]:::vec
      IDX1["GIN Index<br/>idx_articles_content_trgm<br/>(content gin_trgm_ops)"]:::idx
      IDX2["IVFFlat Index<br/>idx_articles_embedding_ivfcos<br/>(embedding vector_cosine_ops)"]:::idx
      EXT1["EXTENSION pg_trgm<br/>set_limit(:min_sim)"]:::ext
      EXT2["EXTENSION pgvector"]:::ext
    end

    EM --> PG2
    SKIP -.-> PG1
    N --> PG1
    PG1 --> MRG["Merge & Rank<br/>score = 0.6*text_sim + 0.4*vec_sim"]
    PG2 --> MRG
    MRG --> TOPK["Top-K Articles"]
  end

  %% 後處理與回傳
  TOPK --> CTX["Build Context from Articles<br/>(title + snippet)"]
  CTX --> AI["LLM Call (OpenAI/Gemini/Qwen/Mock)"]
  AI --> RESP["Answer + Citations/No Knowledge Notice"]
  RESP --> RDS["Redis ChatHistory<br/>chat:session:{sid}"]
  RESP --> OUT["API Response"]

  %% 資料表與索引
  subgraph "articles schema"
    TBL["articles<br/>- id BIGSERIAL PK<br/>- file_path VARCHAR(500) UNIQUE<br/>- content TEXT NOT NULL<br/>- file_date TIMESTAMP NOT NULL<br/>- embedding vector(1536)"]:::tbl
  end
  TBL -. indexed by .-> IDX1
  TBL -. indexed by .-> IDX2

  %% 樣式
  classDef trgm fill:#e3f2fd,stroke:#1e88e5,stroke-width:1px
  classDef vec fill:#fce4ec,stroke:#d81b60,stroke-width:1px
  classDef idx fill:#fff3e0,stroke:#fb8c00,stroke-width:1px
  classDef ext fill:#ede7f6,stroke:#5e35b1,stroke-width:1px
  classDef tbl fill:#f1f8e9,stroke:#43a047,stroke-width:1px`}
                                    </pre>
                                  </div>

                                  <div class="mermaid-diagram">
                                    <pre class="mermaid">
                                      {`graph TB
    subgraph "前端層"
        A[用戶介面] --> B[API 客戶端]
    end

    subgraph "API 層"
        B --> A1[ask-with-model]
        B --> A2[chat-history]
        B --> A3[available-models]
        B --> A4[add-model]
        B --> A5[healthz]
        B --> A6[legacy-chat-history]
    end

    subgraph "服務層"
        S1[FilterChainManager] --> S2[KMSourceManager]
        S3[ChatHistoryService] --> R[(Redis)]
        S4[AIResponseService] --> P1[AI Providers]
        P1 --> P1a[OpenAI]
        P1 --> P1b[Gemini]
        P1 --> P1c[Qwen]
        P1 --> P1d[Mock]
    end

    subgraph "資料層"
        D1[(PostgreSQL)]
        D2[(Redis)]
        D3[(Celery Broker)]
    end

    subgraph "外部系統"
        E1[Paprika API]
        E2[OpenAI API]
        E3[Google Gemini API]
        E4[Qwen API]
    end

    %% 關聯
    A1 --> S1
    S1 --> S2
    S2 --> D1
    A1 --> S3
    S3 --> D2
    A1 --> S4
    S4 --> P1
    P1a --> E2
    P1b --> E3
    P1c --> E4
    S2 --> E1

    %% DB 關聯
    A1 --> D1
    A2 --> D2
    A4 --> D1

    %% 註解
    D1:::db
    D2:::cache
    D3:::broker

    classDef db fill:#f1f8e9
    classDef cache fill:#e3f2fd
    classDef broker fill:#fff3e0`}
                                    </pre>
                                  </div>
                                </>
                              )}
                            </div>
                          ))
                        ) : (
                          <div class="skill-tags">
                            {category.skills.map((skill) => {
                              const gradeMap = {
                                'shade1': 'S',
                                'shade2': 'A', 
                                'shade3': 'B',
                                'shade4': 'C',
                                'shade5': 'D'
                              };
                              return (
                                <span class={`pill ${category.pillClass} ${skill.level} ${(skill as any).specialClass || ''}`} 
                                      data-tooltip={`Level: ${gradeMap[skill.level] || skill.level}`}>
                                  {skill.name}
                                </span>
                              );
                            })}
                          </div>
                        )}
                        {(category as any).description && (category as any).description[lang] && (category as any).description[lang].length > 0 && (
                          <ul class="skill-description">
                            {(category as any).description[lang].map((desc: string, index: number) => (
                              <li set:html={desc.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')}>
                              </li>
                            ))}
                          </ul>
                        )}
                        
                        {category.name === "CI/CD" && (
                          <div class="mermaid-diagram">
                            <pre class="mermaid">
                              graph LR
                                  A[GitHub Repository] --> B[Clone and Setup]
                                  B --> C[Build with Node.js]
                                  C --> D[Build Docker Image with BuildKit]
                                  D --> E[Push to Docker Hub]
                                  E --> F[Deploy to Kubernetes]
                            </pre>
                          </div>
                        )}
                        
                        {category.name === "Security & Authentication" && (
                          <div class="mermaid-diagram">
                            <pre class="mermaid">
                              sequenceDiagram
                                  participant User as User
                                  participant App as Application
                                  participant Auth as Authorization Server
                                  participant API as Resource Server
                                  
                                  User->>App: 1. Access Application
                                  App->>Auth: 2. Redirect to Authorization Page
                                  User->>Auth: 3. Login and Authorize
                                  Auth->>App: 4. Return Authorization Code
                                  App->>Auth: 5. Exchange Code for Token
                                  Auth->>App: 6. Return Access Token
                                  App->>API: 7. Access Resources with Token
                                  API->>App: 8. Return Protected Resources
                            </pre>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        </section>
      </main>

      <ResumePreview />
      <ContactCTA />
    </div>
    
    <!-- Mermaid.js for on-page diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const mermaidLib = window['mermaid'];
        if (mermaidLib) {
          mermaidLib.initialize({ startOnLoad: true, theme: 'default' });
        }
      });
    </script>

    <!-- Styles for export button live in ResumePreview component -->
</body>
