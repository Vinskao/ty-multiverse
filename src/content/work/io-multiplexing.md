---
title: "io-multiplexing"
publishDate: "2025-08-27 01:00:00"
img: /tymultiverse/assets/algorithm.jpg
img_alt: A bright pink sheet of paper used to wrap flowers curves in front of rich blue background
description: é«˜ä½µç™¼æ¶æ§‹æ·±åº¦å‰–æï¼šå¾ I/O å¤šå·¥æŠ€è¡“åˆ°äº‹ä»¶é©…å‹•è¨­è¨ˆçš„å®Œæ•´æ¼”é€²
tags:
  - System Programming
  - I/O Multiplexing
  - Web Frameworks
  - Performance
  - OS Kernel
---

# é«˜ä½µç™¼æ¶æ§‹æ·±åº¦å‰–æï¼šI/O å¤šå·¥æŠ€è¡“èˆ‡äº‹ä»¶é©…å‹•è¨­è¨ˆ

## å‰è¨€

ç¾ä»£ Web é–‹ç™¼çš„æ€§èƒ½ç“¶é ¸ï¼Œå¾€å¾€åœ¨æ–¼å¦‚ä½•é«˜æ•ˆè™•ç†å¤§é‡ä½µç™¼é€£ç·šã€‚æœ¬æ–‡å¾æ“ä½œç³»çµ±çš„ I/O å¤šå·¥æŠ€è¡“å‡ºç™¼ï¼Œæ·±å…¥æ¢è¨äº‹ä»¶é©…å‹•æ¶æ§‹çš„è¨­è¨ˆç†å¿µï¼Œä¸¦æ¯”è¼ƒä¸åŒ Web æ¡†æ¶çš„å¯¦ç¾æ–¹å¼ï¼Œç‚ºé«˜ä½µç™¼ç³»çµ±æ¶æ§‹è¨­è¨ˆæä¾›å®Œæ•´æŒ‡å—ã€‚

å¾åº•å±¤çš„ select/poll/epollï¼Œåˆ°æ‡‰ç”¨å±¤çš„äº‹ä»¶è¿´åœˆè¨­è¨ˆï¼Œå†åˆ°å…·é«”æ¡†æ¶çš„é¸æ“‡ï¼Œé€™ç¯‡æ–‡ç« å°‡å¸¶ä½ å®Œæ•´ç†è§£ç¾ä»£ Web æ¶æ§‹çš„æ¼”é€²ä¹‹è·¯ã€‚

## ğŸ“ OS çš„ã€Œä¸‰ç¨®è½é›»è©±æ–¹æ³•ã€

æƒ³åƒé›»è…¦è¦ã€Œæ¥é›»è©±ã€ï¼ˆè™•ç†å¾ˆå¤š socket é€£ç·šï¼‰ã€‚

### **1ï¸âƒ£ select()ï¼šå‚³çµ±é»åæ³•ï¼ˆæ•ˆç‡æœ€å·®ï¼‰**
```c
// åƒè€å¸«æ¯å¤©è¦é»åä¸€æ•´å€‹ç­ç´šï¼Œæ¯æ¬¡éƒ½è¦å¾é ­æ•¸åˆ°å°¾
int select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout);
```

**ç¼ºé»ï¼š**
- æ¯æ¬¡éƒ½è¦æƒææ‰€æœ‰ socket
- O(n) è¤‡é›œåº¦ï¼Œäººä¸€å¤šå°±æ…¢
- æœ€å¤§ç›£è½æ•¸é‡æœ‰é™ï¼ˆé€šå¸¸ 1024ï¼‰

### **2ï¸âƒ£ poll()ï¼šæ”¹å–„ç‰ˆé»åæ³•**
```c
// æ”¹å–„ä¸€é»ï¼Œä¸ç”¨ bitsetï¼Œä½†é‚„æ˜¯ä¸€å€‹ä¸€å€‹å•ï¼šã€Œä½ æœ‰äº‹å—ï¼Ÿã€
int poll(struct pollfd *fds, nfds_t nfds, int timeout);
```

**å„ªé»ï¼š** æ”¯æ´æ›´å¤š socketï¼ˆç†è«–ä¸Šç„¡ä¸Šé™ï¼‰
**ç¼ºé»ï¼š** é‚„æ˜¯ O(n)ï¼Œæ•ˆç‡æ²’æœ‰æ ¹æœ¬æ”¹å–„

### **3ï¸âƒ£ epoll/kqueue/IOCPï¼šæ™ºæ…§èˆ‰æ‰‹ç³»çµ±ï¼ˆç¾ä»£æ¨™æº–ï¼‰**
```c
// Linux epollï¼šå­¸ç”Ÿè‡ªå·±èˆ‰æ‰‹ï¼Œæœ‰äº‹å†å«è€å¸«
int epoll_create(int size);
int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);
int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);
```

**æ ¸å¿ƒå„ªå‹¢ï¼š**
- **O(1) è¤‡é›œåº¦**ï¼šä¸ç®¡å¤šå°‘ socketï¼Œæ•ˆèƒ½éƒ½ä¸€æ¨£
- **äº‹ä»¶é©…å‹•**ï¼šOS ä¸»å‹•é€šçŸ¥ï¼Œä¸ç”¨è¼ªè©¢
- **ç„¡ä¸Šé™**ï¼šç†è«–ä¸Šå¯ä»¥ç›£è½æ•¸ç™¾è¬å€‹ socket

## ğŸ¡ Event Loopï¼ˆäº‹ä»¶è¿´åœˆï¼‰

æœ‰äº† epoll/kqueue/IOCP é€™äº›ã€Œè°æ˜çš„é»åç³»çµ±ã€ï¼Œç¨‹å¼å°±å¯ä»¥ï¼š

### **å·¥ä½œæµç¨‹ï¼š**
1. **è¨»å†Šç›£è½**ï¼šæŠŠã€Œé€™å€‹ socket æœ‰äº‹æ™‚è¦é€šçŸ¥æˆ‘ã€äº¤çµ¦ OS
2. **OS ç›£æ§**ï¼šOS kernel å¹«å¿™ç›¯è‘—æ‰€æœ‰ socket
3. **äº‹ä»¶é€šçŸ¥**ï¼šä¸€æ—¦æœ‰äº‹ä»¶ï¼ŒOS é€šçŸ¥ event loop
4. **è™•ç†äº‹ä»¶**ï¼ševent loop æ´¾ coroutine å»è™•ç†

### **æ•ˆèƒ½å„ªå‹¢ï¼š**
- **ä¸€å€‹ thread** å°±èƒ½ç®¡ç†å¹¾åƒä¸Šè¬é€£ç·š
- **ä¸æœƒå‚»å‚»åœ°æ¯å€‹éƒ½æª¢æŸ¥**
- **è³‡æºåˆ©ç”¨ç‡æ¥µé«˜**

### **ğŸ› ï¸ Processï¼ˆè¡Œç¨‹ï¼‰èˆ‡ Workerï¼ˆå·¥ä½œç¨‹åºï¼‰**

#### **ğŸ” Processï¼ˆè¡Œç¨‹ï¼Œç¨‹åºï¼‰çš„æœ¬è³ª**
**æ ¸å¿ƒå®šç¾©ï¼š** Process = ä½œæ¥­ç³»çµ±çµ¦ä¸€å€‹ç¨‹å¼åˆ†é…çš„ç¨ç«‹è³‡æºå–®ä½ã€‚

**å®ƒå¯ä»¥æ˜¯ä»€éº¼ï¼š**
- Web serverã€è³‡æ–™åº«ã€æ¡Œé¢æ‡‰ç”¨
- èƒŒæ™¯å®ˆè­·ç¨‹å¼ã€ç³»çµ±æœå‹™
- ä»»ä½•æ­£åœ¨åŸ·è¡Œçš„ç¨‹å¼

**é—œéµç‰¹å¾µï¼š**
- **éš”é›¢æ€§**ï¼šå…¶ä»– process crash ä¸æœƒå½±éŸ¿æˆ‘
- **ç¨ç«‹è¨˜æ†¶é«”**ï¼šä¸èƒ½ç›´æ¥å­˜å–åˆ¥äºº process çš„è®Šæ•¸
- **CPU æ’ç¨‹**ï¼šç³»çµ±è¼ªæµçµ¦ process CPU æ™‚é–“

**æ¯”å–»ï¼š** ä¸€é–“é¤å»³ï¼Œæœ‰è‡ªå·±çš„å»šæˆ¿ã€å†°ç®±ã€å“¡å·¥ï¼Œä¸è·Ÿåˆ¥å®¶å…±äº«ã€‚

#### **ğŸ¯ Node.js Process çš„ç‰¹åˆ¥ä»£è¡¨æ€§**
Node.js ä¸–ç•Œæœ€èƒ½é«”ç¾ process çš„æœ¬è³ªï¼š

**é è¨­æ¶æ§‹ï¼š** åªé–‹ã€Œä¸€å€‹ processã€è·‘ event loopã€‚

**é€™å€‹ process ä¸åªè™•ç† HTTP requestï¼Œé‚„è™•ç†ï¼š**
- **I/O äº‹ä»¶**ï¼šè®€æª”æ¡ˆã€DB æŸ¥è©¢ã€ç¶²è·¯ socket
- **è¨ˆæ™‚å™¨**ï¼šsetTimeoutã€setInterval
- **ç³»çµ±è¨Šè™Ÿ**ï¼šSIGINTï¼ˆCtrl+Cï¼‰
- **äº‹ä»¶ç›£è½**ï¼šfs.watch æª”æ¡ˆè®Šå‹•
- **Promise/microtask**ï¼šæ’é€² microtask queue

**Node Process æœ¬è³ªï¼š** ã€Œä¸€å€‹ event loop + ä¸€å †ç³»çµ± API callback queueã€ï¼Œrequest åªæ˜¯å…¶ä¸­ä¸€ç¨®äº‹ä»¶ã€‚

#### **ğŸ‘· Workerï¼ˆå·¥ä½œç¨‹åºï¼‰**
**å®šç¾©ï¼š** ä¸€å€‹ç‰¹æ®Šè§’è‰²çš„ process â†’ å°ˆé–€æ‹¿ä¾†ã€Œè™•ç† requestã€ã€‚

**æœ¬è³ªï¼š** worker = processï¼ˆåªä¸éå·¥ä½œæ˜¯ã€Œè™•ç† requestã€ï¼‰ã€‚

**å¸¸è¦‹ä¾‹å­ï¼š**
- **Gunicorn/Uvicorn**ï¼šä¸€å€‹ worker = ä¸€å€‹ process
- **Celery worker**ï¼šå¾ queue æŠ“ä»»å‹™åŸ·è¡Œçš„ process

**æ¯”å–»ï¼š** å¦‚æœ process æ˜¯é¤å»³ï¼Œworker å°±æ˜¯å°ˆé–€åšã€Œæ¥å–® + ç…®èœã€çš„é¤å»³ã€‚

**âš¡ èˆ‡äº‹ä»¶è¿´åœˆçš„é—œä¿‚ï¼š**
- **å‚³çµ± worker**ï¼šthread-per-requestï¼Œè³‡æºæµªè²»
- **äº‹ä»¶è¿´åœˆ worker**ï¼šä¸€å€‹ worker ç®¡ç†è¬ç´šé€£ç·šï¼Œè³‡æºé«˜æ•ˆ

## æ¡†æ¶å¦‚ä½•ä½¿ç”¨é€™äº›æŠ€è¡“ï¼Ÿ

é‡é»ï¼š**ä½ ä¸ç”¨è‡ªå·±æŒ‘é¸ select/epoll/kqueue**ã€‚

### **ğŸ­ æ¡†æ¶çš„æ™ºæ…§é¸æ“‡ï¼š**
- **Linux** â†’ è‡ªå‹•ä½¿ç”¨ `epoll`
- **macOS/FreeBSD** â†’ è‡ªå‹•ä½¿ç”¨ `kqueue`
- **Windows** â†’ è‡ªå‹•ä½¿ç”¨ `IOCP`

### **åº•å±¤å¯¦ç¾ï¼š**
- **Spring WebFlux** â†’ Netty è‡ªå‹•é¸æ“‡
- **Django ASGI** â†’ uvicorn/daphne è‡ªå‹•é¸æ“‡
- **Node.js** â†’ libuv è‡ªå‹•é¸æ“‡

## ğŸ”„ äº‹ä»¶è¿´åœˆ vs æ¡†æ¶ï¼šèª°æ˜¯èª°çš„ã€ŒåŸä½æ°‘ã€ï¼Ÿ

ç†è§£äº† I/O å¤šå·¥çš„æŠ€è¡“å¾Œï¼Œè®“æˆ‘å€‘ä¾†çœ‹çœ‹ä¸åŒæ¡†æ¶å¦‚ä½•èˆ‡äº‹ä»¶è¿´åœˆå…±å­˜ã€‚

### **ğŸŒŸ Node.jsï¼šå¤©ç”Ÿçš„äº‹ä»¶è¿´åœˆåŸä½æ°‘**

```javascript
// Node.js å¾ä¸€é–‹å§‹å°±æ˜¯äº‹ä»¶é©…å‹•
const http = require('http');

const server = http.createServer((req, res) => {
  // æ‰€æœ‰ async/await/Promise æœ€çµ‚éƒ½æœƒè®Šæˆ libuv callback
  someAsyncOperation().then(result => {
    res.end(result);
  });
});

server.listen(3000);
```

**æ ¸å¿ƒç‰¹é»ï¼š**
- **å–®åŸ·è¡Œç·’ + libuv event loop**
- **æ‰€æœ‰ I/O éƒ½æ˜¯éé˜»å¡çš„**
- **æ²’æœ‰ã€Œå‚³çµ±é˜»å¡æ¨¡å¼ã€çš„é¸æ“‡**
- **JS ä¸–ç•Œè£¡ä¸€åˆ‡éƒ½æ˜¯ callback â†’ event loop â†’ callback**

### **â˜• Spring Bootï¼šé›™é‡äººæ ¼çš„æ¡†æ¶**

#### **äººæ ¼ä¸€ï¼šå‚³çµ± MVCï¼ˆé˜»å¡æ¨¡å¼ï¼‰**
```java
@RestController
public class TraditionalController {
    @GetMapping("/sync")
    public String syncEndpoint() {
        // Thread æœƒåœ¨é€™è£¡å¡ä½ç­‰å¾… I/O
        return blockingDatabaseCall(); // âŒ é˜»å¡ I/O
    }
}
```

#### **äººæ ¼äºŒï¼šWebFluxï¼ˆäº‹ä»¶è¿´åœˆæ¨¡å¼ï¼‰**
```java
@RestController
public class ReactiveController {
    @GetMapping("/reactive")
    public Mono<String> reactiveEndpoint() {
        // ä¸æœƒå¡ä½ threadï¼Œevent loop ç¹¼çºŒè™•ç†å…¶ä»–è«‹æ±‚
        return reactiveDatabaseCall(); // âœ… éé˜»å¡ I/O
    }
}
```

**æ ¸å¿ƒå·®ç•°ï¼š**
- **MVC**ï¼šThread Pool + é˜»å¡ I/Oï¼ˆ1 è¬é€£ç·š = 1 è¬ threadï¼‰
- **WebFlux**ï¼šNetty + äº‹ä»¶è¿´åœˆï¼ˆ1 è¬é€£ç·š = å¹¾åå€‹ threadï¼‰

### **ğŸ Pythonï¼šWSGI vs ASGI çš„ä¸–ä»£å·®ç•°**

#### **å‚³çµ± WSGIï¼ˆé˜»å¡æ¨¡å¼ï¼‰**
```python
# Flask/Django å‚³çµ±æ¨¡å¼
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return blocking_database_call()  # âŒ é˜»å¡ I/O
```

#### **ç¾ä»£ ASGIï¼ˆäº‹ä»¶è¿´åœˆæ¨¡å¼ï¼‰**
```python
# FastAPI/Django Channels
from fastapi import FastAPI
app = FastAPI()

@app.get('/')
async def hello():
    return await async_database_call()  # âœ… éé˜»å¡ I/O
```

**æ ¸å¿ƒå·®ç•°ï¼š**
- **WSGI**ï¼šåŒæ­¥é˜»å¡ï¼Œthread-per-request
- **ASGI**ï¼šasync/await + uvloop äº‹ä»¶è¿´åœˆ

### **ğŸ¤” ç‚ºä»€éº¼ Java/Python ä¸åšã€ŒåŸç”Ÿäº‹ä»¶è¿´åœˆã€ï¼Ÿ**

#### **1ï¸âƒ£ èªè¨€è¨­è¨ˆçš„æ­·å²åŒ…è¢±**
- **Java**ï¼šå¾ JDK 1.0 å°±å®šä½ã€Œå¤šåŸ·è¡Œç·’ + JVMã€ï¼ŒThread/synchronized æ˜¯æ ¸å¿ƒ
- **Python**ï¼šGIL + CPython çš„è¨­è¨ˆï¼Œè®“å¤šåŸ·è¡Œç·’ä¸€ç›´å¾ˆå°·å°¬
- **JavaScript**ï¼šå¾èª•ç”Ÿå°±æ²’æœ‰å¤šåŸ·è¡Œç·’åŒ…è¢±ï¼Œç›´æ¥äº‹ä»¶è¿´åœˆç‚ºæ ¸å¿ƒ

#### **2ï¸âƒ£ ç”Ÿæ…‹ç³»çµ±çš„å‘å¾Œç›¸å®¹**
- **èˆŠç¨‹å¼ç¢¼å¤ªå¤š**ï¼šå¦‚æœå¼·åˆ¶è½‰äº‹ä»¶è¿´åœˆï¼Œæ•¸ç™¾è¬è¡Œçš„åŒæ­¥ç¨‹å¼è¦é‡å¯«
- **å‡½å¼åº«ç›¸å®¹**ï¼šHibernateã€MyBatisã€Django ORM ç­‰åŒæ­¥åº«ç„¡æ³•ç›´æ¥è·‘åœ¨ async æ¨¡å¼
- **æ¼¸é€²å¼é·ç§»**ï¼šJava/Python é¸æ“‡ã€Œä¸¦å­˜ã€ç­–ç•¥ï¼Œè®“é–‹ç™¼è€…æ…¢æ…¢è½‰ç§»

#### **3ï¸âƒ£ é–‹ç™¼é«”é©—çš„å·®ç•°**
- **åŒæ­¥ç¨‹å¼ç¢¼**ï¼šå¯«èµ·ä¾†ç°¡å–®ï¼Œç›´è¦º
- **éåŒæ­¥ç¨‹å¼ç¢¼**ï¼šcallback hellã€async/await è¤‡é›œåº¦è¼ƒé«˜
- **é™¤éŒ¯å›°é›£**ï¼šäº‹ä»¶è¿´åœˆçš„ stack trace å¾ˆé›£è¿½è¹¤

### **ğŸ“Š æ¡†æ¶å°æ¯”è¡¨ï¼šèª°è·‘åœ¨äº‹ä»¶è¿´åœˆä¸Šï¼Ÿ**

| æ¡†æ¶ | æ¨¡å¼ | åº•å±¤æŠ€è¡“ | é€£ç·šè™•ç†æ–¹å¼ | æ˜¯å¦äº‹ä»¶è¿´åœˆ |
|------|------|----------|--------------|---------------|
| **Node.js** | å–®ä¸€æ¨¡å¼ | libuv + epoll/kqueue/IOCP | å–®åŸ·è¡Œç·’ç®¡ç†æ‰€æœ‰ | âœ… åŸç”Ÿ |
| **Spring MVC** | å‚³çµ± | Tomcat/Jetty + Thread Pool | Thread-per-request | âŒ é˜»å¡ |
| **Spring WebFlux** | ç¾ä»£ | Netty + äº‹ä»¶è¿´åœˆ | å°‘é‡ thread ç®¡ç†å¤§é‡é€£ç·š | âœ… ç¾ä»£ |
| **Django WSGI** | å‚³çµ± | Gunicorn + Thread Pool | Thread-per-request | âŒ é˜»å¡ |
| **Django ASGI** | ç¾ä»£ | uvicorn/daphne + uvloop | äº‹ä»¶è¿´åœˆ + å¤š worker | âœ… ç¾ä»£ |
| **FastAPI** | ç¾ä»£ | uvicorn + uvloop | äº‹ä»¶è¿´åœˆ | âœ… ç¾ä»£ |

### **ğŸ“‹ æ¨¡å¼å°æ¯”è¡¨ï¼šäº‹ä»¶è¿´åœˆ vs å‚³çµ±åŒæ­¥ vs æ¶ˆæ¯éšŠåˆ—**

| æ¨¡å¼                   | I/O æ¨¡å‹                             | ä»»å‹™æ’ç¨‹ / Producer-Consumer      | CPU å¯†é›†                         | Memory ä½¿ç”¨                  | é©åˆå ´æ™¯                  | é¢è©¦èªªæ³•                          |
| -------------------- | ---------------------------------- | ----------------------------- | ------------------------------ | -------------------------- | --------------------- | ----------------------------- |
| **äº‹ä»¶è¿´åœˆ + æ¶ˆæ¯éšŠåˆ—**      | éé˜»å¡ async / coroutine / event loop | Broker å¯¦ç¾å¯é  Producer/Consumer | CPU å¯†é›†ä»»å‹™ä¸Ÿ thread pool / worker | å°‘é‡ thread + memory çœ       | é«˜ä½µç™¼ API + åˆ†å¸ƒå¼ä»»å‹™       | ã€Œé«˜ä½µç™¼ I/O + å¯æ“´å±•äº‹ä»¶é©…å‹•æ¶æ§‹ã€         |
| **å‚³çµ±åŒæ­¥ + æ¶ˆæ¯éšŠåˆ—**      | æ¯å€‹è«‹æ±‚ä¸€å€‹ threadï¼Œé˜»å¡ I/O               | Broker å¯¦ç¾å¯é  Producer/Consumer | CPU å¯†é›†ç›´æ¥åœ¨ thread åŸ·è¡Œ            | æ¯å€‹è«‹æ±‚å ç”¨ä¸€å€‹ thread â†’ memory è²´ | åˆ†å¸ƒå¼ä»»å‹™ã€ä¼æ¥­å¾Œç«¯            | ã€ŒåŒæ­¥ I/O + EDAï¼Œå®¹æ˜“ç†è§£ä½† memory è²´ã€ |
| **äº‹ä»¶è¿´åœˆï¼ˆå–®ç´”å…§å­˜ queueï¼‰** | éé˜»å¡ async / coroutine / event loop | å…§å­˜ queue ç®¡ç†ä»»å‹™ï¼Œåƒ…é€²ç¨‹å…§æœ‰æ•ˆ          | CPU å¯†é›†éœ€å¤šäº‹ä»¶è¿´åœˆæˆ– thread pool      | å°‘é‡ threadï¼Œmemory çœ         | I/O å¯†é›†ã€å–®é€²ç¨‹ / å–® worker | ã€Œäº‹ä»¶é©…å‹•ä½†ä¸ç®—å®Œæ•´ EDAï¼Œé©åˆé«˜ä½µç™¼è¼•é‡ä»»å‹™ã€     |

### **ğŸ¯ äº‹ä»¶è¿´åœˆçš„å±€é™æ€§ï¼šç‚ºä»€éº¼ Node.js ä¸æ˜¯å¾Œç«¯ä¸»æµï¼Ÿ**

å„˜ç®¡äº‹ä»¶è¿´åœˆå¾ˆå¼·å¤§ï¼Œä½†å®ƒä¹Ÿæœ‰å¤©ç”Ÿé™åˆ¶ï¼š

#### **1ï¸âƒ£ CPU å¯†é›†ä»»å‹™çš„ç—›é»**
```javascript
// é€™å€‹é‹ç®—æœƒå¡ä½æ•´å€‹ event loopï¼
app.get('/heavy-calculation', (req, res) => {
  for(let i = 0; i < 1000000000; i++) {
    // é‡é‹ç®—... æœƒè®“å…¶ä»–è«‹æ±‚å»¶é²ï¼
  }
  res.send('Done');
});
```

**è§£æ±ºæ–¹æ¡ˆï¼š**
- ä¸Ÿåˆ° C++ addon
- ç”¨ Worker Threads
- åˆ†æ•£åˆ°å…¶ä»–å¾®æœå‹™

#### **2ï¸âƒ£ å–®åŸ·è¡Œç·’çš„æ¥µé™**
- **è¨˜æ†¶é«”æ´©æ¼**ï¼šä¸€å€‹ bug å°±å¯èƒ½è®“æ•´å€‹æ‡‰ç”¨å´©æ½°
- **éŒ¯èª¤è™•ç†**ï¼šuncaughtException æœƒçµ‚æ­¢æ•´å€‹ process
- **æ“´å±•æ€§**ï¼šå¾ˆé›£å……åˆ†åˆ©ç”¨å¤šæ ¸å¿ƒ CPU

### **ğŸ’¡ çµè«–ï¼šäº‹ä»¶è¿´åœˆæ˜¯æœªä¾†çš„è¶¨å‹¢ï¼Œä½†ä¸æ˜¯å”¯ä¸€è§£**

1. **WebFlux/ASGI/Node.js**ï¼šäº‹ä»¶è¿´åœˆç‚ºæ ¸å¿ƒï¼Œé©åˆ I/O å¯†é›†æ‡‰ç”¨
2. **å‚³çµ± MVC/WSGI**ï¼šThread Pool ç‚ºæ ¸å¿ƒï¼Œé©åˆ CPU å¯†é›†æˆ–ç°¡å–®æ‡‰ç”¨
3. **æ··åˆéƒ¨ç½²**ï¼šç”¨å‚³çµ±æ¡†æ¶è™•ç†ç°¡å–®è«‹æ±‚ï¼Œç”¨äº‹ä»¶è¿´åœˆæ¡†æ¶è™•ç†é«˜ä½µç™¼

**é—œéµæ´å¯Ÿï¼š** äº‹ä»¶è¿´åœˆä¸æ˜¯éŠ€å½ˆï¼Œå®ƒè§£æ±ºäº† I/O é˜»å¡çš„å•é¡Œï¼Œä½†å¸¶ä¾†äº†ç¨‹å¼è¨­è¨ˆè¤‡é›œåº¦çš„æå‡ã€‚é¸æ“‡æ¡†æ¶æ™‚ï¼Œè¦æ ¹æ“šä½ çš„æ‡‰ç”¨ç‰¹æ€§ä¾†æ±ºå®šï¼

## ğŸŒ å‚³çµ±ä¸–ç•Œ vs æ–°ä¸–ç•Œ

### **ğŸ”´ å‚³çµ±ä¸–ç•Œï¼šSpring MVCã€Django WSGI**

```java
// Spring MVCï¼šä¸€å€‹è«‹æ±‚ = ä¸€å€‹ thread
@RestController
public class TraditionalController {
    @GetMapping("/sync")
    public String syncEndpoint() {
        // Thread æœƒåœ¨é€™è£¡å¡ä½ç­‰å¾… I/O
        return blockingDatabaseCall();
    }
}
```

**ç‰¹é»ï¼š**
- **é˜»å¡å¼ã€thread-per-request** è¨­è¨ˆ
- Thread åœ¨ç­‰å¾…è³‡æ–™æ™‚ç›´æ¥å¡ä½
- åº•å±¤å¯èƒ½é‚„åœ¨ç”¨ select()/poll()
- äººä¸€å¤š thread å°±çˆ†æ‰

**æ¯”å–»ï¼š** ã€Œä¾†äº†ä¸€å€‹å®¢äººï¼Œæ´¾ä¸€å€‹å°ˆå±¬æœå‹™ç”Ÿï¼Œæœå‹™ç”Ÿè¦ç­‰å»šæˆ¿ä¸Šèœï¼Œå°±åªèƒ½ä¹¾ç­‰ï¼Œä¸èƒ½å»åšåˆ¥çš„äº‹ã€‚ã€

### **ğŸŸ¢ æ–°ä¸–ç•Œï¼šSpring WebFluxã€Django ASGI**

```java
// Spring WebFluxï¼šä¸€å€‹ thread ç®¡ç†æ‰€æœ‰è«‹æ±‚
@RestController
public class ReactiveController {
    @GetMapping("/reactive")
    public Mono<String> reactiveEndpoint() {
        // ä¸æœƒå¡ä½ threadï¼Œevent loop ç¹¼çºŒè™•ç†å…¶ä»–è«‹æ±‚
        return r2dbcTemplate.queryForObject("SELECT * FROM users", String.class);
    }
}
```

**ç‰¹é»ï¼š**
- **éé˜»å¡ + event loop** è¨­è¨ˆ
- Thread ä¸æœƒå‚»å‚»åœ°å¡ä½
- ç”¨ epoll/kqueue/IOCP ç”± OS å¹«å¿™ç›£è½
- ä¸€å€‹ thread å¯ä»¥ç®¡ç†æˆåƒä¸Šè¬è«‹æ±‚

**æ¯”å–»ï¼š** ã€Œåªæœ‰ä¸€å€‹è¶…å¼·ç®¡å®¶ï¼Œä»–ä¸ç”¨æ¯å¤©æ•¸å­¸ç”Ÿï¼Œè€Œæ˜¯å­¸ç”Ÿæœ‰äº‹è‡ªå·±èˆ‰æ‰‹ã€‚ã€

## å°æ‡‰è¡¨

| OS è½é›»è©±æ–¹å¼ | Spring Boot/Django å‚³çµ±ç‰ˆ | Spring Boot/Django éé˜»å¡ç‰ˆ |
|---------------|---------------------------|-----------------------------|
| **select/pollï¼ˆå‚»å‚»æƒï¼‰** | Spring MVC (Tomcat å‚³çµ± blocking I/O)<br/>Django WSGI (Gunicorn + sync workers) | å¹¾ä¹ä¸ç”¨ï¼ˆæ•ˆç‡å¤ªå·®ï¼‰ |
| **epoll (Linux)** | å‚³çµ± thread pool é‚„æ˜¯é˜»å¡ | **Spring WebFlux** (Netty on Linux)<br/>**Django ASGI** (uvicorn/daphne) |
| **kqueue (macOS/FreeBSD)** | åŒä¸Š | **Spring WebFlux** (Netty on macOS)<br/>**Django ASGI** (uvicorn on macOS) |
| **IOCP (Windows)** | åŒä¸Š | **Spring WebFlux** (Netty on Windows)<br/>**Django ASGI** (uvicorn on Windows) |

## ç¸½çµ

### **æ ¸å¿ƒæŠ€è¡“æ¼”é€²ï¼š**
1. **çŸ³å™¨æ™‚ä»£**ï¼šselect() - ä¸€å€‹ä¸€å€‹æª¢æŸ¥ï¼Œæ•ˆç‡ä½ä¸‹
2. **é’éŠ…æ™‚ä»£**ï¼špoll() - å°å¹…æ”¹å–„ï¼Œä»æœ‰ç“¶é ¸
3. **è³‡è¨Šæ™‚ä»£**ï¼šepoll/kqueue/IOCP - OS ä¸»å‹•é€šçŸ¥ï¼Œæ•ˆèƒ½çˆ†ç™¼

### **ç¾ä»£ Web æ¡†æ¶çš„ç§˜å¯†ï¼š**
- **å‚³çµ±æ¡†æ¶**ï¼šthread-per-requestï¼Œé æ•¸é‡å–å‹
- **ç¾ä»£æ¡†æ¶**ï¼ševent loop + I/O å¤šå·¥ï¼Œé æ™ºæ…§å–å‹

### **ğŸª å¯¦æˆ°å»ºè­°ï¼š**
- **æ–°å°ˆæ¡ˆ**ï¼šå„ªå…ˆè€ƒæ…® Spring WebFlux / Django ASGI
- **èˆŠå°ˆæ¡ˆ**ï¼šè©•ä¼°é·ç§»æˆæœ¬ vs æ•ˆèƒ½æ”¶ç›Š
- **æ··åˆéƒ¨ç½²**ï¼šå‚³çµ±æ¡†æ¶è™•ç†ç°¡å–®è«‹æ±‚ï¼Œç¾ä»£æ¡†æ¶è™•ç†é«˜ä½µç™¼

**ç†è§£ I/O å¤šå·¥ï¼Œå°±æ˜¯ç†è§£ç¾ä»£ Web æ¶æ§‹çš„ç²¾é«“ï¼** 