---
// ç¨ç«‹æ¸¬è©¦é¢æ¿çµ„ä»¶
---

<!-- æ¸¬è©¦é¢æ¿ -->
<div id="test-panel" class="test-panel hidden">
  <div class="test-panel-header">
    <h3>ğŸ”§ æ¸¬è©¦é¢æ¿</h3>
    <button id="close-test-panel" class="close-btn">&times;</button>
  </div>
  
  <div class="test-panel-content">
    <!-- æ¨™ç±¤é  -->
    <div class="test-tabs">
      <button class="tab-btn active" data-tab="api-test">API æ¸¬è©¦</button>
      <button class="tab-btn" data-tab="cache-test">ç·©å­˜ç®¡ç†</button>
      <button class="tab-btn" data-tab="monitor-test">ç³»çµ±ç›£æ§</button>
      <button class="tab-btn" data-tab="damage-test">å‚·å®³è¨ˆç®—</button>
    </div>
    
    <!-- API æ¸¬è©¦å…§å®¹ -->
    <div id="api-test" class="tab-content active">
      <div class="test-section">
        <h4>ğŸŒ API é€£æ¥æ¸¬è©¦</h4>
        <div id="api-test-results" class="test-results">è¼‰å…¥ä¸­...</div>
        <button id="test-api-btn" class="test-btn">æ¸¬è©¦ API</button>
      </div>
    </div>
    
    <!-- ç·©å­˜ç®¡ç†å…§å®¹ -->
    <div id="cache-test" class="tab-content">
      <div class="test-section">
        <h4>ğŸ’¾ ç·©å­˜ç®¡ç†</h4>
        <div id="cache-status" class="test-results">è¼‰å…¥ä¸­...</div>
        <div class="test-buttons">
          <button id="clear-cache-btn" class="test-btn">æ¸…é™¤ç·©å­˜</button>
          <button id="refresh-cache-btn" class="test-btn">åˆ·æ–°æ•¸æ“š</button>
        </div>
      </div>
    </div>
    
    <!-- ç³»çµ±ç›£æ§å…§å®¹ -->
    <div id="monitor-test" class="tab-content">
      <div class="test-section">
        <h4>ğŸ“Š ç³»çµ±ç›£æ§</h4>
        <div id="health-status" class="test-results">è¼‰å…¥ä¸­...</div>
        <div id="consumer-status" class="test-results">è¼‰å…¥ä¸­...</div>
        <div id="api-metrics" class="test-results">è¼‰å…¥ä¸­...</div>
        <div id="error-stats" class="test-results">è¼‰å…¥ä¸­...</div>
        <div class="test-buttons">
          <button id="refresh-monitor-btn" class="test-btn">åˆ·æ–°ç›£æ§</button>
          <button id="export-diagnostics-btn" class="test-btn">å°å‡ºè¨ºæ–·</button>
        </div>
      </div>
    </div>
    
    <!-- å‚·å®³è¨ˆç®—å…§å®¹ -->
    <div id="damage-test" class="tab-content">
      <div class="test-section">
        <h4>ğŸ—¡ï¸ å‚·å®³è¨ˆç®—æ¸¬è©¦</h4>
        <div class="damage-test-input">
          <input type="text" id="damage-test-character" placeholder="è¼¸å…¥è§’è‰²åç¨±" value="Wavo">
          <button id="test-damage-btn" class="test-btn">æ¸¬è©¦å‚·å®³è¨ˆç®—</button>
        </div>
        <div id="damage-test-results" class="test-results">ç­‰å¾…æ¸¬è©¦...</div>
      </div>
    </div>
  </div>
</div>

<style>
  /* æ¸¬è©¦é¢æ¿ */
  .test-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90vw;
    max-width: 800px;
    height: 80vh;
    background: #1a1a1a;
    border: 2px solid #333;
    border-radius: 12px;
    z-index: 10001;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }

  .test-panel.hidden {
    display: none;
  }

  .test-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #333;
    background: #2a2a2a;
    border-radius: 10px 10px 0 0;
  }

  .test-panel-header h3 {
    margin: 0;
    color: #fff;
    font-size: 18px;
  }

  .close-btn {
    background: none;
    border: none;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
  }

  .close-btn:hover {
    background: #444;
  }

  .test-panel-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* æ¨™ç±¤é  */
  .test-tabs {
    display: flex;
    background: #2a2a2a;
    border-bottom: 1px solid #333;
  }

  .tab-btn {
    flex: 1;
    padding: 12px;
    background: none;
    border: none;
    color: #ccc;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
  }

  .tab-btn:hover {
    background: #3a3a3a;
    color: #fff;
  }

  .tab-btn.active {
    background: #4a4a4a;
    color: #fff;
    border-bottom: 2px solid #667eea;
  }

  /* æ¨™ç±¤å…§å®¹ */
  .tab-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .test-section {
    margin-bottom: 25px;
  }

  .test-section h4 {
    margin: 0 0 15px 0;
    color: #fff;
    font-size: 16px;
  }

  .test-results {
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
    color: #ccc;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    max-height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
  }

  .test-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin-right: 10px;
    margin-bottom: 10px;
    transition: all 0.2s;
  }

  .test-btn:hover {
    background: #5a6fd8;
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.4);
    transform: translateY(-1px);
  }

  .test-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .damage-test-input {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .damage-test-input input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #444;
    border-radius: 4px;
    background: #2a2a2a;
    color: #fff;
    font-size: 14px;
  }

  .damage-test-input input::placeholder {
    color: #666;
  }

  /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
  @media (max-width: 768px) {
    .test-panel {
      width: 95vw;
      height: 90vh;
    }
    
    .test-tabs {
      flex-direction: column;
    }
    
    .damage-test-input {
      flex-direction: column;
    }
  }
</style>

<script>
  class TestPanel {
    private isOpen = false;
    private serviceManager: any;
    private characterService: any;
    private damageService: any;

    constructor() {
      this.initialize();
    }

    private async initialize(): Promise<void> {
      await this.loadServices();
      this.setupEventListeners();
      this.initializeTabs();
    }

    private async loadServices(): Promise<void> {
      try {
        const ServiceManager = (await import('../services/serviceManager')).default;
        this.serviceManager = ServiceManager.getInstance();
        
        const CharacterService = (await import('../services/characterService')).default;
        this.characterService = CharacterService.getInstance();
        
        const DamageService = (await import('../services/damageService')).default;
        this.damageService = DamageService.getInstance();
      } catch (error) {
        console.error('è¼‰å…¥æœå‹™å¤±æ•—:', error);
      }
    }

    private setupEventListeners(): void {
      // é—œé–‰é¢æ¿
      const closeBtn = document.getElementById('close-test-panel');
      const panel = document.getElementById('test-panel');

      closeBtn?.addEventListener('click', () => this.closePanel());

      // é»æ“Šå¤–éƒ¨é—œé–‰
      document.addEventListener('click', (e) => {
        if (panel && !panel.contains(e.target as Node)) {
          this.closePanel();
        }
      });

      // API æ¸¬è©¦
      const testApiBtn = document.getElementById('test-api-btn');
      testApiBtn?.addEventListener('click', () => this.testAPI());

      // ç·©å­˜ç®¡ç†
      const clearCacheBtn = document.getElementById('clear-cache-btn');
      const refreshCacheBtn = document.getElementById('refresh-cache-btn');
      clearCacheBtn?.addEventListener('click', () => this.clearCache());
      refreshCacheBtn?.addEventListener('click', () => this.refreshCache());

      // ç³»çµ±ç›£æ§
      const refreshMonitorBtn = document.getElementById('refresh-monitor-btn');
      const exportDiagnosticsBtn = document.getElementById('export-diagnostics-btn');
      refreshMonitorBtn?.addEventListener('click', () => this.refreshMonitor());
      exportDiagnosticsBtn?.addEventListener('click', () => this.exportDiagnostics());

      // å‚·å®³è¨ˆç®—
      const testDamageBtn = document.getElementById('test-damage-btn');
      testDamageBtn?.addEventListener('click', () => this.testDamage());
    }

    private initializeTabs(): void {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.getAttribute('data-tab');
          
          // ç§»é™¤æ‰€æœ‰æ´»å‹•ç‹€æ…‹
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // æ·»åŠ æ´»å‹•ç‹€æ…‹
          btn.classList.add('active');
          const targetContent = document.getElementById(targetTab!);
          targetContent?.classList.add('active');
          
          // è¼‰å…¥å°æ‡‰æ•¸æ“š
          this.loadTabData(targetTab!);
        });
      });
    }

    private loadTabData(tabName: string): void {
      switch (tabName) {
        case 'api-test':
          this.testAPI();
          break;
        case 'cache-test':
          this.updateCacheStatus();
          break;
        case 'monitor-test':
          this.refreshMonitor();
          break;
        case 'damage-test':
          // å‚·å®³æ¸¬è©¦éœ€è¦ç”¨æˆ¶è¼¸å…¥ï¼Œä¸è‡ªå‹•è¼‰å…¥
          break;
      }
    }

    public openPanel(): void {
      this.isOpen = true;
      const panel = document.getElementById('test-panel');
      panel?.classList.remove('hidden');
      this.loadTabData('api-test'); // è¼‰å…¥ç¬¬ä¸€å€‹æ¨™ç±¤é æ•¸æ“š
    }

    private closePanel(): void {
      this.isOpen = false;
      document.getElementById('test-panel')?.classList.add('hidden');
    }

    // API æ¸¬è©¦
    private async testAPI(): Promise<void> {
      const resultsDiv = document.getElementById('api-test-results');
      if (!resultsDiv) return;

      resultsDiv.textContent = 'æ¸¬è©¦ä¸­...';

      try {
        const baseUrl = import.meta.env.PUBLIC_TYMB_URL;
        if (!baseUrl) {
          resultsDiv.textContent = 'âŒ ç’°å¢ƒè®Šé‡æœªè¨­ç½®';
          return;
        }

        const response = await fetch(`${baseUrl}/people/get-all`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'include'
        });

        if (!response.ok) {
          resultsDiv.textContent = `âŒ API éŒ¯èª¤: ${response.status}`;
          return;
        }

        const data = await response.json();
        resultsDiv.textContent = `âœ… API æ­£å¸¸\néŸ¿æ‡‰: ${JSON.stringify(data, null, 2)}`;

        if (data.status === 'processing' && data.requestId) {
          resultsDiv.textContent += '\nğŸ”„ é–‹å§‹è¼ªè©¢çµæœ...';
          await this.pollForResult(data.requestId, baseUrl, resultsDiv);
        }
      } catch (error) {
        resultsDiv.textContent = `âŒ æ¸¬è©¦å¤±æ•—: ${error}`;
      }
    }

    private async pollForResult(requestId: string, baseUrl: string, resultsDiv: HTMLElement): Promise<void> {
      for (let attempt = 1; attempt <= 5; attempt++) {
        try {
          const existsResponse = await fetch(`${baseUrl}/api/request-status/${requestId}/exists`, {
            credentials: 'include'
          });

          if (existsResponse.ok) {
            const existsData = await existsResponse.json();
            if (existsData.exists) {
              const resultResponse = await fetch(`${baseUrl}/api/request-status/${requestId}`, {
                credentials: 'include'
              });

              if (resultResponse.ok) {
                const result = await resultResponse.json();
                resultsDiv.textContent += `\nâœ… è¼ªè©¢æˆåŠŸï¼\nçµæœ: ${JSON.stringify(result, null, 2)}`;
                return;
              }
            }
          }

          await new Promise(resolve => setTimeout(resolve, 3000));
        } catch (error) {
          resultsDiv.textContent += `\nâŒ è¼ªè©¢å¤±æ•—: ${error}`;
          return;
        }
      }

      resultsDiv.textContent += '\nâŒ è¼ªè©¢è¶…æ™‚';
    }

    // ç·©å­˜ç®¡ç†
    private async updateCacheStatus(): Promise<void> {
      const statusDiv = document.getElementById('cache-status');
      if (!statusDiv) return;

      try {
        const status = this.characterService.getCacheStatus();
        statusDiv.textContent = `ç·©å­˜ç‹€æ…‹: ${JSON.stringify(status, null, 2)}`;
      } catch (error) {
        statusDiv.textContent = `âŒ ç²å–ç·©å­˜ç‹€æ…‹å¤±æ•—: ${error}`;
      }
    }

    private async clearCache(): Promise<void> {
      try {
        this.characterService.clearCache();
        this.damageService.clearDamageCache();
        this.serviceManager.clearAllStats();
        this.updateCacheStatus();
        alert('ç·©å­˜å·²æ¸…é™¤');
      } catch (error) {
        alert(`æ¸…é™¤ç·©å­˜å¤±æ•—: ${error}`);
      }
    }

    private async refreshCache(): Promise<void> {
      try {
        await this.characterService.refreshCharacters();
        this.updateCacheStatus();
        alert('æ•¸æ“šå·²åˆ·æ–°');
      } catch (error) {
        alert(`åˆ·æ–°æ•¸æ“šå¤±æ•—: ${error}`);
      }
    }

    // ç³»çµ±ç›£æ§
    private async refreshMonitor(): Promise<void> {
      try {
        const health = await this.serviceManager.getSystemHealth();
        const consumerStatus = this.serviceManager.getConsumerStatus();
        const apiMetrics = this.serviceManager.getAPIMetrics();
        const errorStats = this.serviceManager.getErrorStats();

        document.getElementById('health-status')!.textContent = 
          `ç³»çµ±å¥åº·: ${JSON.stringify(health, null, 2)}`;
        
        document.getElementById('consumer-status')!.textContent = 
          `Consumer ç‹€æ…‹: ${JSON.stringify(consumerStatus, null, 2)}`;
        
        document.getElementById('api-metrics')!.textContent = 
          `API æŒ‡æ¨™: ${JSON.stringify(Array.from(apiMetrics.entries()), null, 2)}`;
        
        document.getElementById('error-stats')!.textContent = 
          `éŒ¯èª¤çµ±è¨ˆ: ${JSON.stringify(errorStats, null, 2)}`;
      } catch (error) {
        console.error('åˆ·æ–°ç›£æ§å¤±æ•—:', error);
      }
    }

    private exportDiagnostics(): void {
      try {
        const diagnostics = this.serviceManager.exportDiagnostics();
        const blob = new Blob([diagnostics], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `diagnostics-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('è¨ºæ–·ä¿¡æ¯å·²å°å‡º');
      } catch (error) {
        alert(`å°å‡ºå¤±æ•—: ${error}`);
      }
    }

    // å‚·å®³è¨ˆç®—
    private async testDamage(): Promise<void> {
      const characterInput = document.getElementById('damage-test-character') as HTMLInputElement;
      const resultsDiv = document.getElementById('damage-test-results');
      
      if (!characterInput || !resultsDiv) return;

      const characterName = characterInput.value.trim();
      if (!characterName) {
        resultsDiv.textContent = 'âŒ è«‹è¼¸å…¥è§’è‰²åç¨±';
        return;
      }

      resultsDiv.textContent = 'è¨ˆç®—ä¸­...';

      try {
        const damage = await this.damageService.getCharacterDamage(characterName);
        resultsDiv.textContent = `âœ… ${characterName} çš„å‚·å®³å€¼: ${damage}`;
      } catch (error) {
        resultsDiv.textContent = `âŒ å‚·å®³è¨ˆç®—å¤±æ•—: ${error}`;
      }
    }
  }

  // åˆå§‹åŒ–æ¸¬è©¦é¢æ¿
  (window as any).testPanel = new TestPanel();
</script>
