<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fight</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
      }
      .fightercontainer {
        display: flex;
        width: 1800px;
        height: 400px;
        padding-top: 50px;
        padding-bottom: 50px;
        margin: 0 auto;
      }
      .half {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0;
      }
      .imagefighter {
        max-width: 100%;
        max-height: 900px;
        border: 1px solid #000;
        margin-bottom: 10px;
      }
      .button-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        max-width: 100%;
      }
      .button {
        padding: 2px 5px;
        font-size: 10px;
        cursor: pointer;
        margin: 1px;
      }
      .button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .info-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 10px;
      }
      .info-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 5px;
      }
      .info {
        margin: 0 10px;
        font-size: 14px;
      }
      /* 縮小 Total Power 的字體 */
      .info-container #leftTotalPower,
      .info-container #rightTotalPower {
        font-size: 12px;
        opacity: 0.8;
      }
      .fightbutton {
        width: 1800px;
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        z-index: 1000;
      }
      .fightbutton button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }
      .result {
        font-weight: bold;
        margin-top: 5px;
        font-size: 70%; /* 縮小結果顯示的字體 */
      }
      .win {
        color: green;
        font-size: 24px; /* 從60px縮小到24px */
      }
      .defeated {
        color: rgb(146, 1, 1);
        font-size: 24px; /* 從60px縮小到24px */
      }
      .fdefeated {
        color: rgb(255, 41, 41);
        font-size: 24px; /* 從60px縮小到24px */
      }
      .sdefeated {
        color: rgb(255, 85, 85);
        font-size: 24px; /* 從60px縮小到24px */
      }
    </style>
  </head>
  <body>
    <div class="fightbutton">
      <button onclick="startFight()">Fight</button>
    </div>
    <div class="fightercontainer">
      <div class="half">
        <img
          id="leftImage"
          class="imagefighter"
          src="/tymultiverse/assets/person/default.png"
          alt="Left Image"
        />
        <div id="leftInfo" class="info-container">
          <div class="info" id="leftName"></div>
          <div id="leftResult" class="result-image"></div>
          <div class="info-row">
            <div class="info" id="leftPhysicPower"></div>
            <div class="info" id="leftMagicPower"></div>
            <div class="info" id="leftUtilityPower"></div>
          </div>
          <div class="info" id="leftAttributes"></div>
          <div class="info" id="leftTotalPower"></div>
        </div>
        <div class="button-container" id="leftButtons"></div>
      </div>
      <div class="half">
        <img
          id="rightImage"
          class="imagefighter"
          src="/tymultiverse/assets/person/default.png"
          alt="Right Image"
        />
        <div id="rightInfo" class="info-container">
          <div class="info" id="rightName"></div>
          <div id="rightResult" class="result-image"></div>
          <div class="info-row">
            <div class="info" id="rightPhysicPower"></div>
            <div class="info" id="rightMagicPower"></div>
            <div class="info" id="rightUtilityPower"></div>
          </div>
          <div class="info" id="rightAttributes"></div>
          <div class="info" id="rightTotalPower"></div>
        </div>
        <div class="button-container" id="rightButtons"></div>
      </div>
    </div>
    <script>
      // 全局設置與狀態
      const config = {
        baseImagePath: "/tymultiverse/assets/person/",
        apiEndpoint: "https://peoplesystem.tatdvsonorth.com/tymb/people/get-by-name",
        defaultImage: "/tymultiverse/assets/person/default.png"
      };
      
      // 角色名稱列表
      const characterNames = [
        "Cleopatra", "Sofia", "Ashe", "Siyu", "Eris", "SayuriRuined", "MasakoEntering",
        "SpokeTied", "Natsumi", "Draeny", "Aile", "MayoPumped", "Doire", "Miyako",
        "Wavo", "Azusa", "Miku", "Spoke", "Monroe", "Hitomi", "Mayo", "KamiraPeeing",
        "Riuri", "Samui", "Z", "Yuko", "Yui", "Valmet", "Uiobbeci", "Taisy", 
        "Sorane", "Shuan", "Sayuri", "Paprika", "Nianca", "Medicis", "Miyu", 
        "Mesoyei", "Masako", "Lucrece", "Kyu", "Kristae", "Kazuko", "Kamira", 
        "Etsuko", "Delsa", "Chiaki", "Caleigh", "Branwen", "Ann", "Isina"
      ];

      // 生成圖片路徑
      const imagePaths = characterNames.map(name => `${config.baseImagePath}${name}.png`);
      
      // 紀錄選擇的角色
      const fighters = {
        left: { image: null, totalPower: 0, name: null },
        right: { image: null, totalPower: 0, name: null }
      };
      
      // DOM 元素快速訪問
      const elements = {
        leftImage: document.getElementById("leftImage"),
        rightImage: document.getElementById("rightImage"),
        leftButtons: document.getElementById("leftButtons"),
        rightButtons: document.getElementById("rightButtons")
      };
      
      // 初始化函數
      function init() {
        createButtons("leftButtons", "left");
        createButtons("rightButtons", "right");
      }
      
      // 創建角色選擇按鈕
      function createButtons(containerId, side) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        
        imagePaths.forEach(imagePath => {
          const name = getNameFromPath(imagePath);
          const button = document.createElement("button");
          button.textContent = name;
          button.className = "button";
          button.onclick = () => selectFighter(side, imagePath);
          container.appendChild(button);
        });
      }
      
      // 從路徑中提取名稱
      function getNameFromPath(path) {
        return path.split("/").pop().split(".")[0];
      }
      
      // 選擇角色
      function selectFighter(side, imagePath) {
        const otherSide = side === "left" ? "right" : "left";
        const selectedName = getNameFromPath(imagePath);
        
        // 檢查是否與另一邊選擇相同的角色
        if (fighters[otherSide].image && getNameFromPath(fighters[otherSide].image) === selectedName) {
          return; // 不允許兩邊選擇相同角色
        }
        
        // 更新選擇
        fighters[side].image = imagePath;
        fighters[side].name = selectedName; // 保存角色名稱
        document.getElementById(`${side}Image`).src = imagePath;
        updateButtonStates();
        fetchFighterInfo(side, imagePath); // 傳遞完整圖片路徑，確保正確提取名稱
      }
      
      // 更新按鈕狀態 (禁用已選擇的角色)
      function updateButtonStates() {
        const leftName = fighters.left.image ? getNameFromPath(fighters.left.image) : null;
        const rightName = fighters.right.image ? getNameFromPath(fighters.right.image) : null;
        
        // 更新左側按鈕狀態
        document.querySelectorAll("#leftButtons .button").forEach(button => {
          button.classList.toggle("disabled", button.textContent === rightName);
        });
        
        // 更新右側按鈕狀態
        document.querySelectorAll("#rightButtons .button").forEach(button => {
          button.classList.toggle("disabled", button.textContent === leftName);
        });
      }
      
      // 獲取角色資訊
      async function fetchFighterInfo(side, imagePath) {
        try {
          // 從圖片路徑提取出正確的名稱
          const name = getNameFromPath(imagePath);
          console.log(`正在獲取角色資訊: ${name} (從圖片路徑: ${imagePath})`);
          
          // 測試數據 - 擴充的角色數據庫
          const testData = {
            // 原始角色
            "Miku": { physicPower: 85, magicPower: 75, utilityPower: 90, attributes: "Cute, Singer" },
            "Wavo": { physicPower: 95, magicPower: 65, utilityPower: 70, attributes: "Strong, Brave" },
            "Azusa": { physicPower: 70, magicPower: 95, utilityPower: 85, attributes: "Magical, Smart" },
            "Spoke": { physicPower: 90, magicPower: 80, utilityPower: 60, attributes: "Tactical, Fast" },
            "Hitomi": { physicPower: 75, magicPower: 90, utilityPower: 75, attributes: "Precise, Agile" },
            
            // 新增角色
            "Cleopatra": { physicPower: 70, magicPower: 90, utilityPower: 95, attributes: "Royal, Charismatic" },
            "Sofia": { physicPower: 85, magicPower: 75, utilityPower: 80, attributes: "Intelligent, Strategic" },
            "Ashe": { physicPower: 92, magicPower: 60, utilityPower: 78, attributes: "Athletic, Determined" },
            "Siyu": { physicPower: 65, magicPower: 95, utilityPower: 85, attributes: "Mystical, Wise" },
            "Eris": { physicPower: 85, magicPower: 90, utilityPower: 95, attributes: "Chaotic, Powerful" },
            "SayuriRuined": { physicPower: 60, magicPower: 100, utilityPower: 90, attributes: "Corrupted, Unstable" },
            "Sayuri": { physicPower: 75, magicPower: 85, utilityPower: 80, attributes: "Graceful, Skilled" },
            "MasakoEntering": { physicPower: 80, magicPower: 85, utilityPower: 70, attributes: "Curious, Adventurous" },
            "Masako": { physicPower: 85, magicPower: 80, utilityPower: 75, attributes: "Balanced, Disciplined" },
            "SpokeTied": { physicPower: 70, magicPower: 85, utilityPower: 65, attributes: "Restrained, Vulnerable" },
            "Natsumi": { physicPower: 88, magicPower: 72, utilityPower: 80, attributes: "Energetic, Friendly" },
            "Draeny": { physicPower: 95, magicPower: 70, utilityPower: 75, attributes: "Powerful, Draconic" },
            "Aile": { physicPower: 80, magicPower: 85, utilityPower: 90, attributes: "Swift, Adaptable" },
            "MayoPumped": { physicPower: 95, magicPower: 65, utilityPower: 75, attributes: "Enhanced, Strong" },
            "Mayo": { physicPower: 75, magicPower: 80, utilityPower: 85, attributes: "Skilled, Versatile" },
            "Miyako": { physicPower: 70, magicPower: 95, utilityPower: 80, attributes: "Mystical, Elegant" },
            "Doire": { physicPower: 92, magicPower: 60, utilityPower: 85, attributes: "Natural, Wild" },
            "Monroe": { physicPower: 75, magicPower: 85, utilityPower: 90, attributes: "Charming, Iconic" },
            "KamiraPeeing": { physicPower: 60, magicPower: 70, utilityPower: 65, attributes: "Vulnerable, Embarrassed" },
            "Kamira": { physicPower: 80, magicPower: 85, utilityPower: 75, attributes: "Balanced, Focused" },
            "Riuri": { physicPower: 85, magicPower: 70, utilityPower: 90, attributes: "Quick, Resourceful" },
            "Samui": { physicPower: 75, magicPower: 80, utilityPower: 85, attributes: "Cool, Collected" },
            "Z": { physicPower: 95, magicPower: 65, utilityPower: 80, attributes: "Mysterious, Powerful" },
            "Yuko": { physicPower: 80, magicPower: 75, utilityPower: 85, attributes: "Friendly, Helpful" },
            "Yui": { physicPower: 70, magicPower: 90, utilityPower: 85, attributes: "Intelligent, Analytical" },
            "Valmet": { physicPower: 95, magicPower: 60, utilityPower: 85, attributes: "Military, Precise" },
            "Uiobbeci": { physicPower: 85, magicPower: 90, utilityPower: 75, attributes: "Complex, Layered" },
            "Taisy": { physicPower: 90, magicPower: 75, utilityPower: 80, attributes: "Resolute, Brave" },
            "Sorane": { physicPower: 70, magicPower: 95, utilityPower: 85, attributes: "Sky-touched, Free" },
            "Shuan": { physicPower: 85, magicPower: 75, utilityPower: 80, attributes: "Traditional, Grounded" },
            "Paprika": { physicPower: 75, magicPower: 90, utilityPower: 80, attributes: "Spicy, Vibrant" },
            "Nianca": { physicPower: 80, magicPower: 85, utilityPower: 75, attributes: "Balanced, Smooth" },
            "Medicis": { physicPower: 70, magicPower: 95, utilityPower: 85, attributes: "Healing, Supportive" },
            "Miyu": { physicPower: 75, magicPower: 90, utilityPower: 80, attributes: "Beautiful, Elegant" },
            "Mesoyei": { physicPower: 85, magicPower: 80, utilityPower: 75, attributes: "Mysterious, Ancient" },
            "Lucrece": { physicPower: 80, magicPower: 85, utilityPower: 90, attributes: "Noble, Refined" },
            "Kyu": { physicPower: 90, magicPower: 75, utilityPower: 80, attributes: "Strong, Direct" },
            "Kristae": { physicPower: 75, magicPower: 90, utilityPower: 85, attributes: "Crystal, Pure" },
            "Kazuko": { physicPower: 85, magicPower: 80, utilityPower: 75, attributes: "Harmonious, Peaceful" },
            "Etsuko": { physicPower: 70, magicPower: 95, utilityPower: 80, attributes: "Child-like, Innocent" },
            "Delsa": { physicPower: 80, magicPower: 85, utilityPower: 90, attributes: "Refined, Cultured" },
            "Chiaki": { physicPower: 75, magicPower: 90, utilityPower: 80, attributes: "Bright, Intelligent" },
            "Caleigh": { physicPower: 85, magicPower: 75, utilityPower: 90, attributes: "Spirited, Energetic" },
            "Branwen": { physicPower: 80, magicPower: 90, utilityPower: 75, attributes: "Raven, Mystical" },
            "Ann": { physicPower: 90, magicPower: 70, utilityPower: 85, attributes: "Simple, Strong" }
          };
          
          // 嘗試從 API 獲取數據 - 使用從PNG檔名提取的名稱
          try {
            const apiName = name; // 使用從圖片路徑提取的名稱作為API查詢參數
            console.log(`API查詢參數: ${apiName}`);
            
            const response = await fetch(config.apiEndpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name: apiName }), // 確保使用正確的參數名稱
              credentials: 'include'
            });
            
            if (!response.ok) {
              throw new Error(`API 返回錯誤: ${response.status}`);
            }
            
            const data = await response.json();
            
            // 處理API回傳數據
            if (data && data.name) {
              console.log("從API獲取角色數據:", data);
              updateFighterInfo(side, data);
              return;
            }
            throw new Error("API 沒有返回有效數據");
          } catch (apiError) {
            console.warn(`API 請求失敗: ${apiError.message}，使用測試數據`);
            
            // 如果 API 失敗，使用測試數據
            if (testData[name]) {
              const mockFighter = {
                name: name,
                physicPower: testData[name].physicPower,
                magicPower: testData[name].magicPower,
                utilityPower: testData[name].utilityPower,
                attributes: testData[name].attributes,
                // 添加額外屬性，以防顯示需要
                nameOriginal: name,
                race: "Unknown",
                gender: "Unknown"
              };
              updateFighterInfo(side, mockFighter);
              return;
            }
            
            // 如果沒有測試數據，生成隨機數據
            const randomPower = () => Math.floor(Math.random() * 30) + 70; // 生成70-100之間的數字，更合理
            const mockFighter = {
              name: name,
              physicPower: randomPower(),
              magicPower: randomPower(),
              utilityPower: randomPower(),
              attributes: "Unknown",
              nameOriginal: name,
              race: "Unknown",
              gender: "Unknown"
            };
            
            console.log(`為 ${name} 生成隨機數據:`, mockFighter);
            updateFighterInfo(side, mockFighter);
          }
        } catch (error) {
          console.error("獲取角色資訊失敗:", error);
          clearFighterInfo(side);
        }
      }
      
      // 更新角色資訊
      function updateFighterInfo(side, fighter) {
        // 確保所有力量值都是數字，不是字符串
        const physicPower = parseInt(fighter.physicPower || 0, 10);
        const magicPower = parseInt(fighter.magicPower || 0, 10);
        const utilityPower = parseInt(fighter.utilityPower || 0, 10);
        const totalPower = physicPower + magicPower + utilityPower;
        
        // 顯示角色名稱，如果有原始名稱則顯示，否則使用name
        const displayName = fighter.nameOriginal && fighter.nameOriginal !== fighter.name ? 
                          `${fighter.name} (${fighter.nameOriginal})` : fighter.name;
        
        document.getElementById(`${side}Name`).textContent = displayName || "N/A";
        document.getElementById(`${side}PhysicPower`).textContent = `Physic Power: ${physicPower || "N/A"}`;
        document.getElementById(`${side}MagicPower`).textContent = `Magic Power: ${magicPower || "N/A"}`;
        document.getElementById(`${side}UtilityPower`).textContent = `Utility Power: ${utilityPower || "N/A"}`;
        
        // 顯示屬性及其他信息
        let attributesText = fighter.attributes || "N/A";
        if (fighter.race && fighter.race !== "Unknown") {
          attributesText += ` | ${fighter.race}`;
        }
        if (fighter.gender && fighter.gender !== "Unknown") {
          attributesText += ` | ${fighter.gender}`;
        }
        document.getElementById(`${side}Attributes`).textContent = `Attributes: ${attributesText}`;
        
        // 使Total Power顯示更小
        document.getElementById(`${side}TotalPower`).textContent = `Total Power: ${totalPower}`;
        
        // 確保存儲的總力量是數字
        fighters[side].totalPower = totalPower;
        
        // 調試輸出，檢查力量值
        console.log(`${side} fighter power:`, {
          name: fighter.name,
          physicPower,
          magicPower,
          utilityPower,
          totalPower
        });
      }
      
      // 清除角色資訊
      function clearFighterInfo(side) {
        document.getElementById(`${side}Name`).textContent = "";
        document.getElementById(`${side}PhysicPower`).textContent = "";
        document.getElementById(`${side}MagicPower`).textContent = "";
        document.getElementById(`${side}UtilityPower`).textContent = "";
        document.getElementById(`${side}Attributes`).textContent = "";
        document.getElementById(`${side}TotalPower`).textContent = "";
        fighters[side].totalPower = 0;
      }
      
      // 開始戰鬥
      function startFight() {
        const leftPower = parseInt(fighters.left.totalPower || 0, 10);
        const rightPower = parseInt(fighters.right.totalPower || 0, 10);
        
        // 調試輸出
        console.log("Fight powers:", { leftPower, rightPower });
        
        const leftResult = document.getElementById("leftResult");
        const rightResult = document.getElementById("rightResult");
        const leftTotalPower = document.getElementById("leftTotalPower");
        const rightTotalPower = document.getElementById("rightTotalPower");
        
        // 重設樣式和文本
        leftResult.textContent = "";
        rightResult.textContent = "";
        leftTotalPower.classList.remove("win", "defeated");
        rightTotalPower.classList.remove("win", "defeated");
        
        // 如果任一方未選擇角色或力量為0，顯示提示
        if (!fighters.left.image || !fighters.right.image) {
          alert("請先選擇兩邊的角色");
          return;
        }
        
        // 計算差距百分比
        const percentageDifference = Math.abs(leftPower - rightPower) / Math.max(leftPower, rightPower, 1);
        console.log("Percentage difference:", percentageDifference);
        
        // 確定勝負
        if (leftPower > rightPower) {
          determineWinner("left", "right", leftPower, rightPower, percentageDifference);
        } else if (rightPower > leftPower) {
          determineWinner("right", "left", rightPower, leftPower, percentageDifference);
        } else {
          // 平局
          leftResult.textContent = "Draw";
          rightResult.textContent = "Draw";
          // 直接使用保存的角色名稱
          document.getElementById("leftName").innerHTML = 
            `${fighters.left.name} <span class='result'>draw</span>`;
          document.getElementById("rightName").innerHTML = 
            `${fighters.right.name} <span class='result'>draw</span>`;
        }
      }
      
      // 確定勝負和結果顯示
      function determineWinner(winnerSide, loserSide, winnerPower, loserPower, difference) {
        const winnerElement = document.getElementById(`${winnerSide}TotalPower`);
        const loserElement = document.getElementById(`${loserSide}TotalPower`);
        const winnerResult = document.getElementById(`${winnerSide}Result`);
        const loserResult = document.getElementById(`${loserSide}Result`);
        const winnerName = document.getElementById(`${winnerSide}Name`);
        const loserName = document.getElementById(`${loserSide}Name`);
        
        // 設置樣式
        winnerElement.classList.add("win");
        loserElement.classList.add("defeated");
        
        // 計算失敗百分比
        const lossPercentage = ((winnerPower - loserPower) / winnerPower * 100).toFixed(2);
        
        // 顯示基本結果
        winnerResult.textContent = "Winner";
        loserResult.textContent = `${lossPercentage}% Defeated`;
        
        // 根據差距程度顯示不同結果
        // 直接使用保存的名稱，而不是從圖片路徑中提取
        const winnerCharName = fighters[winnerSide].name;
        const loserCharName = fighters[loserSide].name;
        
        if (difference > 0.4) {
          winnerName.innerHTML = `${winnerCharName} <span class='result win'>Dominating</span>`;
          loserName.innerHTML = `${loserCharName} <span class='result defeated'>Ravished</span>`;
        } else if (difference > 0.1) {
          winnerName.innerHTML = `${winnerCharName} <span class='result win'>Destroying</span>`;
          loserName.innerHTML = `${loserCharName} <span class='result fdefeated'>Fucked Up</span>`;
        } else {
          winnerName.innerHTML = `${winnerCharName} <span class='result win'>Barely Succeed</span>`;
          loserName.innerHTML = `${loserCharName} <span class='result sdefeated'>Slightly Defeated</span>`;
        }
      }
      
      // 頁面載入時初始化
      window.onload = init;
    </script>
  </body>
</html>
