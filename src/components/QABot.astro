---
// QABotçµ„ä»¶
import '../styles/qabot.css';
---

<style>
  /* è‡ªå®šç¾© SweetAlert æ¨£å¼ */
  .swal-login-popup {
    border-radius: 16px !important;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
    border: none !important;
    overflow: hidden !important;
  }

  .swal-login-title {
    font-size: 24px !important;
    font-weight: 600 !important;
    color: #2c3e50 !important;
    margin-bottom: 10px !important;
  }

  .swal-login-content {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
  }

  .swal-login-content p {
    line-height: 1.6 !important;
    margin: 0 !important;
  }

  /* æŒ‰éˆ•æ¨£å¼ */
  .swal2-confirm {
    border-radius: 8px !important;
    font-weight: 500 !important;
    padding: 12px 24px !important;
    font-size: 14px !important;
    transition: all 0.2s ease !important;
  }

  .swal2-cancel {
    border-radius: 8px !important;
    font-weight: 500 !important;
    padding: 12px 24px !important;
    font-size: 14px !important;
    transition: all 0.2s ease !important;
  }

  .swal2-confirm:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(48, 133, 214, 0.3) !important;
  }

  .swal2-cancel:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3) !important;
  }

  /* å‹•ç•«æ•ˆæœ */
  .swal2-popup {
    animation: swalSlideIn 0.3s ease-out !important;
  }

  @keyframes swalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
  @media (max-width: 480px) {
    .swal-login-popup {
      width: 90% !important;
      margin: 0 5% !important;
    }
    
    .swal-login-title {
      font-size: 20px !important;
    }
    
    .swal-login-content p {
      font-size: 14px !important;
    }
  }
</style>

<!-- æµ®å‹•èŠå¤©æŒ‰éˆ• -->
<div class="qa-bot-toggle" id="qaBotToggle">
  <img src={`${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/MayaHead.png`} alt="Sawa Maya" class="toggle-image" />
  <span class="toggle-text">çœŸå¤œ</span>
</div>

<!-- èŠå¤©å°è©±æ¡† -->
<div class="qa-bot-container" id="qaBotContainer">
  <div class="chat-header">
    <div class="header-content">
      <img src={`${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/MayaHead.png`} alt="ä½å’Œ çœŸå¤œ" class="header-avatar" />
      <div class="header-text">
        <h3>ä½å’Œ çœŸå¤œ</h3>
        <p>TYçš„æ™ºæ…§åº«</p>
      </div>
    </div>
    <div class="header-controls">
      <button class="fullscreen-button" id="fullscreenButton" title="åˆ‡æ›å…¨å±æ¨¡å¼">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
      </button>
      <button class="language-button" id="languageButton" title="åˆ‡æ›èªè¨€">
        <span class="language-text">ä¸­æ–‡</span>
      </button>
      <button class="history-button" id="historyButton" title="æŸ¥çœ‹èŠå¤©æ­·å²">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </button>
      <!-- æ–°å¢ï¼šé é¢åˆ†ææŒ‰éˆ• -->
      <button class="page-analysis-button" id="pageAnalysisButton" title="åˆ†æé é¢">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 4h18M3 10h18M3 16h18"/>
        </svg>
      </button>
      <button class="close-button" id="closeButton">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>
  
  <div class="chat-messages" id="chatMessages">
    <div class="message bot-message">
      <div class="message-avatar">
        <img src={`${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/MayaHead.png`} alt="çœŸå¤œ" class="bot-avatar" />
      </div>
      <div class="message-content-wrapper">
        <div class="message-header">
          <span class="ai-name">çœŸå¤œ</span>
        </div>
        <div class="message-content">
          <p>ä½ æœ‰äº‹ï¼Ÿ<br>å•å‰æƒ³æ¸…æ¥šï¼Œæ©Ÿæœƒä¸æ˜¯èª°éƒ½æœ‰ã€‚</p>
          
          <!-- ä¸»é¡Œå»ºè­° -->
          <div class="topic-suggestions">
            <h4>ğŸ’¡ å»ºè­°ä¸»é¡Œï¼š</h4>
            <div class="suggestion-buttons">
              <button class="suggestion-btn" data-topic="Java">â˜• Java é–‹ç™¼</button>
              <button class="suggestion-btn" data-topic="OOPåŠDIæ¡†æ¶">ğŸ—ï¸ OOPåŠDIæ¡†æ¶</button>
              <button class="suggestion-btn" data-topic="éƒ¨ç½²å¯¦è¸">ğŸš€ éƒ¨ç½²å¯¦è¸</button>
              <button class="suggestion-btn" data-topic="ç¶²è·¯å•é¡Œ">ğŸŒ ç¶²è·¯å•é¡Œ</button>
              <button class="suggestion-btn" data-topic="äº†è§£å¦³">æƒ³å¤šäº†è§£å¦³</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="load-more-container" id="loadMoreContainer" style="display: none;">
    <button class="load-more-button" id="loadMoreButton">
      è¼‰å…¥æ›´å¤šæ­·å²è¨˜éŒ„
    </button>
  </div>
  <!-- æ–°å¢ï¼šé é¢åˆ†æé¢æ¿ -->
  <div class="analysis-panel" id="analysisPanel" style="display:none;"></div>
  <div class="chat-input-container">
    <div class="input-wrapper">
      <input 
        type="text" 
        id="userInput" 
        placeholder=""
        class="chat-input"
        maxlength="500"
      />
      <button 
        id="sendButton" 
        class="send-button"
        disabled
      >
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
      </button>
    </div>
    <div class="input-status" id="inputStatus"></div>
  </div>
</div>

<!-- åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† -->
<div class="image-modal" id="imageModal">
  <div class="image-modal-content">
    <button class="image-modal-close" id="imageModalClose">&times;</button>
    <img id="modalImage" src="" alt="æ”¾å¤§åœ–ç‰‡" />
  </div>
</div>

<script>
  // å°‡è¨Šæ¯é…ç½®ç›´æ¥æ‰“åŒ…ï¼Œé¿å…æ­£å¼ç’°å¢ƒ 404
  // @ts-ignore
  import messages from '../storages/messages.json';
  // @ts-ignore
  import analystTemplates from '../storages/analyst.json';
  class QABot {
    // DOM å…ƒç´ 
    private elements: Record<string, HTMLElement> = {};
    
    // ç‹€æ…‹ç®¡ç†
    private state = {
      userId: '',
      currentHistoryPage: 0,
      historyItemsPerPage: 5,
      currentLanguage: 'chinese',
      isFullscreen: false,
      isThinking: false,
      saucyMessageCount: 0,
      maxSaucyMessages: 3,
      lastSaucyMessage: '',
      hasShownInactivityMessage: false,
      currentTheme: 'light',
      earliestTimestamp: null as number | null,
      botName: 'Maya',
      availableBots: [] as string[],
      currentBotIndex: 0,
      // æ–°å¢ï¼šé é¢åˆ†æç›¸é—œç‹€æ…‹
      analysisType: 'summary',
      isAnalyzing: false,
      hasShownLoginAlert: false
    };
    
    // å®šæ™‚å™¨
    private timers = {
      inactivity: null as NodeJS.Timeout | null,
      randomMessage: null as NodeJS.Timeout | null
    };
    
        // æ¶ˆæ¯é…ç½®
    private messages: any = null;

    constructor() {
      this.initializeElements();
      this.initializeState();
      this.initializeTheme();
      this.setupEventListeners();
      this.setupAvatarSelector(); // æ–°å¢é ­è²¼é¸æ“‡å™¨
      this.setupNetworkListener(); // æ–°å¢ç¶²è·¯ç‹€æ…‹ç›£è½
      this.fetchBotNames();       // å¾ API å–å¾—å¯ç”¨ bot åç¨±
      // æ–°å¢ï¼šåˆå§‹åŒ–é é¢åˆ†æé¢æ¿
      this.setupAnalysisPanel();
      this.loadMessages().then(() => {
      this.loadChatHistory();
        this.startTimers();
      });
    }

    // åˆå§‹åŒ–ä¸»é¡Œ
    private initializeTheme() {
      // æª¢æ¸¬ç•¶å‰ä¸»é¡Œ
      this.state.currentTheme = this.detectCurrentTheme();
      
      // ç›£è½ä¸»é¡Œè®ŠåŒ–
      this.setupThemeListener();
    }

    // æª¢æ¸¬ç•¶å‰ä¸»é¡Œ
    private detectCurrentTheme(): string {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        return savedTheme;
      }
      
      // æª¢æŸ¥ç³»çµ±åå¥½
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark';
      }
      
      // æª¢æŸ¥ DOM ä¸­çš„ theme-dark é¡
      if (document.documentElement.classList.contains('theme-dark')) {
        return 'dark';
      }
      
      return 'light';
    }

    // è¨­ç½®ä¸»é¡Œç›£è½å™¨
    private setupThemeListener() {
      // ç›£è½ localStorage è®ŠåŒ–
      window.addEventListener('storage', (e) => {
        if (e.key === 'theme') {
          this.updateTheme(e.newValue || 'light');
        }
      });
      
      // ç›£è½ DOM è®ŠåŒ–ï¼ˆç•¶å…¶ä»–çµ„ä»¶æ”¹è®Šä¸»é¡Œæ™‚ï¼‰
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const target = mutation.target as HTMLElement;
            if (target === document.documentElement) {
              const newTheme = target.classList.contains('theme-dark') ? 'dark' : 'light';
              if (newTheme !== this.state.currentTheme) {
                this.updateTheme(newTheme);
              }
            }
          }
        });
      });
      
      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
      });
      
      // ç›£è½ç³»çµ±ä¸»é¡Œè®ŠåŒ–
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      mediaQuery.addEventListener('change', (e) => {
        const newTheme = e.matches ? 'dark' : 'light';
        if (newTheme !== this.state.currentTheme) {
          this.updateTheme(newTheme);
        }
      });
    }

    // è¨­ç½®ç¶²è·¯ç‹€æ…‹ç›£è½å™¨
    private setupNetworkListener() {
      let wasOffline = !navigator.onLine;
      
      // ç›£è½ç¶²è·¯ç‹€æ…‹è®ŠåŒ–
      window.addEventListener('online', () => {
        if (wasOffline) {
          console.log('ç¶²è·¯å·²æ¢å¾©ï¼Œé‡æ–°ç²å–AIå°ˆå“¡åˆ—è¡¨');
          wasOffline = false;
          this.refreshBotList();
        }
      });
      
      window.addEventListener('offline', () => {
        wasOffline = true;
        console.log('ç¶²è·¯å·²æ–·ç·š');
      });
    }

    // é‡æ–°æ•´ç†AIå°ˆå“¡åˆ—è¡¨
    private async refreshBotList() {
      try {
        console.log('é–‹å§‹é‡æ–°ç²å–AIå°ˆå“¡åˆ—è¡¨...');
        
        // é¡¯ç¤ºloadingç‹€æ…‹
        this.showBotListLoading();
        
        await this.fetchBotNames();
        
        // éš±è—loadingç‹€æ…‹
        this.hideBotListLoading();
        
        // å¦‚æœç•¶å‰é¸æ“‡çš„AIä¸åœ¨æ–°åˆ—è¡¨ä¸­ï¼Œè‡ªå‹•åˆ‡æ›åˆ°ç¬¬ä¸€å€‹å¯ç”¨çš„AI
        if (this.state.availableBots.length > 0 && !this.state.availableBots.includes(this.state.botName)) {
          console.log(`ç•¶å‰AI ${this.state.botName} ä¸åœ¨æ–°åˆ—è¡¨ä¸­ï¼Œåˆ‡æ›åˆ° ${this.state.availableBots[0]}`);
          this.state.currentBotIndex = 0;
          this.state.botName = this.state.availableBots[0];
          this.updateAvatarAndName();
          
          // é¡¯ç¤ºåˆ‡æ›æç¤º
          this.addBotSwitchMessage();
          
          // å»¶é²é¡¯ç¤ºæ–°çš„æ­¡è¿æ¶ˆæ¯
          setTimeout(() => {
            this.addWelcomeMessage();
          }, 1000);
        }
        
        console.log('AIå°ˆå“¡åˆ—è¡¨æ›´æ–°å®Œæˆ');
      } catch (error) {
        console.error('é‡æ–°ç²å–AIå°ˆå“¡åˆ—è¡¨å¤±æ•—:', error);
        this.hideBotListLoading();
      }
    }

    // é¡¯ç¤ºAIå°ˆå“¡åˆ—è¡¨è¼‰å…¥ä¸­ç‹€æ…‹
    private showBotListLoading() {
      // åœ¨é ­åƒé¸æ“‡å™¨ä¸­é¡¯ç¤ºloadingç‹€æ…‹
      if (this.elements.avatarSelector) {
        this.elements.avatarSelector.innerHTML = `
          <div class="avatar-selector-loading">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨é‡æ–°é€£ç·šä¸­...</p>
          </div>
        `;
        this.elements.avatarSelector.style.display = 'block';
      }
    }

    // éš±è—AIå°ˆå“¡åˆ—è¡¨è¼‰å…¥ä¸­ç‹€æ…‹
    private hideBotListLoading() {
      if (this.elements.avatarSelector) {
        this.elements.avatarSelector.style.display = 'none';
      }
    }

    // æ›´æ–°ä¸»é¡Œ
    private updateTheme(newTheme: string) {
      this.state.currentTheme = newTheme;
      
      // é€™è£¡å¯ä»¥æ·»åŠ ä¸»é¡Œç›¸é—œçš„é‚è¼¯
      // ä¾‹å¦‚æ›´æ–°æŒ‰éˆ•æ¨£å¼ã€é‡æ–°æ¸²æŸ“ç­‰
    }

    // åˆå§‹åŒ– DOM å…ƒç´ 
    private initializeElements() {
      const elementIds = [
        'userInput', 'sendButton', 'chatMessages', 'inputStatus', 'qaBotToggle', 
        'qaBotContainer', 'closeButton', 'historyButton', 'loadMoreButton', 
        'loadMoreContainer', 'imageModal', 'modalImage', 'imageModalClose',
        // æ–°å¢ï¼šé é¢åˆ†æç›¸é—œå…ƒç´ 
        'pageAnalysisButton', 'analysisPanel'
      ];
      
      elementIds.forEach(id => {
        this.elements[id] = document.getElementById(id) as HTMLElement;
      });

      // å¦å¤–å–å¾—é ­è²¼å…ƒç´ 
      this.elements.headerAvatar = document.querySelector('.header-avatar') as HTMLElement;
    }

    // åˆå§‹åŒ–ç‹€æ…‹
    private initializeState() {
      this.state.userId = this.getOrCreateUserId();
      this.state.currentLanguage = localStorage.getItem('qabot_language') || 'chinese';
      this.updateLanguageButton();
      this.updateInputPlaceholder();
    }

    // è¼‰å…¥æ¶ˆæ¯é…ç½®
    private async loadMessages() {
      // ä¸å†é€é fetchï¼Œç›´æ¥ä½¿ç”¨æ‰“åŒ…é€²ä¾†çš„ JSON
      this.messages = messages;
      // ç§»é™¤æ²’æœ‰å°æ‡‰å¥åº«çš„ bot
      this.pruneAvailableBots();
    }

    // æª¢æŸ¥æŒ‡å®šè§’è‰²æ˜¯å¦æœ‰æœ‰æ•ˆçš„ welcome å¥
    private hasValidMessages(name: string): boolean {
      const zh = this.messages?.chinese?.[name];
      const en = this.messages?.english?.[name];
      return (zh?.welcome?.length > 0) || (en?.welcome?.length > 0);
    }

    private pruneAvailableBots() {
      if (!Array.isArray(this.state.availableBots)) return;
      
      console.log('ğŸ” é–‹å§‹éæ¿¾å°ˆå“¡åˆ—è¡¨...');
      console.log('éæ¿¾å‰çš„å°ˆå“¡:', this.state.availableBots);
      
      const beforeFilter = [...this.state.availableBots];
      this.state.availableBots = this.state.availableBots.filter(n => {
        const hasMessages = this.hasValidMessages(n);
        console.log(`å°ˆå“¡ ${n}: ${hasMessages ? 'âœ… æœ‰å¥åº«' : 'âŒ ç„¡å¥åº«'}`);
        return hasMessages;
      });
      
      console.log('éæ¿¾å¾Œçš„å°ˆå“¡:', this.state.availableBots);
      
      // ç¢ºä¿è‡³å°‘ Maya å­˜åœ¨
      if (!this.state.availableBots.includes('Maya') && this.hasValidMessages('Maya')) {
        this.state.availableBots.unshift('Maya');
        console.log('âœ… æ·»åŠ  Maya åˆ°å°ˆå“¡åˆ—è¡¨');
      }
      
      // å¦‚æœç•¶å‰ bot æ²’æœ‰å¥åº« â†’ æ›æˆæ¸…å–®ç¬¬ä¸€å€‹
      if (!this.hasValidMessages(this.state.botName) && this.state.availableBots.length) {
        console.log(`ç•¶å‰å°ˆå“¡ ${this.state.botName} ç„¡å¥åº«ï¼Œåˆ‡æ›åˆ° ${this.state.availableBots[0]}`);
        this.state.botName = this.state.availableBots[0];
        this.state.currentBotIndex = 0;
        this.updateAvatarAndName();
      }
    }
 
    // å–å¾—æ‰€æœ‰å¯é¸ bot åç¨±
    private async fetchBotNames() {
      try {
        const apiBase = import.meta.env.PUBLIC_TYMB_URL;
        const token = localStorage.getItem('token');
        const headers: Record<string, string> = {
          'Content-Type': 'application/json'
        };
        
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        
        const resp = await fetch(`${apiBase}/people/names`, {
          method: 'GET',
          headers,
          credentials: 'include'
        });
        
        console.log('API å›æ‡‰ç‹€æ…‹:', resp.status, resp.statusText);
        
        if (resp.ok) {
          const names = await resp.json();
          console.log('API è¿”å›çš„å°ˆå“¡åˆ—è¡¨:', names);
          
          if (Array.isArray(names)) {
            // ç¢ºä¿ Maya åœ¨åˆ—è¡¨å…§
            if (!names.includes('Maya')) names.unshift('Maya');
            this.state.availableBots = names;
            
            // åˆå§‹åŒ–å¾Œå…ˆéæ¿¾ç„¡å¥åº«çš„
            if (this.messages) this.pruneAvailableBots();
            
            this.state.currentBotIndex = names.indexOf('Maya');
            return; // æˆåŠŸå¾Œç›´æ¥è¿”å›
          }
        } else {
          // API èª¿ç”¨å¤±æ•—ï¼Œé¡¯ç¤º Sweet Alert æç¤ºç”¨æˆ¶å…ˆç™»å…¥
          this.showLoginAlert();
          console.warn('âŒ APIå›æ‡‰éŒ¯èª¤:', resp.status, resp.statusText);
        }
      } catch (err) {
        // ç¶²è·¯éŒ¯èª¤ï¼Œé¡¯ç¤º Sweet Alert æç¤ºç”¨æˆ¶å…ˆç™»å…¥
        this.showLoginAlert();
        console.warn('âŒ ç¶²è·¯éŒ¯èª¤:', err);
      }
      
      // æ‰€æœ‰æƒ…æ³éƒ½å¤±æ•—å¾Œï¼Œç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹é è¨­çš„AIå¯ç”¨
      console.warn('ä½¿ç”¨é è¨­AI');
      if (this.state.availableBots.length === 0) {
        this.state.availableBots = ['Maya'];
        this.state.currentBotIndex = 0;
      }
      this.updateAvatarAndName();
    }

    // é¡¯ç¤ºç™»å…¥æç¤º
    private showLoginAlert() {
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“é¡¯ç¤ºéæç¤ºï¼Œé¿å…é‡è¤‡é¡¯ç¤º
      if (this.state.hasShownLoginAlert) {
        return;
      }
      
      this.state.hasShownLoginAlert = true;
      
      // ä½¿ç”¨ SweetAlert2 é¡¯ç¤ºç¾è§€çš„æç¤º
      if (typeof (window as any).Swal !== 'undefined') {
        (window as any).Swal.fire({
          title: 'ğŸ” éœ€è¦ç™»å…¥',
          html: `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 20px;">ğŸ‘‹</div>
              <p style="font-size: 16px; color: #666; margin-bottom: 15px;">
                éœ€è¦ç™»å…¥æ‰èƒ½ç²å–å®Œæ•´çš„AIå°ˆå“¡åˆ—è¡¨
              </p>
              <p style="font-size: 14px; color: #999;">
                ç™»å…¥å¾Œå¯ä»¥é¸æ“‡æ›´å¤šAIåŠ©æ‰‹é€²è¡Œå°è©±
              </p>
            </div>
          `,
          icon: 'info',
          confirmButtonText: 'çŸ¥é“äº†',
          confirmButtonColor: '#3085d6',
          showCancelButton: true,
          cancelButtonText: 'ç¨å¾Œå†èªª',
          cancelButtonColor: '#6c757d',
          customClass: {
            popup: 'swal-login-popup',
            title: 'swal-login-title',
            htmlContainer: 'swal-login-content'
          },
          background: '#fff',
          backdrop: 'rgba(0,0,0,0.4)',
          allowOutsideClick: true,
          allowEscapeKey: true,
          width: '400px'
        });
      }
    }

    // ä¾ç›®å‰ botName æ›´æ–° UI
    private updateAvatarAndName() {
      const avatarUrl = this.getAvatarUrl(this.state.botName);
      const defaultAvatarUrl = this.getDefaultAvatarUrl();
      
      // æ›´æ–° header é ­åƒ
      const avatarEl = this.elements.headerAvatar as HTMLImageElement;
      if (avatarEl) {
        avatarEl.src = avatarUrl;
        avatarEl.alt = this.state.botName;
        avatarEl.onerror = () => {
          avatarEl.src = defaultAvatarUrl;
        };
      }
      
      // æ›´æ–° toggle æŒ‰éˆ•é ­åƒ
      const toggleImage = this.elements.qaBotToggle?.querySelector('.toggle-image') as HTMLImageElement;
      if (toggleImage) {
        toggleImage.src = avatarUrl;
        toggleImage.alt = this.state.botName;
        toggleImage.onerror = () => {
          toggleImage.src = defaultAvatarUrl;
        };
      }
      
      const headerName = avatarEl?.parentElement?.querySelector('.header-text h3') as HTMLElement;
      if (headerName) headerName.textContent = this.state.botName;
    }

    // å–å¾—é è¨­é ­è²¼ URL
    private getDefaultAvatarUrl(): string {
      // ä½¿ç”¨ç’°å¢ƒè®Šæ•¸å–å¾— PNG åœ–ç‰‡ URL
      return `${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/default.png`;
    }

    // å»ºç«‹é ­è²¼é¸æ“‡ UI èˆ‡äº‹ä»¶
    private setupAvatarSelector() {
      const avatarEl = this.elements.headerAvatar as HTMLImageElement;
      if (!avatarEl) return;

      // å‰µå»ºæµ®å‹•é ­åƒé¸æ“‡é¢æ¿
      const avatarSelector = document.createElement('div');
      avatarSelector.className = 'avatar-selector';
      avatarSelector.style.display = 'none';
      document.body.appendChild(avatarSelector);

      // é»æ“Šé ­åƒé¡¯ç¤ºé¸æ“‡é¢æ¿
      avatarEl.addEventListener('click', (e) => {
        e.stopPropagation();
        this.showAvatarSelector(avatarSelector);
      });

      // é»æ“Šå…¶ä»–åœ°æ–¹éš±è—é¸æ“‡é¢æ¿
      document.addEventListener('click', (e) => {
        if (!avatarSelector.contains(e.target as Node) && !avatarEl.contains(e.target as Node)) {
          avatarSelector.style.display = 'none';
        }
      });

      // å­˜åˆ° elements æ–¹ä¾¿ä»¥å¾Œå–ç”¨
      this.elements.avatarSelector = avatarSelector;
    }

    // è¨­ç½®åˆ†æé¢æ¿äº‹ä»¶ç›£è½å™¨
    private setupAnalysisPanelEvents() {
      const panel = this.elements.analysisPanel as HTMLElement;
      if (!panel) {
        console.warn('åˆ†æé¢æ¿å…ƒç´ ä¸å­˜åœ¨');
        return;
      }

      // ç¶å®šåˆ†æé¡å‹æŒ‰éˆ•äº‹ä»¶
      const typeButtons = panel.querySelectorAll('.pa-type-btn');
      
      typeButtons.forEach((btn, index) => {
        btn.addEventListener('click', (e) => {
          const type = (e.currentTarget as HTMLElement).getAttribute('data-type') || 'summary';
          this.selectAnalysisType(type);
        });
      });

      // ç¶å®šé–‹å§‹åˆ†ææŒ‰éˆ•äº‹ä»¶
      const startBtn = panel.querySelector('#startPageAnalysis') as HTMLButtonElement;
      if (startBtn) {
        startBtn.addEventListener('click', () => {
          this.analyzePage();
        });
      } else {
        console.warn('æœªæ‰¾åˆ°é–‹å§‹åˆ†ææŒ‰éˆ•');
      }
    }

    // é¡¯ç¤ºé ­åƒé¸æ“‡é¢æ¿
    private showAvatarSelector(selector: HTMLElement) {
      // æ¸…ç©ºç¾æœ‰å…§å®¹
      selector.innerHTML = '';
      
      // å‰µå»ºæ¨™é¡Œ
      const title = document.createElement('h4');
      title.textContent = 'åœ¨ç·šå°ˆå“¡';
      title.className = 'avatar-selector-title';
      selector.appendChild(title);

      // å‰µå»ºé ­åƒç¶²æ ¼
      const avatarGrid = document.createElement('div');
      avatarGrid.className = 'avatar-grid';

      const defaultAvatarUrl = this.getDefaultAvatarUrl();

      // éæ¿¾æ‰ default è§’è‰²å’Œå¯èƒ½çš„ç„¡æ•ˆè§’è‰²
      const validBots = this.state.availableBots.filter(botName => 
        botName.toLowerCase() !== 'default' && 
        botName.toLowerCase() !== 'unknown' &&
        botName.trim() !== ''
      );

      validBots.forEach((botName, index) => {
        const avatarItem = document.createElement('div');
        avatarItem.className = 'avatar-item';
        if (botName === this.state.botName) {
          avatarItem.classList.add('active');
        }

        const avatarImg = document.createElement('img');
        avatarImg.src = this.getAvatarUrl(botName);
        avatarImg.alt = botName;
        avatarImg.className = 'avatar-selector-img';
        
        // å¦‚æœåœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œéš±è—æ•´å€‹é¸é …
        avatarImg.onerror = () => {
          avatarItem.style.display = 'none';
        };

        const avatarName = document.createElement('span');
        avatarName.textContent = botName;
        avatarName.className = 'avatar-name';

        avatarItem.appendChild(avatarImg);
        avatarItem.appendChild(avatarName);

        // é»æ“Šåˆ‡æ›AI - ä½¿ç”¨åŸå§‹ç´¢å¼•
        avatarItem.addEventListener('click', () => {
          const originalIndex = this.state.availableBots.indexOf(botName);
          this.selectBot(originalIndex);
          selector.style.display = 'none';
        });

        avatarGrid.appendChild(avatarItem);
      });

      selector.appendChild(avatarGrid);

      // é¡¯ç¤ºé¢æ¿
      selector.style.display = 'block';
    }

    // é¸æ“‡æŒ‡å®šçš„bot
    private selectBot(index: number) {
      if (index >= 0 && index < this.state.availableBots.length) {
        this.state.currentBotIndex = index;
        this.state.botName = this.state.availableBots[index];
        this.updateAvatarAndName();
        
        // ç«‹å³æ¸…é™¤å°è©±æ­·å²ï¼Œé¿å…é ­åƒå’Œå°è©±ä¸åŒ¹é…
        this.elements.chatMessages.innerHTML = '';
        // éš±è—è¼‰å…¥æ›´å¤šæ­·å²æŒ‰éˆ•
        if (this.elements.loadMoreContainer) {
          this.elements.loadMoreContainer.style.display = 'none';
        }
        
        // é‡ç½®ç‹€æ…‹
        this.state.lastSaucyMessage = '';
        this.state.hasShownInactivityMessage = false;
        this.state.isThinking = false;
        this.state.saucyMessageCount = 0;
        this.state.earliestTimestamp = null;
        
        // é¡¯ç¤ºAIåˆ‡æ›æç¤º
        this.addBotSwitchMessage();
        
        // å»¶é²é¡¯ç¤ºæ–°çš„æ­¡è¿æ¶ˆæ¯ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°åˆ‡æ›æç¤º
        setTimeout(() => {
          this.addWelcomeMessage();
        }, 1000);
        
        this.resetInactivityTimer();
        this.scrollToBottom();
      }
    }



    // å–å¾—é ­è²¼ URL
    private getAvatarUrl(name: string): string {
      // ä½¿ç”¨ç’°å¢ƒè®Šæ•¸å–å¾— PNG åœ–ç‰‡ URL
      return `${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/${encodeURIComponent(name)}Head.png`;
    }

    // è¨­ç½®äº‹ä»¶ç›£è½å™¨
    private setupEventListeners() {
      // åŸºæœ¬æ§åˆ¶äº‹ä»¶
      this.elements.qaBotToggle.addEventListener('click', () => this.toggleChat());
      this.elements.closeButton.addEventListener('click', () => this.hideChat());
      this.elements.historyButton.addEventListener('click', () => this.loadChatHistory());
      this.elements.loadMoreButton.addEventListener('click', () => this.loadMoreHistory());
      // æ–°å¢ï¼šé é¢åˆ†ææŒ‰éˆ•äº‹ä»¶
      this.elements.pageAnalysisButton.addEventListener('click', () => this.toggleAnalysisPanel());
      
      // æ–°å¢ï¼šé é¢åˆ†æé¢æ¿äº‹ä»¶ï¼ˆå»¶é²ç¶å®šï¼Œç¢ºä¿é¢æ¿å·²å‰µå»ºï¼‰
      setTimeout(() => {
        this.setupAnalysisPanelEvents();
      }, 100);
      
      // åŠŸèƒ½æŒ‰éˆ•äº‹ä»¶
      (document.getElementById('fullscreenButton') as HTMLButtonElement).addEventListener('click', () => this.toggleFullscreen());
      (document.getElementById('languageButton') as HTMLButtonElement).addEventListener('click', () => this.toggleLanguage());
      
      // è¼¸å…¥ç›¸é—œäº‹ä»¶
      this.elements.userInput.addEventListener('input', () => {
        this.updateSendButton();
        this.resetInactivityTimer();
      });

      this.elements.userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
        this.resetInactivityTimer();
      });

      this.elements.sendButton.addEventListener('click', () => {
        this.sendMessage();
        this.resetInactivityTimer();
      });

      // ä¸»é¡Œå»ºè­°äº‹ä»¶
      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target?.classList.contains('suggestion-btn')) {
          const topic = target.getAttribute('data-topic');
          if (topic) {
            this.handleTopicSuggestion(topic);
          }
        }
      });
      
      // åœ–ç‰‡æ¨¡æ…‹æ¡†äº‹ä»¶
      this.elements.imageModalClose.addEventListener('click', (e) => {
        e.stopPropagation();
        this.hideImageModal();
      });

      this.elements.imageModal.addEventListener('click', (e) => {
        if (e.target === this.elements.imageModal) this.hideImageModal();
      });
      
      // åœ–ç‰‡é»æ“Šäº‹ä»¶
      this.elements.chatMessages.addEventListener('click', (e) => {
        const img = (e.target as HTMLElement).closest('.answer-image') as HTMLImageElement;
        if (img) {
          const imageSrc = img.getAttribute('data-src') || img.src;
          this.showImageModal(imageSrc);
        }
      });
      
      // ESC éµé—œé–‰æ¨¡æ…‹æ¡†
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.elements.imageModal.classList.contains('show')) {
          this.hideImageModal();
        }
      });
    }

    // å‰µå»ºæ¶ˆæ¯çµæ§‹çš„é€šç”¨æ–¹æ³•
    private createMessageStructure(type: 'bot' | 'user' | 'loading' = 'bot', content?: any) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}-message`;
      
      if (type === 'bot' || type === 'loading') {
      // æ·»åŠ é ­åƒ
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      const avatarImg = document.createElement('img');
      avatarImg.src = this.getAvatarUrl(this.state.botName);
      avatarImg.alt = this.state.botName;
      avatarImg.className = 'bot-avatar';
      avatarImg.onerror = () => {
        avatarImg.src = this.getDefaultAvatarUrl();
      };
      avatarDiv.appendChild(avatarImg);
      messageDiv.appendChild(avatarDiv);
      
      // æ·»åŠ å…§å®¹åŒ…è£å™¨
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'message-content-wrapper';
      
      // æ·»åŠ æ¶ˆæ¯é ­éƒ¨
      const headerDiv = document.createElement('div');
      headerDiv.className = 'message-header';
      const aiName = document.createElement('span');
      aiName.className = 'ai-name';
      aiName.textContent = this.state.botName;
      headerDiv.appendChild(aiName);
      contentWrapper.appendChild(headerDiv);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      
        if (type === 'loading') {
          contentDiv.innerHTML = `
            <div class="loading">
              <div class="spinner"></div>
              <span>æ­£åœ¨æ€è€ƒä¸­...</span>
            </div>
          `;
        } else if (content) {
          // ç¢ºä¿ content æ˜¯å­—ç¬¦ä¸²é¡å‹
          if (typeof content !== 'string') {
            content = String(content || '');
          }
          contentDiv.innerHTML = content;
        }
        
        contentWrapper.appendChild(contentDiv);
        messageDiv.appendChild(contentWrapper);
      } else if (type === 'user' && content) {
        // ç”¨æˆ¶æ¶ˆæ¯
        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';
        const userId = document.createElement('span');
        userId.className = 'user-id';
        userId.textContent = `ID: ${this.state.userId.substring(0, 8)}...`;
        headerDiv.appendChild(userId);
        messageDiv.appendChild(headerDiv);
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        // ç¢ºä¿ content æ˜¯å­—ç¬¦ä¸²é¡å‹
        if (typeof content !== 'string') {
          content = String(content || '');
        }
        contentDiv.innerHTML = `<p>${this.escapeHtml(content)}</p>`;
        messageDiv.appendChild(contentDiv);
      }
      
      return messageDiv;
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å€åŸŸ
    private addMessage(content: any, type: 'bot' | 'user' | 'loading' = 'bot') {
      // ç¢ºä¿ content æ˜¯å­—ç¬¦ä¸²é¡å‹
      if (typeof content !== 'string') {
        console.warn('addMessage: content is not a string:', content);
        content = String(content || '');
      }
      
      const messageDiv = this.createMessageStructure(type, content);
      this.elements.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
      return messageDiv;
    }

    // æ·»åŠ è¼‰å…¥æ¶ˆæ¯
    private addLoadingMessage() {
      this.state.isThinking = true;
      const loadingDiv = this.createMessageStructure('loading');
      this.elements.chatMessages.appendChild(loadingDiv);
      this.scrollToBottom();
      return loadingDiv;
    }

    // æ·»åŠ æ­¡è¿æ¶ˆæ¯
    private addWelcomeMessage() {
      // å…ˆé¡¯ç¤º loading æ•ˆæœ
      const loadingDiv = this.createMessageStructure('loading');
      this.elements.chatMessages.appendChild(loadingDiv);
      this.scrollToBottom();
      
      // å»¶é² 1.5 ç§’å¾Œé¡¯ç¤ºå¯¦éš›çš„æ­¡è¿æ¶ˆæ¯
      setTimeout(() => {
        this.removeMessage(loadingDiv);
        
        const langData = this.messages?.[this.state.currentLanguage];
        const currentMessages = langData?.[this.state.botName] || langData?.['Maya'];
        const randomWelcome = currentMessages.welcome[Math.floor(Math.random() * currentMessages.welcome.length)];
        
        const messageDiv = this.createMessageStructure('bot', `<p>${randomWelcome}</p>`);
      
      // æ·»åŠ ä¸»é¡Œå»ºè­°
        const contentDiv = messageDiv.querySelector('.message-content') as HTMLDivElement;
      const topicSuggestions = document.createElement('div');
      topicSuggestions.className = 'topic-suggestions';
      
      const suggestionsTitle = document.createElement('h4');
        suggestionsTitle.textContent = this.state.currentLanguage === 'chinese' ? 'ğŸ’¡ å»ºè­°ä¸»é¡Œï¼š' : 'ğŸ’¡ Suggested Topics:';
      topicSuggestions.appendChild(suggestionsTitle);
      
      const suggestionButtons = document.createElement('div');
      suggestionButtons.className = 'suggestion-buttons';
      
        const topics = this.state.currentLanguage === 'chinese' ? [
        { key: 'Java', text: 'â˜• Java é–‹ç™¼' },
        { key: 'OOPåŠDIæ¡†æ¶', text: 'ğŸ—ï¸ OOPåŠDIæ¡†æ¶' },
        { key: 'éƒ¨ç½²å¯¦è¸', text: 'ğŸš€ éƒ¨ç½²å¯¦è¸' },
        { key: 'ç¶²è·¯å•é¡Œ', text: 'ğŸŒ ç¶²è·¯å•é¡Œ' },
        { key: 'äº†è§£å¦³', text: this.state.botName === 'Wavo' ? 'æƒ³å¤šäº†è§£ä½ ' : 'æƒ³å¤šäº†è§£å¦³' }
      ] : [
        { key: 'Java', text: 'â˜• Java Development' },
        { key: 'OOPåŠDIæ¡†æ¶', text: 'ğŸ—ï¸ OOP & DI Frameworks' },
        { key: 'éƒ¨ç½²å¯¦è¸', text: 'ğŸš€ Deployment Practices' },
        { key: 'ç¶²è·¯å•é¡Œ', text: 'ğŸŒ Network Issues' },
        { key: 'äº†è§£å¦³', text: 'Learn More About Maya' }
      ];
      
      topics.forEach(topic => {
        const button = document.createElement('button');
        button.className = 'suggestion-btn';
        button.setAttribute('data-topic', topic.key);
        button.textContent = topic.text;
        suggestionButtons.appendChild(button);
      });
      
      topicSuggestions.appendChild(suggestionButtons);
      contentDiv.appendChild(topicSuggestions);
      
        this.elements.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
      }, 1500);
    }

    // æ·»åŠ AIåˆ‡æ›æç¤ºæ¶ˆæ¯
    private addBotSwitchMessage() {
      const switchMessage = this.state.currentLanguage === 'chinese' 
        ? `ğŸ”„ å·²åˆ‡æ›åˆ° ${this.state.botName}`
        : `ğŸ”„ Switched to ${this.state.botName}`;
      
      const messageDiv = this.createMessageStructure('bot', `<p class="bot-switch-message">${switchMessage}</p>`);
      this.elements.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
      
      // 3ç§’å¾Œè‡ªå‹•ç§»é™¤åˆ‡æ›æç¤º
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 3000);
    }

    // è™•ç†ä¸»é¡Œå»ºè­°
    private handleTopicSuggestion(topic: string) {
      if (!this.messages) {
        console.error('æ¶ˆæ¯é…ç½®æœªè¼‰å…¥');
        return;
      }
      
      const langData = this.messages?.[this.state.currentLanguage];
      const topicsData = langData?.topics;
      if (!topicsData) {
        console.error('ç•¶å‰èªè¨€æ¶ˆæ¯æˆ–topicsä¸å­˜åœ¨');
        return;
      }
      const suggestion = (topicsData as any)[topic];
      
      if (suggestion) {
        (this.elements.userInput as HTMLInputElement).value = suggestion;
        this.updateSendButton();
        (this.elements.userInput as HTMLInputElement).focus();
      } else {
        // å˜—è©¦ä½¿ç”¨å‚™ç”¨æ–‡æœ¬
        const fallbackText = `è«‹å‘Šè¨´æˆ‘é—œæ–¼ ${topic} çš„çŸ¥è­˜`;
        (this.elements.userInput as HTMLInputElement).value = fallbackText;
        this.updateSendButton();
        (this.elements.userInput as HTMLInputElement).focus();
      }
    }

    // æ ¼å¼åŒ–ç­”æ¡ˆ
    private formatAnswer(answer: string): string {
      let formattedAnswer = answer;
      
      // è™•ç†ç‰¹æ®Šæ ¼å¼
      formattedAnswer = formattedAnswer.replace(/ã€Œ([^ã€]+)ã€/g, '<strong>ã€Œ$1ã€</strong>');
      formattedAnswer = formattedAnswer.replace(/(å‰å›½\s*[å°åƒç§‹][ç™¾ç§‹])(?![^<]*\.png)/g, '<strong>$1</strong>');
      formattedAnswer = formattedAnswer.replace(/(æ£®ç¯‰\s*ç©ºéŸ³)(?![^<]*\.png)/g, '<strong>$1</strong>');
      formattedAnswer = formattedAnswer.replace(/(Sayuri|Chiaki|Sorane)(?![^<]*\.png)/g, '<strong>$1</strong>');
      
      // è™•ç†åœ–ç‰‡é€£çµ
      formattedAnswer = formattedAnswer.replace(/åœ–ç‰‡é€£çµï¼š\s*\n((?:- [^\n]+\n?)+)/gi, (match, imageList) => {
        const imageUrls = imageList.match(/https?:\/\/[^\n]+\.(?:png|jpg|jpeg|gif|webp)/gi) || [];
        return `<div class="image-container-wrapper">${imageUrls.map(url => 
          `<div class="image-container"><img src="${url}" alt="åœ–ç‰‡" class="answer-image" data-src="${url}" onerror="this.style.display='none'" loading="lazy" width="260" style="max-width:260px;height:auto;" /></div>`
        ).join('')}</div>`;
      });
      
      formattedAnswer = formattedAnswer.replace(/åœ–ç‰‡é€£çµï¼š\s*(https?:\/\/[^\n]+\.(?:png|jpg|jpeg|gif|webp))/gi, 
        '<div class="image-container"><img src="$1" alt="åœ–ç‰‡" class="answer-image" data-src="$1" onerror="this.style.display=\'none\'" loading="lazy" width="260" style="max-width:260px;height:auto;" /></div>');

      // å°‡ç´”åœ–ç‰‡é€£çµä¹Ÿè½‰æˆ <img>ï¼Œéš±è—åŸå§‹ç¶²å€
      formattedAnswer = formattedAnswer.replace(/(?<!src=")https?:\/\/[^\s<]+\.(?:png|jpg|jpeg|gif|webp)(?=[\s]|$)/gi, (url) => {
        return `<div class="image-container"><img src="${url}" alt="åœ–ç‰‡" class="answer-image" data-src="${url}" onerror="this.style.display='none'" loading="lazy" width="260" style="max-width:260px;height:auto;" /></div>`;
      });
      
      // è™•ç†æ›è¡Œ
      formattedAnswer = formattedAnswer.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
      return `<p>${formattedAnswer}</p>`;
    }

    // æ·»åŠ æ©Ÿå™¨äººå›æ‡‰
    private addBotResponse(answer: any, sources: any[]) {
      this.state.isThinking = false;
      
      // è™•ç† answer å¯èƒ½æ˜¯å°è±¡çš„æƒ…æ³
      let answerText = '';
      if (typeof answer === 'object' && answer !== null) {
        // å¦‚æœæ˜¯å°è±¡ï¼Œå˜—è©¦æå– text å­—æ®µ
        if (answer.text) {
          answerText = answer.text;
        } else if (answer.answer) {
          answerText = answer.answer;
        } else if (answer.response) {
          answerText = answer.response;
        } else {
          // å¦‚æœæ²’æœ‰æ‰¾åˆ°é æœŸçš„å­—æ®µï¼Œå°‡æ•´å€‹å°è±¡è½‰æ›ç‚ºå­—ç¬¦ä¸²
          answerText = JSON.stringify(answer);
        }
      } else if (typeof answer === 'string') {
        answerText = answer;
      } else {
        answerText = String(answer || '');
      }
      
      const messageDiv = this.createMessageStructure('bot', this.formatAnswer(answerText));
      const contentDiv = messageDiv.querySelector('.message-content') as HTMLDivElement;
      
      // æ·»åŠ ä¾†æºåˆ—è¡¨ï¼ˆåƒ…åœ¨å­˜åœ¨æœ‰æ•ˆä¾†æºæ™‚ï¼‰
      if (sources && Array.isArray(sources) && sources.length > 0) {
        const sourcesDiv = document.createElement('div');
        sourcesDiv.className = 'sources-list';

        let hasValidSource = false;

        sources.forEach(source => {
          // å–å¾—æª”æ¡ˆè·¯å¾‘ï¼ˆå¯èƒ½æ¬„ä½åç¨±ä¸åŒï¼‰
          const filePath = (source && (source.file_path || source.path || source.file)) as string | undefined;
          if (!filePath) return; // ç„¡æ•ˆä¾†æºç›´æ¥è·³é

          // ç¬¬ä¸€æ¬¡å–å¾—æœ‰æ•ˆä¾†æºæ™‚ï¼Œæ’å…¥æ¨™é¡Œ
          if (!hasValidSource) {
            const sourcesTitle = document.createElement('h4');
            sourcesTitle.textContent = 'ğŸ“š åƒè€ƒæ–‡æª”ï¼š';
            sourcesDiv.appendChild(sourcesTitle);
            hasValidSource = true;
          }

          const sourceItem = document.createElement('div');
          sourceItem.className = 'source-item';

          const link = document.createElement('a');
          link.href = `/tymultiverse/work/${filePath.replace('.md', '')}`;
          link.target = '_blank';
          link.className = 'source-link';
          link.innerHTML = `ğŸ“„ ${this.escapeHtml(filePath)}`;

          // é¡¯ç¤ºç›¸ä¼¼åº¦ï¼ˆè‹¥æœ‰ï¼‰
          if (source && typeof source.similarity === 'number') {
            const similaritySpan = document.createElement('span');
            similaritySpan.className = 'similarity';
            similaritySpan.textContent = `ç›¸é—œåº¦: ${(source.similarity * 100).toFixed(1)}%`;
            sourceItem.appendChild(similaritySpan);
          }

          sourceItem.appendChild(link);
          sourcesDiv.appendChild(sourceItem);
        });

        // åªæœ‰åœ¨ç¢ºå®šæœ‰è‡³å°‘ä¸€å€‹æœ‰æ•ˆä¾†æºæ™‚æ‰åŠ å…¥å…§å®¹
        if (hasValidSource) {
          contentDiv.appendChild(sourcesDiv);
        }
      }
      
      this.elements.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
      
      // AIå›ç­”å®Œæˆå¾Œï¼Œé‡æ–°é–‹å§‹å‚¬ä¿ƒè¨ˆæ™‚
      this.resetInactivityTimer();
    }

    // æ·»åŠ éŒ¯èª¤æ¶ˆæ¯
    private addErrorMessage(message: string) {
      this.state.isThinking = false;
      const messageDiv = this.createMessageStructure('bot', `<p class="error-message">âŒ ${this.escapeHtml(message)}</p>`);
      this.elements.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
    }

    // ç™¼é€æ¶ˆæ¯
    private async sendMessage() {
      const userText = (this.elements.userInput as HTMLInputElement).value.trim();
      if (!userText) return;

      (this.elements.userInput as HTMLInputElement).value = '';
      this.updateSendButton();
      this.elements.inputStatus.textContent = '';

      this.addMessage(userText, 'user');
      const loadingId = this.addLoadingMessage();

      try {
        const response = await this.callQAAPI(userText);
        this.removeMessage(loadingId);

        // console.log('APIéŸ¿æ‡‰:', response);

        if (response.success) {
          // æ ¹æ“šAPIéŸ¿æ‡‰çµæ§‹ï¼Œä½¿ç”¨ response.text æˆ– response.answer
          const answer = response.text || response.answer || response;
          const sources = response.data || response.sources || [];
          // console.log('æå–çš„ç­”æ¡ˆ:', answer);
          // console.log('æå–çš„ä¾†æº:', sources);
          this.addBotResponse(answer, sources);
        } else {
          this.addErrorMessage('æŠ±æ­‰ï¼Œç„¡æ³•ç²å–ç­”æ¡ˆï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
      } catch (error) {
        console.error('APIèª¿ç”¨éŒ¯èª¤:', error);
        this.removeMessage(loadingId);
        this.addErrorMessage('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£æ¥å¾Œé‡è©¦ã€‚');
      }
    }

    // èª¿ç”¨ QA API
    private async callQAAPI(payload: string | object) {
      const apiBaseUrl = import.meta.env.DEV ? 'http://localhost:8000' : (import.meta.env.PUBLIC_API_BASE_URL || '');
      const apiPathPrefix = '/maya-sawa';
      
      // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œæ§‹å»ºåŸºæœ¬ payload
      const finalPayload = typeof payload === 'string' ? {
        text: payload,
        user_id: this.state.userId,
        language: this.state.currentLanguage,
        name: this.state.botName
      } : payload;

      // èª¿è©¦æ—¥èªŒï¼šç¢ºèªé€å‡ºçš„è«‹æ±‚å…§å®¹
      console.log('callQAAPI payload =>', finalPayload);

      const token = localStorage.getItem('token');
      const headers: Record<string, string> = {
        'Content-Type': 'application/json'
      };
      
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      const response = await fetch(`${apiBaseUrl}${apiPathPrefix}/qa/query`, {
        method: 'POST',
        headers,
        body: JSON.stringify(finalPayload),
        credentials: 'include'
      });

      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

      const result = await response.json();

      // èª¿è©¦æ—¥èªŒï¼šæŸ¥çœ‹ API å›å‚³
      // console.log('callQAAPI response =>', result);

      return result;
    }

    // è¼‰å…¥èŠå¤©æ­·å²
    private async loadChatHistory() {
      try {
        const apiBaseUrl = import.meta.env.DEV ? 'http://localhost:8000' : (import.meta.env.PUBLIC_API_BASE_URL || '');
        const apiPathPrefix = '/maya-sawa';
        
        const token = localStorage.getItem('token');
        const headers: Record<string, string> = {
          'Content-Type': 'application/json'
        };
        
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch(`${apiBaseUrl}${apiPathPrefix}/qa/chat-history/${this.state.userId}`, {
          headers,
          credentials: 'include'
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const result = await response.json();
        
        // æ¸…é™¤ç¾æœ‰å°è©±
        this.elements.chatMessages.innerHTML = '';
        
        // é¡¯ç¤ºæ­¡è¿æ¶ˆæ¯
        this.addWelcomeMessage();
        
        if (result.success && result.history && result.history.length > 0) {
          // ä¾ç…§æ™‚é–“å‡åºæ’åˆ—ï¼Œç¢ºä¿é¡¯ç¤ºé †åºæ­£ç¢º
          const sortedHistory = [...result.history].sort((a, b) => {
            const aTime = new Date(a.created_at || a.timestamp || a.time || 0).getTime();
            const bTime = new Date(b.created_at || b.timestamp || b.time || 0).getTime();
            return aTime - bTime;
          });
          
          // åªé¡¯ç¤ºæœ€è¿‘10åˆ†é˜å…§çš„å°è©±ï¼ˆèˆ‡Redis TTLä¿æŒä¸€è‡´ï¼‰
          const tenMinutesAgo = Date.now() - (10 * 60 * 1000);
          const recentHistory = sortedHistory.filter(item => {
            const itemTime = new Date(item.created_at || item.timestamp || item.time || 0).getTime();
            return itemTime > tenMinutesAgo;
          });
          
          if (recentHistory.length > 0) {
            const total = recentHistory.length;
            this.state.currentHistoryPage = 0; // 0 = latest page
            const startIdx = Math.max(0, total - this.state.historyItemsPerPage);
            const historyToShow = recentHistory.slice(startIdx, total);
            
            historyToShow.forEach(item => {
              this.addHistoryMessage(item.user_message, item.ai_answer, item.reference_data || []);
            });

            // è¨˜éŒ„ç›®å‰æœ€æ—©çš„è¨Šæ¯æ™‚é–“
            if (historyToShow.length > 0) {
              const firstItem = historyToShow[0];
              this.state.earliestTimestamp = new Date(firstItem.created_at || firstItem.timestamp || firstItem.time || 0).getTime();
            } else {
              this.state.earliestTimestamp = null;
            }
          }
        }
      } catch (error) {
        console.error('è¼‰å…¥èŠå¤©æ­·å²å¤±æ•—:', error);
        this.addErrorMessage('âŒ è¼‰å…¥èŠå¤©æ­·å²å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // è¼‰å…¥æ›´å¤šæ­·å²è¨˜éŒ„
    private async loadMoreHistory() {
      try {
        const apiBaseUrl = import.meta.env.DEV ? 'http://localhost:8000' : (import.meta.env.PUBLIC_API_BASE_URL || '');
        const apiPathPrefix = '/maya-sawa';
        
        const token = localStorage.getItem('token');
        const headers: Record<string, string> = {
          'Content-Type': 'application/json'
        };
        
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch(`${apiBaseUrl}${apiPathPrefix}/qa/chat-history/${this.state.userId}`, {
          headers,
          credentials: 'include'
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const result = await response.json();
        
        if (result.success && result.history) {
          const sortedHistory = [...result.history].sort((a, b) => {
            const aTime = new Date(a.created_at || a.timestamp || a.time || 0).getTime();
            const bTime = new Date(b.created_at || b.timestamp || b.time || 0).getTime();
            return aTime - bTime;
          });
          const total = sortedHistory.length;
          // åªå–æ—©æ–¼ç›®å‰ earliestTimestamp çš„ç´€éŒ„
          const olderHistory = (this.state.earliestTimestamp !== null)
            ? sortedHistory.filter(item => {
                const ts = new Date(item.created_at || item.timestamp || item.time || 0).getTime();
                return ts < (this.state.earliestTimestamp as number);
              })
            : sortedHistory;

          if (olderHistory.length === 0) {
            this.elements.loadMoreContainer.style.display = 'none';
            return;
          }

          const startIndex = Math.max(0, olderHistory.length - this.state.historyItemsPerPage);
          const endIndex = olderHistory.length;
          const historyToShow = olderHistory.slice(startIndex, endIndex);
           
          // èª¿æ•´æ’å…¥é †åºï¼Œç¢ºä¿æ™‚é–“é †
          historyToShow.forEach(item => {
            this.addHistoryMessage(item.user_message, item.ai_answer, item.reference_data || [], true);
          });

          // æ›´æ–° earliestTimestamp
          const firstOld = historyToShow[0];
          this.state.earliestTimestamp = new Date(firstOld.created_at || firstOld.timestamp || firstOld.time || 0).getTime();
           
          // ç•¶å†ä¹Ÿæ²’æœ‰æ›´èˆŠç´€éŒ„æ™‚ï¼Œéš±è—æŒ‰éˆ•ä¸¦æ¸…ç©ºæ¨™è¨˜
          if (startIndex === 0) {
            this.elements.loadMoreContainer.style.display = 'none';
            this.state.earliestTimestamp = null;
          } else {
            this.state.currentHistoryPage++;
          }
        }
      } catch (error) {
        console.error('è¼‰å…¥æ›´å¤šæ­·å²è¨˜éŒ„å¤±æ•—:', error);
        this.addErrorMessage('âŒ è¼‰å…¥æ›´å¤šè¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // æ·»åŠ æ­·å²æ¶ˆæ¯
    private addHistoryMessage(userMessage: any, aiAnswer: any, sources: any[], insertAtTop: boolean = false) {
      // ç¢ºä¿åƒæ•¸æ˜¯å­—ç¬¦ä¸²é¡å‹
      if (typeof userMessage !== 'string') {
        userMessage = String(userMessage || '');
      }
      if (typeof aiAnswer !== 'string') {
        aiAnswer = String(aiAnswer || '');
      }
      
      if (insertAtTop) {
        const userDiv = this.createMessageStructure('user', userMessage);
        const botDiv = this.createMessageStructure('bot', this.formatAnswer(aiAnswer));
        this.elements.chatMessages.insertBefore(botDiv, this.elements.chatMessages.firstChild);
        this.elements.chatMessages.insertBefore(userDiv, this.elements.chatMessages.firstChild);
      } else {
        this.addMessage(userMessage, 'user');
        this.addBotResponse(aiAnswer, sources);
      }
    }

    // é¡¯ç¤ºå‚¬ä¿ƒæ¶ˆæ¯
    private showSaucyMessage() {
      if (this.state.saucyMessageCount >= this.state.maxSaucyMessages) {
        console.log('å·²é”åˆ°æœ€å¤§å‚¬ä¿ƒæ¬¡æ•¸ï¼Œåœæ­¢å‚¬ä¿ƒ');
        return;
      }
      
      this.state.saucyMessageCount++;
      console.log(`é¡¯ç¤ºç¬¬${this.state.saucyMessageCount}æ¬¡å‚¬ä¿ƒæ¶ˆæ¯`);
      
      const langData = this.messages?.[this.state.currentLanguage];
      const currentMessages = langData?.[this.state.botName] || langData?.['Maya'];
      
      // é¿å…é‡è¤‡é¡¯ç¤ºç›¸åŒçš„æ¶ˆæ¯
      let availableMessages = currentMessages.saucy.filter((msg: string) => msg !== this.state.lastSaucyMessage);
      if (availableMessages.length === 0) {
        // å¦‚æœæ‰€æœ‰æ¶ˆæ¯éƒ½ç”¨éäº†ï¼Œé‡ç½®ä¸¦ä½¿ç”¨æ‰€æœ‰æ¶ˆæ¯
        availableMessages = currentMessages.saucy;
        this.state.lastSaucyMessage = '';
      }
      
      const randomMessage = availableMessages[Math.floor(Math.random() * availableMessages.length)];
      this.state.lastSaucyMessage = randomMessage;
      
      const messageDiv = this.createMessageStructure('loading');
      this.elements.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
      
      setTimeout(() => {
        const contentDiv = messageDiv.querySelector('.message-content') as HTMLDivElement;
        contentDiv.innerHTML = `<p>${randomMessage}</p>`;
        this.scrollToBottom();
      }, 1500);
    }

    // å•Ÿå‹•å®šæ™‚å™¨
    private startTimers() {
      // å•Ÿå‹•ä¸æ´»èºè¨ˆæ™‚å™¨ï¼ˆä½¿ç”¨éå¢é–“éš”ï¼‰
      this.startInactivityTimer();
    }

    // é‡ç½®ä¸æ´»èºè¨ˆæ™‚å™¨
    private resetInactivityTimer() {
      console.log('é‡ç½®å‚¬ä¿ƒè¨ˆæ™‚å™¨');
      if (this.timers.inactivity) clearTimeout(this.timers.inactivity);
      this.state.hasShownInactivityMessage = false;
      this.state.saucyMessageCount = 0;
      
      // é‡æ–°å•Ÿå‹•å®šæ™‚å™¨ï¼Œä½¿ç”¨éå¢é–“éš”
      this.startInactivityTimer();
    }

    // å•Ÿå‹•ä¸æ´»èºè¨ˆæ™‚å™¨ï¼ˆä½¿ç”¨éå¢é–“éš”ï¼‰
    private startInactivityTimer() {
      const intervals = [10, 30, 60]; // 10åˆ†é˜, 30åˆ†é˜, 60åˆ†é˜
      const currentInterval = intervals[this.state.saucyMessageCount] || intervals[intervals.length - 1];
      
      
      this.timers.inactivity = setTimeout(() => {
        if (!this.state.isThinking && this.state.saucyMessageCount < this.state.maxSaucyMessages) {
          console.log(`è§¸ç™¼ç¬¬${this.state.saucyMessageCount + 1}æ¬¡å‚¬ä¿ƒ`);
          this.showSaucyMessage();
          
          // å¦‚æœé‚„æ²’é”åˆ°æœ€å¤§æ¬¡æ•¸ï¼Œè¨­ç½®ä¸‹ä¸€æ¬¡å®šæ™‚å™¨
          if (this.state.saucyMessageCount < this.state.maxSaucyMessages) {
            this.startInactivityTimer();
          }
        }
      }, currentInterval * 60 * 1000);
    }

    // åˆ‡æ›èªè¨€
    private toggleLanguage() {
      this.state.currentLanguage = this.state.currentLanguage === 'chinese' ? 'english' : 'chinese';
      localStorage.setItem('qabot_language', this.state.currentLanguage);
      this.updateLanguageButton();
      this.updateInputPlaceholder();
      
      // æ›´æ–°åˆ†æé¢æ¿èªè¨€
      this.updateAnalysisPanelLanguage();
      
      this.reinitializeChat();
    }

    // é‡æ–°åˆå§‹åŒ–èŠå¤©
    private reinitializeChat() {
      this.elements.chatMessages.innerHTML = '';
      this.state.lastSaucyMessage = '';
      this.state.hasShownInactivityMessage = false;
      this.state.isThinking = false;
      this.state.saucyMessageCount = 0;
      this.addWelcomeMessage();
      this.resetInactivityTimer();
      this.scrollToBottom();
    }

    // åˆ‡æ›å…¨å±
    private toggleFullscreen() {
      this.state.isFullscreen = !this.state.isFullscreen;
      this.elements.qaBotContainer.classList.toggle('fullscreen', this.state.isFullscreen);
      this.updateFullscreenButton();
    }

    // åˆ‡æ›èŠå¤©æ¡†
    private toggleChat() {
      this.elements.qaBotContainer.classList.toggle('show');
      if (this.elements.qaBotContainer.classList.contains('show')) {
        (this.elements.userInput as HTMLInputElement).focus();
      }
    }

    // éš±è—èŠå¤©æ¡†
    private hideChat() {
      this.elements.qaBotContainer.classList.remove('show');
    }

    // é¡¯ç¤º/éš±è—åœ–ç‰‡æ¨¡æ…‹æ¡†
    private showImageModal(imageSrc: string) {
      (this.elements.modalImage as HTMLImageElement).src = imageSrc;
      this.elements.imageModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    private hideImageModal() {
      this.elements.imageModal.classList.remove('show');
      document.body.style.overflow = '';
    }

    // å·¥å…·æ–¹æ³•
    private getOrCreateUserId(): string {
      const storageKey = 'qabot_user_id';
      let userId = localStorage.getItem(storageKey);
      
      if (!userId) {
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(2, 15);
        userId = `user_${timestamp}_${random}`;
        localStorage.setItem(storageKey, userId);
      }
      
      return userId;
    }

    private updateSendButton() {
      const hasText = (this.elements.userInput as HTMLInputElement).value.trim().length > 0;
      (this.elements.sendButton as HTMLButtonElement).disabled = !hasText;
    }

    private updateLanguageButton() {
      const languageButton = document.getElementById('languageButton') as HTMLButtonElement;
      const languageText = languageButton.querySelector('.language-text') as HTMLSpanElement;
      
      if (this.state.currentLanguage === 'chinese') {
        languageText.textContent = 'ä¸­æ–‡';
        languageButton.title = 'åˆ‡æ›åˆ°è‹±æ–‡';
      } else {
        languageText.textContent = 'English';
        languageButton.title = 'Switch to Chinese';
      }
    }
    
    private updateInputPlaceholder() {
      (this.elements.userInput as HTMLInputElement).placeholder = this.state.currentLanguage === 'chinese' 
        ? 'è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ...' 
        : 'Please enter your question...';
    }

    private updateFullscreenButton() {
      const fullscreenButton = document.getElementById('fullscreenButton') as HTMLButtonElement;
      const svg = fullscreenButton.querySelector('svg');
      
      if (svg) {
        svg.innerHTML = this.state.isFullscreen 
          ? '<path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>'
          : '<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>';
        
        fullscreenButton.title = this.state.isFullscreen ? 'é€€å‡ºå…¨å±æ¨¡å¼' : 'åˆ‡æ›å…¨å±æ¨¡å¼';
      }
    }

    private removeMessage(messageElement: HTMLElement) {
      if (messageElement?.parentNode) {
        messageElement.parentNode.removeChild(messageElement);
      }
    }

    private scrollToBottom() {
      this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
    }

    private escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================
    // é é¢åˆ†æåŠŸèƒ½  Page Analyzer
    // ============================
    private setupAnalysisPanel() {
      const panel = this.elements.analysisPanel as HTMLElement;
      if (!panel) return;

      this.updateAnalysisPanelLanguage();
    }

    // æ›´æ–°åˆ†æé¢æ¿èªè¨€
    private updateAnalysisPanelLanguage() {
      const panel = this.elements.analysisPanel as HTMLElement;
      if (!panel) return;

      const currentLang = this.state.currentLanguage;
      const templates = analystTemplates[currentLang as keyof typeof analystTemplates];
      
      if (!templates) {
        console.warn(`æœªæ‰¾åˆ°èªè¨€æ¨¡æ¿: ${currentLang}`);
        return;
      }

      const analysisTypes = templates.analysis_types;
      const ui = templates.ui;

      panel.innerHTML = `
        <div class="pa-wrapper">
          <h4 class="pa-title">${ui.title}</h4>
          <div class="pa-grid">
            ${analysisTypes.map(t => `
              <button class="pa-type-btn" data-type="${t.value}">
                <div>${t.label}</div>
                <div class="pa-desc">${t.desc}</div>
              </button>`).join('')}
          </div>
          <button id="startPageAnalysis" class="pa-start-btn">${ui.start_button}</button>
        </div>`;

      // é è¨­é¸æ“‡ summary
      this.selectAnalysisType('summary');
      
      // é‡æ–°ç¶å®šäº‹ä»¶
      this.setupAnalysisPanelEvents();
    }

    private toggleAnalysisPanel(forceShow?: boolean) {
      const panel = this.elements.analysisPanel as HTMLElement;
      if (!panel) {
        console.warn('åˆ†æé¢æ¿å…ƒç´ ä¸å­˜åœ¨');
        return;
      }
      const show = forceShow !== undefined ? forceShow : panel.style.display === 'none';
      console.log(`åˆ‡æ›åˆ†æé¢æ¿é¡¯ç¤º: ${show}`);
      panel.style.display = show ? 'block' : 'none';
      
      // å¦‚æœé¡¯ç¤ºé¢æ¿ï¼Œé‡æ–°ç¶å®šäº‹ä»¶
      if (show) {
        setTimeout(() => {
          this.setupAnalysisPanelEvents();
        }, 50);
      }
    }

    private selectAnalysisType(type: string) {
      this.state.analysisType = type;
      const panel = this.elements.analysisPanel as HTMLElement;
      if (!panel) return;
      panel.querySelectorAll('.pa-type-btn').forEach(btn => {
        (btn as HTMLElement).classList.toggle('active', (btn as HTMLElement).getAttribute('data-type') === type);
      });
    }

    // å®‰å…¨åœ°æå–é é¢å…§å®¹
    private extractPageContentSafe(): { text: string; length: number } {
      console.log('é–‹å§‹æå–é é¢å…§å®¹...');
      
      // ä½¿ç”¨å…¨å±€çš„é é¢å…§å®¹æå–å‡½æ•¸ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      if (typeof (window as any).extractPageContent === 'function') {
        try {
          const pageData = (window as any).extractPageContent();
          console.log(`ä½¿ç”¨å…¨å±€æå–å‡½æ•¸ï¼Œå…§å®¹é•·åº¦: ${pageData.length}`);
          console.log(`å…§å®¹é è¦½: ${pageData.content.substring(0, 200)}...`);
          
          // é™åˆ¶é•·åº¦é¿å… token è¶…é™
          const maxLength = 3000;
          const truncated = pageData.content.length > maxLength 
            ? pageData.content.substring(0, maxLength) + '...' 
            : pageData.content;
          
          console.log(`æœ€çµ‚æ–‡å­—é•·åº¦: ${truncated.length}`);
          return { text: truncated, length: truncated.length };
        } catch (error) {
          console.warn('å…¨å±€æå–å‡½æ•¸å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ³•:', error);
        }
      }
      
      // å‚™ç”¨æå–æ–¹æ³•
      console.log('ä½¿ç”¨å‚™ç”¨å…§å®¹æå–æ–¹æ³•...');
      
      // å˜—è©¦å¤šå€‹å…§å®¹é¸æ“‡å™¨ï¼ŒæŒ‰å„ªå…ˆç´šæ’åº
      const contentSelectors = [
        '[data-page-type="content"]',
        '[data-page-type="main"]',
        '[data-page-type="article"]',
        'main',
        'article',
        '.content',
        '.main-content',
        '#content',
        '#main',
        '.post-content',
        '.entry-content'
      ];
      
      let contentElement: Element | null = null;
      
      // å°‹æ‰¾æœ€ä½³å…§å®¹å…ƒç´ 
      for (const selector of contentSelectors) {
        const element = document.querySelector(selector);
        if (element) {
          const text = (element as HTMLElement).innerText || element.textContent || '';
          if (text.trim().length > 100) { // ç¢ºä¿æœ‰è¶³å¤ å…§å®¹
            contentElement = element;
            console.log(`æ‰¾åˆ°å…§å®¹å…ƒç´ : ${selector}, é•·åº¦: ${text.length}`);
            break;
          }
        }
      }
      
      // å¦‚æœæ²’æœ‰æ‰¾åˆ°åˆé©çš„å…§å®¹å…ƒç´ ï¼Œä½¿ç”¨ body
      if (!contentElement) {
        contentElement = document.body;
        console.log('ä½¿ç”¨ document.body ä½œç‚ºå…§å®¹å…ƒç´ ');
      }
      
      // å‰µå»ºè‡¨æ™‚å®¹å™¨
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = contentElement.innerHTML;
      
      // ç§»é™¤ä¸éœ€è¦çš„å…ƒç´ 
      const elementsToRemove = [
        'script', 'style', 'nav', 'footer', 'aside', 'header',
        '[aria-hidden="true"]', '[style*="display: none"]', '[style*="display:none"]',
        '.qa-bot-container', '.qa-bot-toggle', // ç§»é™¤èŠå¤©æ©Ÿå™¨äººæœ¬èº«
        '.sidebar', '.side-nav', '.navigation',
        '.advertisement', '.ads', '.banner',
        '.social-share', '.share-buttons',
        '.comments', '.comment-section'
      ];
      
      elementsToRemove.forEach(selector => {
        const elements = tempDiv.querySelectorAll(selector);
        elements.forEach(el => el.remove());
      });
      
      // æå–ç´”æ–‡å­—
      let text = tempDiv.innerText || tempDiv.textContent || '';
      text = text.replace(/\s+/g, ' ').trim();
      
      console.log(`æå–çš„åŸå§‹æ–‡å­—é•·åº¦: ${text.length}`);
      console.log(`æå–çš„æ–‡å­—é è¦½: ${text.substring(0, 200)}...`);
      
      // å¦‚æœå…§å®¹å¤ªå°‘ï¼Œå˜—è©¦å¾ body æå–æ›´å¤šå…§å®¹
      if (text.length < 200 && contentElement !== document.body) {
        console.log('å…§å®¹å¤ªå°‘ï¼Œå˜—è©¦å¾ body æå–æ›´å¤šå…§å®¹');
        const bodyDiv = document.createElement('div');
        bodyDiv.innerHTML = document.body.innerHTML;
        
        // ç§»é™¤ä¸éœ€è¦çš„å…ƒç´ 
        elementsToRemove.forEach(selector => {
          const elements = bodyDiv.querySelectorAll(selector);
          elements.forEach(el => el.remove());
        });
        
        const bodyText = bodyDiv.innerText || bodyDiv.textContent || '';
        const cleanedBodyText = bodyText.replace(/\s+/g, ' ').trim();
        
        if (cleanedBodyText.length > text.length) {
          text = cleanedBodyText;
          console.log(`ä½¿ç”¨ body å…§å®¹ï¼Œæ–°é•·åº¦: ${text.length}`);
        }
      }
      
      // é™åˆ¶é•·åº¦é¿å… token è¶…é™
      const maxLength = 3000;
      const truncated = text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
      
      console.log(`æœ€çµ‚æ–‡å­—é•·åº¦: ${truncated.length}`);
      
      return { text: truncated, length: truncated.length };
    }

    // æª¢æ¸¬é é¢èªè¨€
    private detectPageLanguage(): string {
      console.log('é–‹å§‹æª¢æ¸¬é é¢èªè¨€...');
      
      // æª¢æŸ¥ HTML lang å±¬æ€§
      const htmlLang = document.documentElement.lang;
      console.log(`HTML lang å±¬æ€§: ${htmlLang}`);
      
      // æª¢æŸ¥ meta æ¨™ç±¤
      const metaLang = document.querySelector('meta[name="language"]') as HTMLMetaElement;
      console.log(`Meta language: ${metaLang?.content}`);
      
      // å„ªå…ˆä½¿ç”¨ Unicode æª¢æ¸¬ï¼ˆæ›´æº–ç¢ºï¼‰
      const text = document.body.innerText || '';
      const chineseCharCount = (text.match(/[\u4e00-\u9fff]/g) || []).length;
      const totalCharCount = text.length;
      const chineseRatio = totalCharCount > 0 ? chineseCharCount / totalCharCount : 0;
      
      console.log(`ç¸½å­—ç¬¦æ•¸: ${totalCharCount}, ä¸­æ–‡å­—ç¬¦æ•¸: ${chineseCharCount}, ä¸­æ–‡æ¯”ä¾‹: ${(chineseRatio * 100).toFixed(1)}%`);
      
      // å¦‚æœä¸­æ–‡æ¯”ä¾‹è¶…é 20%ï¼Œå°±èªç‚ºæ˜¯ä¸­æ–‡é é¢
      if (chineseRatio > 0.2) {
        console.log('æª¢æ¸¬åˆ°ä¸­æ–‡é é¢');
        return 'chinese';
      }
      
      // å¦‚æœä¸­æ–‡æ¯”ä¾‹å¾ˆä½ï¼Œæª¢æŸ¥ HTML lang å±¬æ€§
      if (htmlLang && (htmlLang.startsWith('zh') || htmlLang.startsWith('en'))) {
        const detectedLang = htmlLang.startsWith('zh') ? 'chinese' : 'english';
        console.log(`æ ¹æ“š HTML lang å±¬æ€§æª¢æ¸¬ç‚º: ${detectedLang}`);
        return detectedLang;
      }
      
      // æª¢æŸ¥ meta æ¨™ç±¤
      if (metaLang?.content) {
        const detectedLang = metaLang.content.startsWith('zh') ? 'chinese' : 'english';
        console.log(`æ ¹æ“š Meta æ¨™ç±¤æª¢æ¸¬ç‚º: ${detectedLang}`);
        return detectedLang;
      }
      
      console.log('é è¨­ç‚ºè‹±æ–‡é é¢');
      return 'english';
    }

    // æ§‹å»ºé é¢åˆ†æè«‹æ±‚åƒæ•¸
    private buildPageAnalysisPayload({ text, length, type }: { text: string; length: number; type: string }) {
      const detectedLanguage = this.detectPageLanguage();
      
      return {
        text,
        analysis_type: `page_${type}`,
        content_length: length,
        user_id: this.state.userId,
        language: detectedLanguage,
        name: this.state.botName,
        frontend_source: 'astro_page_analyzer',
        page_url: window.location.href,
        page_title: document.title
      };
    }

    // æª¢æŸ¥å¿«å–
    private getAnalysisCache(type: string): { answer: string; timestamp: number } | null {
      const cacheKey = `page_analysis_${window.location.href}_${type}`;
      const cached = sessionStorage.getItem(cacheKey);
      if (!cached) return null;
      
      const data = JSON.parse(cached);
      const now = Date.now();
      const fiveMinutes = 5 * 60 * 1000;
      
      // æª¢æŸ¥æ˜¯å¦åœ¨ 5 åˆ†é˜å…§
      if (now - data.timestamp < fiveMinutes) {
        return data;
      }
      
      // éæœŸå‰‡æ¸…é™¤
      sessionStorage.removeItem(cacheKey);
      return null;
    }

    // å„²å­˜å¿«å–
    private setAnalysisCache(type: string, answer: string) {
      const cacheKey = `page_analysis_${window.location.href}_${type}`;
      const data = { answer, timestamp: Date.now() };
      sessionStorage.setItem(cacheKey, JSON.stringify(data));
    }

    // æ¸²æŸ“åˆ†æçµæœå¡ç‰‡
    private renderAnalysisCard(answer: string, analysisType: string, contentLength: number) {
      const currentLang = this.state.currentLanguage;
      const templates = analystTemplates[currentLang as keyof typeof analystTemplates];
      const labels = templates?.labels || {};
      const metadata = templates?.metadata || {};
      
      const typeLabels: Record<string, string> = {
        'page_summary': labels.page_summary || 'ğŸ“„ é é¢æ‘˜è¦',
        'page_key_points': labels.page_key_points || 'ğŸ” é‡é»æå–',
        'page_technical': labels.page_technical || 'âš™ï¸ æŠ€è¡“åˆ†æ',
        'page_qa': labels.page_qa || 'â“ å•é¡Œç”Ÿæˆ'
      };
      
      const messageDiv = this.createMessageStructure('bot', this.formatAnswer(answer));
      const contentDiv = messageDiv.querySelector('.message-content') as HTMLDivElement;
      
      // æ·»åŠ åˆ†æå¡ç‰‡å…ƒæ•¸æ“š
      const metadataDiv = document.createElement('div');
      metadataDiv.className = 'analysis-metadata';
      metadataDiv.innerHTML = `
        <div class="analysis-info">
          <span class="analysis-type">${typeLabels[analysisType] || 'é é¢åˆ†æ'}</span>
          <span class="content-length">${metadata.content_length || 'å…§å®¹é•·åº¦'}: ${contentLength} ${currentLang === 'english' ? 'chars' : 'å­—'}</span>
          <span class="page-url">${metadata.source || 'ä¾†æº'}: ${document.title}</span>
        </div>
        <div class="analysis-actions">
          <button class="reanalyze-btn" onclick="this.closest('.message').dispatchEvent(new CustomEvent('reanalyze'))">
            ${metadata.reanalyze || 'ğŸ”„ é‡æ–°åˆ†æ'}
          </button>
          <button class="copy-btn" onclick="navigator.clipboard.writeText('${answer.replace(/'/g, "\\'")}')">
            ${metadata.copy_result || 'ğŸ“‹ è¤‡è£½çµæœ'}
          </button>
        </div>
      `;
      
      contentDiv.appendChild(metadataDiv);
      this.elements.chatMessages.appendChild(messageDiv);
      
      // ç›£è½é‡æ–°åˆ†æäº‹ä»¶
      messageDiv.addEventListener('reanalyze', () => {
        this.analyzePage(true); // å¼·åˆ¶é‡æ–°åˆ†æï¼Œå¿½ç•¥å¿«å–
      });
      
      this.scrollToBottom();
    }

    // æ›´æ–°åˆ†ææŒ‰éˆ•ç‹€æ…‹
    private updateAnalysisButtonState() {
      const startBtn = document.querySelector('#startPageAnalysis') as HTMLButtonElement;
      if (!startBtn) return;
      
      const currentLang = this.state.currentLanguage;
      const templates = analystTemplates[currentLang as keyof typeof analystTemplates];
      const ui = templates?.ui;
      
      if (this.state.isAnalyzing) {
        startBtn.disabled = true;
        startBtn.innerHTML = `<span class="spinner">â³</span> ${ui?.analyzing || 'åˆ†æä¸­...'}`;
      } else {
        startBtn.disabled = false;
        startBtn.innerHTML = ui?.start_button || 'ğŸ“„ åˆ†æé é¢';
      }
    }

    private async analyzePage(forceRefresh: boolean = false) {
      if (this.state.isAnalyzing) return;
      
      this.state.isAnalyzing = true;
      this.updateAnalysisButtonState();
      
      const loadingId = this.addLoadingMessage();

      try {
        // æª¢æŸ¥å¿«å–ï¼ˆé™¤éå¼·åˆ¶é‡æ–°åˆ†æï¼‰
        if (!forceRefresh) {
          const cached = this.getAnalysisCache(this.state.analysisType);
          if (cached) {
            this.removeMessage(loadingId);
            this.renderAnalysisCard(cached.answer, `page_${this.state.analysisType}`, 0);
            this.state.isAnalyzing = false;
            this.updateAnalysisButtonState();
            this.toggleAnalysisPanel(false);
            return;
          }
        }

        // ç”Ÿæˆç”¨æˆ¶æç¤ºæ¶ˆæ¯
        const currentLang = this.state.currentLanguage;
        const templates = analystTemplates[currentLang as keyof typeof analystTemplates];
        const labels = templates?.labels || {};
        
        const typeLabels: Record<string, string> = {
          summary: labels.page_summary || 'ğŸ“„ é é¢æ‘˜è¦',
          key_points: labels.page_key_points || 'ğŸ” é‡é»æå–',
          technical: labels.page_technical || 'âš™ï¸ æŠ€è¡“åˆ†æ',
          qa: labels.page_qa || 'â“ å•é¡Œç”Ÿæˆ'
        };
        
        const userPrompt = currentLang === 'english' 
          ? `Please ${typeLabels[this.state.analysisType] || 'analyze the page'}`
          : `è«‹${typeLabels[this.state.analysisType] || 'åˆ†æé é¢'}`;
        
        this.addMessage(userPrompt, 'user');
        
        // æå–é é¢å…§å®¹
        const { text, length } = this.extractPageContentSafe();
        
        // æ§‹å»ºè«‹æ±‚åƒæ•¸
        const payload = this.buildPageAnalysisPayload({ text, length, type: this.state.analysisType });
        
        // èª¿ç”¨ API
        const result = await this.callQAAPI(payload);
        this.removeMessage(loadingId);

        if (result.success) {
          const answer = result.text || result.answer || result;
          
          // å„²å­˜å¿«å–
          this.setAnalysisCache(this.state.analysisType, answer);
          
          // æ¸²æŸ“çµæœ
          this.renderAnalysisCard(answer, `page_${this.state.analysisType}`, length);
        } else {
          this.addErrorMessage(result.error || 'åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
      } catch (err) {
        this.removeMessage(loadingId);
        this.addErrorMessage(`åˆ†æå¤±æ•—ï¼š${(err as Error).message}`);
      } finally {
        this.state.isAnalyzing = false;
        this.updateAnalysisButtonState();
        this.toggleAnalysisPanel(false);
      }
    }
  }

  // åˆå§‹åŒ–QABot
  document.addEventListener('DOMContentLoaded', () => {
    new QABot();
  });
</script>

<!-- å¼•å…¥ SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
