---
// QABotçµ„ä»¶
import '../styles/qabot.css';
---

<!-- æµ®å‹•èŠå¤©æŒ‰éˆ• -->
<div class="qa-bot-toggle" id="qaBotToggle">
  <img src="/tymultiverse/assets/sawamayo.jpeg" alt="Sawa Maya" class="toggle-image" />
  <span class="toggle-text">çœŸå¤œ</span>
</div>

<!-- èŠå¤©å°è©±æ¡† -->
<div class="qa-bot-container" id="qaBotContainer">
  <div class="chat-header">
    <div class="header-content">
      <img src="/tymultiverse/assets/sawamayo.jpeg" alt="ä½å’Œ çœŸå¤œ" class="header-avatar" />
      <div class="header-text">
        <h3>ä½å’Œ çœŸå¤œ</h3>
        <p>TYçš„æ™ºæ…§åº«</p>
      </div>
    </div>
    <div class="header-controls">
      <button class="fullscreen-button" id="fullscreenButton" title="åˆ‡æ›å…¨å±æ¨¡å¼">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
      </button>
      <button class="language-button" id="languageButton" title="åˆ‡æ›èªè¨€">
        <span class="language-text">ä¸­æ–‡</span>
      </button>
      <button class="history-button" id="historyButton" title="æŸ¥çœ‹èŠå¤©æ­·å²">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </button>
      <button class="close-button" id="closeButton">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>
  
  <div class="chat-messages" id="chatMessages">
    <div class="message bot-message">
      <div class="message-avatar">
        <img src="/tymultiverse/assets/sawamayo.jpeg" alt="çœŸå¤œ" class="bot-avatar" />
      </div>
      <div class="message-content-wrapper">
        <div class="message-header">
          <span class="ai-name">çœŸå¤œ</span>
        </div>
        <div class="message-content">
          <p>ä½ æœ‰äº‹ï¼Ÿ<br>å•å‰æƒ³æ¸…æ¥šï¼Œæ©Ÿæœƒä¸æ˜¯èª°éƒ½æœ‰ã€‚</p>
          
          <!-- ä¸»é¡Œå»ºè­° -->
          <div class="topic-suggestions">
            <h4>ğŸ’¡ å»ºè­°ä¸»é¡Œï¼š</h4>
            <div class="suggestion-buttons">
              <button class="suggestion-btn" data-topic="Java">â˜• Java é–‹ç™¼</button>
              <button class="suggestion-btn" data-topic="OOPåŠDIæ¡†æ¶">ğŸ—ï¸ OOPåŠDIæ¡†æ¶</button>
              <button class="suggestion-btn" data-topic="éƒ¨ç½²å¯¦è¸">ğŸš€ éƒ¨ç½²å¯¦è¸</button>
              <button class="suggestion-btn" data-topic="ç¶²è·¯å•é¡Œ">ğŸŒ ç¶²è·¯å•é¡Œ</button>
              <button class="suggestion-btn" data-topic="äº†è§£çœŸå¤œ">æƒ³å¤šäº†è§£å¦³</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="load-more-container" id="loadMoreContainer" style="display: none;">
    <button class="load-more-button" id="loadMoreButton">
      è¼‰å…¥æ›´å¤šæ­·å²è¨˜éŒ„
    </button>
  </div>
  
  <div class="chat-input-container">
    <div class="input-wrapper">
      <input 
        type="text" 
        id="userInput" 
        placeholder=""
        class="chat-input"
        maxlength="500"
      />
      <button 
        id="sendButton" 
        class="send-button"
        disabled
      >
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
      </button>
    </div>
    <div class="input-status" id="inputStatus"></div>
  </div>
</div>

<!-- åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† -->
<div class="image-modal" id="imageModal">
  <div class="image-modal-content">
    <button class="image-modal-close" id="imageModalClose">&times;</button>
    <img id="modalImage" src="" alt="æ”¾å¤§åœ–ç‰‡" />
  </div>
</div>

<script>
  // å°‡è¨Šæ¯é…ç½®ç›´æ¥æ‰“åŒ…ï¼Œé¿å…æ­£å¼ç’°å¢ƒ 404
  // @ts-ignore
  import mayaMessages from '../storages/mayaMessages.json';
  class QABot {
    // DOM å…ƒç´ 
    private elements: Record<string, HTMLElement> = {};
    
    // ç‹€æ…‹ç®¡ç†
    private state = {
      userId: '',
      currentHistoryPage: 0,
      historyItemsPerPage: 5,
      currentLanguage: 'chinese',
      isFullscreen: false,
      isThinking: false,
      saucyMessageCount: 0,
      maxSaucyMessages: 3,
      lastSaucyMessage: '',
      hasShownInactivityMessage: false,
      currentTheme: 'light'
    };
    
    // å®šæ™‚å™¨
    private timers = {
      inactivity: null as NodeJS.Timeout | null,
      randomMessage: null as NodeJS.Timeout | null
    };
    
        // æ¶ˆæ¯é…ç½®
    private messages: any = null;

    constructor() {
      this.initializeElements();
      this.initializeState();
      this.initializeTheme();
      this.setupEventListeners();
      this.loadMessages().then(() => {
      this.loadChatHistory();
        this.startTimers();
      });
    }

    // åˆå§‹åŒ–ä¸»é¡Œ
    private initializeTheme() {
      // æª¢æ¸¬ç•¶å‰ä¸»é¡Œ
      this.state.currentTheme = this.detectCurrentTheme();
      
      // ç›£è½ä¸»é¡Œè®ŠåŒ–
      this.setupThemeListener();
    }

    // æª¢æ¸¬ç•¶å‰ä¸»é¡Œ
    private detectCurrentTheme(): string {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        return savedTheme;
      }
      
      // æª¢æŸ¥ç³»çµ±åå¥½
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark';
      }
      
      // æª¢æŸ¥ DOM ä¸­çš„ theme-dark é¡
      if (document.documentElement.classList.contains('theme-dark')) {
        return 'dark';
      }
      
      return 'light';
    }

    // è¨­ç½®ä¸»é¡Œç›£è½å™¨
    private setupThemeListener() {
      // ç›£è½ localStorage è®ŠåŒ–
      window.addEventListener('storage', (e) => {
        if (e.key === 'theme') {
          this.updateTheme(e.newValue || 'light');
        }
      });
      
      // ç›£è½ DOM è®ŠåŒ–ï¼ˆç•¶å…¶ä»–çµ„ä»¶æ”¹è®Šä¸»é¡Œæ™‚ï¼‰
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const target = mutation.target as HTMLElement;
            if (target === document.documentElement) {
              const newTheme = target.classList.contains('theme-dark') ? 'dark' : 'light';
              if (newTheme !== this.state.currentTheme) {
                this.updateTheme(newTheme);
              }
            }
          }
        });
      });
      
      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
      });
      
      // ç›£è½ç³»çµ±ä¸»é¡Œè®ŠåŒ–
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      mediaQuery.addEventListener('change', (e) => {
        const newTheme = e.matches ? 'dark' : 'light';
        if (newTheme !== this.state.currentTheme) {
          this.updateTheme(newTheme);
        }
      });
    }

    // æ›´æ–°ä¸»é¡Œ
    private updateTheme(newTheme: string) {
      this.state.currentTheme = newTheme;
      console.log('QABot theme updated to:', newTheme);
      
      // é€™è£¡å¯ä»¥æ·»åŠ ä¸»é¡Œç›¸é—œçš„é‚è¼¯
      // ä¾‹å¦‚æ›´æ–°æŒ‰éˆ•æ¨£å¼ã€é‡æ–°æ¸²æŸ“ç­‰
    }

    // åˆå§‹åŒ– DOM å…ƒç´ 
    private initializeElements() {
      const elementIds = [
        'userInput', 'sendButton', 'chatMessages', 'inputStatus', 'qaBotToggle', 
        'qaBotContainer', 'closeButton', 'historyButton', 'loadMoreButton', 
        'loadMoreContainer', 'imageModal', 'modalImage', 'imageModalClose'
      ];
      
      elementIds.forEach(id => {
        this.elements[id] = document.getElementById(id) as HTMLElement;
      });
    }

    // åˆå§‹åŒ–ç‹€æ…‹
    private initializeState() {
      this.state.userId = this.getOrCreateUserId();
      this.state.currentLanguage = localStorage.getItem('qabot_language') || 'chinese';
      this.updateLanguageButton();
      this.updateInputPlaceholder();
    }

    // è¼‰å…¥æ¶ˆæ¯é…ç½®
    private async loadMessages() {
      // ä¸å†é€é fetchï¼Œç›´æ¥ä½¿ç”¨æ‰“åŒ…é€²ä¾†çš„ JSON
      this.messages = mayaMessages;
    }

    // è¨­ç½®äº‹ä»¶ç›£è½å™¨
    private setupEventListeners() {
      // åŸºæœ¬æ§åˆ¶äº‹ä»¶
      this.elements.qaBotToggle.addEventListener('click', () => this.toggleChat());
      this.elements.closeButton.addEventListener('click', () => this.hideChat());
      this.elements.historyButton.addEventListener('click', () => this.loadChatHistory());
      this.elements.loadMoreButton.addEventListener('click', () => this.loadMoreHistory());
      
      // åŠŸèƒ½æŒ‰éˆ•äº‹ä»¶
      (document.getElementById('fullscreenButton') as HTMLButtonElement).addEventListener('click', () => this.toggleFullscreen());
      (document.getElementById('languageButton') as HTMLButtonElement).addEventListener('click', () => this.toggleLanguage());
      
      // è¼¸å…¥ç›¸é—œäº‹ä»¶
      this.elements.userInput.addEventListener('input', () => {
        this.updateSendButton();
        this.resetInactivityTimer();
      });

      this.elements.userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
        this.resetInactivityTimer();
      });

      this.elements.sendButton.addEventListener('click', () => {
        this.sendMessage();
        this.resetInactivityTimer();
      });

      // ä¸»é¡Œå»ºè­°äº‹ä»¶
      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target?.classList.contains('suggestion-btn')) {
          const topic = target.getAttribute('data-topic');
          if (topic) {
            this.handleTopicSuggestion(topic);
          }
        }
      });
      
      // åœ–ç‰‡æ¨¡æ…‹æ¡†äº‹ä»¶
      this.elements.imageModalClose.addEventListener('click', (e) => {
        e.stopPropagation();
        this.hideImageModal();
      });

      this.elements.imageModal.addEventListener('click', (e) => {
        if (e.target === this.elements.imageModal) this.hideImageModal();
      });
      
      // åœ–ç‰‡é»æ“Šäº‹ä»¶
      this.elements.chatMessages.addEventListener('click', (e) => {
        const img = (e.target as HTMLElement).closest('.answer-image') as HTMLImageElement;
        if (img) {
          const imageSrc = img.getAttribute('data-src') || img.src;
          this.showImageModal(imageSrc);
        }
      });
      
      // ESC éµé—œé–‰æ¨¡æ…‹æ¡†
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.elements.imageModal.classList.contains('show')) {
          this.hideImageModal();
        }
      });
    }

    // å‰µå»ºæ¶ˆæ¯çµæ§‹çš„é€šç”¨æ–¹æ³•
    private createMessageStructure(type: 'bot' | 'user' | 'loading' = 'bot', content?: any) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}-message`;
      
      if (type === 'bot' || type === 'loading') {
      // æ·»åŠ é ­åƒ
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      const avatarImg = document.createElement('img');
      avatarImg.src = '/tymultiverse/assets/sawamayo.jpeg';
      avatarImg.alt = 'çœŸå¤œ';
      avatarImg.className = 'bot-avatar';
      avatarDiv.appendChild(avatarImg);
      messageDiv.appendChild(avatarDiv);
      
      // æ·»åŠ å…§å®¹åŒ…è£å™¨
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'message-content-wrapper';
      
      // æ·»åŠ æ¶ˆæ¯é ­éƒ¨
      const headerDiv = document.createElement('div');
      headerDiv.className = 'message-header';
      const aiName = document.createElement('span');
      aiName.className = 'ai-name';
      aiName.textContent = 'çœŸå¤œ';
      headerDiv.appendChild(aiName);
      contentWrapper.appendChild(headerDiv);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      
        if (type === 'loading') {
          contentDiv.innerHTML = `
            <div class="loading">
              <div class="spinner"></div>
              <span>æ­£åœ¨æ€è€ƒä¸­...</span>
            </div>
          `;
        } else if (content) {
          // ç¢ºä¿ content æ˜¯å­—ç¬¦ä¸²é¡å‹
          if (typeof content !== 'string') {
            content = String(content || '');
          }
          contentDiv.innerHTML = content;
        }
        
        contentWrapper.appendChild(contentDiv);
        messageDiv.appendChild(contentWrapper);
      } else if (type === 'user' && content) {
        // ç”¨æˆ¶æ¶ˆæ¯
        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';
        const userId = document.createElement('span');
        userId.className = 'user-id';
        userId.textContent = `ID: ${this.state.userId.substring(0, 8)}...`;
        headerDiv.appendChild(userId);
        messageDiv.appendChild(headerDiv);
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        // ç¢ºä¿ content æ˜¯å­—ç¬¦ä¸²é¡å‹
        if (typeof content !== 'string') {
          content = String(content || '');
        }
        contentDiv.innerHTML = `<p>${this.escapeHtml(content)}</p>`;
        messageDiv.appendChild(contentDiv);
      }
      
      return messageDiv;
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å€åŸŸ
    private addMessage(content: any, type: 'bot' | 'user' | 'loading' = 'bot') {
      // ç¢ºä¿ content æ˜¯å­—ç¬¦ä¸²é¡å‹
      if (typeof content !== 'string') {
        console.warn('addMessage: content is not a string:', content);
        content = String(content || '');
      }
      
      const messageDiv = this.createMessageStructure(type, content);
      this.elements.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
      return messageDiv;
    }

    // æ·»åŠ è¼‰å…¥æ¶ˆæ¯
    private addLoadingMessage() {
      this.state.isThinking = true;
      const loadingDiv = this.createMessageStructure('loading');
      this.elements.chatMessages.appendChild(loadingDiv);
      this.scrollToBottom();
      return loadingDiv;
    }

    // æ·»åŠ æ­¡è¿æ¶ˆæ¯
    private addWelcomeMessage() {
      // å…ˆé¡¯ç¤º loading æ•ˆæœ
      const loadingDiv = this.createMessageStructure('loading');
      this.elements.chatMessages.appendChild(loadingDiv);
      this.scrollToBottom();
      
      // å»¶é² 1.5 ç§’å¾Œé¡¯ç¤ºå¯¦éš›çš„æ­¡è¿æ¶ˆæ¯
      setTimeout(() => {
        this.removeMessage(loadingDiv);
        
        const currentMessages = this.messages[this.state.currentLanguage as keyof typeof this.messages];
        const randomWelcome = currentMessages.welcome[Math.floor(Math.random() * currentMessages.welcome.length)];
        
        const messageDiv = this.createMessageStructure('bot', `<p>${randomWelcome}</p>`);
      
      // æ·»åŠ ä¸»é¡Œå»ºè­°
        const contentDiv = messageDiv.querySelector('.message-content') as HTMLDivElement;
      const topicSuggestions = document.createElement('div');
      topicSuggestions.className = 'topic-suggestions';
      
      const suggestionsTitle = document.createElement('h4');
        suggestionsTitle.textContent = this.state.currentLanguage === 'chinese' ? 'ğŸ’¡ å»ºè­°ä¸»é¡Œï¼š' : 'ğŸ’¡ Suggested Topics:';
      topicSuggestions.appendChild(suggestionsTitle);
      
      const suggestionButtons = document.createElement('div');
      suggestionButtons.className = 'suggestion-buttons';
      
        const topics = this.state.currentLanguage === 'chinese' ? [
        { key: 'Java', text: 'â˜• Java é–‹ç™¼' },
        { key: 'OOPåŠDIæ¡†æ¶', text: 'ğŸ—ï¸ OOPåŠDIæ¡†æ¶' },
        { key: 'éƒ¨ç½²å¯¦è¸', text: 'ğŸš€ éƒ¨ç½²å¯¦è¸' },
        { key: 'ç¶²è·¯å•é¡Œ', text: 'ğŸŒ ç¶²è·¯å•é¡Œ' },
        { key: 'äº†è§£çœŸå¤œ', text: 'æƒ³å¤šäº†è§£å¦³' }
      ] : [
        { key: 'Java', text: 'â˜• Java Development' },
        { key: 'OOPåŠDIæ¡†æ¶', text: 'ğŸ—ï¸ OOP & DI Frameworks' },
        { key: 'éƒ¨ç½²å¯¦è¸', text: 'ğŸš€ Deployment Practices' },
        { key: 'ç¶²è·¯å•é¡Œ', text: 'ğŸŒ Network Issues' },
        { key: 'äº†è§£çœŸå¤œ', text: 'Learn More About Maya' }
      ];
      
      topics.forEach(topic => {
        const button = document.createElement('button');
        button.className = 'suggestion-btn';
        button.setAttribute('data-topic', topic.key);
        button.textContent = topic.text;
        suggestionButtons.appendChild(button);
      });
      
      topicSuggestions.appendChild(suggestionButtons);
      contentDiv.appendChild(topicSuggestions);
      
        this.elements.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
      }, 1500);
    }

    // è™•ç†ä¸»é¡Œå»ºè­°
    private handleTopicSuggestion(topic: string) {
      if (!this.messages) {
        console.error('æ¶ˆæ¯é…ç½®æœªè¼‰å…¥');
        return;
      }
      
      const currentMessages = this.messages[this.state.currentLanguage as keyof typeof this.messages];
      
      if (!currentMessages || !currentMessages.topics) {
        console.error('ç•¶å‰èªè¨€æ¶ˆæ¯æˆ–topicsä¸å­˜åœ¨');
        return;
      }
      
      const suggestion = currentMessages.topics[topic as keyof typeof currentMessages.topics];
      
      if (suggestion) {
        (this.elements.userInput as HTMLInputElement).value = suggestion;
        this.updateSendButton();
        (this.elements.userInput as HTMLInputElement).focus();
      } else {
        // å˜—è©¦ä½¿ç”¨å‚™ç”¨æ–‡æœ¬
        const fallbackText = `è«‹å‘Šè¨´æˆ‘é—œæ–¼ ${topic} çš„çŸ¥è­˜`;
        (this.elements.userInput as HTMLInputElement).value = fallbackText;
        this.updateSendButton();
        (this.elements.userInput as HTMLInputElement).focus();
      }
    }

    // æ ¼å¼åŒ–ç­”æ¡ˆ
    private formatAnswer(answer: string): string {
      let formattedAnswer = answer;
      
      // è™•ç†ç‰¹æ®Šæ ¼å¼
      formattedAnswer = formattedAnswer.replace(/ã€Œ([^ã€]+)ã€/g, '<strong>ã€Œ$1ã€</strong>');
      formattedAnswer = formattedAnswer.replace(/(å‰å›½\s*[å°åƒç§‹][ç™¾ç§‹])(?![^<]*\.png)/g, '<strong>$1</strong>');
      formattedAnswer = formattedAnswer.replace(/(æ£®ç¯‰\s*ç©ºéŸ³)(?![^<]*\.png)/g, '<strong>$1</strong>');
      formattedAnswer = formattedAnswer.replace(/(Sayuri|Chiaki|Sorane)(?![^<]*\.png)/g, '<strong>$1</strong>');
      
      // è™•ç†åœ–ç‰‡é€£çµ
      formattedAnswer = formattedAnswer.replace(/åœ–ç‰‡é€£çµï¼š\s*\n((?:- [^\n]+\n?)+)/gi, (match, imageList) => {
        const imageUrls = imageList.match(/https?:\/\/[^\n]+\.(?:png|jpg|jpeg|gif|webp)/gi) || [];
        return `<div class="image-container-wrapper">${imageUrls.map(url => 
          `<div class="image-container"><img src="${url}" alt="åœ–ç‰‡" class="answer-image" data-src="${url}" onerror="this.style.display='none'" /></div>`
        ).join('')}</div>`;
      });
      
      formattedAnswer = formattedAnswer.replace(/åœ–ç‰‡é€£çµï¼š\s*(https?:\/\/[^\n]+\.(?:png|jpg|jpeg|gif|webp))/gi, 
        '<div class="image-container"><img src="$1" alt="åœ–ç‰‡" class="answer-image" data-src="$1" onerror="this.style.display=\'none\'" /></div>');
      
      // è™•ç†æ›è¡Œ
      formattedAnswer = formattedAnswer.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
      return `<p>${formattedAnswer}</p>`;
    }

    // æ·»åŠ æ©Ÿå™¨äººå›æ‡‰
    private addBotResponse(answer: any, sources: any[]) {
      this.state.isThinking = false;
      
      // è™•ç† answer å¯èƒ½æ˜¯å°è±¡çš„æƒ…æ³
      let answerText = '';
      if (typeof answer === 'object' && answer !== null) {
        // å¦‚æœæ˜¯å°è±¡ï¼Œå˜—è©¦æå– text å­—æ®µ
        if (answer.text) {
          answerText = answer.text;
        } else if (answer.answer) {
          answerText = answer.answer;
        } else if (answer.response) {
          answerText = answer.response;
        } else {
          // å¦‚æœæ²’æœ‰æ‰¾åˆ°é æœŸçš„å­—æ®µï¼Œå°‡æ•´å€‹å°è±¡è½‰æ›ç‚ºå­—ç¬¦ä¸²
          answerText = JSON.stringify(answer);
        }
      } else if (typeof answer === 'string') {
        answerText = answer;
      } else {
        answerText = String(answer || '');
      }
      
      const messageDiv = this.createMessageStructure('bot', this.formatAnswer(answerText));
      const contentDiv = messageDiv.querySelector('.message-content') as HTMLDivElement;
      
      // æ·»åŠ ä¾†æºåˆ—è¡¨ï¼ˆåƒ…åœ¨å­˜åœ¨æœ‰æ•ˆä¾†æºæ™‚ï¼‰
      if (sources && Array.isArray(sources) && sources.length > 0) {
        const sourcesDiv = document.createElement('div');
        sourcesDiv.className = 'sources-list';

        let hasValidSource = false;

        sources.forEach(source => {
          // å–å¾—æª”æ¡ˆè·¯å¾‘ï¼ˆå¯èƒ½æ¬„ä½åç¨±ä¸åŒï¼‰
          const filePath = (source && (source.file_path || source.path || source.file)) as string | undefined;
          if (!filePath) return; // ç„¡æ•ˆä¾†æºç›´æ¥è·³é

          // ç¬¬ä¸€æ¬¡å–å¾—æœ‰æ•ˆä¾†æºæ™‚ï¼Œæ’å…¥æ¨™é¡Œ
          if (!hasValidSource) {
            const sourcesTitle = document.createElement('h4');
            sourcesTitle.textContent = 'ğŸ“š åƒè€ƒæ–‡æª”ï¼š';
            sourcesDiv.appendChild(sourcesTitle);
            hasValidSource = true;
          }

          const sourceItem = document.createElement('div');
          sourceItem.className = 'source-item';

          const link = document.createElement('a');
          link.href = `/tymultiverse/work/${filePath.replace('.md', '')}`;
          link.target = '_blank';
          link.className = 'source-link';
          link.innerHTML = `ğŸ“„ ${this.escapeHtml(filePath)}`;

          // é¡¯ç¤ºç›¸ä¼¼åº¦ï¼ˆè‹¥æœ‰ï¼‰
          if (source && typeof source.similarity === 'number') {
            const similaritySpan = document.createElement('span');
            similaritySpan.className = 'similarity';
            similaritySpan.textContent = `ç›¸é—œåº¦: ${(source.similarity * 100).toFixed(1)}%`;
            sourceItem.appendChild(similaritySpan);
          }

          sourceItem.appendChild(link);
          sourcesDiv.appendChild(sourceItem);
        });

        // åªæœ‰åœ¨ç¢ºå®šæœ‰è‡³å°‘ä¸€å€‹æœ‰æ•ˆä¾†æºæ™‚æ‰åŠ å…¥å…§å®¹
        if (hasValidSource) {
          contentDiv.appendChild(sourcesDiv);
        }
      }
      
      this.elements.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
    }

    // æ·»åŠ éŒ¯èª¤æ¶ˆæ¯
    private addErrorMessage(message: string) {
      this.state.isThinking = false;
      const messageDiv = this.createMessageStructure('bot', `<p class="error-message">âŒ ${this.escapeHtml(message)}</p>`);
      this.elements.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
    }

    // ç™¼é€æ¶ˆæ¯
    private async sendMessage() {
      const userText = (this.elements.userInput as HTMLInputElement).value.trim();
      if (!userText) return;

      (this.elements.userInput as HTMLInputElement).value = '';
      this.updateSendButton();
      this.elements.inputStatus.textContent = '';

      this.addMessage(userText, 'user');
      const loadingId = this.addLoadingMessage();

      try {
        const response = await this.callQAAPI(userText);
        this.removeMessage(loadingId);

        // console.log('APIéŸ¿æ‡‰:', response);

        if (response.success) {
          // æ ¹æ“šAPIéŸ¿æ‡‰çµæ§‹ï¼Œä½¿ç”¨ response.text æˆ– response.answer
          const answer = response.text || response.answer || response;
          const sources = response.data || response.sources || [];
          // console.log('æå–çš„ç­”æ¡ˆ:', answer);
          // console.log('æå–çš„ä¾†æº:', sources);
          this.addBotResponse(answer, sources);
        } else {
          this.addErrorMessage('æŠ±æ­‰ï¼Œç„¡æ³•ç²å–ç­”æ¡ˆï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
      } catch (error) {
        console.error('APIèª¿ç”¨éŒ¯èª¤:', error);
        this.removeMessage(loadingId);
        this.addErrorMessage('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£æ¥å¾Œé‡è©¦ã€‚');
      }
    }

    // èª¿ç”¨ QA API
    private async callQAAPI(text: string) {
      const apiBaseUrl = import.meta.env.DEV ? 'http://localhost:8000' : (import.meta.env.PUBLIC_API_BASE_URL || '');
      const apiPathPrefix = '/maya-sawa';
      
      const response = await fetch(`${apiBaseUrl}${apiPathPrefix}/qa/query`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          text,
          user_id: this.state.userId,
          language: this.state.currentLanguage
        })
      });

      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return await response.json();
    }

    // è¼‰å…¥èŠå¤©æ­·å²
    private async loadChatHistory() {
      try {
        const apiBaseUrl = import.meta.env.DEV ? 'http://localhost:8000' : (import.meta.env.PUBLIC_API_BASE_URL || '');
        const apiPathPrefix = '/maya-sawa';
        
        const response = await fetch(`${apiBaseUrl}${apiPathPrefix}/qa/chat-history/${this.state.userId}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const result = await response.json();
        
        this.elements.chatMessages.innerHTML = '';
        this.addWelcomeMessage();
        
        if (result.success && result.history && result.history.length > 0) {
          this.state.currentHistoryPage = 0;
          const historyToShow = result.history.slice(0, this.state.historyItemsPerPage);
          
          historyToShow.forEach(item => {
            this.addHistoryMessage(item.user_message, item.ai_answer, item.reference_data || []);
          });
          
          if (result.history.length > this.state.historyItemsPerPage) {
            this.elements.loadMoreContainer.style.display = 'block';
            this.state.currentHistoryPage = 1;
          }
        }
      } catch (error) {
        console.error('è¼‰å…¥èŠå¤©æ­·å²å¤±æ•—:', error);
        this.addErrorMessage('âŒ è¼‰å…¥èŠå¤©æ­·å²å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // è¼‰å…¥æ›´å¤šæ­·å²è¨˜éŒ„
    private async loadMoreHistory() {
      try {
        const apiBaseUrl = import.meta.env.DEV ? 'http://localhost:8000' : (import.meta.env.PUBLIC_API_BASE_URL || '');
        const apiPathPrefix = '/maya-sawa';
        
        const response = await fetch(`${apiBaseUrl}${apiPathPrefix}/qa/chat-history/${this.state.userId}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const result = await response.json();
        
        if (result.success && result.history) {
          const startIndex = this.state.currentHistoryPage * this.state.historyItemsPerPage;
          const endIndex = startIndex + this.state.historyItemsPerPage;
          const historyToShow = result.history.slice(startIndex, endIndex);
          
          historyToShow.forEach(item => {
            this.addHistoryMessage(item.user_message, item.ai_answer, item.reference_data || []);
          });
          
          this.state.currentHistoryPage++;
          
          if (endIndex >= result.history.length) {
            this.elements.loadMoreContainer.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('è¼‰å…¥æ›´å¤šæ­·å²è¨˜éŒ„å¤±æ•—:', error);
        this.addErrorMessage('âŒ è¼‰å…¥æ›´å¤šè¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // æ·»åŠ æ­·å²æ¶ˆæ¯
    private addHistoryMessage(userMessage: any, aiAnswer: any, sources: any[]) {
      // ç¢ºä¿åƒæ•¸æ˜¯å­—ç¬¦ä¸²é¡å‹
      if (typeof userMessage !== 'string') {
        userMessage = String(userMessage || '');
      }
      if (typeof aiAnswer !== 'string') {
        aiAnswer = String(aiAnswer || '');
      }
      
      this.addMessage(userMessage, 'user');
      this.addBotResponse(aiAnswer, sources);
    }

    // é¡¯ç¤ºå‚¬ä¿ƒæ¶ˆæ¯
    private showSaucyMessage() {
      if (this.state.saucyMessageCount >= this.state.maxSaucyMessages) return;
      
      this.state.saucyMessageCount++;
      const currentMessages = this.messages[this.state.currentLanguage as keyof typeof this.messages];
      
      // é¿å…é‡è¤‡é¡¯ç¤ºç›¸åŒçš„æ¶ˆæ¯
      let availableMessages = currentMessages.saucy.filter((msg: string) => msg !== this.state.lastSaucyMessage);
      if (availableMessages.length === 0) {
        // å¦‚æœæ‰€æœ‰æ¶ˆæ¯éƒ½ç”¨éäº†ï¼Œé‡ç½®ä¸¦ä½¿ç”¨æ‰€æœ‰æ¶ˆæ¯
        availableMessages = currentMessages.saucy;
        this.state.lastSaucyMessage = '';
      }
      
      const randomMessage = availableMessages[Math.floor(Math.random() * availableMessages.length)];
      this.state.lastSaucyMessage = randomMessage;
      
      const messageDiv = this.createMessageStructure('loading');
      this.elements.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
      
      setTimeout(() => {
        const contentDiv = messageDiv.querySelector('.message-content') as HTMLDivElement;
        contentDiv.innerHTML = `<p>${randomMessage}</p>`;
        this.scrollToBottom();
      }, 1500);
    }

    // å•Ÿå‹•å®šæ™‚å™¨
    private startTimers() {
      // å•Ÿå‹•ä¸æ´»èºè¨ˆæ™‚å™¨ï¼ˆä½¿ç”¨éå¢é–“éš”ï¼‰
      this.startInactivityTimer();

      // å®šæœŸæª¢æŸ¥æ˜¯å¦éœ€è¦ç™¼é€å‚¬ä¿ƒæ¶ˆæ¯
      this.timers.randomMessage = setInterval(() => {
        if (this.elements.qaBotContainer.classList.contains('show') && 
            !this.state.isThinking && 
            this.state.saucyMessageCount < this.state.maxSaucyMessages) {
          this.showSaucyMessage();
        }
      }, 100000); // æ¯100ç§’æª¢æŸ¥ä¸€æ¬¡
    }

    // é‡ç½®ä¸æ´»èºè¨ˆæ™‚å™¨
    private resetInactivityTimer() {
      if (this.timers.inactivity) clearTimeout(this.timers.inactivity);
      this.state.hasShownInactivityMessage = false;
      this.state.saucyMessageCount = 0;
      
      // é‡æ–°å•Ÿå‹•å®šæ™‚å™¨ï¼Œä½¿ç”¨éå¢é–“éš”
      this.startInactivityTimer();
    }

    // å•Ÿå‹•ä¸æ´»èºè¨ˆæ™‚å™¨ï¼ˆä½¿ç”¨éå¢é–“éš”ï¼‰
    private startInactivityTimer() {
      const intervals = [3, 9, 27]; // 3åˆ†é˜, 9åˆ†é˜, 27åˆ†é˜
      const currentInterval = intervals[this.state.saucyMessageCount] || intervals[intervals.length - 1];
      
      this.timers.inactivity = setTimeout(() => {
        if (!this.state.hasShownInactivityMessage && !this.state.isThinking && this.state.saucyMessageCount < this.state.maxSaucyMessages) {
          this.showSaucyMessage();
          this.state.hasShownInactivityMessage = true;
          
          // å¦‚æœé‚„æ²’é”åˆ°æœ€å¤§æ¬¡æ•¸ï¼Œè¨­ç½®ä¸‹ä¸€æ¬¡å®šæ™‚å™¨
          if (this.state.saucyMessageCount < this.state.maxSaucyMessages) {
      this.startInactivityTimer();
    }
        }
      }, currentInterval * 60 * 1000);
    }

    // åˆ‡æ›èªè¨€
    private toggleLanguage() {
      this.state.currentLanguage = this.state.currentLanguage === 'chinese' ? 'english' : 'chinese';
      localStorage.setItem('qabot_language', this.state.currentLanguage);
      this.updateLanguageButton();
      this.updateInputPlaceholder();
      this.reinitializeChat();
    }

    // é‡æ–°åˆå§‹åŒ–èŠå¤©
    private reinitializeChat() {
      this.elements.chatMessages.innerHTML = '';
      this.state.lastSaucyMessage = '';
      this.state.hasShownInactivityMessage = false;
      this.state.isThinking = false;
      this.state.saucyMessageCount = 0;
      this.addWelcomeMessage();
      this.resetInactivityTimer();
      this.scrollToBottom();
    }

    // åˆ‡æ›å…¨å±
    private toggleFullscreen() {
      this.state.isFullscreen = !this.state.isFullscreen;
      this.elements.qaBotContainer.classList.toggle('fullscreen', this.state.isFullscreen);
      this.updateFullscreenButton();
    }

    // åˆ‡æ›èŠå¤©æ¡†
    private toggleChat() {
      this.elements.qaBotContainer.classList.toggle('show');
      if (this.elements.qaBotContainer.classList.contains('show')) {
        (this.elements.userInput as HTMLInputElement).focus();
      }
    }

    // éš±è—èŠå¤©æ¡†
    private hideChat() {
      this.elements.qaBotContainer.classList.remove('show');
    }

    // é¡¯ç¤º/éš±è—åœ–ç‰‡æ¨¡æ…‹æ¡†
    private showImageModal(imageSrc: string) {
      (this.elements.modalImage as HTMLImageElement).src = imageSrc;
      this.elements.imageModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    private hideImageModal() {
      this.elements.imageModal.classList.remove('show');
      document.body.style.overflow = '';
    }

    // å·¥å…·æ–¹æ³•
    private getOrCreateUserId(): string {
      const storageKey = 'qabot_user_id';
      let userId = localStorage.getItem(storageKey);
      
      if (!userId) {
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(2, 15);
        userId = `user_${timestamp}_${random}`;
        localStorage.setItem(storageKey, userId);
      }
      
      return userId;
    }

    private updateSendButton() {
      const hasText = (this.elements.userInput as HTMLInputElement).value.trim().length > 0;
      (this.elements.sendButton as HTMLButtonElement).disabled = !hasText;
    }

    private updateLanguageButton() {
      const languageButton = document.getElementById('languageButton') as HTMLButtonElement;
      const languageText = languageButton.querySelector('.language-text') as HTMLSpanElement;
      
      if (this.state.currentLanguage === 'chinese') {
        languageText.textContent = 'ä¸­æ–‡';
        languageButton.title = 'åˆ‡æ›åˆ°è‹±æ–‡';
      } else {
        languageText.textContent = 'English';
        languageButton.title = 'Switch to Chinese';
      }
    }
    
    private updateInputPlaceholder() {
      (this.elements.userInput as HTMLInputElement).placeholder = this.state.currentLanguage === 'chinese' 
        ? 'è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ...' 
        : 'Please enter your question...';
    }

    private updateFullscreenButton() {
      const fullscreenButton = document.getElementById('fullscreenButton') as HTMLButtonElement;
      const svg = fullscreenButton.querySelector('svg');
      
      if (svg) {
        svg.innerHTML = this.state.isFullscreen 
          ? '<path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>'
          : '<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>';
        
        fullscreenButton.title = this.state.isFullscreen ? 'é€€å‡ºå…¨å±æ¨¡å¼' : 'åˆ‡æ›å…¨å±æ¨¡å¼';
      }
    }

    private removeMessage(messageElement: HTMLElement) {
      if (messageElement?.parentNode) {
        messageElement.parentNode.removeChild(messageElement);
      }
    }

    private scrollToBottom() {
      this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
    }

    private escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  }

  // åˆå§‹åŒ–QABot
  document.addEventListener('DOMContentLoaded', () => {
    new QABot();
  });
</script>
