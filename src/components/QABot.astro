---
// QABotçµ„ä»¶
import '../styles/qabot.css';
---

<!-- æµ®å‹•èŠå¤©æŒ‰éˆ• -->
<div class="qa-bot-toggle" id="qaBotToggle">
  <img src="/tymultiverse/assets/sawamayo.jpeg" alt="Sawa Maya" class="toggle-image" />
  <span class="toggle-text">çœŸå¤œ</span>
</div>

<!-- èŠå¤©å°è©±æ¡† -->
<div class="qa-bot-container" id="qaBotContainer">
  <div class="chat-header">
    <div class="header-content">
      <img src="/tymultiverse/assets/sawamayo.jpeg" alt="ä½å’Œ çœŸå¤œ" class="header-avatar" />
      <div class="header-text">
        <h3>ä½å’Œ çœŸå¤œ</h3>
        <p>TYçš„æ™ºæ…§åº«</p>
      </div>
    </div>
    <div class="header-controls">
      <button class="fullscreen-button" id="fullscreenButton" title="åˆ‡æ›å…¨å±æ¨¡å¼">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
      </button>
      <button class="language-button" id="languageButton" title="åˆ‡æ›èªè¨€">
        <span class="language-text">ä¸­æ–‡</span>
      </button>
      <button class="history-button" id="historyButton" title="æŸ¥çœ‹èŠå¤©æ­·å²">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </button>
      <button class="close-button" id="closeButton">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>
  
  <div class="chat-messages" id="chatMessages">
    <div class="message bot-message">
      <div class="message-avatar">
        <img src="/tymultiverse/assets/sawamayo.jpeg" alt="çœŸå¤œ" class="bot-avatar" />
      </div>
      <div class="message-content-wrapper">
        <div class="message-header">
          <span class="ai-name">çœŸå¤œ</span>
        </div>
        <div class="message-content">
          <p>ä½ æœ‰äº‹ï¼Ÿ<br>å•å‰æƒ³æ¸…æ¥šï¼Œæ©Ÿæœƒä¸æ˜¯èª°éƒ½æœ‰ã€‚</p>
          
          <!-- ä¸»é¡Œå»ºè­° -->
          <div class="topic-suggestions">
            <h4>ğŸ’¡ å»ºè­°ä¸»é¡Œï¼š</h4>
            <div class="suggestion-buttons">
              <button class="suggestion-btn" data-topic="Java">â˜• Java é–‹ç™¼</button>
              <button class="suggestion-btn" data-topic="OOPåŠDIæ¡†æ¶">ğŸ—ï¸ OOPåŠDIæ¡†æ¶</button>
              <button class="suggestion-btn" data-topic="éƒ¨ç½²å¯¦è¸">ğŸš€ éƒ¨ç½²å¯¦è¸</button>
              <button class="suggestion-btn" data-topic="ç¶²è·¯å•é¡Œ">ğŸŒ ç¶²è·¯å•é¡Œ</button>
              <button class="suggestion-btn" data-topic="äº†è§£çœŸå¤œ">æƒ³å¤šäº†è§£å¦³</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="load-more-container" id="loadMoreContainer" style="display: none;">
    <button class="load-more-button" id="loadMoreButton">
      è¼‰å…¥æ›´å¤šæ­·å²è¨˜éŒ„
    </button>
  </div>
  
  <div class="chat-input-container">
    <div class="input-wrapper">
      <input 
        type="text" 
        id="userInput" 
        placeholder=""
        class="chat-input"
        maxlength="500"
      />
      <button 
        id="sendButton" 
        class="send-button"
        disabled
      >
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
      </button>
    </div>
    <div class="input-status" id="inputStatus"></div>
  </div>
</div>

<script>
  class QABot {
    private userInput: HTMLInputElement;
    private sendButton: HTMLButtonElement;
    private chatMessages: HTMLDivElement;
    private inputStatus: HTMLDivElement;
    private qaBotToggle: HTMLDivElement;
    private qaBotContainer: HTMLDivElement;
    private closeButton: HTMLButtonElement;
    private historyButton: HTMLButtonElement;
    private loadMoreButton: HTMLButtonElement;
    private loadMoreContainer: HTMLDivElement;
    private userId: string;
    private currentHistoryPage: number = 0;
    private historyItemsPerPage: number = 5;
    private inactivityTimer: NodeJS.Timeout | null = null;
    private hasShownInactivityMessage: boolean = false;
    private randomMessageTimer: NodeJS.Timeout | null = null;
    private lastSaucyMessage: string = ''; // è¨˜éŒ„ä¸Šä¸€å€‹å‚¬ä¿ƒæ¶ˆæ¯
    private isThinking: boolean = false; // è¨˜éŒ„æ˜¯å¦æ­£åœ¨æ€è€ƒå›ç­”
    private currentLanguage: string = 'chinese'; // ç•¶å‰èªè¨€è¨­ç½®
    private isFullscreen: boolean = false; // å…¨å±æ¨¡å¼ç‹€æ…‹
    private saucyMessageCount: number = 0; // å‚¬ä¿ƒæ¶ˆæ¯è¨ˆæ•¸
    private maxSaucyMessages: number = 3; // æœ€å¤§å‚¬ä¿ƒæ¶ˆæ¯æ¬¡æ•¸
    
    // æ­¡è¿æ¶ˆæ¯é™£åˆ— - ä¸­æ–‡ç‰ˆæœ¬ 10å€‹
    private welcomeMessagesChinese = [
      "ä½ æœ‰äº‹ï¼Ÿ<br>å•å‰æƒ³æ¸…æ¥šï¼Œæ©Ÿæœƒä¸æ˜¯èª°éƒ½æœ‰ã€‚",
      "å“¼ï½åˆä¾†ç…©æˆ‘äº†ï¼Ÿ<br>å¸Œæœ›ä½ çš„å•é¡Œå€¼å¾—æˆ‘å›ç­”ã€‚",
      "å˜–å˜–ï¼Œåˆæ˜¯ä½ é€™å€‹å°å‚¢ä¼™ï¼Ÿ<br>åˆ¥æµªè²»æˆ‘çš„æ™‚é–“ã€‚",
      "å“å‘€ï½åˆæœ‰äººä¾†æ‰¾æˆ‘äº†ï¼Ÿ<br>æœ€å¥½çµ¦æˆ‘ä¸€å€‹å¥½ç†ç”±ã€‚",
      "å‘µå‘µï¼Œåˆä¾†æ‰“æ“¾æˆ‘äº†ï¼Ÿ<br>æˆ‘çš„æ™‚é–“å¾ˆå¯¶è²´çš„ã€‚",
      "å˜ï½åˆæ˜¯ä½ ï¼Ÿ<br>åˆ¥ä»¥ç‚ºæˆ‘æœƒå°ä½ å®¢æ°£ã€‚",
      "å“¼ï¼Œåˆä¾†ç…©æˆ‘äº†ï¼Ÿ<br>å¸Œæœ›ä½ çš„å•é¡Œä¸æœƒè®“æˆ‘å¤±æœ›ã€‚",
      "å˜–ï¼Œåˆæ˜¯é€™å€‹å‚¢ä¼™ï¼Ÿ<br>æˆ‘çš„è€å¿ƒå¯æ˜¯æœ‰é™çš„ã€‚",
      "å“å‘€ï½åˆæœ‰äººä¾†æ‰¾æˆ‘äº†ï¼Ÿ<br>å¿«é»èªªé‡é»ã€‚",
      "å—¯ï¼Ÿé‚„ä¸èªªï¼Ÿ<br>æˆ‘çš„è€å¿ƒå¯æ˜¯å¾ˆæœ‰é™çš„ï¼Œå°å‚¢ä¼™ï½"
    ];
    
    // æ­¡è¿æ¶ˆæ¯é™£åˆ— - è‹±æ–‡ç‰ˆæœ¬ 10å€‹
    private welcomeMessagesEnglish = [
      "What do you want?<br>Think carefully before asking, opportunities aren't for everyone.",
      "Hmph~ bothering me again?<br>I hope your question is worth my time.",
      "Tsk tsk, it's you again, little one?<br>Don't waste my time.",
      "Oh my~ someone's looking for me again?<br>You'd better have a good reason.",
      "Hehe, disturbing me again?<br>My time is precious.",
      "Hmph~ you again?<br>Don't think I'll be nice to you.",
      "Hmph, bothering me again?<br>I hope your question won't disappoint me.",
      "Tsk, this guy again?<br>My patience is limited.",
      "Oh my~ someone's looking for me again?<br>Get to the point quickly.",
      "Hm? Still not talking?<br>My patience is very limited, little one~"
    ];
    
    // å‚¬ä¿ƒç”¨æˆ¶èªªè©±çš„é¨·æ°£å›æ‡‰é™£åˆ— - ä¸­æ–‡ç‰ˆæœ¬ 10å€‹
    private saucyMessagesChinese = [
      "å—¯ï¼Ÿé‚„ä¸èªªï¼Ÿ<br>æˆ‘çš„è€å¿ƒå¯æ˜¯æœ‰é™çš„å“¦ï½",
      "å˜–å˜–ï¼Œæ‰“é–‹èŠå¤©æ¡†åˆä¸èªªè©±ï¼Ÿ<br>æœ‰è©±å¿«èªªï¼Œåˆ¥æµªè²»æˆ‘çš„æ™‚é–“ã€‚",
      "æ—¢ç„¶ä¾†äº†å°±å¿«é»èªªé‡é»ã€‚",
      "åˆ¥å…‰çœ‹è‘—ï¼Œæœ‰è©±å°±èªªã€‚",
      "æ—¢ç„¶ä¾†äº†å°±åˆ¥æµªè²»æ™‚é–“ã€‚",
      "åˆ¥ä»¥ç‚ºæˆ‘æœƒä¸€ç›´ç­‰ä½ ï¼Œæœ‰è©±å¿«èªªã€‚",
      "æˆ‘çš„æ™‚é–“å¾ˆå¯¶è²´çš„ï¼ŒçŸ¥é“å—ï¼Ÿå¿«é»èªªã€‚",
      "åˆ¥å…‰ç›¯è‘—æˆ‘çœ‹ï¼Œæœ‰è©±å°±èªªã€‚",
      "åˆ¥æµªè²»æˆ‘çš„æ™‚é–“ï¼Œå¿«é»èªªé‡é»ã€‚",
      "å—¯ï¼Ÿé‚„ä¸èªªï¼Ÿ<br>æˆ‘çš„è€å¿ƒå¯æ˜¯å¾ˆæœ‰é™çš„ï¼Œå°å‚¢ä¼™ï½"
    ];
    
    // å‚¬ä¿ƒç”¨æˆ¶èªªè©±çš„é¨·æ°£å›æ‡‰é™£åˆ— - è‹±æ–‡ç‰ˆæœ¬ 10å€‹
    private saucyMessagesEnglish = [
      "Hm? Still not talking?<br>My patience is limited, you know~",
      "Tsk tsk, opening the chat but not saying anything?<br>Speak up, don't waste my time.",
      "Since you're here, get to the point quickly.",
      "Don't just stare, say something.",
      "Since you're here, don't waste time.",
      "Don't think I'll wait for you forever, speak up.",
      "My time is precious, you know? Hurry up and talk.",
      "Don't just stare at me, say something.",
      "Don't waste my time, get to the point quickly.",
      "Hm? Still not talking?<br>My patience is very limited, little one~"
    ];
    
    // ç²å–ç•¶å‰èªè¨€çš„æ­¡è¿æ¶ˆæ¯
    get welcomeMessages() {
      return this.currentLanguage === 'chinese' ? this.welcomeMessagesChinese : this.welcomeMessagesEnglish;
    }
    
    // ç²å–ç•¶å‰èªè¨€çš„é¨·æ°£æ¶ˆæ¯
    get saucyMessages() {
      return this.currentLanguage === 'chinese' ? this.saucyMessagesChinese : this.saucyMessagesEnglish;
    }

    constructor() {
      this.userInput = document.getElementById('userInput') as HTMLInputElement;
      this.sendButton = document.getElementById('sendButton') as HTMLButtonElement;
      this.chatMessages = document.getElementById('chatMessages') as HTMLDivElement;
      this.inputStatus = document.getElementById('inputStatus') as HTMLDivElement;
      this.qaBotToggle = document.getElementById('qaBotToggle') as HTMLDivElement;
      this.qaBotContainer = document.getElementById('qaBotContainer') as HTMLDivElement;
      this.closeButton = document.getElementById('closeButton') as HTMLButtonElement;
      this.historyButton = document.getElementById('historyButton') as HTMLButtonElement;
      this.loadMoreButton = document.getElementById('loadMoreButton') as HTMLButtonElement;
      this.loadMoreContainer = document.getElementById('loadMoreContainer') as HTMLDivElement;
      
      // åˆå§‹åŒ–èªè¨€è¨­ç½®
      this.initializeLanguage();
      
      // è¨­ç½®è¼¸å…¥æ¡†ä½”ä½ç¬¦
      this.updateInputPlaceholder();
      
      // ç”Ÿæˆæˆ–ç²å–ç”¨æˆ¶ID
      this.userId = this.getOrCreateUserId();
      console.log('QABot: ç”¨æˆ¶ID:', this.userId);
      
      this.setupEventListeners();
      
      // åˆå§‹åŒ–æ™‚è¼‰å…¥èŠå¤©æ­·å²
      this.loadChatHistory();
      
      // å•Ÿå‹•ä¸æ´»èºè¨ˆæ™‚å™¨
      this.startInactivityTimer();
      
      // å•Ÿå‹•éš¨æ©Ÿé¨·æ°£æ¶ˆæ¯å®šæ™‚å™¨
      this.startRandomMessageTimer();
    }

    setupEventListeners() {
      // åˆ‡æ›å°è©±æ¡†äº‹ä»¶
      this.qaBotToggle.addEventListener('click', () => {
        this.toggleChat();
      });

      this.closeButton.addEventListener('click', () => {
        this.hideChat();
      });

      // å…¨å±æŒ‰éˆ•äº‹ä»¶
      const fullscreenButton = document.getElementById('fullscreenButton') as HTMLButtonElement;
      fullscreenButton.addEventListener('click', () => {
        this.toggleFullscreen();
      });

      // èªè¨€åˆ‡æ›æŒ‰éˆ•äº‹ä»¶
      const languageButton = document.getElementById('languageButton') as HTMLButtonElement;
      languageButton.addEventListener('click', () => {
        this.toggleLanguage();
      });

      // æ­·å²æŒ‰éˆ•äº‹ä»¶
      this.historyButton.addEventListener('click', () => {
        this.loadChatHistory();
      });

      // è¼‰å…¥æ›´å¤šæŒ‰éˆ•äº‹ä»¶
      this.loadMoreButton.addEventListener('click', () => {
        this.loadMoreHistory();
      });

      // ä¸»é¡Œå»ºè­°æŒ‰éˆ•äº‹ä»¶
      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target && target.classList.contains('suggestion-btn')) {
          const topic = target.getAttribute('data-topic');
          if (topic) {
            this.handleTopicSuggestion(topic);
          }
        }
      });

      // è¼¸å…¥æ¡†äº‹ä»¶
      this.userInput.addEventListener('input', () => {
        this.updateSendButton();
      });

      this.userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
      });

      // ç™¼é€æŒ‰éˆ•äº‹ä»¶
      this.sendButton.addEventListener('click', () => {
        this.sendMessage();
      });

      // é‡ç½®ä¸æ´»èºè¨ˆæ™‚å™¨çš„äº‹ä»¶
      this.userInput.addEventListener('input', () => {
        this.resetInactivityTimer();
      });

      this.userInput.addEventListener('keypress', () => {
        this.resetInactivityTimer();
      });

      this.sendButton.addEventListener('click', () => {
        this.resetInactivityTimer();
      });
    }

    updateSendButton() {
      const hasText = this.userInput.value.trim().length > 0;
      this.sendButton.disabled = !hasText;
    }

    // è™•ç†ä¸»é¡Œå»ºè­°
    handleTopicSuggestion(topic: string) {
      const suggestions = this.currentLanguage === 'chinese' ? {
        'Java': 'è«‹å‘Šè¨´æˆ‘é—œæ–¼ Java é–‹ç™¼çš„çŸ¥è­˜ï¼ŒåŒ…æ‹¬æ ¸å¿ƒæ¦‚å¿µã€æœ€ä½³å¯¦è¸å’Œå¸¸è¦‹å•é¡Œè§£æ±ºæ–¹æ¡ˆã€‚',
        'OOPåŠDIæ¡†æ¶': 'æˆ‘æƒ³äº†è§£é¢å‘å°è±¡ç·¨ç¨‹å’Œä¾è³´æ³¨å…¥æ¡†æ¶çš„è¨­è¨ˆåŸå‰‡å’Œå¯¦ç¾æ–¹å¼ã€‚',
        'éƒ¨ç½²å¯¦è¸': 'è«‹åˆ†äº«é—œæ–¼æ‡‰ç”¨ç¨‹åºéƒ¨ç½²ã€å®¹å™¨åŒ–å’Œ DevOps å¯¦è¸çš„ç¶“é©—ã€‚',
        'ç¶²è·¯å•é¡Œ': 'æˆ‘æƒ³äº†è§£ç¶²è·¯ç·¨ç¨‹ã€å”è­°å’Œå¸¸è¦‹ç¶²è·¯å•é¡Œçš„è¨ºæ–·èˆ‡è§£æ±ºæ–¹æ³•ã€‚',
        'äº†è§£çœŸå¤œ': 'å¦³æ˜¯èª°ï¼Ÿ'
      } : {
        'Java': 'Please tell me about Java development, including core concepts, best practices, and common problem solutions.',
        'OOPåŠDIæ¡†æ¶': 'I want to understand the design principles and implementation of object-oriented programming and dependency injection frameworks.',
        'éƒ¨ç½²å¯¦è¸': 'Please share your experience with application deployment, containerization, and DevOps practices.',
        'ç¶²è·¯å•é¡Œ': 'I want to understand network programming, protocols, and diagnosis and solutions for common network issues.',
        'äº†è§£çœŸå¤œ': 'Who are you?'
      };

      const suggestion = suggestions[topic as keyof typeof suggestions];
      if (suggestion) {
        this.userInput.value = suggestion;
        this.updateSendButton();
        this.userInput.focus();
      }
    }

    // æ·»åŠ æ­¡è¿æ¶ˆæ¯ï¼ˆåŒ…å«ä¸»é¡Œå»ºè­°ï¼‰
    addWelcomeMessage() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot-message';
      
      // æ·»åŠ é ­åƒ
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      const avatarImg = document.createElement('img');
      avatarImg.src = '/tymultiverse/assets/sawamayo.jpeg';
      avatarImg.alt = 'çœŸå¤œ';
      avatarImg.className = 'bot-avatar';
      avatarDiv.appendChild(avatarImg);
      messageDiv.appendChild(avatarDiv);
      
      // æ·»åŠ å…§å®¹åŒ…è£å™¨
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'message-content-wrapper';
      
      // æ·»åŠ æ¶ˆæ¯é ­éƒ¨
      const headerDiv = document.createElement('div');
      headerDiv.className = 'message-header';
      const aiName = document.createElement('span');
      aiName.className = 'ai-name';
      aiName.textContent = 'çœŸå¤œ';
      headerDiv.appendChild(aiName);
      contentWrapper.appendChild(headerDiv);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      
      // æ·»åŠ æ­¡è¿æ–‡å­— - ä½¿ç”¨éš¨æ©Ÿæ­¡è¿æ¶ˆæ¯
      const welcomeP = document.createElement('p');
      const randomWelcome = this.welcomeMessages[Math.floor(Math.random() * this.welcomeMessages.length)];
      welcomeP.innerHTML = randomWelcome;
      contentDiv.appendChild(welcomeP);
      
      // æ·»åŠ ä¸»é¡Œå»ºè­°
      const topicSuggestions = document.createElement('div');
      topicSuggestions.className = 'topic-suggestions';
      
      const suggestionsTitle = document.createElement('h4');
      suggestionsTitle.textContent = this.currentLanguage === 'chinese' ? 'ğŸ’¡ å»ºè­°ä¸»é¡Œï¼š' : 'ğŸ’¡ Suggested Topics:';
      topicSuggestions.appendChild(suggestionsTitle);
      
      const suggestionButtons = document.createElement('div');
      suggestionButtons.className = 'suggestion-buttons';
      
      const topics = this.currentLanguage === 'chinese' ? [
        { key: 'Java', text: 'â˜• Java é–‹ç™¼' },
        { key: 'OOPåŠDIæ¡†æ¶', text: 'ğŸ—ï¸ OOPåŠDIæ¡†æ¶' },
        { key: 'éƒ¨ç½²å¯¦è¸', text: 'ğŸš€ éƒ¨ç½²å¯¦è¸' },
        { key: 'ç¶²è·¯å•é¡Œ', text: 'ğŸŒ ç¶²è·¯å•é¡Œ' },
        { key: 'äº†è§£çœŸå¤œ', text: 'æƒ³å¤šäº†è§£å¦³' }
      ] : [
        { key: 'Java', text: 'â˜• Java Development' },
        { key: 'OOPåŠDIæ¡†æ¶', text: 'ğŸ—ï¸ OOP & DI Frameworks' },
        { key: 'éƒ¨ç½²å¯¦è¸', text: 'ğŸš€ Deployment Practices' },
        { key: 'ç¶²è·¯å•é¡Œ', text: 'ğŸŒ Network Issues' },
        { key: 'äº†è§£çœŸå¤œ', text: 'Learn More About Maya' }
      ];
      
      topics.forEach(topic => {
        const button = document.createElement('button');
        button.className = 'suggestion-btn';
        button.setAttribute('data-topic', topic.key);
        button.textContent = topic.text;
        suggestionButtons.appendChild(button);
      });
      
      topicSuggestions.appendChild(suggestionButtons);
      contentDiv.appendChild(topicSuggestions);
      
      contentWrapper.appendChild(contentDiv);
      messageDiv.appendChild(contentWrapper);
      this.chatMessages.appendChild(messageDiv);
      
      this.scrollToBottom();
    }

    // ç”Ÿæˆæˆ–ç²å–ç”¨æˆ¶ID
    getOrCreateUserId(): string {
      const storageKey = 'qabot_user_id';
      let userId = localStorage.getItem(storageKey);
      
      if (!userId) {
        // ç”Ÿæˆæ–°çš„ç”¨æˆ¶IDï¼šæ™‚é–“æˆ³ + éš¨æ©Ÿæ•¸
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(2, 15);
        userId = `user_${timestamp}_${random}`;
        localStorage.setItem(storageKey, userId);
        console.log('QABot: ç”Ÿæˆæ–°ç”¨æˆ¶ID:', userId);
      }
      
      return userId;
    }



    // è¼‰å…¥èŠå¤©æ­·å²
    async loadChatHistory() {
      try {
        console.log('è¼‰å…¥èŠå¤©æ­·å²ï¼Œç”¨æˆ¶ID:', this.userId);
        
        const response = await fetch(`${import.meta.env.PUBLIC_API_BASE_URL}/maya-sawa/qa/chat-history/${this.userId}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success && result.history && result.history.length > 0) {
          // é‡ç½®åˆ†é 
          this.currentHistoryPage = 0;
          
          // æ¸…ç©ºç•¶å‰èŠå¤©è¨˜éŒ„
          this.chatMessages.innerHTML = '';
          
          // æ·»åŠ æ­¡è¿æ¶ˆæ¯ï¼ˆåŒ…å«ä¸»é¡Œå»ºè­°ï¼‰
          this.addWelcomeMessage();
          
          // è¼‰å…¥å‰5æ¢æ­·å²è¨˜éŒ„
          const historyToShow = result.history.slice(0, this.historyItemsPerPage);
          historyToShow.forEach(item => {
            // ä½¿ç”¨æ­·å²è¨˜éŒ„ä¸­çš„reference_dataä½œç‚ºsources
            const sources = item.reference_data || [];
            this.addHistoryMessage(item.user_message, item.ai_answer, sources);
          });
          
          // å¦‚æœé‚„æœ‰æ›´å¤šè¨˜éŒ„ï¼Œé¡¯ç¤ºè¼‰å…¥æ›´å¤šæŒ‰éˆ•
          if (result.history.length > this.historyItemsPerPage) {
            this.loadMoreContainer.style.display = 'block';
            this.currentHistoryPage = 1;
          }
        } else {
          // æ²’æœ‰æ­·å²è¨˜éŒ„æ™‚ï¼Œé¡¯ç¤ºæ­¡è¿æ¶ˆæ¯
          this.chatMessages.innerHTML = '';
          this.addWelcomeMessage();
        }
      } catch (error) {
        console.error('è¼‰å…¥èŠå¤©æ­·å²å¤±æ•—:', error);
        this.addErrorMessage('âŒ è¼‰å…¥èŠå¤©æ­·å²å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // è¼‰å…¥æ›´å¤šæ­·å²è¨˜éŒ„
    async loadMoreHistory() {
      try {
        const response = await fetch(`${import.meta.env.PUBLIC_API_BASE_URL}/maya-sawa/qa/chat-history/${this.userId}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success && result.history) {
          const startIndex = this.currentHistoryPage * this.historyItemsPerPage;
          const endIndex = startIndex + this.historyItemsPerPage;
          const historyToShow = result.history.slice(startIndex, endIndex);
          
          // åœ¨è¼‰å…¥æ›´å¤šæŒ‰éˆ•å‰æ’å…¥æ­·å²è¨˜éŒ„
          historyToShow.forEach(item => {
            // ä½¿ç”¨æ­·å²è¨˜éŒ„ä¸­çš„reference_dataä½œç‚ºsources
            const sources = item.reference_data || [];
            this.addHistoryMessage(item.user_message, item.ai_answer, sources);
          });
          
          this.currentHistoryPage++;
          
          // å¦‚æœæ²’æœ‰æ›´å¤šè¨˜éŒ„ï¼Œéš±è—è¼‰å…¥æ›´å¤šæŒ‰éˆ•
          if (endIndex >= result.history.length) {
            this.loadMoreContainer.style.display = 'none';
          }
          

        }
      } catch (error) {
        console.error('è¼‰å…¥æ›´å¤šæ­·å²è¨˜éŒ„å¤±æ•—:', error);
        this.addErrorMessage('âŒ è¼‰å…¥æ›´å¤šè¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    async sendMessage() {
      const userText = this.userInput.value.trim();
      if (!userText) return;

      // æ¸…ç©ºè¼¸å…¥æ¡†å’Œç‹€æ…‹
      this.userInput.value = '';
      this.updateSendButton();
      this.inputStatus.textContent = '';

      // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯
      this.addMessage(userText, 'user');

      // æ·»åŠ è¼‰å…¥æ¶ˆæ¯
      const loadingId = this.addLoadingMessage();

      try {
        // èª¿ç”¨API
        const response = await this.callQAAPI(userText);
        
        // ç§»é™¤è¼‰å…¥æ¶ˆæ¯
        this.removeMessage(loadingId);

        if (response.success) {
          // æ·»åŠ æ©Ÿå™¨äººå›æ‡‰
          this.addBotResponse(response.answer, response.data);
        } else {
          // æ·»åŠ éŒ¯èª¤æ¶ˆæ¯
          this.addErrorMessage('æŠ±æ­‰ï¼Œç„¡æ³•ç²å–ç­”æ¡ˆï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
      } catch (error) {
        console.error('APIèª¿ç”¨éŒ¯èª¤:', error);
        this.removeMessage(loadingId);
        this.addErrorMessage('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£æ¥å¾Œé‡è©¦ã€‚');
      }
    }

    async callQAAPI(text) {
      console.log('QA API: èª¿ç”¨é ç¨‹æœå‹™ï¼Œç”¨æˆ¶ID:', this.userId, 'èªè¨€:', this.currentLanguage);
      
      // èª¿ç”¨é ç¨‹QAæœå‹™ï¼Œå¸¶ä¸Šç”¨æˆ¶IDå’Œèªè¨€åƒæ•¸
      const response = await fetch(`${import.meta.env.PUBLIC_API_BASE_URL}/maya-sawa/qa/query`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          text,
          user_id: this.userId,
          language: this.currentLanguage
        })
      });

      console.log('QA API: éŸ¿æ‡‰ç‹€æ…‹:', response.status);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return await response.json();
    }

    addMessage(content, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}-message`;
      
      if (type === 'bot') {
        // æ·»åŠ é ­åƒ
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        const avatarImg = document.createElement('img');
        avatarImg.src = '/tymultiverse/assets/sawamayo.jpeg';
        avatarImg.alt = 'çœŸå¤œ';
        avatarImg.className = 'bot-avatar';
        avatarDiv.appendChild(avatarImg);
        messageDiv.appendChild(avatarDiv);
        
        // æ·»åŠ å…§å®¹åŒ…è£å™¨
        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'message-content-wrapper';
        
        // æ·»åŠ æ¶ˆæ¯é ­éƒ¨
        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';
        const aiName = document.createElement('span');
        aiName.className = 'ai-name';
        aiName.textContent = 'çœŸå¤œ';
        headerDiv.appendChild(aiName);
        contentWrapper.appendChild(headerDiv);
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (typeof content === 'string') {
          contentDiv.innerHTML = `<p>${this.escapeHtml(content)}</p>`;
        } else {
          contentDiv.appendChild(content);
        }
        
        contentWrapper.appendChild(contentDiv);
        messageDiv.appendChild(contentWrapper);
      } else if (type === 'user') {
        // ç”¨æˆ¶æ¶ˆæ¯ä¿æŒåŸæ¨£
        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';
        const userId = document.createElement('span');
        userId.className = 'user-id';
        userId.textContent = `ID: ${this.userId.substring(0, 8)}...`;
        headerDiv.appendChild(userId);
        messageDiv.appendChild(headerDiv);
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (typeof content === 'string') {
          contentDiv.innerHTML = `<p>${this.escapeHtml(content)}</p>`;
        } else {
          contentDiv.appendChild(content);
        }
        
        messageDiv.appendChild(contentDiv);
      }
      
      this.chatMessages.appendChild(messageDiv);
      
      // æ»¾å‹•åˆ°åº•éƒ¨
      this.scrollToBottom();
      
      return messageDiv;
    }

    // æ·»åŠ æ­·å²æ¶ˆæ¯ï¼ˆä¸åŒ…å«é ­éƒ¨ï¼‰
    addHistoryMessage(userMessage, aiAnswer, sources) {
      // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯
      const userDiv = document.createElement('div');
      userDiv.className = 'message user-message';
      
      const userHeader = document.createElement('div');
      userHeader.className = 'message-header';
      const userUserId = document.createElement('span');
      userUserId.className = 'user-id';
      userUserId.textContent = `ID: ${this.userId.substring(0, 8)}...`;
      userHeader.appendChild(userUserId);
      userDiv.appendChild(userHeader);
      
      const userContent = document.createElement('div');
      userContent.className = 'message-content';
      userContent.innerHTML = `<p>${this.escapeHtml(userMessage)}</p>`;
      userDiv.appendChild(userContent);
      
      this.chatMessages.appendChild(userDiv);
      
      // æ·»åŠ AIå›æ‡‰
      const aiDiv = document.createElement('div');
      aiDiv.className = 'message bot-message';
      
      // æ·»åŠ é ­åƒ
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      const avatarImg = document.createElement('img');
      avatarImg.src = '/tymultiverse/assets/sawamayo.jpeg';
      avatarImg.alt = 'çœŸå¤œ';
      avatarImg.className = 'bot-avatar';
      avatarDiv.appendChild(avatarImg);
      aiDiv.appendChild(avatarDiv);
      
      // æ·»åŠ å…§å®¹åŒ…è£å™¨
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'message-content-wrapper';
      
      const aiHeader = document.createElement('div');
      aiHeader.className = 'message-header';
      const aiName = document.createElement('span');
      aiName.className = 'ai-name';
      aiName.textContent = 'çœŸå¤œ';
      aiHeader.appendChild(aiName);
      contentWrapper.appendChild(aiHeader);
      
      const aiContent = document.createElement('div');
      aiContent.className = 'message-content';
      
      // æ ¼å¼åŒ–ç­”æ¡ˆï¼ŒåŒ…æ‹¬åœ–ç‰‡è™•ç†
      const formattedAnswer = this.formatAnswer(aiAnswer);
      aiContent.innerHTML = formattedAnswer;
      
      // æ·»åŠ ä¾†æºåˆ—è¡¨
      if (sources && sources.length > 0) {
        const sourcesDiv = document.createElement('div');
        sourcesDiv.className = 'sources-list';
        
        const sourcesTitle = document.createElement('h4');
        sourcesTitle.textContent = 'ğŸ“š åƒè€ƒæ–‡æª”ï¼š';
        sourcesDiv.appendChild(sourcesTitle);
        
        sources.forEach(source => {
          const sourceItem = document.createElement('div');
          sourceItem.className = 'source-item';
          
          const link = document.createElement('a');
          link.href = `/tymultiverse/work/${source.file_path.replace('.md', '')}`;
          link.target = '_blank';
          link.className = 'source-link';
          link.innerHTML = `ğŸ“„ ${this.escapeHtml(source.file_path)}`;
          
          const similaritySpan = document.createElement('span');
          similaritySpan.className = 'similarity';
          similaritySpan.textContent = `ç›¸é—œåº¦: ${(source.similarity * 100).toFixed(1)}%`;
          
          sourceItem.appendChild(link);
          sourceItem.appendChild(similaritySpan);
          sourcesDiv.appendChild(sourceItem);
        });
        
        aiContent.appendChild(sourcesDiv);
      }
      
      contentWrapper.appendChild(aiContent);
      aiDiv.appendChild(contentWrapper);
      this.chatMessages.appendChild(aiDiv);
      
      this.scrollToBottom();
    }

    addLoadingMessage() {
      // è¨­ç½®æ€è€ƒç‹€æ…‹ç‚º true
      this.isThinking = true;
      
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message bot-message';
      
      // æ·»åŠ é ­åƒ
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      const avatarImg = document.createElement('img');
      avatarImg.src = '/tymultiverse/assets/sawamayo.jpeg';
      avatarImg.alt = 'çœŸå¤œ';
      avatarImg.className = 'bot-avatar';
      avatarDiv.appendChild(avatarImg);
      loadingDiv.appendChild(avatarDiv);
      
      // æ·»åŠ å…§å®¹åŒ…è£å™¨
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'message-content-wrapper';
      
      // æ·»åŠ æ¶ˆæ¯é ­éƒ¨
      const headerDiv = document.createElement('div');
      headerDiv.className = 'message-header';
      
      const aiName = document.createElement('span');
      aiName.className = 'ai-name';
      aiName.textContent = 'çœŸå¤œ';
      headerDiv.appendChild(aiName);
      contentWrapper.appendChild(headerDiv);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <span>æ­£åœ¨æ€è€ƒä¸­...</span>
        </div>
      `;
      
      contentWrapper.appendChild(contentDiv);
      loadingDiv.appendChild(contentWrapper);
      this.chatMessages.appendChild(loadingDiv);
      this.scrollToBottom();
      
      return loadingDiv;
    }

    // æ ¼å¼åŒ–AIå›ç­”ï¼Œæ”¹å–„æ’ç‰ˆ
    formatAnswer(answer: string): string {
      console.log('formatAnswer input:', answer);
      
      // å‰µå»ºå°ˆé–€çš„è§£æå™¨ä¾†è™•ç†åœ–ç‰‡å’Œæ–‡æœ¬
      const segments: Array<{ type: 'text' | 'image'; content: string }> = [];
      
      // è™•ç†æ–°çš„åœ–ç‰‡æ ¼å¼ï¼ˆåˆ—è¡¨å½¢å¼ï¼‰
      let processedAnswer = answer;
      const imageListRegex = /åœ–ç‰‡é€£çµï¼š\s*\n((?:- [^ï¼š]+ï¼š\s*https?:\/\/[^\n]+\n?)+)/gi;
      
      processedAnswer = processedAnswer.replace(imageListRegex, (match, imageList) => {
        const imageUrls = imageList.match(/https?:\/\/[^\n]+\.(?:png|jpg|jpeg|gif|webp)/gi) || [];
        return `<div class="image-container-wrapper">${imageUrls.map(url => `<div class="image-container"><img src="${url}" alt="åœ–ç‰‡" class="answer-image" onerror="this.style.display='none'" /></div>`).join('')}</div>`;
      });
      
      // è™•ç†å–®å€‹åœ–ç‰‡é€£çµï¼ˆèˆŠæ ¼å¼ï¼‰
      const singleImageRegex = /åœ–ç‰‡é€£çµï¼š\s*(https?:\/\/[^\n]+\.(?:png|jpg|jpeg|gif|webp))/gi;
      processedAnswer = processedAnswer.replace(singleImageRegex, 
        '<div class="image-container"><img src="$1" alt="åœ–ç‰‡" class="answer-image" onerror="this.style.display=\'none\'" /></div>');
      
      // å°‡è™•ç†å¾Œçš„æ–‡æœ¬åˆ†å‰²æˆæ®µè½
      const paragraphs = processedAnswer.split(/\n\n/);
      paragraphs.forEach(paragraph => {
        if (paragraph.trim()) {
          segments.push({ type: 'text', content: paragraph });
        }
      });
      
      // æ§‹å»ºæœ€çµ‚çš„HTML
      let result = '';
      segments.forEach(segment => {
        if (segment.type === 'text') {
          // è™•ç†æ–‡æœ¬
          let textContent = segment.content;
          // å°‡ \n\n è½‰æ›ç‚ºæ®µè½åˆ†éš”
          textContent = textContent.replace(/\n\n/g, '</p><p>');
          // å°‡å–®å€‹ \n è½‰æ›ç‚º <br>
          textContent = textContent.replace(/\n/g, '<br>');
          // åŒ…è£åœ¨æ®µè½æ¨™ç±¤ä¸­
          textContent = `<p>${textContent}</p>`;
          // è™•ç†ç‰¹æ®Šæ ¼å¼
          textContent = textContent.replace(/ã€Œ([^ã€]+)ã€/g, '<strong>ã€Œ$1ã€</strong>');
          textContent = textContent.replace(/(å‰å›½\s*[å°åƒç§‹][ç™¾ç§‹])/g, '<strong>$1</strong>');
          textContent = textContent.replace(/(æ£®ç¯‰\s*ç©ºéŸ³)/g, '<strong>$1</strong>');
          textContent = textContent.replace(/(Sayuri|Chiaki|Sorane)/g, '<strong>$1</strong>');
          result += textContent;
        } else if (segment.type === 'image') {
          // è™•ç†åœ–ç‰‡ - ä¸åŒ…è£åœ¨pæ¨™ç±¤å…§
          result += `<div class="image-container"><img src="${segment.content}" alt="åœ–ç‰‡" class="answer-image" onerror="this.style.display='none'" /></div>`;
        }
      });
      
      console.log('final formattedAnswer:', result);
      return result;
    }

    addBotResponse(answer, sources) {
      // é‡ç½®æ€è€ƒç‹€æ…‹ç‚º false
      this.isThinking = false;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot-message';
      
      // æ·»åŠ é ­åƒ
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      const avatarImg = document.createElement('img');
      avatarImg.src = '/tymultiverse/assets/sawamayo.jpeg';
      avatarImg.alt = 'çœŸå¤œ';
      avatarImg.className = 'bot-avatar';
      avatarDiv.appendChild(avatarImg);
      messageDiv.appendChild(avatarDiv);
      
      // æ·»åŠ å…§å®¹åŒ…è£å™¨
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'message-content-wrapper';
      
      // æ·»åŠ æ¶ˆæ¯é ­éƒ¨
      const headerDiv = document.createElement('div');
      headerDiv.className = 'message-header';
      
      const aiName = document.createElement('span');
      aiName.className = 'ai-name';
      aiName.textContent = 'çœŸå¤œ';
      headerDiv.appendChild(aiName);
      contentWrapper.appendChild(headerDiv);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      
      // æ·»åŠ æ ¼å¼åŒ–å¾Œçš„ç­”æ¡ˆ
      contentDiv.innerHTML = this.formatAnswer(answer);
      
      // æ·»åŠ ä¾†æºåˆ—è¡¨
      if (sources && sources.length > 0) {
        const sourcesDiv = document.createElement('div');
        sourcesDiv.className = 'sources-list';
        
        const sourcesTitle = document.createElement('h4');
        sourcesTitle.textContent = 'ğŸ“š åƒè€ƒæ–‡æª”ï¼š';
        sourcesDiv.appendChild(sourcesTitle);
        
        sources.forEach(source => {
          const sourceItem = document.createElement('div');
          sourceItem.className = 'source-item';
          
          // å‰µå»ºå¯é»æ“Šçš„é€£çµ
          const link = document.createElement('a');
          link.href = `/tymultiverse/work/${source.file_path.replace('.md', '')}`;
          link.target = '_blank';
          link.className = 'source-link';
          link.innerHTML = `ğŸ“„ ${this.escapeHtml(source.file_path)}`;
          
          const similaritySpan = document.createElement('span');
          similaritySpan.className = 'similarity';
          similaritySpan.textContent = `ç›¸é—œåº¦: ${(source.similarity * 100).toFixed(1)}%`;
          
          sourceItem.appendChild(link);
          sourceItem.appendChild(similaritySpan);
          sourcesDiv.appendChild(sourceItem);
        });
        
        contentDiv.appendChild(sourcesDiv);
      }
      
      contentWrapper.appendChild(contentDiv);
      messageDiv.appendChild(contentWrapper);
      this.chatMessages.appendChild(messageDiv);
      
      // æ»¾å‹•åˆ°åº•éƒ¨
      this.scrollToBottom();
    }

    addErrorMessage(message) {
      // é‡ç½®æ€è€ƒç‹€æ…‹ç‚º false
      this.isThinking = false;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot-message';
      
      // æ·»åŠ é ­åƒ
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      const avatarImg = document.createElement('img');
      avatarImg.src = '/tymultiverse/assets/sawamayo.jpeg';
      avatarImg.alt = 'çœŸå¤œ';
      avatarImg.className = 'bot-avatar';
      avatarDiv.appendChild(avatarImg);
      messageDiv.appendChild(avatarDiv);
      
      // æ·»åŠ å…§å®¹åŒ…è£å™¨
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'message-content-wrapper';
      
      // æ·»åŠ æ¶ˆæ¯é ­éƒ¨
      const headerDiv = document.createElement('div');
      headerDiv.className = 'message-header';
      
      const aiName = document.createElement('span');
      aiName.className = 'ai-name';
      aiName.textContent = 'çœŸå¤œ';
      headerDiv.appendChild(aiName);
      contentWrapper.appendChild(headerDiv);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = `<p style="color: #ffebee;">âŒ ${this.escapeHtml(message)}</p>`;
      
      contentWrapper.appendChild(contentDiv);
      messageDiv.appendChild(contentWrapper);
      this.chatMessages.appendChild(messageDiv);
      
      // æ»¾å‹•åˆ°åº•éƒ¨
      this.scrollToBottom();
    }

    removeMessage(messageElement) {
      if (messageElement && messageElement.parentNode) {
        messageElement.parentNode.removeChild(messageElement);
      }
    }

    scrollToBottom() {
      this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    toggleChat() {
      if (this.qaBotContainer.classList.contains('show')) {
        this.hideChat();
      } else {
        this.showChat();
      }
    }

    showChat() {
      this.qaBotContainer.classList.add('show');
      this.userInput.focus();
    }

    hideChat() {
      this.qaBotContainer.classList.remove('show');
    }

    // å•Ÿå‹•ä¸æ´»èºè¨ˆæ™‚å™¨
    startInactivityTimer() {
      this.inactivityTimer = setTimeout(() => {
        if (!this.hasShownInactivityMessage && !this.isThinking) {
          this.showInactivityMessage();
          this.hasShownInactivityMessage = true;
        }
      }, 10000); // 10ç§’
    }

    // é‡ç½®ä¸æ´»èºè¨ˆæ™‚å™¨
    resetInactivityTimer() {
      if (this.inactivityTimer) {
        clearTimeout(this.inactivityTimer);
      }
      this.hasShownInactivityMessage = false;
      this.saucyMessageCount = 0; // é‡ç½®å‚¬ä¿ƒæ¶ˆæ¯è¨ˆæ•¸
      this.startInactivityTimer();
    }

    // ç²å–ä¸é‡è¤‡çš„éš¨æ©Ÿå‚¬ä¿ƒæ¶ˆæ¯
    getRandomSaucyMessage(): string {
      let randomMessage: string;
      do {
        randomMessage = this.saucyMessages[Math.floor(Math.random() * this.saucyMessages.length)];
      } while (randomMessage === this.lastSaucyMessage && this.saucyMessages.length > 1);
      
      this.lastSaucyMessage = randomMessage;
      return randomMessage;
    }

    // é¡¯ç¤ºä¸æ´»èºæç¤ºæ¶ˆæ¯
    showInactivityMessage() {
      // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°æœ€å¤§æ¬¡æ•¸
      if (this.saucyMessageCount >= this.maxSaucyMessages) {
        return;
      }
      
      // å¢åŠ è¨ˆæ•¸
      this.saucyMessageCount++;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot-message';
      
      // æ·»åŠ é ­åƒ
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      const avatarImg = document.createElement('img');
      avatarImg.src = '/tymultiverse/assets/sawamayo.jpeg';
      avatarImg.alt = 'çœŸå¤œ';
      avatarImg.className = 'bot-avatar';
      avatarDiv.appendChild(avatarImg);
      messageDiv.appendChild(avatarDiv);
      
      // æ·»åŠ å…§å®¹åŒ…è£å™¨
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'message-content-wrapper';
      
      // æ·»åŠ æ¶ˆæ¯é ­éƒ¨
      const headerDiv = document.createElement('div');
      headerDiv.className = 'message-header';
      const aiName = document.createElement('span');
      aiName.className = 'ai-name';
      aiName.textContent = 'çœŸå¤œ';
      headerDiv.appendChild(aiName);
      contentWrapper.appendChild(headerDiv);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      
      // å…ˆé¡¯ç¤º"æ­£åœ¨æ€è€ƒä¸­..."
      contentDiv.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <span>æ­£åœ¨æ€è€ƒä¸­...</span>
        </div>
      `;
      
      contentWrapper.appendChild(contentDiv);
      messageDiv.appendChild(contentWrapper);
      this.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
      
      // å»¶é²1.5ç§’å¾Œé¡¯ç¤ºå¯¦éš›çš„å‚¬ä¿ƒæ¶ˆæ¯
      setTimeout(() => {
        const randomMessage = this.getRandomSaucyMessage();
        contentDiv.innerHTML = `<p>${randomMessage}</p>`;
        this.scrollToBottom();
      }, 1500);
      
      // å¦‚æœé‚„æ²’é”åˆ°æœ€å¤§æ¬¡æ•¸ï¼Œè¨­ç½®ä¸‹ä¸€æ¬¡å®šæ™‚å™¨ï¼ˆ3å€æ™‚é–“ï¼‰
      if (this.saucyMessageCount < this.maxSaucyMessages) {
        setTimeout(() => {
          if (this.qaBotContainer.classList.contains('show') && !this.isThinking) {
            this.showInactivityMessage();
          }
        }, 30000); // 30ç§’ï¼ˆ3å€æ–¼åŸä¾†çš„10ç§’ï¼‰
      }
    }

    // å•Ÿå‹•éš¨æ©Ÿé¨·æ°£æ¶ˆæ¯å®šæ™‚å™¨
    startRandomMessageTimer() {
      this.randomMessageTimer = setInterval(() => {
        // åªåœ¨èŠå¤©æ¡†é¡¯ç¤ºæ™‚ä¸”ä¸åœ¨æ€è€ƒç‹€æ…‹æ™‚æ‰ç™¼é€éš¨æ©Ÿæ¶ˆæ¯
        if (this.qaBotContainer.classList.contains('show') && !this.isThinking && this.saucyMessageCount < this.maxSaucyMessages) {
          this.sendRandomSaucyMessage();
        }
      }, 100000); // æ¯100ç§’
    }

    // ç™¼é€éš¨æ©Ÿé¨·æ°£æ¶ˆæ¯
    sendRandomSaucyMessage() {
      // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°æœ€å¤§æ¬¡æ•¸
      if (this.saucyMessageCount >= this.maxSaucyMessages) {
        return;
      }
      
      // å¢åŠ è¨ˆæ•¸
      this.saucyMessageCount++;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot-message';
      
      // æ·»åŠ é ­åƒ
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      const avatarImg = document.createElement('img');
      avatarImg.src = '/tymultiverse/assets/sawamayo.jpeg';
      avatarImg.alt = 'çœŸå¤œ';
      avatarImg.className = 'bot-avatar';
      avatarDiv.appendChild(avatarImg);
      messageDiv.appendChild(avatarDiv);
      
      // æ·»åŠ å…§å®¹åŒ…è£å™¨
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'message-content-wrapper';
      
      // æ·»åŠ æ¶ˆæ¯é ­éƒ¨
      const headerDiv = document.createElement('div');
      headerDiv.className = 'message-header';
      const aiName = document.createElement('span');
      aiName.className = 'ai-name';
      aiName.textContent = 'çœŸå¤œ';
      headerDiv.appendChild(aiName);
      contentWrapper.appendChild(headerDiv);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      
      // å…ˆé¡¯ç¤º"æ­£åœ¨æ€è€ƒä¸­..."
      contentDiv.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <span>æ­£åœ¨æ€è€ƒä¸­...</span>
        </div>
      `;
      
      contentWrapper.appendChild(contentDiv);
      messageDiv.appendChild(contentWrapper);
      this.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
      
      // å»¶é²1.5ç§’å¾Œé¡¯ç¤ºå¯¦éš›çš„å‚¬ä¿ƒæ¶ˆæ¯
      setTimeout(() => {
        const randomMessage = this.getRandomSaucyMessage();
        contentDiv.innerHTML = `<p>${randomMessage}</p>`;
        this.scrollToBottom();
      }, 1500);
      
      // å¦‚æœé‚„æ²’é”åˆ°æœ€å¤§æ¬¡æ•¸ï¼Œè¨­ç½®ä¸‹ä¸€æ¬¡å®šæ™‚å™¨ï¼ˆ3å€æ™‚é–“ï¼‰
      if (this.saucyMessageCount < this.maxSaucyMessages) {
        setTimeout(() => {
          if (this.qaBotContainer.classList.contains('show') && !this.isThinking) {
            this.sendRandomSaucyMessage();
          }
        }, 300000); // 300ç§’ = 5åˆ†é˜ï¼ˆ3å€æ–¼åŸä¾†çš„100ç§’ï¼‰
      }
    }

    // åˆå§‹åŒ–èªè¨€è¨­ç½®
    initializeLanguage() {
      // å¾ localStorage è®€å–ä¿å­˜çš„èªè¨€è¨­ç½®
      const savedLanguage = localStorage.getItem('qabot_language');
      if (savedLanguage) {
        this.currentLanguage = savedLanguage;
      }
      this.updateLanguageButton();
    }

    // åˆ‡æ›èªè¨€
    toggleLanguage() {
      this.currentLanguage = this.currentLanguage === 'chinese' ? 'english' : 'chinese';
      localStorage.setItem('qabot_language', this.currentLanguage);
      this.updateLanguageButton();
      
      // é‡æ–°åˆå§‹åŒ–å°è©±
      this.reinitializeChat();
    }
    
    // é‡æ–°åˆå§‹åŒ–èŠå¤©å°è©±
    reinitializeChat() {
      // æ¸…ç©ºç•¶å‰èŠå¤©è¨˜éŒ„
      this.chatMessages.innerHTML = '';
      
      // é‡ç½®ç‹€æ…‹
      this.lastSaucyMessage = '';
      this.hasShownInactivityMessage = false;
      this.isThinking = false;
      this.saucyMessageCount = 0; // é‡ç½®å‚¬ä¿ƒæ¶ˆæ¯è¨ˆæ•¸
      
      // æ›´æ–°è¼¸å…¥æ¡†ä½”ä½ç¬¦
      this.updateInputPlaceholder();
      
      // æ·»åŠ æ–°çš„æ­¡è¿æ¶ˆæ¯ï¼ˆä½¿ç”¨ç•¶å‰èªè¨€ï¼‰
      this.addWelcomeMessage();
      
      // é‡ç½®ä¸æ´»èºè¨ˆæ™‚å™¨
      this.resetInactivityTimer();
      
      // æ»¾å‹•åˆ°åº•éƒ¨
      this.scrollToBottom();
    }

    // æ›´æ–°èªè¨€æŒ‰éˆ•é¡¯ç¤º
    updateLanguageButton() {
      const languageButton = document.getElementById('languageButton') as HTMLButtonElement;
      const languageText = languageButton.querySelector('.language-text') as HTMLSpanElement;
      
      if (this.currentLanguage === 'chinese') {
        languageText.textContent = 'ä¸­æ–‡';
        languageButton.title = 'åˆ‡æ›åˆ°è‹±æ–‡';
      } else {
        languageText.textContent = 'English';
        languageButton.title = 'Switch to Chinese';
      }
    }
    
    // æ›´æ–°è¼¸å…¥æ¡†ä½”ä½ç¬¦
    updateInputPlaceholder() {
      this.userInput.placeholder = this.currentLanguage === 'chinese' 
        ? 'è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ...' 
        : 'Please enter your question...';
    }

    // åˆ‡æ›å…¨å±æ¨¡å¼
    toggleFullscreen() {
      this.isFullscreen = !this.isFullscreen;
      
      if (this.isFullscreen) {
        this.qaBotContainer.classList.add('fullscreen');
        this.updateFullscreenButton(true);
      } else {
        this.qaBotContainer.classList.remove('fullscreen');
        this.updateFullscreenButton(false);
      }
    }

    // æ›´æ–°å…¨å±æŒ‰éˆ•åœ–æ¨™
    updateFullscreenButton(isFullscreen: boolean) {
      const fullscreenButton = document.getElementById('fullscreenButton') as HTMLButtonElement;
      const svg = fullscreenButton.querySelector('svg');
      
      if (svg) {
        if (isFullscreen) {
          // é¡¯ç¤ºé€€å‡ºå…¨å±åœ–æ¨™
          svg.innerHTML = `
            <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
          `;
          fullscreenButton.title = 'é€€å‡ºå…¨å±æ¨¡å¼';
        } else {
          // é¡¯ç¤ºé€²å…¥å…¨å±åœ–æ¨™
          svg.innerHTML = `
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
          `;
          fullscreenButton.title = 'åˆ‡æ›å…¨å±æ¨¡å¼';
        }
      }
    }


  }

  // åˆå§‹åŒ–QABot
  document.addEventListener('DOMContentLoaded', () => {
    new QABot();
  });
</script>
