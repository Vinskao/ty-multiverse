---
import '../styles/galwall.css';
---
<div id="galwallWrapper">
  <div id="containerFront"></div>
  <div id="containerBack"></div>
</div>

<script>
  import { peopleService } from '../services/api/peopleService';

  let frontList: string[] = [];
  let backList: string[] = [];
  const baseImagePath = import.meta.env.PUBLIC_PEOPLE_IMAGE_URL + "/";

  // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦å­˜åœ¨
  async function checkImageExists(imagePath) {
    try {
      const response = await fetch(imagePath);
      return response.ok;
    } catch (error) {
      return false;
    }
  }

  // ç²å–è§’è‰²åˆ—è¡¨
  async function fetchCharacterNames() {
    try {
      console.log('ğŸ”„ Galwall ä½¿ç”¨ peopleService ç²å–è§’è‰²åç¨±åˆ—è¡¨...');
      const names = await peopleService.getAllPeopleNames();
      console.log('âœ… Galwall ç²å–è§’è‰²åç¨±åˆ—è¡¨æˆåŠŸ:', names);

      // ç¢ºä¿æ˜¯æ•¸çµ„æ ¼å¼
      return Array.isArray(names) ? names : [];
    } catch (error) {
      console.error('âŒ Galwall ç²å–è§’è‰²åç¨±åˆ—è¡¨å¤±æ•—:', error);
      return [];
    }
  }

  // æª¢æŸ¥ä¸‰ç¨®åœ–ç‰‡é¡å‹
  async function checkImageTypes(characterName) {
    const normalPath = `${baseImagePath}${characterName}.png`;
    const fightingPath = `${baseImagePath}${characterName}Fighting.png`;
    const ruinedPath = `${baseImagePath}${characterName}Ruined.png`;
    
    const [normalExists, fightingExists, ruinedExists] = await Promise.all([
      checkImageExists(normalPath),
      checkImageExists(fightingPath),
      checkImageExists(ruinedPath)
    ]);
    
    return {
      name: characterName,
      normalPath: normalExists ? normalPath : null,
      fightingPath: fightingExists ? fightingPath : null,
      ruinedPath: ruinedExists ? ruinedPath : null
    };
  }

  document.addEventListener("DOMContentLoaded", async function () {
    console.log('ğŸš€ Galwall çµ„ä»¶é–‹å§‹åˆå§‹åŒ–...');
    
    // ç²å–è§’è‰²åç¨±åˆ—è¡¨
    const characterNames = await fetchCharacterNames();
    console.log('ğŸ“‹ ç²å–åˆ°çš„è§’è‰²åç¨±æ•¸é‡:', characterNames.length);

    // æª¢æŸ¥æ¯å€‹è§’è‰²çš„åœ–ç‰‡
    const imagePromises = characterNames.map(name => checkImageTypes(name));
    const imageResults = await Promise.all(imagePromises);
    
    // æ”¶é›†æ‰€æœ‰æœ‰æ•ˆçš„åœ–ç‰‡è·¯å¾‘
    const validImages = imageResults.flatMap(result => {
      const paths: string[] = [];
      if (result.normalPath) paths.push(result.normalPath);
      if (result.fightingPath) paths.push(result.fightingPath);
      if (result.ruinedPath) paths.push(result.ruinedPath);
      return paths;
    });

    console.log('ğŸ–¼ï¸ æœ‰æ•ˆåœ–ç‰‡æ•¸é‡:', validImages.length);
    console.log('ğŸ–¼ï¸ æœ‰æ•ˆåœ–ç‰‡è·¯å¾‘:', validImages.slice(0, 5)); // åªé¡¯ç¤ºå‰5å€‹

    // åˆ†é…åœ–ç‰‡åˆ° front å’Œ back åˆ—è¡¨
    const totalImages = validImages.length;
    const frontCount = Math.ceil(totalImages / 3);
    
    frontList = validImages.slice(0, frontCount);
    backList = validImages.slice(frontCount);

    console.log('ğŸ“Š å‰æ’åœ–ç‰‡æ•¸é‡:', frontList.length);
    console.log('ğŸ“Š å¾Œæ’åœ–ç‰‡æ•¸é‡:', backList.length);

    // åˆå§‹åŒ–å‹•ç•«
    const containerFront = document.getElementById("containerFront");
    const containerBack = document.getElementById("containerBack");

    if (!containerFront || !containerBack) {
      console.error('âŒ æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ ');
      return;
    }

    console.log('âœ… æ‰¾åˆ°å®¹å™¨å…ƒç´ ï¼Œé–‹å§‹è¼‰å…¥åœ–ç‰‡...');

    function createAdDiv(imageURL, isFront) {
      const adDiv = document.createElement("div");
      adDiv.className = isFront ? "ad-front" : "ad-back";
      
      const adImage = document.createElement("img");
      adImage.className = "ad-image";
      adImage.src = imageURL;
      // è¨­ç½®å›ºå®šé«˜åº¦å’Œå¯¬åº¦ï¼Œä¿æŒæ¯”ä¾‹
      adImage.style.height = "300px";
      adImage.style.width = "auto";
      adImage.style.objectFit = "contain";
      // ä¿æŒé è¨­æ¸²æŸ“å“è³ªä»¥ç¶­æŒé€æ˜åº¦
      adImage.style.imageRendering = "auto";
      adImage.style.background = "transparent";
      
      // åœ–ç‰‡è¼‰å…¥å®Œæˆå¾Œé€²è¡Œå“è³ªå„ªåŒ–
      adImage.onload = function() {
        console.log('âœ… åœ–ç‰‡è¼‰å…¥æˆåŠŸ:', imageURL);
        optimizeImageQuality(adImage);
      };
      
      // åœ–ç‰‡è¼‰å…¥å¤±æ•—è™•ç†
      adImage.onerror = function() {
        console.error('âŒ åœ–ç‰‡è¼‰å…¥å¤±æ•—:', imageURL);
        // å¯ä»¥è¨­ç½®ä¸€å€‹é è¨­åœ–ç‰‡æˆ–éš±è—å…ƒç´ 
        adImage.style.display = 'none';
      };
      
      adDiv.appendChild(adImage);
      return adDiv;
    }

    // åœ–ç‰‡å“è³ªå„ªåŒ–å‡½æ•¸ - ä¿®æ­£é€æ˜èƒŒæ™¯å•é¡Œ
    function optimizeImageQuality(imgElement) {
      try {
        // æª¢æŸ¥åŸå§‹åœ–ç‰‡æ˜¯å¦ç‚º PNGï¼ˆæ”¯æŒé€æ˜åº¦ï¼‰
        const originalSrc = imgElement.src;
        const isPNG = originalSrc.toLowerCase().includes('.png') || 
                     originalSrc.includes('data:image/png') ||
                     originalSrc.includes('image/png');
        
        // å°æ–¼ PNG åœ–ç‰‡ï¼Œç‚ºäº†ä¿æŒé€æ˜åº¦ï¼Œè·³é Canvas å„ªåŒ–
        if (isPNG) {
          return;
        }
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { alpha: true }); // æ˜ç¢ºå•Ÿç”¨ alpha é€šé“
        
        // æª¢æŸ¥ canvas context æ˜¯å¦æˆåŠŸç²å–
        if (!ctx) {
          console.warn('ç„¡æ³•ç²å– canvas context');
          return;
        }
        
        // è¨­å®šè¼ƒå°çš„ç•«å¸ƒå°ºå¯¸ä¾†é™ä½å“è³ªï¼ˆé™ä½20%ï¼‰
        const targetWidth = 240;  // 300 * 0.8
        const targetHeight = 440; // 550 * 0.8
        
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        
        // ç¢ºä¿ Canvas èƒŒæ™¯å®Œå…¨é€æ˜
        ctx.clearRect(0, 0, targetWidth, targetHeight);
        
        // è¨­å®šæ¸²æŸ“å“è³ªï¼Œä½†ä¿æŒé€æ˜åº¦æ”¯æŒ
        ctx.imageSmoothingEnabled = true; // æ”¹ç‚º true ä»¥æ›´å¥½è™•ç†é€æ˜åº¦
        ctx.imageSmoothingQuality = 'medium'; // æå‡å“è³ªä»¥ä¿æŒé€æ˜åº¦
        ctx.globalCompositeOperation = 'source-over';
        
        // ç¹ªè£½åœ–ç‰‡åˆ°ç•«å¸ƒ
        ctx.drawImage(imgElement, 0, 0, targetWidth, targetHeight);
        
        // å§‹çµ‚ä½¿ç”¨ PNG æ ¼å¼ä»¥ä¿æŒé€æ˜åº¦
        const optimizedDataURL = canvas.toDataURL('image/png');
        
        // æ›´æ–°åœ–ç‰‡ä¾†æº
        imgElement.src = optimizedDataURL;
      } catch (error) {
        console.warn('åœ–ç‰‡å“è³ªå„ªåŒ–å¤±æ•—:', error);
        // å¦‚æœå„ªåŒ–å¤±æ•—ï¼Œä¿æŒåŸåœ–
      }
    }

    function loadAds(imageList, container, isFront) {
      container.innerHTML = "";
      const numAds = imageList.length;
      for (let i = 0; i < numAds; i++) {
        const imageURL = imageList[i];
        const adDiv = createAdDiv(imageURL, isFront);
        container.appendChild(adDiv);
      }
    }

    // æ¯ 10 ç§’éš¨æ©Ÿé‡æ–°æ’åˆ—åœ–ç‰‡ï¼Œä¸¦ç”¨ FLIP å‹•ç•«è®“æ‰€æœ‰åœ–ç‰‡å¹³æ»‘æ»‘åˆ°æ–°ä½ç½®
    function animateContainer(container) {
      const SHUFFLE_INTERVAL = 40000; // 40 ç§’

      const doShuffle = () => {
        const items = Array.from(container.children) as HTMLElement[];
        if (items.length <= 1) return;

        // 1) è¨˜éŒ„åˆå§‹ä½ç½®ï¼ˆFirstï¼‰
        const firstPositions = new Map<HTMLElement, number>();
        items.forEach(el => {
          firstPositions.set(el, el.getBoundingClientRect().left);
        });

        // 2) æ‰“äº‚é †åºï¼ˆDOM é‡æ–°æ’åºï¼‰
        const shuffled = [...items].sort(() => Math.random() - 0.5);
        shuffled.forEach(el => container.appendChild(el));

        // 3) é‡æ–°è¨ˆç®—ä½ç½®ï¼ˆLastï¼‰ä¸¦è¨­ç½® Invert â†’ Play
        shuffled.forEach(el => {
          const lastLeft = el.getBoundingClientRect().left;
          const firstLeft = firstPositions.get(el) || lastLeft;
          const deltaX = firstLeft - lastLeft;

          // æ‡‰ç”¨ä½ç§»æŠµæ¶ˆç•¶å‰ä½ç½® (Invert)
          el.style.transform = `translateX(${deltaX}px)`;
          el.style.transition = 'none';
        });

        // 4) æ–¼ä¸‹ä¸€ç¦å•Ÿå‹• transitionï¼Œæ’­æ”¾åˆ°æ–°ä½ç½®
        requestAnimationFrame(() => {
          shuffled.forEach(el => {
            el.style.transition = 'transform 800ms ease';
            el.style.transform = 'translateX(0)';

            // æ¸…ç†è¡Œå…§æ¨£å¼
            el.addEventListener(
              'transitionend',
              () => {
                el.style.transition = '';
                el.style.transform = '';
              },
              { once: true }
            );
          });
        });
      };

      // åˆå§‹å•Ÿå‹•
      setInterval(doShuffle, SHUFFLE_INTERVAL);
    }

    loadAds(frontList, containerFront, true);
    loadAds(backList, containerBack, false);

    if (containerFront) {
      containerFront.style.width = (300 * frontList.length) + "px";
    }
    
    if (containerBack) {
      containerBack.style.width = (300 * backList.length) + "px";
    }

    if (containerFront) {
      animateContainer(containerFront);
    }
    
    if (containerBack) {
      animateContainer(containerBack);
    }
  });
</script> 