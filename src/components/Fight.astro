---
// 不再使用 Astro.glob，而是直接從 API 獲取角色列表
const characterNames = ['default']; // 初始化為默認值，實際角色列表將從 API 獲取
---

<div class="fightbutton">
  <button id="fightButton">Fight</button>
</div>
<div class="fightercontainer">
  <div class="half">
    <div class="image-container">
      <img
        id="leftImage"
        class="imagefighter"
        src="/tymultiverse/assets/person/default.png"
        alt="Left Image"
      />
      <img
        id="leftOverlay1"
        class="overlay-image"
        src="/tymultiverse/assets/person/RavishingWavo.png"
        alt="Left Overlay 1"
      />
      <img
        id="leftOverlay2"
        class="overlay-image"
        src="/tymultiverse/assets/person/RavishingYui.png"
        alt="Left Overlay 2"
      />
      <img
        id="leftOverlay3"
        class="overlay-image"
        src="/tymultiverse/assets/person/RavishingMiku.png"
        alt="Left Overlay 3"
      />
    </div>
    <div id="leftInfo" class="info-container">
      <div class="info" id="leftName"></div>
      <div id="leftResult" class="result-image"></div>
      <div class="info-row">
        <div class="info" id="leftPhysicPower"></div>
        <div class="info" id="leftMagicPower"></div>
        <div class="info" id="leftUtilityPower"></div>
      </div>
      <div class="info" id="leftAttributes"></div>
      <div class="info" id="leftTotalPower"></div>
    </div>
    <div class="button-container" id="leftButtons"></div>
  </div>
  <div class="half">
    <div class="image-container">
      <img
        id="rightImage"
        class="imagefighter"
        src="/tymultiverse/assets/person/default.png"
        alt="Right Image"
      />
      <img
        id="rightOverlay1"
        class="overlay-image"
        src="/tymultiverse/assets/person/RavishingWavo.png"
        alt="Right Overlay 1"
      />
      <img
        id="rightOverlay2"
        class="overlay-image"
        src="/tymultiverse/assets/person/RavishingYui.png"
        alt="Right Overlay 2"
      />
      <img
        id="rightOverlay3"
        class="overlay-image"
        src="/tymultiverse/assets/person/RavishingMiku.png"
        alt="Right Overlay 3"
      />
    </div>
    <div id="rightInfo" class="info-container">
      <div class="info" id="rightName"></div>
      <div id="rightResult" class="result-image"></div>
      <div class="info-row">
        <div class="info" id="rightPhysicPower"></div>
        <div class="info" id="rightMagicPower"></div>
        <div class="info" id="rightUtilityPower"></div>
      </div>
      <div class="info" id="rightAttributes"></div>
      <div class="info" id="rightTotalPower"></div>
    </div>
    <div class="button-container" id="rightButtons"></div>
  </div>
</div>

<script>
  // 定義類型
  interface Fighter {
    image: string | null;
    totalPower: number;
    name: string | null;
    nameOriginal?: string;
  }

  interface Fighters {
    left: Fighter;
    right: Fighter;
  }

  // 全局設置與狀態
  const config = {
    baseImagePath: "/tymultiverse/assets/person/",
    apiEndpoint: `${import.meta.env.PUBLIC_TYMB_URL}/people/get-by-name`,
    defaultImage: "/tymultiverse/assets/person/default.png"
  };
  
  // 初始化角色列表
  let characterNames = ['default'];
  
  // 刷新 token 的函數
  async function refreshToken() {
    try {
      // 從 URL 參數中獲取 refresh token
      const urlParams = new URLSearchParams(window.location.search);
      const refreshToken = urlParams.get('refresh_token');
      
      if (!refreshToken) {
        console.error('No refresh token available');
        window.location.href = '/tymultiverse/login';
        return false;
      }

      const response = await fetch(`${import.meta.env.PUBLIC_TYMB_URL}/keycloak/refresh`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({ refresh_token: refreshToken }),
        credentials: 'include'
      });

      if (!response.ok) {
        console.error('Token refresh failed:', response.status);
        window.location.href = '/tymultiverse/login';
        return false;
      }

      const data = await response.json();
      if (data.token) {
        // 更新 URL 中的 token
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('token', data.token);
        if (data.refresh_token) {
          currentUrl.searchParams.set('refresh_token', data.refresh_token);
        }
        window.history.replaceState({}, '', currentUrl.toString());
        return true;
      }
      return false;
    } catch (error) {
      console.error('Error refreshing token:', error);
      window.location.href = '/tymultiverse/login';
      return false;
    }
  }

  // 驗證 token 是否有效
  async function verifyToken(token: string) {
    try {
      const response = await fetch(`${import.meta.env.PUBLIC_TYMB_URL}/keycloak/introspect?token=${token}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
        },
        credentials: 'include'
      });

      if (response.ok) {
        const data = await response.json();
        return data.active;
      }
      return false;
    } catch (error) {
      console.error('Token verification failed:', error);
      return false;
    }
  }

  // 獲取有效的 token
  async function getValidToken() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
      console.error('No token available');
      window.location.href = '/tymultiverse/login';
      return null;
    }

    const isValid = await verifyToken(token);
    if (isValid) {
      return token;
    }

    const refreshed = await refreshToken();
    if (!refreshed) {
      return null;
    }

    // 重新獲取更新後的 token
    const newUrlParams = new URLSearchParams(window.location.search);
    return newUrlParams.get('token');
  }
  
  // 從 API 獲取角色列表
  async function fetchCharacterList() {
    try {
      const token = await getValidToken();
      if (!token) {
        return;
      }

      const response = await fetch(`${import.meta.env.PUBLIC_TYMB_URL}/people/get-all`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
          "Accept": "application/json"
        },
        credentials: 'include'
      });
      
      if (!response.ok) {
        if (response.status === 401) {
          const newToken = await getValidToken();
          if (!newToken) {
            return;
          }
          // 重試請求
          return fetchCharacterList();
        }
        throw new Error('Failed to fetch character list');
      }
      
      const data = await response.json();
      
      // 檢查每個角色是否有對應的圖片
      const validCharacters = await Promise.all(
        data.map(async char => {
          const imagePath = `${config.baseImagePath}${char.name}.png`;
          try {
            const imgResponse = await fetch(imagePath);
            if (imgResponse.ok) {
              return char.name;
            }
            return null;
          } catch {
            return null;
          }
        })
      );
      
      // 過濾掉沒有圖片的角色
      characterNames = validCharacters.filter(name => name !== null);
      
      // 更新按鈕
      createButtons("leftButtons", "left");
      createButtons("rightButtons", "right");
    } catch (error) {
      console.error('Error fetching character list:', error);
      characterNames = ['default']; // 如果出錯，只保留默認角色
    }
  }
  
  // 紀錄選擇的角色
  const fighters: Fighters = {
    left: { image: null, totalPower: 0, name: null },
    right: { image: null, totalPower: 0, name: null }
  };
  
  // DOM 元素快速訪問
  const elements = {
    leftImage: document.getElementById("leftImage") as HTMLImageElement,
    rightImage: document.getElementById("rightImage") as HTMLImageElement,
    leftButtons: document.getElementById("leftButtons"),
    rightButtons: document.getElementById("rightButtons")
  };
  
  // 初始化函數
  function init() {
    fetchCharacterList();  // 獲取角色列表
  }
  
  // 創建角色選擇按鈕
  function createButtons(containerId: string, side: 'left' | 'right') {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = "";
    
    characterNames.forEach(name => {
      const button = document.createElement("button");
      button.textContent = name;
      button.className = "button";
      button.onclick = () => selectFighter(side, `${config.baseImagePath}${name}.png`);
      container.appendChild(button);
    });
  }
  
  // 選擇角色
  function selectFighter(side: 'left' | 'right', imagePath: string) {
    const otherSide = side === "left" ? "right" : "left";
    const selectedName = characterNames.find(name => name === imagePath.split("/").pop()?.split(".")[0]);
    
    // 檢查是否與另一邊選擇相同的角色
    if (fighters[otherSide].image && selectedName === fighters[otherSide].name) {
      return; // 不允許兩邊選擇相同角色
    }
    
    // 清除所有狀態效果
    const leftImage = document.getElementById("leftImage") as HTMLImageElement;
    const rightImage = document.getElementById("rightImage") as HTMLImageElement;
    const leftName = document.getElementById("leftName");
    const rightName = document.getElementById("rightName");
    
    // 移除所有動畫效果和疊加圖像
    leftImage.classList.remove('shake', 'shake-hard', 'shake-extreme', 'glow', 'glow-strong', 'glow-extreme');
    rightImage.classList.remove('shake', 'shake-hard', 'shake-extreme', 'glow', 'glow-strong', 'glow-extreme');
    
    // 移除疊加圖像
    const leftOverlay1 = document.getElementById("leftOverlay1");
    const leftOverlay2 = document.getElementById("leftOverlay2");
    const leftOverlay3 = document.getElementById("leftOverlay3");
    const rightOverlay1 = document.getElementById("rightOverlay1");
    const rightOverlay2 = document.getElementById("rightOverlay2");
    const rightOverlay3 = document.getElementById("rightOverlay3");
    if (leftOverlay1) {
      leftOverlay1.classList.remove('active', 'slide-in-right');
      leftOverlay1.style.transform = 'translateX(100%)';
    }
    if (leftOverlay2) {
      leftOverlay2.classList.remove('active', 'slide-in-left');
      leftOverlay2.style.transform = 'translateX(-100%)';
    }
    if (leftOverlay3) {
      leftOverlay3.classList.remove('active', 'scale-in');
      leftOverlay3.style.transform = 'scale(1.5)';
    }
    if (rightOverlay1) {
      rightOverlay1.classList.remove('active', 'slide-in-right');
      rightOverlay1.style.transform = 'translateX(100%)';
    }
    if (rightOverlay2) {
      rightOverlay2.classList.remove('active', 'slide-in-left');
      rightOverlay2.style.transform = 'translateX(-100%)';
    }
    if (rightOverlay3) {
      rightOverlay3.classList.remove('active', 'scale-in');
      rightOverlay3.style.transform = 'scale(1.5)';
    }
    
    // 清除結果文本
    if (leftName) leftName.innerHTML = fighters.left.name || "";
    if (rightName) rightName.innerHTML = fighters.right.name || "";
    
    // 更新選擇
    fighters[side].image = imagePath;
    fighters[side].name = selectedName;
    const sideImage = document.getElementById(`${side}Image`) as HTMLImageElement;
    if (sideImage) sideImage.src = imagePath;
    updateButtonStates();
    fetchFighterInfo(side, imagePath);
  }
  
  // 更新按鈕狀態 (禁用已選擇的角色)
  function updateButtonStates() {
    const leftName = fighters.left.image ? characterNames.find(name => name === fighters.left.image.split("/").pop()?.split(".")[0]) : null;
    const rightName = fighters.right.image ? characterNames.find(name => name === fighters.right.image.split("/").pop()?.split(".")[0]) : null;
    
    // 更新左側按鈕狀態
    document.querySelectorAll("#leftButtons .button").forEach(button => {
      button.classList.toggle("disabled", button.textContent === rightName);
    });
    
    // 更新右側按鈕狀態
    document.querySelectorAll("#rightButtons .button").forEach(button => {
      button.classList.toggle("disabled", button.textContent === leftName);
    });
  }
  
  // 獲取角色資訊
  async function fetchFighterInfo(side: 'left' | 'right', imagePath: string) {
    try {
      // 從圖片路徑提取出正確的名稱
      const name = characterNames.find(n => n === imagePath.split("/").pop()?.split(".")[0]);
      
      // 使用 API 獲取數據
      const apiName = name;
      
      const token = await getValidToken();
      if (!token) {
        return;
      }
      
      const response = await fetch(config.apiEndpoint, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
          "Accept": "application/json"
        },
        body: JSON.stringify({ name: apiName }),
        credentials: 'include'
      });
      
      if (!response.ok) {
        if (response.status === 401) {
          const newToken = await getValidToken();
          if (!newToken) {
            return;
          }
          // 重試請求
          return fetchFighterInfo(side, imagePath);
        }
        throw new Error(`API 返回錯誤: ${response.status}`);
      }
      
      const data = await response.json();
      
      // 處理API回傳數據
      if (data && data.name) {
        updateFighterInfo(side, data);
        return;
      }
      throw new Error("API 沒有返回有效數據");
    } catch (error) {
      console.error("獲取角色資訊失敗:", error);
      clearFighterInfo(side);
    }
  }
  
  // 更新角色資訊
  function updateFighterInfo(side: 'left' | 'right', fighter: any) {
    // 確保所有力量值都是數字，不是字符串
    const physicPower = parseInt(String(fighter.physicPower || 0), 10);
    const magicPower = parseInt(String(fighter.magicPower || 0), 10);
    const utilityPower = parseInt(String(fighter.utilityPower || 0), 10);
    const totalPower = physicPower + magicPower + utilityPower;
    
    // 顯示角色名稱，優先使用 nameOriginal
    const displayName = fighter.nameOriginal || fighter.name;
    const nameElement = document.getElementById(`${side}Name`);
    if (nameElement) nameElement.textContent = displayName || "N/A";
    
    const physicPowerElement = document.getElementById(`${side}PhysicPower`);
    const magicPowerElement = document.getElementById(`${side}MagicPower`);
    const utilityPowerElement = document.getElementById(`${side}UtilityPower`);
    
    if (physicPowerElement) physicPowerElement.textContent = `Physic Power: ${physicPower}`;
    if (magicPowerElement) magicPowerElement.textContent = `Magic Power: ${magicPower}`;
    if (utilityPowerElement) utilityPowerElement.textContent = `Utility Power: ${utilityPower}`;
    
    // 顯示屬性及其他信息
    let attributesText = fighter.attributes || "N/A";
    if (fighter.race && fighter.race !== "Unknown") {
      attributesText += ` | ${fighter.race}`;
    }
    if (fighter.gender && fighter.gender !== "Unknown") {
      attributesText += ` | ${fighter.gender}`;
    }
    const attributesElement = document.getElementById(`${side}Attributes`);
    if (attributesElement) attributesElement.textContent = `Attributes: ${attributesText}`;
    
    // 使Total Power顯示更小
    const totalPowerElement = document.getElementById(`${side}TotalPower`);
    if (totalPowerElement) totalPowerElement.textContent = `Total Power: ${totalPower}`;
    
    // 確保存儲的總力量是數字
    fighters[side].totalPower = totalPower;
    fighters[side].nameOriginal = fighter.nameOriginal;
    
    // 調試輸出，檢查力量值
    // console.log(`${side} fighter power:`, {
    //   name: displayName,
    //   physicPower,
    //   magicPower,
    //   utilityPower,
    //   totalPower
    // });
  }
  
  // 清除角色資訊
  function clearFighterInfo(side: 'left' | 'right') {
    const elements = [
      `${side}Name`,
      `${side}PhysicPower`,
      `${side}MagicPower`,
      `${side}UtilityPower`,
      `${side}Attributes`,
      `${side}TotalPower`
    ];
    
    elements.forEach(id => {
      const element = document.getElementById(id);
      if (element) element.textContent = "";
    });
    
    fighters[side].totalPower = 0;
    fighters[side].nameOriginal = undefined;
  }
  
  // 開始戰鬥
  function startFight() {
    const leftPower = parseInt(String(fighters.left.totalPower || 0), 10);
    const rightPower = parseInt(String(fighters.right.totalPower || 0), 10);
    
    // 調試輸出
    // console.log("Fight powers:", { leftPower, rightPower });
    
    const leftResult = document.getElementById("leftResult");
    const rightResult = document.getElementById("rightResult");
    const leftTotalPower = document.getElementById("leftTotalPower");
    const rightTotalPower = document.getElementById("rightTotalPower");
    
    // 重設樣式和文本
    if (leftResult) leftResult.textContent = "";
    if (rightResult) rightResult.textContent = "";
    if (leftTotalPower) leftTotalPower.classList.remove("win", "defeated");
    if (rightTotalPower) rightTotalPower.classList.remove("win", "defeated");
    
    // 如果任一方未選擇角色或力量為0，顯示提示
    if (!fighters.left.image || !fighters.right.image) {
      alert("請先選擇兩邊的角色");
      return;
    }
    
    // 計算差距百分比
    const percentageDifference = Math.abs(leftPower - rightPower) / Math.max(leftPower, rightPower, 1);
    // console.log("Percentage difference:", percentageDifference);
    
    // 確定勝負
    if (leftPower > rightPower) {
      determineWinner("left", "right", leftPower, rightPower, percentageDifference);
    } else if (rightPower > leftPower) {
      determineWinner("right", "left", rightPower, leftPower, percentageDifference);
    } else {
      // 平局
      if (leftResult) leftResult.textContent = "Draw";
      if (rightResult) rightResult.textContent = "Draw";
      // 使用 nameOriginal 顯示角色名稱
      const leftName = document.getElementById("leftName");
      const rightName = document.getElementById("rightName");
      if (leftName) leftName.innerHTML = 
        `${fighters.left.nameOriginal || fighters.left.name}<br><span class='result'>draw</span>`;
      if (rightName) rightName.innerHTML = 
        `${fighters.right.nameOriginal || fighters.right.name}<br><span class='result'>draw</span>`;
    }
  }
  
  // 確定勝負和結果顯示
  function determineWinner(winnerSide: 'left' | 'right', loserSide: 'left' | 'right', winnerPower: number, loserPower: number, difference: number) {
    const winnerElement = document.getElementById(`${winnerSide}TotalPower`);
    const loserElement = document.getElementById(`${loserSide}TotalPower`);
    const winnerResult = document.getElementById(`${winnerSide}Result`);
    const loserResult = document.getElementById(`${loserSide}Result`);
    const winnerName = document.getElementById(`${winnerSide}Name`);
    const loserName = document.getElementById(`${loserSide}Name`);
    const loserImage = document.getElementById(`${loserSide}Image`) as HTMLImageElement;
    const winnerImage = document.getElementById(`${winnerSide}Image`) as HTMLImageElement;
    
    // 重設樣式
    if (winnerElement) {
      winnerElement.classList.remove("defeated");
      winnerElement.classList.add("win");
      // 根據差距設置強度
      if (difference > 0.4) {
        winnerElement.setAttribute("data-intensity", "high");
      } else if (difference > 0.1) {
        winnerElement.setAttribute("data-intensity", "medium");
      } else {
        winnerElement.setAttribute("data-intensity", "low");
      }
    }
    if (loserElement) {
      loserElement.classList.remove("win");
      loserElement.classList.add("defeated");
      // 根據差距設置強度
      if (difference > 0.4) {
        loserElement.setAttribute("data-intensity", "high");
      } else if (difference > 0.1) {
        loserElement.setAttribute("data-intensity", "medium");
      } else {
        loserElement.setAttribute("data-intensity", "low");
      }
    }
    
    // 計算失敗百分比
    const lossPercentage = ((winnerPower - loserPower) / winnerPower * 100).toFixed(2);
    
    // 顯示基本結果
    if (winnerResult) winnerResult.textContent = "Winner";
    if (loserResult) loserResult.textContent = `${lossPercentage}% Defeated`;
    
    // 根據差距程度顯示不同結果和效果
    const winnerCharName = fighters[winnerSide].nameOriginal || fighters[winnerSide].name;
    const loserCharName = fighters[loserSide].nameOriginal || fighters[loserSide].name;
    
    // 添加疊加圖像
    const loserOverlay1 = document.getElementById(`${loserSide}Overlay1`) as HTMLImageElement;
    const loserOverlay2 = document.getElementById(`${loserSide}Overlay2`) as HTMLImageElement;
    const loserOverlay3 = document.getElementById(`${loserSide}Overlay3`) as HTMLImageElement;
    if (loserOverlay1 && loserOverlay2 && loserOverlay3) {
      // 先添加左側滑入的圖像
      loserOverlay2.classList.add('active', 'slide-in-left');
      
      // 延遲添加右側滑入的圖像
      setTimeout(() => {
        loserOverlay1.classList.add('active', 'slide-in-right');
      }, 250); // 延遲 250ms，讓第一張圖滑入一半時第二張圖開始滑入

      // 延遲添加第三張圖像（從後方縮放出現）
      setTimeout(() => {
        loserOverlay3.classList.add('active', 'scale-in');
      }, 500); // 延遲 500ms，讓前兩張圖完全滑入後再顯示第三張
    }
    
    if (difference > 0.4) {
      if (winnerName) {
        winnerName.innerHTML = `${winnerCharName}<br><span class='result' style='color: #ff0000; text-shadow: 0 0 8px rgba(255, 0, 0, 0.5); font-size: 18px; font-weight: bold;'>Destroying</span>`;
      }
      if (loserName) {
        loserName.innerHTML = `${loserCharName}<br><span class='result' style='color: #00ff00; text-shadow: 0 0 8px rgba(0, 255, 0, 0.5); font-size: 18px; font-weight: bold;'>Fucked Up</span>`;
      }
      if (loserImage) loserImage.classList.add('shake-extreme');
      if (winnerImage) winnerImage.classList.add('glow-extreme');
    } else if (difference > 0.1) {
      if (winnerName) {
        winnerName.innerHTML = `${winnerCharName}<br><span class='result' style='color: #cc0000; text-shadow: 0 0 6px rgba(204, 0, 0, 0.4); font-size: 18px; font-weight: bold;'>Destroying</span>`;
      }
      if (loserName) {
        loserName.innerHTML = `${loserCharName}<br><span class='result' style='color: #00cc00; text-shadow: 0 0 6px rgba(0, 204, 0, 0.4); font-size: 18px; font-weight: bold;'>Fucked Up</span>`;
      }
      if (loserImage) loserImage.classList.add('shake-hard');
      if (winnerImage) winnerImage.classList.add('glow-strong');
    } else {
      if (winnerName) {
        winnerName.innerHTML = `${winnerCharName}<br><span class='result' style='color: #990000; text-shadow: 0 0 4px rgba(153, 0, 0, 0.3); font-size: 18px; font-weight: bold;'>Destroying</span>`;
      }
      if (loserName) {
        loserName.innerHTML = `${loserCharName}<br><span class='result' style='color: #009900; text-shadow: 0 0 4px rgba(0, 153, 0, 0.3); font-size: 18px; font-weight: bold;'>Fucked Up</span>`;
      }
      if (loserImage) loserImage.classList.add('shake');
      if (winnerImage) winnerImage.classList.add('glow');
    }

    // 動畫結束後移除效果
    setTimeout(() => {
      if (loserImage) loserImage.classList.remove('shake', 'shake-hard', 'shake-extreme');
      if (winnerImage) winnerImage.classList.remove('glow', 'glow-strong', 'glow-extreme');
    }, 500);
  }
  
  // 頁面載入時初始化
  window.onload = () => {
    init();
    // 添加 Fight 按鈕的點擊事件監聽器
    const fightButton = document.getElementById('fightButton');
    if (fightButton) {
      fightButton.addEventListener('click', startFight);
    }
  };
</script>

<script define:vars={{ characterNames }}>
  // 將角色名稱列表傳遞給客戶端腳本
  document.currentScript?.setAttribute('data-characters', JSON.stringify(characterNames));
</script>

<style>
  body,
  html {
    margin: 0;
    padding: 0;
  }
  .fightercontainer {
    display: flex;
    width: 100%;
    max-width: 1800px;
    min-height: 1200px;  /* 增加最小高度 */
    padding-top: 20px;
    padding-bottom: 20px;
    margin: 0 auto;
    justify-content: center;
    align-items: flex-start;  /* 改為頂部對齊 */
    gap: 5px;
    position: relative;
    z-index: 50;
  }
  .half {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    margin: 0;
    width: 400px;
    min-height: 1200px;
    flex: none;
    gap: 10px;
    position: relative;
    z-index: 50;
  }
  .image-container {
    position: relative;
    width: 400px;
    height: 400px;
  }
  .imagefighter {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border: 1px solid #000;
    display: block;
    margin: 0 auto;
    position: relative;
    background-color: rgba(0, 0, 0, 0.1);
    z-index: 50;
  }
  .overlay-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    z-index: 51;
    pointer-events: none;
    opacity: 0;
    transition: all 0.5s ease;
  }
  .overlay-image.active {
    opacity: 1;
  }
  #leftOverlay1, #rightOverlay1 {
    transform: translateX(100%);
  }
  #leftOverlay2, #rightOverlay2 {
    transform: translateX(-100%);
  }
  #leftOverlay1.active, #rightOverlay1.active {
    transform: translateX(0);
  }
  #leftOverlay2.active, #rightOverlay2.active {
    transform: translateX(0);
  }
  #leftOverlay3, #rightOverlay3 {
    transform: scale(1.5);
    z-index: 45;  // 降低 z-index，確保在所有圖片後面
  }
  #leftOverlay3.active, #rightOverlay3.active {
    transform: scale(1);
    opacity: 1;
  }
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  @keyframes slideInLeft {
    from {
      transform: translateX(-100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  @keyframes scaleIn {
    from {
      transform: scale(1.5);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }
  .slide-in-right {
    animation: slideInRight 0.5s ease forwards;
  }
  .slide-in-left {
    animation: slideInLeft 0.5s ease forwards;
  }
  .scale-in {
    animation: scaleIn 0.5s ease forwards;
  }
  .info-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    min-height: 200px;
    max-height: 200px;
    background: linear-gradient(135deg, rgba(207, 157, 165, 0.11), rgba(218, 203, 205, 0.048));
    z-index: 50;
    padding: 10px 0;
    overflow-y: auto;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(255, 192, 203, 0.3);
    border: 1px solid rgba(255, 192, 203, 0.5);
  }
  .info-row {
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin-bottom: 1px;  /* 減少間距 */
    width: 100%;
    gap: 1px;  /* 減少間距 */
  }
  .info {
    margin: 0;
    font-size: 14px;  /* 增加字體大小 */
    text-align: center;
    width: 100%;
    white-space: nowrap;
    color: #0066ff;
    line-height: 1.2;  /* 稍微增加行高 */
    padding: 1px 0;  /* 減少內邊距 */
  }
  .info-container #leftTotalPower,
  .info-container #rightTotalPower {
    font-size: 16px;
    font-weight: bold;
    opacity: 1;
    margin-top: 2px;
    padding: 2px;
    border-radius: 5px;
    width: 90%;
    transition: all 0.3s ease;
  }

  .info-container #leftTotalPower.win[data-intensity="high"],
  .info-container #rightTotalPower.win[data-intensity="high"] {
    color: #00ff00;
    background: rgba(0, 255, 0, 0.2);
    text-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
  }

  .info-container #leftTotalPower.win[data-intensity="medium"],
  .info-container #rightTotalPower.win[data-intensity="medium"] {
    color: #00cc00;
    background: rgba(0, 204, 0, 0.15);
    text-shadow: 0 0 6px rgba(0, 204, 0, 0.4);
  }

  .info-container #leftTotalPower.win[data-intensity="low"],
  .info-container #rightTotalPower.win[data-intensity="low"] {
    color: #009900;
    background: rgba(0, 153, 0, 0.1);
    text-shadow: 0 0 4px rgba(0, 153, 0, 0.3);
  }

  .info-container #leftTotalPower.defeated[data-intensity="high"],
  .info-container #rightTotalPower.defeated[data-intensity="high"] {
    color: #ff0000;
    background: rgba(255, 0, 0, 0.2);
    text-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
  }

  .info-container #leftTotalPower.defeated[data-intensity="medium"],
  .info-container #rightTotalPower.defeated[data-intensity="medium"] {
    color: #cc0000;
    background: rgba(204, 0, 0, 0.15);
    text-shadow: 0 0 6px rgba(204, 0, 0, 0.4);
  }

  .info-container #leftTotalPower.defeated[data-intensity="low"],
  .info-container #rightTotalPower.defeated[data-intensity="low"] {
    color: #990000;
    background: rgba(153, 0, 0, 0.1);
    text-shadow: 0 0 4px rgba(153, 0, 0, 0.3);
  }
  .button-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 400px;
    width: 100%;
    height: 300px;
    overflow-y: auto;
    margin-top: 0;
    background: linear-gradient(135deg, rgba(255, 192, 203, 0.15), rgba(255, 182, 193, 0.1));
    z-index: 50;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(255, 192, 203, 0.2);
    border: 1px solid rgba(255, 192, 203, 0.3);
    padding: 15px;
    gap: 5px;
  }
  .button {
    padding: 10px 15px;
    font-size: 14px;
    cursor: pointer;
    margin: 5px;
    width: 110px;
    background: linear-gradient(135deg, #ffd1dc, #ffb6c1);
    border: 2px solid #ff99ac;
    border-radius: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(255, 182, 193, 0.3);
    color: #4a4a4a;
    font-weight: 500;
    text-transform: capitalize;
    letter-spacing: 0.5px;
  }
  .button:hover:not(.disabled) {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(255, 182, 193, 0.4);
    background: linear-gradient(135deg, #ffb6c1, #ff99ac);
    border-color: #ff8da1;
    color: #2a2a2a;
  }
  .button:active:not(.disabled) {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 2px 4px rgba(255, 182, 193, 0.2);
  }
  .button.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
    border-color: #ddd;
    color: #999;
    box-shadow: none;
  }
  .fightbutton {
    width: 100%;
    max-width: 1800px;
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    z-index: 100;
  }
  .fightbutton button {
    padding: 15px 40px;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    position: relative;
    z-index: 100;
    background: linear-gradient(45deg, #ff4d4d, #ff0000);
    color: white;
    border: none;
    border-radius: 30px;
    box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .fightbutton button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 0, 0, 0.4);
  }
  .fightbutton button:active {
    transform: translateY(1px);
  }
  .result {
    font-weight: bold;
    margin-top: 1px;
    margin-bottom: 1px;
    font-size: 14px;  /* 增加結果字體大小 */
    line-height: 1.2;
  }
  .win {
    color: #00cc00;
    font-size: 18px;
    text-shadow: 0 0 5px rgba(0, 204, 0, 0.3);
  }

  .win[data-intensity="high"] {
    color: #00ff00;
    text-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
  }

  .win[data-intensity="medium"] {
    color: #00cc00;
    text-shadow: 0 0 6px rgba(0, 204, 0, 0.4);
  }

  .win[data-intensity="low"] {
    color: #009900;
    text-shadow: 0 0 4px rgba(0, 153, 0, 0.3);
  }

  .defeated {
    color: #cc0000;
    font-size: 18px;
    text-shadow: 0 0 5px rgba(204, 0, 0, 0.3);
  }

  .defeated[data-intensity="high"] {
    color: #ff0000;
    text-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
  }

  .defeated[data-intensity="medium"] {
    color: #cc0000;
    text-shadow: 0 0 6px rgba(204, 0, 0, 0.4);
  }

  .defeated[data-intensity="low"] {
    color: #990000;
    text-shadow: 0 0 4px rgba(153, 0, 0, 0.3);
  }

  .fdefeated {
    color: #ff3333;
    font-size: 18px;
    text-shadow: 0 0 5px rgba(255, 51, 51, 0.3);
  }

  .sdefeated {
    color: #ff6666;
    font-size: 18px;
    text-shadow: 0 0 5px rgba(255, 102, 102, 0.3);
  }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  @keyframes shakeHard {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-15px); }
    75% { transform: translateX(15px); }
  }
  @keyframes shakeExtreme {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-25px); }
    75% { transform: translateX(25px); }
  }
  .shake {
    animation: shake 0.5s ease-in-out;
  }
  .shake-hard {
    animation: shakeHard 0.5s ease-in-out;
  }
  .shake-extreme {
    animation: shakeExtreme 0.5s ease-in-out;
  }
  @keyframes glow {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.2); }
    100% { filter: brightness(1); }
  }
  @keyframes glowStrong {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.4); }
    100% { filter: brightness(1); }
  }
  @keyframes glowExtreme {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.6); }
    100% { filter: brightness(1); }
  }
  .glow {
    animation: glow 0.5s ease-in-out;
  }
  .glow-strong {
    animation: glowStrong 0.5s ease-in-out;
  }
  .glow-extreme {
    animation: glowExtreme 0.5s ease-in-out;
  }
  .result-image {
    position: relative;
    z-index: 100;
    font-size: 14px;  /* 增加結果圖片字體大小 */
    font-weight: bold;
    margin: 1px 0;  /* 減少間距 */
    padding: 1px 6px;
    border-radius: 5px;
    background: rgba(255, 255, 255, 0.2);
  }
  /* 自定義滾動條樣式 */
  .button-container::-webkit-scrollbar {
    width: 8px;
  }

  .button-container::-webkit-scrollbar-track {
    background: rgba(255, 192, 203, 0.1);
    border-radius: 4px;
  }

  .button-container::-webkit-scrollbar-thumb {
    background: rgba(255, 182, 193, 0.5);
    border-radius: 4px;
  }

  .button-container::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 182, 193, 0.7);
  }
</style> 