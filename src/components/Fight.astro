---
  // å¾ API ç²å–è§’è‰²åˆ—è¡¨
  import '../styles/fight.css';
  const characterNames = ['default']; // åˆå§‹åŒ–ç‚ºé»˜èªå€¼ï¼Œå¯¦éš›è§’è‰²åˆ—è¡¨å°‡å¾ API ç²å–

  // æª¢æŸ¥è§’è‰²åœ–ç‰‡æ˜¯å¦å­˜åœ¨
  async function checkCharacterImageExists(characterName: string): Promise<boolean> {
    try {
      const response = await fetch(`${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/${characterName}.png`, {
        method: 'HEAD',
      });
      return response.ok;
    } catch (error) {
      console.error(`æª¢æŸ¥è§’è‰²åœ–ç‰‡å¤±æ•— ${characterName}:`, error);
      return false;
    }
  }
---
<div class="fightbutton">
  <button id="fightButton">Fight</button>
</div>
<div class="fightercontainer">
  <div class="half left-container">
    <div class="image-container">
      <img
        id="leftImage"
        class="imagefighter"
        src={import.meta.env.PUBLIC_PEOPLE_IMAGE_URL + "/default.png"}
        alt="Left Image"
      />
      <img
        id="leftOverlay1"
        class="overlay-image"
        src={import.meta.env.PUBLIC_PEOPLE_IMAGE_URL + "/RavishingWavo.png"}
        alt="Left Overlay 1"
      />
      <img
        id="leftOverlay2"
        class="overlay-image"
        src={import.meta.env.PUBLIC_PEOPLE_IMAGE_URL + "/RavishingYui.png"}
        alt="Left Overlay 2"
      />
      <img
        id="leftOverlay3"
        class="overlay-image"
        src={import.meta.env.PUBLIC_PEOPLE_IMAGE_URL + "/RavishingMiku.png"}
        alt="Left Overlay 3"
      />
    </div>
    <div id="leftInfo" class="info-container">
      <div class="info loading-state" id="leftName">
        <div class="loading-spinner"></div>
        <span>è¼‰å…¥ä¸­...</span>
      </div>
      <div id="leftResult" class="result-image"></div>
      <div class="info-row">
        <div class="info loading-state" id="leftPhysicPower">
          <div class="loading-spinner"></div>
          <span>è¼‰å…¥ä¸­...</span>
        </div>
        <div class="info loading-state" id="leftMagicPower">
          <div class="loading-spinner"></div>
          <span>è¼‰å…¥ä¸­...</span>
        </div>
        <div class="info loading-state" id="leftUtilityPower">
          <div class="loading-spinner"></div>
          <span>è¼‰å…¥ä¸­...</span>
        </div>
      </div>
      <div class="info loading-state" id="leftAttributes">
        <div class="loading-spinner"></div>
        <span>è¼‰å…¥ä¸­...</span>
      </div>
      <div class="info loading-state" id="leftTotalPower">
        <div class="loading-spinner"></div>
        <span>è¼‰å…¥ä¸­...</span>
      </div>
      <div class="weapon-info" id="leftWeaponInfo">
        <div class="weapon-loading" id="leftWeaponLoading">
          <div class="loading-spinner"></div>
          <span>è¼‰å…¥æ­¦å™¨ä¸­...</span>
        </div>
        <div class="weapons-container" id="leftWeaponsContainer">
          <!-- æ­¦å™¨ä¿¡æ¯å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
        </div>
      </div>
    </div>
    <div class="button-container" id="leftButtons"></div>
  </div>
  <div class="half right-container">
    <div class="image-container">
      <img
        id="rightImage"
        class="imagefighter"
        src={import.meta.env.PUBLIC_PEOPLE_IMAGE_URL + "/default.png"}
        alt="Right Image"
      />
      <img
        id="rightOverlay1"
        class="overlay-image"
        src={import.meta.env.PUBLIC_PEOPLE_IMAGE_URL + "/RavishingWavo.png"}
        alt="Right Overlay 1"
      />
      <img
        id="rightOverlay2"
        class="overlay-image"
        src={import.meta.env.PUBLIC_PEOPLE_IMAGE_URL + "/RavishingYui.png"}
        alt="Right Overlay 2"
      />
      <img
        id="rightOverlay3"
        class="overlay-image"
        src={import.meta.env.PUBLIC_PEOPLE_IMAGE_URL + "/RavishingMiku.png"}
        alt="Right Overlay 3"
      />
    </div>
    <div id="rightInfo" class="info-container">
      <div class="info loading-state" id="rightName">
        <div class="loading-spinner"></div>
        <span>è¼‰å…¥ä¸­...</span>
      </div>
      <div id="rightResult" class="result-image"></div>
      <div class="info-row">
        <div class="info loading-state" id="rightPhysicPower">
          <div class="loading-spinner"></div>
          <span>è¼‰å…¥ä¸­...</span>
        </div>
        <div class="info loading-state" id="rightMagicPower">
          <div class="loading-spinner"></div>
          <span>è¼‰å…¥ä¸­...</span>
        </div>
        <div class="info loading-state" id="rightUtilityPower">
          <div class="loading-spinner"></div>
          <span>è¼‰å…¥ä¸­...</span>
        </div>
      </div>
      <div class="info loading-state" id="rightAttributes">
        <div class="loading-spinner"></div>
        <span>è¼‰å…¥ä¸­...</span>
      </div>
      <div class="info loading-state" id="rightTotalPower">
        <div class="loading-spinner"></div>
        <span>è¼‰å…¥ä¸­...</span>
      </div>
      <div class="weapon-info" id="rightWeaponInfo">
        <div class="weapon-loading" id="rightWeaponLoading">
          <div class="loading-spinner"></div>
          <span>è¼‰å…¥æ­¦å™¨ä¸­...</span>
        </div>
        <div class="weapons-container" id="rightWeaponsContainer">
          <!-- æ­¦å™¨ä¿¡æ¯å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
        </div>
      </div>
    </div>
    <div class="button-container" id="rightButtons"></div>
  </div>
</div>

<script>
import { applyWeaponDamage, calculateWeaponDamage } from "../scripts/weapon";

  // å®šç¾©é¡å‹
  interface Fighter {
    image: string | null;
    totalPower: number;
    name: string | null;
    nameOriginal?: string;
    physicPower?: number;
    magicPower?: number;
    utilityPower?: number;
    attributes?: string;
  }

  interface SideFighters {
    main: Fighter;
    left?: Fighter;
    right?: Fighter;
  }

  interface Fighters {
    left: SideFighters;
    right: SideFighters;
  }

  // å…¨å±€è¨­ç½®èˆ‡ç‹€æ…‹
  // æª¢æŸ¥ç’°å¢ƒè®Šé‡
  if (!import.meta.env.PUBLIC_TYMB_URL) {
    throw new Error('PUBLIC_TYMB_URL ç’°å¢ƒè®Šé‡æœªè¨­ç½®');
  }
  if (!import.meta.env.PUBLIC_PEOPLE_IMAGE_URL) {
    throw new Error('PUBLIC_PEOPLE_IMAGE_URL ç’°å¢ƒè®Šé‡æœªè¨­ç½®');
  }

  const config = {
    baseImagePath: import.meta.env.PUBLIC_PEOPLE_IMAGE_URL + "/",
    defaultImage: import.meta.env.PUBLIC_PEOPLE_IMAGE_URL + "/default.png",
    sideOffset: 75 // å´é‚Šè§’è‰²çš„åç§»é‡
  };
  
  // åˆå§‹åŒ–è§’è‰²åˆ—è¡¨
  let characterNames = ['default'];

  // æ·»åŠ æˆ°é¬¥ç‹€æ…‹è¿½è¹¤
  let fightCompleted = false;

  // æª¢æŸ¥è§’è‰²åœ–ç‰‡æ˜¯å¦å­˜åœ¨ï¼ˆå®¢æˆ¶ç«¯ç‰ˆæœ¬ï¼‰
  async function checkCharacterImageExistsClient(characterName: string): Promise<boolean> {
    try {
      const response = await fetch(`${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/${characterName}.png`, {
        method: 'HEAD',
      });
      return response.ok;
    } catch (error) {
      console.error(`æª¢æŸ¥è§’è‰²åœ–ç‰‡å¤±æ•— ${characterName}:`, error);
      return false;
    }
  }
  
  // å¾ API ç²å–è§’è‰²åç¨±åˆ—è¡¨ï¼ˆåŒæ­¥ï¼‰
  async function fetchCharacterNames() {
    try {
      // ä½¿ç”¨çµ±ä¸€çš„ peopleService
      const { peopleService } = await import('../services/api/peopleService');
      const names = await peopleService.getAllPeopleNames();

      // ç¢ºä¿æ˜¯æ•¸çµ„æ ¼å¼
      const allNames = Array.isArray(names) ? names : ['default'];

      // éæ¿¾æ‰åœ–ç‰‡ä¸å­˜åœ¨çš„è§’è‰²
      const filteredNames: string[] = [];
      for (const name of allNames) {
        const hasImage = await checkCharacterImageExistsClient(name);
        if (hasImage) {
          filteredNames.push(name);
          console.log(`âœ… è§’è‰² ${name} åœ–ç‰‡å­˜åœ¨ï¼ŒåŠ å…¥åˆ—è¡¨`);
        } else {
          console.log(`âŒ è§’è‰² ${name} åœ–ç‰‡ä¸å­˜åœ¨ï¼Œè·³é`);
        }
      }

      characterNames = filteredNames.length > 0 ? filteredNames : ['default'];
      console.log(`ğŸ“‹ æœ€çµ‚è§’è‰²åˆ—è¡¨ (${characterNames.length} å€‹):`, characterNames);
    } catch (error) {
      console.error('âŒ ç²å–è§’è‰²åç¨±åˆ—è¡¨å¤±æ•—:', error);
      characterNames = ['default'];
      console.log('âš ï¸ ä½¿ç”¨é»˜èªè§’è‰²åˆ—è¡¨:', characterNames);
    }
  }

  // æ ¹æ“šåç¨±ç²å–è§’è‰²è©³ç´°ä¿¡æ¯ï¼ˆåŒæ­¥ï¼‰
  async function fetchCharacterByName(name: string) {
    try {
      // ä½¿ç”¨çµ±ä¸€çš„ peopleService
      const { peopleService } = await import('../services/api/peopleService');
      const person = await peopleService.getPersonByNameAndWait(name);

      return person;
    } catch (error) {
      console.error(`âŒ ç²å–è§’è‰² ${name} ä¿¡æ¯å¤±æ•—:`, error);
      throw error;
    }
  }
  
  // ç´€éŒ„é¸æ“‡çš„è§’è‰²
  const fighters: Fighters = {
    left: {
      main: { image: null, totalPower: 0, name: null },
      left: undefined,
      right: undefined
    },
    right: {
      main: { image: null, totalPower: 0, name: null },
      left: undefined,
      right: undefined
    }
  };
  
  // DOM å…ƒç´ å¿«é€Ÿè¨ªå•
  const elements = {
    leftImage: document.getElementById("leftImage") as HTMLImageElement,
    rightImage: document.getElementById("rightImage") as HTMLImageElement,
    leftButtons: document.getElementById("leftButtons"),
    rightButtons: document.getElementById("rightButtons")
  };
  
  // åˆå§‹åŒ–å‡½æ•¸
  async function init() {
    // åˆå§‹åŒ–è¼‰å…¥ç‹€æ…‹
    showInfoLoading('left');
    showInfoLoading('right');

    // ç²å–è§’è‰²åç¨±åˆ—è¡¨ï¼ˆç•°æ­¥ï¼‰
    await fetchCharacterNames();

    // å‰µå»ºæŒ‰éˆ•
    createButtons("leftButtons", "left");
    createButtons("rightButtons", "right");

    // å‰µå»ºå´é‚Šå®¹å™¨
    createSideContainers('left');
    createSideContainers('right');

    // éš±è—è¼‰å…¥ç‹€æ…‹ï¼ˆå› ç‚ºé‚„æ²’æœ‰é¸æ“‡è§’è‰²ï¼‰
    hideInfoLoading('left');
    hideInfoLoading('right');
  }
  
  // å‰µå»ºè§’è‰²é¸æ“‡æŒ‰éˆ•
  function createButtons(containerId: string, side: 'left' | 'right') {

    const container = document.getElementById(containerId);
    if (!container) {
      console.error(`âŒ æ‰¾ä¸åˆ°å®¹å™¨: ${containerId}`);
      return;
    }

    container.innerHTML = "";

    if (characterNames.length === 0) {
      console.warn(`âš ï¸ è§’è‰²åç¨±åˆ—è¡¨ç‚ºç©º`);
      return;
    }

    characterNames.forEach(name => {
      const button = document.createElement("button");
      button.textContent = name;
      button.className = "button";
      button.onclick = async () => {
        try {
          await selectFighter(side, `${config.baseImagePath}${name}.png`);
        } catch (error) {
          console.error(`é¸æ“‡è§’è‰² ${name} å¤±æ•—:`, error);
        }
      };
      container.appendChild(button);
    });

  }
  
  // å‰µå»ºå´é‚Šè§’è‰²å®¹å™¨
  function createSideContainers(side: 'left' | 'right') {
    const mainContainer = document.querySelector(`.${side}-container`);
    if (!mainContainer) return;

    // å‰µå»ºå·¦å´å®¹å™¨
    const leftContainer = document.createElement('div');
    leftContainer.className = `${side}-side-container left-side`;
    leftContainer.style.position = 'absolute';
    leftContainer.style.left = `-${config.sideOffset}px`;
    leftContainer.style.top = '0';
    leftContainer.style.width = '400px';
    leftContainer.style.height = '400px';
    leftContainer.style.zIndex = '40';

    // å‰µå»ºå³å´å®¹å™¨
    const rightContainer = document.createElement('div');
    rightContainer.className = `${side}-side-container right-side`;
    rightContainer.style.position = 'absolute';
    rightContainer.style.right = `-${config.sideOffset}px`;
    rightContainer.style.top = '0';
    rightContainer.style.width = '400px';
    rightContainer.style.height = '400px';
    rightContainer.style.zIndex = '40';

    // å‰µå»ºåœ–ç‰‡å…ƒç´ 
    const leftImage = document.createElement('img');
    leftImage.className = 'imagefighter side-image';
    leftImage.style.width = '100%';
    leftImage.style.height = '100%';
    leftImage.style.objectFit = 'contain';
    leftImage.style.display = 'none';

    const rightImage = document.createElement('img');
    rightImage.className = 'imagefighter side-image';
    rightImage.style.width = '100%';
    rightImage.style.height = '100%';
    rightImage.style.objectFit = 'contain';
    rightImage.style.display = 'none';

    leftContainer.appendChild(leftImage);
    rightContainer.appendChild(rightImage);

    mainContainer.appendChild(leftContainer);
    mainContainer.appendChild(rightContainer);
  }
  
  // æ¸…é™¤æ‰€æœ‰æ•ˆæœ
  function clearAllEffects() {
    const sides = ['left', 'right'];
    sides.forEach(side => {
      // æ¸…é™¤è§’è‰²åœ–ç‰‡æ•ˆæœ
      const mainImage = document.getElementById(`${side}Image`) as HTMLImageElement;
      const leftImage = document.querySelector(`.${side}-side-container.left-side .side-image`) as HTMLImageElement;
      const rightImage = document.querySelector(`.${side}-side-container.right-side .side-image`) as HTMLImageElement;

      [mainImage, leftImage, rightImage].forEach(image => {
        if (image) {
          image.classList.remove('shake', 'shake-hard', 'shake-extreme', 'glow', 'glow-strong', 'glow-extreme');
        }
      });

      // æ¸…é™¤ç–ŠåŠ åœ–ç‰‡æ•ˆæœ
      const overlays = [
        document.getElementById(`${side}Overlay1`),
        document.getElementById(`${side}Overlay2`),
        document.getElementById(`${side}Overlay3`)
      ];
      
      overlays.forEach(overlay => {
        if (overlay) {
          overlay.classList.remove('active', 'slide-in-right', 'slide-in-left', 'scale-in');
          overlay.style.transform = '';
          overlay.style.opacity = '0';
        }
      });
    });
  }
  
  // é¸æ“‡è§’è‰²
  async function selectFighter(side: 'left' | 'right', imagePath: string) {
    const otherSide = side === "left" ? "right" : "left";
    const selectedName = characterNames.find(name => name === imagePath.split("/").pop()?.split(".")[0]) || null;

    // å†æ¬¡æª¢æŸ¥åœ–ç‰‡æ˜¯å¦å­˜åœ¨ï¼ˆé˜²æ­¢å¿«å–å•é¡Œï¼‰
    if (selectedName) {
      const hasImage = await checkCharacterImageExistsClient(selectedName);
      if (!hasImage) {
        console.error(`âŒ è§’è‰² ${selectedName} åœ–ç‰‡ä¸å­˜åœ¨ï¼Œç„¡æ³•é¸æ“‡`);
        return;
      }
    }

    // å¦‚æœæˆ°é¬¥å·²ç¶“å®Œæˆï¼Œé¸æ“‡æ–°è§’è‰²æ™‚æ¸…é™¤æ‰€æœ‰è§’è‰²
    if (fightCompleted) {
      resetSideSelection('left');
      resetSideSelection('right');
      fightCompleted = false;

      // å•Ÿç”¨ Fight æŒ‰éˆ•
      const fightButton = document.getElementById('fightButton') as HTMLButtonElement;
      if (fightButton) {
        fightButton.disabled = false;
        fightButton.style.opacity = '1';
        fightButton.style.cursor = 'pointer';
      }

      // æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•çš„ç¦ç”¨ç‹€æ…‹
      document.querySelectorAll("#leftButtons .button, #rightButtons .button").forEach(button => {
        button.classList.remove("disabled");
      });

      // ç›´æ¥é¸æ“‡æ–°è§’è‰²ï¼Œè¨­ç½®ç‚ºmain fighter
      clearAllEffects();
      fighters[side].main.image = imagePath;
      fighters[side].main.name = selectedName;
      const mainImage = document.getElementById(`${side}Image`) as HTMLImageElement;
      if (mainImage) mainImage.src = imagePath;

      updateButtonStates();
      fetchFighterInfo(side, imagePath, 'main');
      fetchAndDisplayWeaponInfo(side, selectedName, 'main');
      return;
    }

    // å¦‚æœæˆ°é¬¥æœªå®Œæˆï¼Œå‰‡æª¢æŸ¥è§’è‰²æ˜¯å¦å·²è¢«é¸æ“‡
    if (isCharacterSelected(otherSide, selectedName)) {
      return;
    }

    // å¦‚æœæ˜¯é¸æ“‡ç¬¬ä¸€å€‹è§’è‰²ï¼Œæ¸…ç©ºæ‰€æœ‰ localStorage æ•¸æ“š
    if (!fighters.left.main.image && !fighters.right.main.image) {
      localStorage.clear();
      console.log('Cleared all localStorage data before selecting first character');
    }

    clearAllEffects();

    // ç¢ºå®šfighteré¡å‹ï¼šæ ¹æ“šé¸æ“‡é †åºæ±ºå®šæ˜¯main/left/right
    let fighterType: 'main' | 'left' | 'right' = 'main';

    // æª¢æŸ¥é¸æ“‡çš„é †åºä¾†ç¢ºå®šfighteré¡å‹
    if (!fighters[side].main.image) {
      // ç¬¬ä¸€å€‹é¸æ“‡ï¼Œè¨­ç½®ç‚ºmain
      fighterType = 'main';
      fighters[side].main.image = imagePath;
      fighters[side].main.name = selectedName;
      const mainImage = document.getElementById(`${side}Image`) as HTMLImageElement;
      if (mainImage) mainImage.src = imagePath;
    } else if (!fighters[side].left?.image) {
      // ç¬¬äºŒå€‹é¸æ“‡ï¼Œè¨­ç½®ç‚ºleft
      fighterType = 'left';
      fighters[side].left = { image: imagePath, totalPower: 0, name: selectedName };
      const leftImage = document.querySelector(`.${side}-side-container.left-side .side-image`) as HTMLImageElement;
      if (leftImage) {
        leftImage.src = imagePath;
        leftImage.style.display = 'block';
      }
    } else if (!fighters[side].right?.image) {
      // ç¬¬ä¸‰å€‹é¸æ“‡ï¼Œè¨­ç½®ç‚ºright
      fighterType = 'right';
      fighters[side].right = { image: imagePath, totalPower: 0, name: selectedName };
      const rightImage = document.querySelector(`.${side}-side-container.right-side .side-image`) as HTMLImageElement;
      if (rightImage) {
        rightImage.src = imagePath;
        rightImage.style.display = 'block';
      }
    } else {
      // æ‰€æœ‰ä½ç½®éƒ½å·²é¸æ“‡ï¼Œè¦†è“‹main
      fighterType = 'main';
      // å…ˆç§»é™¤èˆŠçš„mainæ­¦å™¨
      fetchAndDisplayWeaponInfo(side, null, 'main');

      fighters[side].main.image = imagePath;
      fighters[side].main.name = selectedName;
      const mainImage = document.getElementById(`${side}Image`) as HTMLImageElement;
      if (mainImage) mainImage.src = imagePath;
    }

    updateButtonStates();
    fetchFighterInfo(side, imagePath, fighterType);
    fetchAndDisplayWeaponInfo(side, selectedName, fighterType);
  }

  // ç²å–ä¸¦é¡¯ç¤ºæ­¦å™¨ä¿¡æ¯
  async function fetchAndDisplayWeaponInfo(side: 'left' | 'right', characterName: string | null, fighterType: 'main' | 'left' | 'right') {
    if (!characterName) {
      // å¦‚æœæ²’æœ‰è§’è‰²åï¼Œç§»é™¤è©²fighteré¡å‹çš„æ­¦å™¨
      removeWeaponByFighterType(side, fighterType);
      updateNoWeaponsDisplay(side);
      return;
    }

    try {
      // é–‹å§‹ç²å–æ­¦å™¨ä¿¡æ¯
      const weapons = await fetchWeaponData(characterName);
      displayWeaponInfo(side, weapons, fighterType);
    } catch (error) {
      console.error(`âŒ ç²å–æ­¦å™¨ä¿¡æ¯å¤±æ•— (${side}-${fighterType}):`, error);
      displayWeaponInfo(side, [], fighterType); // é¡¯ç¤ºç„¡æ­¦å™¨ç‹€æ…‹
    }
  }
  
  // æª¢æŸ¥è§’è‰²æ˜¯å¦å·²è¢«é¸æ“‡
  function isCharacterSelected(side: 'left' | 'right', name: string | null): boolean {
    if (!name) return false;
    // æª¢æŸ¥æ‰€æœ‰å·²é¸æ“‡çš„è§’è‰²ï¼ˆåŒ…æ‹¬å…©é‚Šï¼‰
    return fighters.left.main.name === name || 
           fighters.left.left?.name === name || 
           fighters.left.right?.name === name ||
           fighters.right.main.name === name || 
           fighters.right.left?.name === name || 
           fighters.right.right?.name === name;
  }

  // é‡ç½®ä¸€å´çš„æ‰€æœ‰é¸æ“‡
  function resetSideSelection(side: 'left' | 'right') {
    fighters[side].main = { image: null, totalPower: 0, name: null, physicPower: 0, magicPower: 0, utilityPower: 0, attributes: "" };
    fighters[side].left = undefined;
    fighters[side].right = undefined;

    const mainImage = document.getElementById(`${side}Image`) as HTMLImageElement;
    const leftImage = document.querySelector(`.${side}-side-container.left-side .side-image`) as HTMLImageElement;
    const rightImage = document.querySelector(`.${side}-side-container.right-side .side-image`) as HTMLImageElement;

    if (mainImage) mainImage.src = config.defaultImage;
    if (leftImage) {
      leftImage.src = '';
      leftImage.style.display = 'none';
    }
    if (rightImage) {
      rightImage.src = '';
      rightImage.style.display = 'none';
    }

    // æ¸…é™¤ localStorage æ•¸æ“š
    clearLocalStorage(side);

    // æ¸…é™¤æ­¦å™¨ä¿¡æ¯
    clearWeaponInfo(side);

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    showInfoLoading(side);
  }
  
  // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
  function updateButtonStates() {
    const selectedNames = new Set([
      fighters.left.main.name,
      fighters.left.left?.name,
      fighters.left.right?.name,
      fighters.right.main.name,
      fighters.right.left?.name,
      fighters.right.right?.name
    ].filter(Boolean));
    
    document.querySelectorAll("#leftButtons .button, #rightButtons .button").forEach(button => {
      button.classList.toggle("disabled", selectedNames.has(button.textContent));
    });
  }
  
  // ç²å–è§’è‰²è³‡è¨Š
  async function fetchFighterInfo(side: 'left' | 'right', imagePath: string, fighterType: 'main' | 'left' | 'right' = 'main') {
    try {
      const name = characterNames.find(n => n === imagePath.split("/").pop()?.split(".")[0]);
      if (!name) {
        throw new Error("ç„¡æ³•æ‰¾åˆ°è§’è‰²åç¨±");
      }

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      showInfoLoading(side);

      // ä½¿ç”¨æ–°çš„åŒæ­¥ API ç²å–è§’è‰²è©³ç´°ä¿¡æ¯
      const data = await fetchCharacterByName(name);

      if (data && data.name) {
        // è¨ˆç®—ç¸½å‚·å®³ï¼ˆç•°æ­¥ï¼‰
        const ownerName = name;

        try {
          // æ·»åŠ å»¶é²ä»¥é¿å… 429 éŒ¯èª¤ (é¡ä¼¼ Levellist.astro çš„è™•ç†)
          const delayMs = 100; // 100ms å»¶é²
          if (delayMs > 0) {
            await new Promise(resolve => setTimeout(resolve, delayMs));
          }

          // ä½¿ç”¨æ–°çš„å‚·å®³è¨ˆç®—æœå‹™ç²å–ç¸½å‚·å®³å€¼
          const damageService = (await import('../services/api/damageService')).default.getInstance();
          const totalDamage = await damageService.getCharacterDamage(ownerName);

          if (totalDamage > 0) {
            // è¨ˆç®—åŸå§‹ç¸½æˆ°åŠ›ï¼ˆphysic + magic + utilityï¼‰
            const originalPhysic = parseInt(String(data.physicPower || 0), 10);
            const originalMagic = parseInt(String(data.magicPower || 0), 10);
            const originalUtility = parseInt(String(data.utilityPower || 0), 10);
            const originalTotal = originalPhysic + originalMagic + originalUtility;

                  // æˆ°åŠ›è¨ˆç®—å®Œæˆ

            // å¦‚æœ API è¿”å›çš„ç¸½æˆ°åŠ›å¤§æ–¼åŸå§‹è¨ˆç®—ï¼Œèªªæ˜æœ‰æ­¦å™¨åŠ æˆ
            if (totalDamage > originalTotal) {
              // è¨ˆç®—æ­¦å™¨åŠ æˆ
              data.weaponBonus = totalDamage - originalTotal;
              data.hasBonus = true;
              // è¨ˆç®—æ­¦å™¨åŠ æˆå®Œæˆ
            } else {
              // å¦‚æœ API è¿”å›çš„ç¸½æˆ°åŠ›ä¸å¤§æ–¼åŸå§‹è¨ˆç®—ï¼Œä½¿ç”¨åŸå§‹æ•¸æ“š
              data.weaponBonus = 0;
              data.hasBonus = false;
              // ä½¿ç”¨åŸå§‹æ•¸æ“š
            }
          } else {
            // å¦‚æœ API è¿”å›ç„¡æ•ˆå€¼ï¼Œä½¿ç”¨åŸå§‹æ•¸æ“š
            data.weaponBonus = 0;
            data.hasBonus = false;
            // API è¿”å›ç„¡æ•ˆå€¼ï¼Œä½¿ç”¨åŸå§‹æ•¸æ“š
          }
        } catch (damageError) {
          console.error(`damageWithWeapon API error for ${ownerName}:`, damageError);
          // å¦‚æœå‚·å®³è¨ˆç®—å¤±æ•—ï¼Œä½¿ç”¨åŸå§‹æ•¸æ“šï¼ˆèˆ‡ Levellist.astro å®Œå…¨ä¸€è‡´ï¼‰
          data.weaponBonus = 0;
          data.hasBonus = false;
        }

        // æ¸…é™¤è¼‰å…¥ç‹€æ…‹ä¸¦æ›´æ–°é¡¯ç¤º
        hideInfoLoading(side);
        updateFighterInfo(side, data);
        // å„²å­˜åˆ° localStorage
        saveToLocalStorage(side, data);
        return;
      }
      throw new Error(`æ‰¾ä¸åˆ°è§’è‰²: ${name}`);
    } catch (error) {
      console.error("ç²å–è§’è‰²è³‡è¨Šå¤±æ•—:", error);
      hideInfoLoading(side);
      clearFighterInfo(side);
    }
  }

  // é¡¯ç¤ºinfoå€åŸŸçš„è¼‰å…¥ç‹€æ…‹
  function showInfoLoading(side: 'left' | 'right') {
    const infoElements = [
      `${side}Name`,
      `${side}PhysicPower`,
      `${side}MagicPower`,
      `${side}UtilityPower`,
      `${side}Attributes`,
      `${side}TotalPower`
    ];

    infoElements.forEach(elementId => {
      const element = document.getElementById(elementId);
      if (element) {
        element.classList.add('loading-state');
        element.innerHTML = `
          <div class="loading-spinner"></div>
          <span>è¼‰å…¥ä¸­...</span>
        `;
      }
    });
  }

  // éš±è—infoå€åŸŸçš„è¼‰å…¥ç‹€æ…‹
  function hideInfoLoading(side: 'left' | 'right') {
    const infoElements = [
      `${side}Name`,
      `${side}PhysicPower`,
      `${side}MagicPower`,
      `${side}UtilityPower`,
      `${side}Attributes`,
      `${side}TotalPower`
    ];

    infoElements.forEach(elementId => {
      const element = document.getElementById(elementId);
      if (element) {
        element.classList.remove('loading-state');
      }
    });
  }
  
  // æ›´æ–°è§’è‰²è³‡è¨Š
  function updateFighterInfo(side: 'left' | 'right', fighter: any) {
    // å¾ localStorage ç²å–ç´¯åŠ çš„å€¼
    const storageKey = `fighters_${side}`;
    const storedData = JSON.parse(localStorage.getItem(storageKey) || '{}');

    // ç²å–ç•¶å‰é¡¯ç¤ºçš„è§’è‰²åˆ—è¡¨
    const displayedCharacters: string[] = [];
    if (fighters[side].main.image) {
      const mainName = fighters[side].main.image.split("/").pop()?.split(".")[0];
      if (mainName) displayedCharacters.push(mainName);
    }
    if (fighters[side].left?.image) {
      const leftName = fighters[side].left.image.split("/").pop()?.split(".")[0];
      if (leftName) displayedCharacters.push(leftName);
    }
    if (fighters[side].right?.image) {
      const rightName = fighters[side].right.image.split("/").pop()?.split(".")[0];
      if (rightName) displayedCharacters.push(rightName);
    }

    // ä½¿ç”¨ç•¶å‰è§’è‰²çš„åŸºç¤å€¼ï¼ˆä¾†è‡ª get-by-name APIï¼‰
    const physicPower = parseInt(String(fighter.physicPower || 0), 10);
    const magicPower = parseInt(String(fighter.magicPower || 0), 10);
    const utilityPower = parseInt(String(fighter.utilityPower || 0), 10);

    // è¨ˆç®—æ­¦å™¨åŠ æˆ
    const weaponBonus = parseInt(String(fighter.weaponBonus || 0), 10);
    const hasBonus = fighter.hasBonus || false;

    // è¨ˆç®—ç¸½æˆ°åŠ›
    let totalPower;
    if (hasBonus && weaponBonus > 0) {
      // å¦‚æœæœ‰æ­¦å™¨åŠ æˆï¼Œä½¿ç”¨ damageWithWeapon API çš„ç¸½å€¼
      // æˆ–è€…ä½¿ç”¨åŸºç¤å€¼ + æ­¦å™¨åŠ æˆ
      totalPower = physicPower + magicPower + utilityPower + weaponBonus;
    } else {
      // å¦‚æœæ²’æœ‰æ­¦å™¨åŠ æˆï¼Œä½¿ç”¨åŸºç¤å€¼ç¸½å’Œ
      totalPower = physicPower + magicPower + utilityPower;
    }

    // å¦‚æœæœ‰å¤šå€‹è§’è‰²ï¼Œç´¯åŠ  localStorage ä¸­çš„å€¼
    if (storedData.physicPower && displayedCharacters.length > 1) {
      const storedPhysic = parseInt(String(storedData.physicPower || 0), 10);
      const storedMagic = parseInt(String(storedData.magicPower || 0), 10);
      const storedUtility = parseInt(String(storedData.utilityPower || 0), 10);
      const storedWeaponBonus = parseInt(String(storedData.weaponBonus || 0), 10);
      const storedHasBonus = storedData.hasBonus || false;

      if (storedHasBonus && storedWeaponBonus > 0) {
        totalPower = storedPhysic + storedMagic + storedUtility + storedWeaponBonus;
      } else {
        totalPower = storedPhysic + storedMagic + storedUtility;
      }
    }

    // é¡¯ç¤ºè§’è‰²åç¨±ï¼Œä½¿ç”¨ localStorage ä¸­çš„åç¨±åˆ—è¡¨
    const nameElement = document.getElementById(`${side}Name`);
    if (nameElement) {
      const names = storedData.nameOriginal || [];
      nameElement.textContent = names.join('ã€') || (fighter.nameOriginal || fighter.name) || "N/A";
      nameElement.classList.remove('loading-state');
    }

        const physicPowerElement = document.getElementById(`${side}PhysicPower`);
    const magicPowerElement = document.getElementById(`${side}MagicPower`);
    const utilityPowerElement = document.getElementById(`${side}UtilityPower`);

    if (physicPowerElement) {
      physicPowerElement.textContent = `Physic Power: ${physicPower}`;
      physicPowerElement.classList.remove('loading-state');
    }
    if (magicPowerElement) {
      magicPowerElement.textContent = `Magic Power: ${magicPower}`;
      magicPowerElement.classList.remove('loading-state');
    }
    if (utilityPowerElement) {
      if (hasBonus && weaponBonus > 0) {
        utilityPowerElement.textContent = `Utility Power: ${utilityPower} (+${weaponBonus})`;
      } else {
        utilityPowerElement.textContent = `Utility Power: ${utilityPower}`;
      }
      utilityPowerElement.classList.remove('loading-state');
    }

    // é¡¯ç¤ºå±¬æ€§ï¼Œä½¿ç”¨ localStorage ä¸­çš„å±¬æ€§åˆ—è¡¨
    const attributesElement = document.getElementById(`${side}Attributes`);
    if (attributesElement) {
      const attributes = storedData.attributes || [];
      attributesElement.textContent = `Attributes: ${attributes.join('ã€') || (fighter.attributes || "N/A")}`;
      attributesElement.classList.remove('loading-state');
    }

    // é¡¯ç¤ºç¸½åŠ›é‡
    const totalPowerElement = document.getElementById(`${side}TotalPower`);
    if (totalPowerElement) {
      totalPowerElement.textContent = `Total Power: ${totalPower}`;
      totalPowerElement.classList.remove('loading-state');
    }

    // ç¢ºä¿å­˜å„²çš„ç¸½åŠ›é‡æ˜¯æ•¸å­—
    fighters[side].main.totalPower = totalPower;
    fighters[side].main.nameOriginal = fighter.nameOriginal;
  }
  
  // æ¸…é™¤è§’è‰²è³‡è¨Š
  function clearFighterInfo(side: 'left' | 'right') {
    hideInfoLoading(side);

    const elements = [
      `${side}Name`,
      `${side}PhysicPower`,
      `${side}MagicPower`,
      `${side}UtilityPower`,
      `${side}Attributes`,
      `${side}TotalPower`
    ];

    elements.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = "";
        element.classList.remove('loading-state');
      }
    });

    fighters[side].main.totalPower = 0;
    fighters[side].main.nameOriginal = undefined;
  }
  
  // æª¢æŸ¥ä¸¦è¼‰å…¥æˆ°é¬¥ç‰ˆæœ¬çš„åœ–ç‰‡
  async function loadFightingImage(side: 'left' | 'right', originalImagePath: string): Promise<string> {
    try {
      // æª¢æŸ¥ç•¶å‰åœ–ç‰‡æ˜¯å¦å·²ç¶“æ˜¯ ruined åœ–ç‰‡
      const currentImage = document.getElementById(`${side}Image`) as HTMLImageElement;
      if (currentImage && currentImage.src.includes('Ruined.png')) {
        return currentImage.src; // å¦‚æœå·²ç¶“æ˜¯ ruined åœ–ç‰‡ï¼Œç›´æ¥è¿”å›ç•¶å‰åœ–ç‰‡è·¯å¾‘
      }

      const originalName = originalImagePath.split("/").pop()?.split(".")[0];
      if (!originalName) return originalImagePath;

      const fightingImagePath = `${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/${originalName}Fighting.png`;
      const response = await fetch(fightingImagePath);
      
      if (response.ok) {
        return fightingImagePath;
      }
    } catch (error) {
      console.error(`Error loading fighting image for ${side}:`, error);
    }
    return originalImagePath;
  }
  
  // æª¢æŸ¥ä¸¦è¼‰å…¥æˆ°æ•—ç‰ˆæœ¬çš„åœ–ç‰‡
  async function loadRuinedImage(side: 'left' | 'right', currentImagePath: string): Promise<string> {
    try {
      // æª¢æŸ¥ç•¶å‰åœ–ç‰‡æ˜¯å¦å·²ç¶“æ˜¯ ruined åœ–ç‰‡
      const currentImage = document.getElementById(`${side}Image`) as HTMLImageElement;
      if (currentImage && currentImage.src.includes('Ruined.png')) {
        return currentImage.src; // å¦‚æœå·²ç¶“æ˜¯ ruined åœ–ç‰‡ï¼Œç›´æ¥è¿”å›ç•¶å‰åœ–ç‰‡è·¯å¾‘
      }

      // å¾ç•¶å‰åœ–ç‰‡è·¯å¾‘ä¸­æå–è§’è‰²åç¨±
      const imageName = currentImagePath.split("/").pop()?.split(".")[0] || "";
      const baseName = imageName.replace("Fighting", "");
      
      if (!baseName) return currentImagePath;

      const ruinedImagePath = `${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/${baseName}Ruined.png`;
      const response = await fetch(ruinedImagePath);
      
      if (response.ok) {
        return ruinedImagePath;
      }
    } catch (error) {
      console.error(`Error loading ruined image for ${side}:`, error);
    }
    return currentImagePath;
  }
  
  // ç‚ºå¤¥ä¼´è¼‰å…¥æˆ°æ•—ç‰ˆæœ¬çš„åœ–ç‰‡
  async function loadPartnerRuinedImage(side: 'left' | 'right', currentImagePath: string): Promise<string> {
    try {
      // å¾ç•¶å‰åœ–ç‰‡è·¯å¾‘ä¸­æå–è§’è‰²åç¨±
      const imageName = currentImagePath.split("/").pop()?.split(".")[0] || "";
      const baseName = imageName.replace("Fighting", "");
      
      if (!baseName) return currentImagePath;

      const ruinedImagePath = `${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/${baseName}Ruined.png`;
      const response = await fetch(ruinedImagePath);
      
      if (response.ok) {
        return ruinedImagePath;
      }
    } catch (error) {
      console.error(`Error loading partner ruined image for ${side}:`, error);
    }
    return currentImagePath;
  }
  
  // æ·»åŠ ç‹€æ…‹æ•ˆæœ
  function addStateEffect(side: 'left' | 'right', states: string[]) {
    const targetImage = document.getElementById(`${side}Image`) as HTMLImageElement;
    if (!targetImage) return;

    // ä¾æ¬¡é¡¯ç¤ºæ¯å€‹ç‹€æ…‹æ•ˆæœ
    states.forEach((state, index) => {
      setTimeout(() => {
        const stateOverlay = document.createElement('div');
        stateOverlay.className = 'state-overlay';
        stateOverlay.textContent = state;
        targetImage.parentElement?.appendChild(stateOverlay);
        
        // 1ç§’å¾Œç§»é™¤ç‹€æ…‹æ•ˆæœ
        setTimeout(() => {
          stateOverlay.remove();
        }, 1000);
      }, index * 1000); // æ¯å€‹ç‹€æ…‹æ•ˆæœé–“éš”1ç§’
    });
  }
  
  // é–‹å§‹æˆ°é¬¥
  async function startFight() {
    const leftPower = parseInt(String(fighters.left.main.totalPower || 0), 10);
    const rightPower = parseInt(String(fighters.right.main.totalPower || 0), 10);
    
    const leftResult = document.getElementById("leftResult");
    const rightResult = document.getElementById("rightResult");
    const leftTotalPower = document.getElementById("leftTotalPower");
    const rightTotalPower = document.getElementById("rightTotalPower");
    
    // é‡è¨­æ¨£å¼å’Œæ–‡æœ¬
    if (leftResult) leftResult.textContent = "";
    if (rightResult) rightResult.textContent = "";
    if (leftTotalPower) leftTotalPower.classList.remove("win", "defeated");
    if (rightTotalPower) rightTotalPower.classList.remove("win", "defeated");
    
    // å¦‚æœä»»ä¸€æ–¹æœªé¸æ“‡è§’è‰²æˆ–åŠ›é‡ç‚º0ï¼Œé¡¯ç¤ºæç¤º
    if (!fighters.left.main.image || !fighters.right.main.image) {
      alert("è«‹å…ˆé¸æ“‡å…©é‚Šçš„è§’è‰²");
      return;
    }

    // æª¢æŸ¥è§’è‰²æ˜¯å¦å·²ç¶“è™•æ–¼ ruined ç‹€æ…‹
    const leftImage = document.getElementById("leftImage") as HTMLImageElement;
    const rightImage = document.getElementById("rightImage") as HTMLImageElement;
    
    const leftIsRuined = leftImage && leftImage.src.includes('Ruined.png');
    const rightIsRuined = rightImage && rightImage.src.includes('Ruined.png');
    
    // å¦‚æœé›™æ–¹éƒ½å·²ç¶“è™•æ–¼ ruined ç‹€æ…‹ï¼Œé¡¯ç¤ºæç¤º
    if (leftIsRuined && rightIsRuined) {
      alert("é›™æ–¹è§’è‰²éƒ½å·²ç¶“æˆ°æ•—ï¼Œç„¡æ³•å†æ¬¡æˆ°é¬¥");
      return;
    }

    // è¼‰å…¥æˆ°é¬¥ç‰ˆæœ¬çš„åœ–ç‰‡
    await loadFightingImages('left');
    await loadFightingImages('right');

    // æª¢æŸ¥ä¸¦æ‡‰ç”¨ç‹€æ…‹æ•ˆæœ
    await checkAndApplyStateEffects();
    
    // è¨ˆç®—å·®è·ç™¾åˆ†æ¯”
    const percentageDifference = Math.abs(leftPower - rightPower) / Math.max(leftPower, rightPower, 1);
    
    // ç¢ºå®šå‹è² 
    if (leftPower > rightPower) {
      determineWinner("left", "right", leftPower, rightPower, percentageDifference);
    } else if (rightPower > leftPower) {
      determineWinner("right", "left", rightPower, leftPower, percentageDifference);
    } else {
      // å¹³å±€
      if (leftResult) leftResult.textContent = "Draw";
      if (rightResult) rightResult.textContent = "Draw";
      // ä½¿ç”¨ nameOriginal é¡¯ç¤ºè§’è‰²åç¨±
      const leftName = document.getElementById("leftName");
      const rightName = document.getElementById("rightName");
      if (leftName) leftName.innerHTML = 
        `${fighters.left.main.nameOriginal || fighters.left.main.name}<br><span class='result'>draw</span>`;
      if (rightName) rightName.innerHTML = 
        `${fighters.right.main.nameOriginal || fighters.right.main.name}<br><span class='result'>draw</span>`;
    }
  }
  
  // è¼‰å…¥æˆ°é¬¥ç‰ˆæœ¬çš„åœ–ç‰‡
  async function loadFightingImages(side: 'left' | 'right') {
    const mainImage = document.getElementById(`${side}Image`) as HTMLImageElement;
    const leftImage = document.querySelector(`.${side}-side-container.left-side .side-image`) as HTMLImageElement;
    const rightImage = document.querySelector(`.${side}-side-container.right-side .side-image`) as HTMLImageElement;

    if (mainImage && fighters[side].main.image) {
      const mainFightingImage = await loadFightingImage(side, fighters[side].main.image);
      mainImage.src = mainFightingImage;
    }

    if (leftImage && fighters[side].left?.image) {
      const leftFightingImage = await loadFightingImage(side, fighters[side].left.image);
      leftImage.src = leftFightingImage;
    }

    if (rightImage && fighters[side].right?.image) {
      const rightFightingImage = await loadFightingImage(side, fighters[side].right.image);
      rightImage.src = rightFightingImage;
    }
  }
  
  // ç¢ºå®šå‹è² å’Œçµæœé¡¯ç¤º
  function determineWinner(winnerSide: 'left' | 'right', loserSide: 'left' | 'right', winnerPower: number, loserPower: number, difference: number) {
    const winnerElement = document.getElementById(`${winnerSide}TotalPower`);
    const loserElement = document.getElementById(`${loserSide}TotalPower`);
    const winnerResult = document.getElementById(`${winnerSide}Result`);
    const loserResult = document.getElementById(`${loserSide}Result`);
    const winnerName = document.getElementById(`${winnerSide}Name`);
    const loserName = document.getElementById(`${loserSide}Name`);
    const loserImage = document.getElementById(`${loserSide}Image`) as HTMLImageElement;
    const winnerImage = document.getElementById(`${winnerSide}Image`) as HTMLImageElement;
    
    // ç²å–å‹åˆ©æ–¹å’Œå¤±æ•—æ–¹çš„å¤¥ä¼´åœ–ç‰‡
    const winnerLeftImage = document.querySelector(`.${winnerSide}-side-container.left-side .side-image`) as HTMLImageElement;
    const winnerRightImage = document.querySelector(`.${winnerSide}-side-container.right-side .side-image`) as HTMLImageElement;
    const loserLeftImage = document.querySelector(`.${loserSide}-side-container.left-side .side-image`) as HTMLImageElement;
    const loserRightImage = document.querySelector(`.${loserSide}-side-container.right-side .side-image`) as HTMLImageElement;
    
    // æª¢æŸ¥å¤±æ•—æ–¹æ˜¯å¦å·²ç¶“è™•æ–¼ ruined ç‹€æ…‹
    const loserIsRuined = loserImage && loserImage.src.includes('Ruined.png');
    const loserLeftIsRuined = loserLeftImage && loserLeftImage.style.display !== 'none' && loserLeftImage.src.includes('Ruined.png');
    const loserRightIsRuined = loserRightImage && loserRightImage.style.display !== 'none' && loserRightImage.src.includes('Ruined.png');
    
    // é‡è¨­æ¨£å¼
    if (winnerElement) {
      winnerElement.classList.remove("defeated");
      winnerElement.classList.add("win");
      // æ ¹æ“šå·®è·è¨­ç½®å¼·åº¦
      if (difference > 0.4) {
        winnerElement.setAttribute("data-intensity", "high");
      } else if (difference > 0.1) {
        winnerElement.setAttribute("data-intensity", "medium");
      } else {
        winnerElement.setAttribute("data-intensity", "low");
      }
    }
    if (loserElement) {
      loserElement.classList.remove("win");
      loserElement.classList.add("defeated");
      // æ ¹æ“šå·®è·è¨­ç½®å¼·åº¦
      if (difference > 0.4) {
        loserElement.setAttribute("data-intensity", "high");
      } else if (difference > 0.1) {
        loserElement.setAttribute("data-intensity", "medium");
      } else {
        loserElement.setAttribute("data-intensity", "low");
      }
    }
    
    // è¨ˆç®—å¤±æ•—ç™¾åˆ†æ¯”
    const lossPercentage = ((winnerPower - loserPower) / winnerPower * 100).toFixed(2);
    
    // é¡¯ç¤ºåŸºæœ¬çµæœ
    if (winnerResult) winnerResult.textContent = "Winner";
    if (loserResult) loserResult.textContent = `${lossPercentage}% Defeated`;
    
    // æ ¹æ“šå·®è·ç¨‹åº¦é¡¯ç¤ºä¸åŒçµæœå’Œæ•ˆæœ
    const winnerCharName = fighters[winnerSide].main.nameOriginal || fighters[winnerSide].main.name;
    const loserCharName = fighters[loserSide].main.nameOriginal || fighters[loserSide].main.name;
    
    // æ·»åŠ ç–ŠåŠ åœ–åƒ
    const loserOverlay1 = document.getElementById(`${loserSide}Overlay1`) as HTMLImageElement;
    const loserOverlay2 = document.getElementById(`${loserSide}Overlay2`) as HTMLImageElement;
    const loserOverlay3 = document.getElementById(`${loserSide}Overlay3`) as HTMLImageElement;
    if (loserOverlay1 && loserOverlay2 && loserOverlay3) {
      // å…ˆæ·»åŠ å·¦å´æ»‘å…¥çš„åœ–åƒ
      loserOverlay2.classList.add('active', 'slide-in-left');
      
      // å»¶é²æ·»åŠ å³å´æ»‘å…¥çš„åœ–åƒ
      setTimeout(() => {
        loserOverlay1.classList.add('active', 'slide-in-right');
      }, 250);

      // å»¶é²æ·»åŠ ç¬¬ä¸‰å¼µåœ–åƒï¼ˆå¾å¾Œæ–¹ç¸®æ”¾å‡ºç¾ï¼‰
      setTimeout(() => {
        loserOverlay3.classList.add('active', 'scale-in');
      }, 500);
    }
    
    // æ¸…é™¤ä¹‹å‰çš„å‹•ç•«é¡
    if (winnerImage) {
      winnerImage.classList.remove('glow', 'glow-strong', 'glow-extreme', 'victory-effect');
      // å¼·åˆ¶é‡æ–°æ‡‰ç”¨å‹•ç•«
      void winnerImage.offsetWidth; // è§¸ç™¼é‡æ’
      winnerImage.classList.add('victory-jump');
    }
    
    if (winnerLeftImage && winnerLeftImage.style.display !== 'none') {
      winnerLeftImage.classList.remove('victory-jump');
      void winnerLeftImage.offsetWidth; // è§¸ç™¼é‡æ’
      winnerLeftImage.classList.add('victory-jump');
    }
    
    if (winnerRightImage && winnerRightImage.style.display !== 'none') {
      winnerRightImage.classList.remove('victory-jump');
      void winnerRightImage.offsetWidth; // è§¸ç™¼é‡æ’
      winnerRightImage.classList.add('victory-jump');
    }

    // ç‚ºå¤±æ•—çš„è§’è‰²å’Œå…¶å¤¥ä¼´æ·»åŠ æ™ƒå‹•æ•ˆæœ
    if (loserImage) {
      loserImage.classList.remove('shake', 'shake-hard', 'shake-extreme');
      void loserImage.offsetWidth; // è§¸ç™¼é‡æ’
      loserImage.classList.add('defeat-shake');
    }

    if (loserLeftImage && loserLeftImage.style.display !== 'none') {
      loserLeftImage.classList.remove('defeat-shake');
      void loserLeftImage.offsetWidth; // è§¸ç™¼é‡æ’
      loserLeftImage.classList.add('defeat-shake');
    }

    if (loserRightImage && loserRightImage.style.display !== 'none') {
      loserRightImage.classList.remove('defeat-shake');
      void loserRightImage.offsetWidth; // è§¸ç™¼é‡æ’
      loserRightImage.classList.add('defeat-shake');
    }
    
    if (difference > 0.4) {
      if (winnerName) {
        winnerName.innerHTML = `${winnerCharName}<br><span class='result' style='color: #00ff00; text-shadow: 0 0 8px rgba(0, 255, 0, 0.5); font-size: 18px; font-weight: bold;'>Destroying</span>`;
      }
      if (loserName) {
        loserName.innerHTML = `${loserCharName}<br><span class='result' style='color: #ff0000; text-shadow: 0 0 8px rgba(255, 0, 0, 0.5); font-size: 18px; font-weight: bold;'>Fucked Up</span>`;
      }
    } else if (difference > 0.1) {
      if (winnerName) {
        winnerName.innerHTML = `${winnerCharName}<br><span class='result' style='color: #00cc00; text-shadow: 0 0 6px rgba(0, 204, 0, 0.4); font-size: 18px; font-weight: bold;'>Destroying</span>`;
      }
      if (loserName) {
        loserName.innerHTML = `${loserCharName}<br><span class='result' style='color: #cc0000; text-shadow: 0 0 6px rgba(204, 0, 0, 0.4); font-size: 18px; font-weight: bold;'>Fucked Up</span>`;
      }
    } else {
      if (winnerName) {
        winnerName.innerHTML = `${winnerCharName}<br><span class='result' style='color: #009900; text-shadow: 0 0 4px rgba(0, 153, 0, 0.3); font-size: 18px; font-weight: bold;'>Destroying</span>`;
      }
      if (loserName) {
        loserName.innerHTML = `${loserCharName}<br><span class='result' style='color: #990000; text-shadow: 0 0 4px rgba(153, 0, 0, 0.3); font-size: 18px; font-weight: bold;'>Fucked Up</span>`;
      }
    }

    // å‹•ç•«çµæŸå¾Œç§»é™¤æ•ˆæœ
    setTimeout(() => {
      if (loserImage) loserImage.classList.remove('defeat-shake');
      if (loserLeftImage) loserLeftImage.classList.remove('defeat-shake');
      if (loserRightImage) loserRightImage.classList.remove('defeat-shake');
      if (winnerImage) winnerImage.classList.remove('victory-jump');
      if (winnerLeftImage) winnerLeftImage.classList.remove('victory-jump');
      if (winnerRightImage) winnerRightImage.classList.remove('victory-jump');
    }, 500);
    
    // ç­‰å¾… 2 ç§’å¾Œé¡¯ç¤ºæˆ°æ•—/æˆ°å‹æ•ˆæœ
    setTimeout(async () => {
      // ç‚ºè¼¸å®¶çš„ä¸»è§’è‰²è¼‰å…¥æˆ°æ•—åœ–ç‰‡ï¼Œä½†åªæœ‰åœ¨ä¸æ˜¯å·²ç¶“è™•æ–¼ ruined ç‹€æ…‹æ™‚æ‰è¼‰å…¥
      if (loserImage && !loserIsRuined) {
        const currentSrc = loserImage.src;
        const ruinedImagePath = await loadRuinedImage(loserSide, currentSrc);
        if (ruinedImagePath !== currentSrc) {
          loserImage.src = ruinedImagePath;
          loserImage.classList.add('ruined-effect');
          // ç§»é™¤æŒçºŒçš„æˆ°æ•—æ•ˆæœ
          // loserImage.style.filter = 'brightness(80%) saturate(80%)';
        }
      }
      
      // ç‚ºè¼¸å®¶çš„å·¦å´å¤¥ä¼´è¼‰å…¥æˆ°æ•—åœ–ç‰‡ï¼Œä½†åªæœ‰åœ¨ä¸æ˜¯å·²ç¶“è™•æ–¼ ruined ç‹€æ…‹æ™‚æ‰è¼‰å…¥
      if (loserLeftImage && loserLeftImage.style.display !== 'none' && !loserLeftIsRuined) {
        const currentSrc = loserLeftImage.src;
        // å¾ç•¶å‰åœ–ç‰‡è·¯å¾‘ä¸­æå–è§’è‰²åç¨±
        const imageName = currentSrc.split("/").pop()?.split(".")[0] || "";
        const baseName = imageName.replace("Fighting", "");
        
        if (baseName) {
          const ruinedImagePath = `${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/${baseName}Ruined.png`;
          try {
            const response = await fetch(ruinedImagePath);
            if (response.ok && ruinedImagePath !== currentSrc) {
              loserLeftImage.src = ruinedImagePath;
              loserLeftImage.classList.add('ruined-effect');
              // ç§»é™¤æŒçºŒçš„æˆ°æ•—æ•ˆæœ
              // loserLeftImage.style.filter = 'brightness(80%) saturate(80%)';
            }
          } catch (error) {
            console.error(`Error loading partner ruined image for ${loserSide} left:`, error);
          }
        }
      }
      
      // ç‚ºè¼¸å®¶çš„å³å´å¤¥ä¼´è¼‰å…¥æˆ°æ•—åœ–ç‰‡ï¼Œä½†åªæœ‰åœ¨ä¸æ˜¯å·²ç¶“è™•æ–¼ ruined ç‹€æ…‹æ™‚æ‰è¼‰å…¥
      if (loserRightImage && loserRightImage.style.display !== 'none' && !loserRightIsRuined) {
        const currentSrc = loserRightImage.src;
        // å¾ç•¶å‰åœ–ç‰‡è·¯å¾‘ä¸­æå–è§’è‰²åç¨±
        const imageName = currentSrc.split("/").pop()?.split(".")[0] || "";
        const baseName = imageName.replace("Fighting", "");
        
        if (baseName) {
          const ruinedImagePath = `${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/${baseName}Ruined.png`;
          try {
            const response = await fetch(ruinedImagePath);
            if (response.ok && ruinedImagePath !== currentSrc) {
              loserRightImage.src = ruinedImagePath;
              loserRightImage.classList.add('ruined-effect');
              // ç§»é™¤æŒçºŒçš„æˆ°æ•—æ•ˆæœ
              // loserRightImage.style.filter = 'brightness(80%) saturate(80%)';
            }
          } catch (error) {
            console.error(`Error loading partner ruined image for ${loserSide} right:`, error);
          }
        }
      }
      
      // æˆ°é¬¥å®Œæˆå¾Œç¦ç”¨ Fight æŒ‰éˆ•
      fightCompleted = true;
      const fightButton = document.getElementById('fightButton') as HTMLButtonElement;
      if (fightButton) {
        fightButton.disabled = true;
        fightButton.style.opacity = '0.5';
        fightButton.style.cursor = 'not-allowed';
      }
    }, 2000);
  }
  
  // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
  window.onload = async () => {
    try {
      await init();
      // æ·»åŠ  Fight æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶ç›£è½å™¨
      const fightButton = document.getElementById('fightButton');
      if (fightButton) {
        fightButton.addEventListener('click', startFight);
      }
    } catch (error) {
      console.error('âŒ Fight çµ„ä»¶åˆå§‹åŒ–å¤±æ•—:', error);
    }
  };

  // å„²å­˜åˆ° localStorage
  function saveToLocalStorage(side: 'left' | 'right', fighter: any) {
    const storageKey = `fighters_${side}`;
    let currentData = JSON.parse(localStorage.getItem(storageKey) || '{}');
    
    // åˆå§‹åŒ–æ•¸æ“šçµæ§‹
    if (!currentData.physicPower) currentData.physicPower = 0;
    if (!currentData.magicPower) currentData.magicPower = 0;
    if (!currentData.utilityPower) currentData.utilityPower = 0;
    if (!currentData.weaponBonus) currentData.weaponBonus = 0;
    if (!currentData.nameOriginal) currentData.nameOriginal = [];
    if (!currentData.attributes) currentData.attributes = [];

    // ç²å–ç•¶å‰é¸æ“‡çš„è§’è‰²åç¨±
    const currentName = fighter.nameOriginal || fighter.name;
    if (!currentName) return;

    // æª¢æŸ¥ç•¶å‰è§’è‰²æ˜¯å¦å·²ç¶“åœ¨åˆ—è¡¨ä¸­
    const isAlreadyAdded = currentData.nameOriginal.includes(currentName);

    // å¦‚æœè§’è‰²å·²ç¶“å­˜åœ¨ï¼Œä¸é‡è¤‡æ·»åŠ 
    if (!isAlreadyAdded) {
      // ç´¯åŠ æ•¸å€¼
      currentData.physicPower += parseInt(String(fighter.physicPower || 0), 10);
      currentData.magicPower += parseInt(String(fighter.magicPower || 0), 10);
      currentData.utilityPower += parseInt(String(fighter.utilityPower || 0), 10);
      currentData.weaponBonus += parseInt(String(fighter.weaponBonus || 0), 10);

      // å¦‚æœä»»ä½•è§’è‰²æœ‰æ­¦å™¨åŠ æˆï¼Œæ•´é«”å°±æœ‰åŠ æˆ
      if (fighter.hasBonus) {
        currentData.hasBonus = true;
      }

      // æ·»åŠ åç¨±å’Œå±¬æ€§
      currentData.nameOriginal.push(currentName);
      const attributes = fighter.attributes;
      if (attributes && !currentData.attributes.includes(attributes)) {
        currentData.attributes.push(attributes);
      }

      // ä¿å­˜æ­¦å™¨æ•¸æ“š
      if (fighter.weaponData) {
        currentData.weaponData = fighter.weaponData;
      }

      // å„²å­˜å› localStorage
      localStorage.setItem(storageKey, JSON.stringify(currentData));

      // è¼¸å‡ºåˆ°æ§åˆ¶å°ä»¥ä¾¿æª¢æŸ¥
      console.log(`${side} side localStorage data:`, currentData);
      console.log(`Added character: ${currentName}`);

      // ç«‹å³æ›´æ–°é¡¯ç¤º
      updateFighterInfo(side, currentData);
    } else {
      console.log(`Character ${currentName} already exists in localStorage`);
    }
  }

  // æ¸…é™¤ localStorage æ•¸æ“š
  function clearLocalStorage(side: 'left' | 'right') {
    localStorage.removeItem(`fighters_${side}`);
    console.log(`Cleared ${side} side localStorage data`);
  }

    // é€šç”¨çš„æ­¦å™¨ API èª¿ç”¨å‡½æ•¸ï¼ˆç•°æ­¥è™•ç†ï¼‰
  async function fetchWeaponData(ownerName: string) {
    try {
      // ä½¿ç”¨çµ±ä¸€çš„ weaponService
      const { weaponService } = await import('../services/api/weaponService');
      const weapons = await weaponService.getWeaponsByOwner(ownerName);

      return weapons;
    } catch (error) {
      console.error(`âŒ ç²å–æ­¦å™¨æ•¸æ“šå¤±æ•— (${ownerName}):`, error);
      return [];
    }
  }

  // è¼ªè©¢æ­¦å™¨æ•¸æ“š
  async function pollWeaponData(requestId: string, baseUrl: string, maxAttempts: number = 8, interval: number = 5000) {
    // èª¿æ•´è¼ªè©¢åƒæ•¸ä»¥åœ¨ 40 ç§’å…§å®Œæˆ (8 æ¬¡ * 5 ç§’ = 40 ç§’)
    maxAttempts = Math.min(maxAttempts, 8);
    interval = Math.max(interval, 5000);
    // é–‹å§‹è¼ªè©¢æ­¦å™¨æ•¸æ“š

    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
      try {
        // æ­¦å™¨è¼ªè©¢å˜—è©¦

        // æª¢æŸ¥çµæœæ˜¯å¦å­˜åœ¨
        const existsUrl = `${baseUrl}/api/request-status/${requestId}/exists`;
        const existsResponse = await fetch(existsUrl, { credentials: 'include' });

        if (existsResponse.ok) {
          const existsData = await existsResponse.json();
          console.log(`å‚·å®³çµæœå­˜åœ¨æª¢æŸ¥: ${JSON.stringify(existsData)}`);

          // å¦‚æœ exists ç‚º falseï¼Œç­‰å¾…3ç§’å¾Œåœæ­¢è¼ªè©¢
          if (!existsData.exists) {
            console.log('å‚·å®³çµæœå­˜åœ¨æª¢æŸ¥:', existsData);
            console.log('â³ çµæœä¸å­˜åœ¨ï¼Œ3ç§’å¾Œåœæ­¢è¼ªè©¢...');
            await new Promise(resolve => setTimeout(resolve, 3000));
            console.log('âŒ çµæœä¸å­˜åœ¨ï¼Œè‚¯å®šæ²’åˆ°éšŠåˆ—è£¡é¢ï¼Œåœæ­¢è¼ªè©¢');
            throw new Error('çµæœä¸å­˜åœ¨ï¼Œè‚¯å®šæ²’åˆ°éšŠåˆ—è£¡é¢');
          }

          if (existsData.exists) {
            // ç²å–çµæœ
            const resultUrl = `${baseUrl}/api/request-status/${requestId}`;
            const resultResponse = await fetch(resultUrl, { credentials: 'include' });

            if (!resultResponse.ok) {
              const errorText = await resultResponse.text();
              console.error('âŒ æ­¦å™¨çµæœç²å–å¤±æ•—:', errorText);
              throw new Error(`æ­¦å™¨çµæœç²å–å¤±æ•—: ${resultResponse.status} - ${errorText}`);
            }

            const result = await resultResponse.json();
            // æ­¦å™¨è¼ªè©¢çµæœ

            // æª¢æŸ¥æ˜¯å¦é‚„åœ¨è™•ç†ä¸­
            if (result.status === 'processing' || result.data === null) {
              // æ­¦å™¨æ•¸æ“šä»åœ¨è™•ç†ä¸­ï¼Œç¹¼çºŒç­‰å¾…
              if (attempt < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, interval));
                continue;
              } else {
                throw new Error('æ­¦å™¨æ•¸æ“šè¼ªè©¢è¶…æ™‚');
              }
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
            if (result.error) {
              console.error('âŒ æ­¦å™¨è™•ç†éŒ¯èª¤:', result.error);
              throw new Error(`æ­¦å™¨è™•ç†éŒ¯èª¤: ${result.error}`);
            }

            // æª¢æŸ¥æ•¸æ“šæ ¼å¼
            if (result.data && Array.isArray(result.data)) {
              return result.data;
            } else {
              console.error('âŒ æ­¦å™¨æ•¸æ“šæ ¼å¼éŒ¯èª¤:', result);
              throw new Error('æ­¦å™¨æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
            }
          }
        }

        // çµæœé‚„ä¸å­˜åœ¨ï¼Œç¹¼çºŒç­‰å¾…
        // æ­¦å™¨çµæœé‚„ä¸å­˜åœ¨ï¼Œç¹¼çºŒç­‰å¾…
        if (attempt < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, interval));
          continue;
        } else {
          throw new Error('æ­¦å™¨æ•¸æ“šè¼ªè©¢è¶…æ™‚');
        }

      } catch (error) {
        console.error(`âŒ æ­¦å™¨è¼ªè©¢å˜—è©¦ ${attempt} å¤±æ•—:`, error);
        if (attempt === maxAttempts) {
          throw error;
        }
        await new Promise(resolve => setTimeout(resolve, interval));
      }
    }

    throw new Error('æ­¦å™¨æ•¸æ“šè¼ªè©¢è¶…æ™‚');
  }

  // é¡¯ç¤ºæ­¦å™¨ä¿¡æ¯ï¼ˆç´¯ç©æ¨¡å¼ï¼‰
  function displayWeaponInfo(side: 'left' | 'right', weapons: any[], fighterType: 'main' | 'left' | 'right') {
    const weaponLoading = document.getElementById(`${side}WeaponLoading`);
    const weaponsContainer = document.getElementById(`${side}WeaponsContainer`);

    if (!weaponLoading || !weaponsContainer) {
      console.error(`âŒ æ‰¾ä¸åˆ°æ­¦å™¨é¡¯ç¤ºå…ƒç´  (${side})`);
      return;
    }

    // éš±è— loadingï¼ˆåªæœ‰åœ¨æ²’æœ‰ä»»ä½•fighteræ™‚æ‰é¡¯ç¤ºloadingï¼‰
    const hasAnyFighter = fighters[side].main.image || fighters[side].left?.image || fighters[side].right?.image;
    weaponLoading.style.display = hasAnyFighter ? 'none' : 'flex';

    // å…ˆç§»é™¤èˆŠçš„fighteré¡å‹çš„æ­¦å™¨ï¼ˆå¦‚æœå­˜åœ¨çš„è©±ï¼‰
    removeWeaponByFighterType(side, fighterType);

    if (!weapons || weapons.length === 0) {
      // fighter ç„¡æ­¦å™¨
      updateNoWeaponsDisplay(side);
      return;
    }

    // æ·»åŠ æ–°æ­¦å™¨çš„æ¨™è­˜ï¼Œè®“æˆ‘å€‘çŸ¥é“é€™æ˜¯å“ªå€‹fighterçš„æ­¦å™¨
    weapons.forEach((weapon, index) => {
      const weaponElement = document.createElement('div');
      weaponElement.className = `weapon-item fighter-${fighterType}`;
      weaponElement.dataset.fighterType = fighterType;
      weaponElement.innerHTML = `
        <div class="weapon-header">
          <span class="weapon-name">${weapon.weapon || 'æœªçŸ¥æ­¦å™¨'}</span>
          <span class="weapon-owner">(${weapon.owner})</span>
          <span class="fighter-type">${getFighterTypeLabel(fighterType)}</span>
        </div>
        <div class="weapon-stats">
          <div class="weapon-damage">
            <div class="base-damage">åŸºç¤å‚·å®³: ${weapon.baseDamage || 0}</div>
            <div class="bonus-damage">åŠ æˆå‚·å®³: ${weapon.bonusDamage || 0}</div>
          </div>
          <div class="weapon-attributes">
            <div class="main-attribute">ä¸»å±¬æ€§: ${weapon.attributes || 'ç„¡'}</div>
            ${weapon.bonusAttributes && weapon.bonusAttributes.length > 0 ?
              `<div class="bonus-attributes">å‰¯å±¬æ€§: ${weapon.bonusAttributes.join(', ')}</div>` : ''}
          </div>
          ${weapon.stateAttributes && weapon.stateAttributes.length > 0 ?
            `<div class="state-effects">
              <span class="state-label">ç‹€æ…‹æ•ˆæœ:</span>
              <div class="state-tags">
                ${weapon.stateAttributes.slice(0, 4).map(state =>
                  `<span class="state-tag">${state}</span>`
                ).join('')}
                ${weapon.stateAttributes.length > 4 ?
                  `<span class="state-tag more">+${weapon.stateAttributes.length - 4}</span>` : ''}
              </div>
            </div>` : ''}
        </div>
      `;
      weaponsContainer.appendChild(weaponElement);
    });

    // å·²ç´¯ç©é¡¯ç¤ºæ­¦å™¨ä¿¡æ¯
    updateNoWeaponsDisplay(side);
  }

  // ç§»é™¤ç‰¹å®šfighteré¡å‹çš„æ­¦å™¨
  function removeWeaponByFighterType(side: 'left' | 'right', fighterType: 'main' | 'left' | 'right') {
    const weaponsContainer = document.getElementById(`${side}WeaponsContainer`);
    if (!weaponsContainer) return;

    // ç§»é™¤æŒ‡å®šfighteré¡å‹çš„æ­¦å™¨å…ƒç´ 
    const weaponElements = weaponsContainer.querySelectorAll(`[data-fighter-type="${fighterType}"]`);
    weaponElements.forEach(element => element.remove());

    // å·²ç§»é™¤æ­¦å™¨
  }

  // æ›´æ–°ç„¡æ­¦å™¨é¡¯ç¤º
  function updateNoWeaponsDisplay(side: 'left' | 'right') {
    const weaponsContainer = document.getElementById(`${side}WeaponsContainer`);
    if (!weaponsContainer) return;

    // æª¢æŸ¥æ˜¯å¦é‚„æœ‰æ­¦å™¨
    const hasWeapons = weaponsContainer.querySelectorAll('.weapon-item').length > 0;

    // ç§»é™¤ç¾æœ‰çš„ç„¡æ­¦å™¨æç¤º
    const noWeaponsElement = weaponsContainer.querySelector('.no-weapons');
    if (noWeaponsElement) {
      noWeaponsElement.remove();
    }

    // å¦‚æœæ²’æœ‰æ­¦å™¨ï¼Œé¡¯ç¤ºç„¡æ­¦å™¨æç¤º
    if (!hasWeapons) {
      weaponsContainer.innerHTML = '<div class="no-weapons">ç„¡æ­¦å™¨</div>';
    }
  }

  // ç²å–fighteré¡å‹æ¨™ç±¤
  function getFighterTypeLabel(fighterType: 'main' | 'left' | 'right'): string {
    switch (fighterType) {
      case 'main': return 'ä¸»';
      case 'left': return 'å·¦';
      case 'right': return 'å³';
      default: return '';
    }
  }

  // æ¸…é™¤æ­¦å™¨ä¿¡æ¯
  function clearWeaponInfo(side: 'left' | 'right') {
    const weaponLoading = document.getElementById(`${side}WeaponLoading`);
    const weaponsContainer = document.getElementById(`${side}WeaponsContainer`);

    if (weaponLoading) {
      weaponLoading.style.display = 'flex';
    }

    if (weaponsContainer) {
      weaponsContainer.innerHTML = '';
    }
  }

  // æª¢æŸ¥ä¸¦æ‡‰ç”¨ç‹€æ…‹æ•ˆæœ
  async function checkAndApplyStateEffects() {
    try {
      // å¾ localStorage ç²å–è§’è‰²æ•¸æ“š
      const leftStorageKey = 'fighters_left';
      const rightStorageKey = 'fighters_right';
      const leftData = JSON.parse(localStorage.getItem(leftStorageKey) || '{}');
      const rightData = JSON.parse(localStorage.getItem(rightStorageKey) || '{}');
      
      // æ”¶é›†å·¦æ–¹æ‰€æœ‰è§’è‰²çš„ç‹€æ…‹æ•ˆæœ
      const leftSideStates: string[] = [];
      
      // æª¢æŸ¥å·¦æ–¹ä¸»è§’è‰²çš„æ­¦å™¨æ•ˆæœ
      if (leftData.weaponData && leftData.hasBonus && leftData.weaponData.stateAttributes) {
        leftSideStates.push(...leftData.weaponData.stateAttributes);
      }
      
      // æª¢æŸ¥å·¦æ–¹å·¦å´å¤¥ä¼´çš„æ­¦å™¨æ•ˆæœ
      if (fighters.left.left?.name) {
        const leftPartnerName = fighters.left.left.name;
        const leftPartnerWeaponData = await fetchWeaponData(leftPartnerName);
        
        if (leftPartnerWeaponData) {
          const { hasBonus } = calculateWeaponDamage(fighters.left.left, leftPartnerWeaponData);
          
          if (hasBonus && leftPartnerWeaponData.stateAttributes && Array.isArray(leftPartnerWeaponData.stateAttributes)) {
            leftSideStates.push(...leftPartnerWeaponData.stateAttributes);
          }
        }
      }
      
      // æª¢æŸ¥å·¦æ–¹å³å´å¤¥ä¼´çš„æ­¦å™¨æ•ˆæœ
      if (fighters.left.right?.name) {
        const leftRightPartnerName = fighters.left.right.name;
        const leftRightPartnerWeaponData = await fetchWeaponData(leftRightPartnerName);
        
        if (leftRightPartnerWeaponData) {
          const { hasBonus } = calculateWeaponDamage(fighters.left.right, leftRightPartnerWeaponData);
          
          if (hasBonus && leftRightPartnerWeaponData.stateAttributes && Array.isArray(leftRightPartnerWeaponData.stateAttributes)) {
            leftSideStates.push(...leftRightPartnerWeaponData.stateAttributes);
          }
        }
      }
      
      // æ”¶é›†å³æ–¹æ‰€æœ‰è§’è‰²çš„ç‹€æ…‹æ•ˆæœ
      const rightSideStates: string[] = [];
      
      // æª¢æŸ¥å³æ–¹ä¸»è§’è‰²çš„æ­¦å™¨æ•ˆæœ
      if (rightData.weaponData && rightData.hasBonus && rightData.weaponData.stateAttributes) {
        rightSideStates.push(...rightData.weaponData.stateAttributes);
      }
      
      // æª¢æŸ¥å³æ–¹å·¦å´å¤¥ä¼´çš„æ­¦å™¨æ•ˆæœ
      if (fighters.right.left?.name) {
        const rightPartnerName = fighters.right.left.name;
        const rightPartnerWeaponData = await fetchWeaponData(rightPartnerName);
        
        if (rightPartnerWeaponData) {
          const { hasBonus } = calculateWeaponDamage(fighters.right.left, rightPartnerWeaponData);
          
          if (hasBonus && rightPartnerWeaponData.stateAttributes && Array.isArray(rightPartnerWeaponData.stateAttributes)) {
            rightSideStates.push(...rightPartnerWeaponData.stateAttributes);
          }
        }
      }
      
      // æª¢æŸ¥å³æ–¹å³å´å¤¥ä¼´çš„æ­¦å™¨æ•ˆæœ
      if (fighters.right.right?.name) {
        const rightRightPartnerName = fighters.right.right.name;
        const rightRightPartnerWeaponData = await fetchWeaponData(rightRightPartnerName);
        
        if (rightRightPartnerWeaponData) {
          const { hasBonus } = calculateWeaponDamage(fighters.right.right, rightRightPartnerWeaponData);
          
          if (hasBonus && rightRightPartnerWeaponData.stateAttributes && Array.isArray(rightRightPartnerWeaponData.stateAttributes)) {
            rightSideStates.push(...rightRightPartnerWeaponData.stateAttributes);
          }
        }
      }
      
      // ä¸€æ¬¡æ€§é¡¯ç¤ºæ‰€æœ‰ç‹€æ…‹æ•ˆæœ
      if (leftSideStates.length > 0) {
        addStateEffect('right', leftSideStates);
      }
      
      if (rightSideStates.length > 0) {
        addStateEffect('left', rightSideStates);
      }
      
    } catch (error) {
      console.error("æª¢æŸ¥æ­¦å™¨ç‹€æ…‹æ•ˆæœå¤±æ•—:", error);
    }
  }
</script>

<script define:vars={{ characterNames }}>
  // å°‡è§’è‰²åç¨±åˆ—è¡¨å‚³éçµ¦å®¢æˆ¶ç«¯è…³æœ¬
  document.currentScript?.setAttribute('data-characters', JSON.stringify(characterNames));
</script>



