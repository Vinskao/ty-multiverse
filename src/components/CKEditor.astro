---
// å¾ç’°å¢ƒè®Šæ•¸ç²å– API åŸºç¤ URL
if (!import.meta.env.PUBLIC_TYMB_URL) {
  throw new Error('PUBLIC_TYMB_URL ç’°å¢ƒè®Šé‡æœªè¨­ç½®');
}
const hostUrl = import.meta.env.PUBLIC_TYMB_URL;

// ç²å– URL åƒæ•¸ä¾†æª¢æŸ¥ç™»å…¥ç‹€æ…‹
const url = new URL(Astro.request.url);
const username = url.searchParams.get('username');
const token = url.searchParams.get('token');
---

<!-- ç·¨è¼¯å™¨å®¹å™¨ - åŒ…å«å…©å±¤ï¼Œå¤–å±¤æ§åˆ¶æ•´é«”ä½ˆå±€ï¼Œå…§å±¤æ˜¯ CKEditor çš„æ›è¼‰é» -->
<div id="editor-container">
    <div id="editor"></div>
    <div id="login-prompt" style="text-align: center; margin-top: 10px; color: #ff9800; display: none;">
        è«‹å…ˆç™»å…¥å¾Œå†ç•™è¨€
    </div>

    <!-- ç™»å…¥é®ç½©å±¤ -->
    <div id="login-overlay" class="login-overlay">
        <div class="overlay-content">
            <div class="overlay-icon">ğŸ”’</div>
            <h3 class="overlay-title">è«‹ç™»å…¥ä»¥æŸ¥çœ‹ç•™è¨€</h3>
            <div class="overlay-buttons">
                <a href="/tymultiverse/login" class="btn-login" id="login-link">ç™»å…¥</a>
            </div>
        </div>
    </div>
</div>

<!-- ä¿å­˜ç‹€æ…‹æŒ‡ç¤ºå™¨ - é¡¯ç¤ºæ–‡æª”æ˜¯å¦å·²ä¿å­˜ -->
<div id="save-indicator" style="margin-top: 2px; font-size: 12px; font-weight: bold;"></div>

<!-- ç‹€æ…‹æç¤ºå€åŸŸ - é¡¯ç¤ºä¿å­˜ç‹€æ…‹å’ŒéŒ¯èª¤è¨Šæ¯ -->
<div id="editor-status" style="margin-top: 5px; font-size: 14px; color: #aaa;"></div>

<!-- å¼•å…¥å¤–éƒ¨åº« -->
<script is:inline src="https://cdn.ckeditor.com/ckeditor5/34.0.0/classic/ckeditor.js"></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- é¡å¤–å¼•å…¥å­—é«”å¤§å°å’Œé¡è‰²æ’ä»¶ -->
<script is:inline src="https://cdn.ckeditor.com/ckeditor5/34.0.0/classic/translations/zh.js"></script>

<!-- æ¨£å¼è¨­å®š -->
<style>
    /* å…¨å±€æš—è‰²ä¸»é¡Œ */
    :root {
        --ck-color-base-foreground: #2a2a2a !important;
        --ck-color-base-background: #333 !important;
        --ck-color-base-border: #444 !important;
        --ck-color-text: #e0e0e0 !important;
        --ck-color-focus-border: #666 !important;
        --ck-color-button-default-background: #333 !important;
        --ck-color-button-default-hover-background: #444 !important;
        --ck-color-button-on-background: #555 !important;
        --ck-color-button-on-hover-background: #666 !important;
    }
    
    body {
        background-color: #222;
        color: #e0e0e0;
    }

    /* æœªç™»å…¥æ™‚éš±è—å·¥å…·æ¬„å’Œç·¨è¼¯å€åŸŸ */
    .not-logged-in .ck.ck-toolbar {
        display: none !important;
    }

    .not-logged-in .ck.ck-editor__editable {
        pointer-events: none !important;
        opacity: 0.3 !important;
    }

    /* ç·¨è¼¯å™¨å®¹å™¨çš„æ¨£å¼ */
    #editor-container {
        width: 100%;
        margin: 15px 0 5px 0;
        position: relative;
        min-height: 200px; /* ç¢ºä¿æœ‰è¶³å¤ ç©ºé–“é¡¯ç¤ºé®ç½© */
    }
    
    /* è¶…å¼·åŠ›è¦†è“‹ */
    /* ç·¨è¼¯å™¨ä¸»å®¹å™¨ */
    .ck.ck-editor__main {
        background-color: #2a2a2a !important;
        color: #e0e0e0 !important;
    }

    /* ç·¨è¼¯å€åŸŸ - æœ€é—œéµçš„éƒ¨åˆ† */
    .ck-editor__editable_inline {
        background-color: #2a2a2a !important;
        color: #e0e0e0 !important;
        border-color: #444 !important;
    }

    .ck.ck-content, 
    .ck-editor__editable,
    .ck.ck-editor__editable,
    .ck.ck-editor__editable.ck-focused,
    .ck.ck-editor__editable_inline,
    .ck.ck-editor__editable_inline.ck-focused {
        background-color: #2a2a2a !important;
        color: #e0e0e0 !important;
        border-color: #444 !important;
    }

    /* å·¥å…·æ¬„å…¨è¦†è“‹ */
    .ck.ck-toolbar,
    .ck.ck-toolbar__items {
        background-color: #333 !important;
        border-color: #444 !important;
        color: #e0e0e0 !important;
    }

    /* æŒ‰éˆ•å…¨è¦†è“‹ */
    .ck.ck-button,
    .ck.ck-splitbutton .ck-splitbutton__action {
        background-color: #333 !important;
        color: #ccc !important;
        border-color: #444 !important;
    }

    .ck.ck-button:hover,
    .ck.ck-splitbutton .ck-splitbutton__action:hover {
        background-color: #444 !important;
        color: #fff !important;
    }

    .ck.ck-button.ck-on,
    .ck.ck-splitbutton.ck-splitbutton_open > .ck-splitbutton__action {
        background-color: #555 !important;
        color: #fff !important;
    }

    /* ä¸‹æ‹‰èœå–® */
    .ck.ck-dropdown__panel {
        background-color: #333 !important;
        border-color: #444 !important;
    }

    .ck.ck-dropdown__panel .ck-list__item {
        color: #ccc !important;
    }

    .ck.ck-dropdown__panel .ck-list__item:hover,
    .ck.ck-dropdown__panel .ck-list__item:focus {
        background-color: #444 !important;
    }
    
    .ck.ck-dropdown__panel .ck-list__item.ck-on {
        background-color: #555 !important;
    }

    /* ä¸‹æ‹‰ç®­é ­ */
    .ck.ck-dropdown .ck-dropdown__arrow {
        color: #ccc !important;
    }

    /* å½ˆå‡ºæ¡†å’Œå°è©±æ¡† */
    .ck.ck-balloon-panel {
        background-color: #333 !important;
        border-color: #444 !important;
    }
    
    .ck.ck-balloon-panel .ck-button {
        color: #ccc !important;
        background: #444 !important;
    }
    
    .ck.ck-balloon-panel .ck-button:hover {
        background-color: #555 !important;
    }
    
    /* ç·¨è¼¯å™¨ç‹€æ…‹æç¤ºçš„æ¨£å¼ */
    #editor-status {
        transition: opacity 0.5s ease-in-out;
        text-align: center; /* æ–‡å­—ç½®ä¸­ */
        margin-top: 5px;
        color: #aaa;
    }
    .success { color: #4caf50 !important; }
    .error { color: #ff5252 !important; }
    .loading { color: #999 !important; }
    .warning { color: #ffc107 !important; }

    /* ä¿å­˜ç‹€æ…‹æŒ‡ç¤ºå™¨æ¨£å¼ */
    #save-indicator {
        padding: 2px 8px;
        border-radius: 3px;
        display: block;
        text-align: center;
        width: 100px;
        margin: 0 auto;  /* ç§»é™¤ä¸Šé‚Šè·ï¼Œåªä¿ç•™æ°´å¹³ç½®ä¸­ */
    }
    #save-indicator.saved { background-color: #1e3b2a; color: #4caf50; }
    #save-indicator.unsaved { background-color: #3e3417; color: #ffc107; }

    /* æ·»åŠ ç™»å…¥æç¤ºçš„æ¨£å¼ */
    #login-prompt {
        background-color: rgba(255, 152, 0, 0.1);
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
    }

    /* ç™»å…¥é®ç½©å±¤æ¨£å¼ */
    .login-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(34, 34, 34, 0.95));
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999; /* æé«˜z-indexç¢ºä¿è¦†è“‹CKEditor */
        border-radius: 8px;
        opacity: 1;
        transition: opacity 0.3s ease;
    }

    .login-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .overlay-content {
        text-align: center;
        color: #e0e0e0;
        padding: 20px;
        max-width: 300px;
    }

    .overlay-icon {
        font-size: 36px;
        margin-bottom: 15px;
        opacity: 0.8;
    }

    .overlay-title {
        font-size: 18px;
        font-weight: bold;
        margin: 0 0 20px 0;
        color: #fff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .overlay-buttons {
        display: flex;
        justify-content: center;
    }

    .overlay-buttons a {
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        display: inline-block;
        text-align: center;
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        border-color: #2196f3;
    }

    .btn-login:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(33, 150, 243, 0.3);
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 480px) {
        .overlay-content {
            padding: 15px;
        }

        .overlay-title {
            font-size: 16px;
        }

        .overlay-buttons a {
            padding: 8px 16px;
            font-size: 13px;
        }
    }
</style>

<script define:vars={{ hostUrl, EDITOR_ID: '1', username, token }}>
    // ç¢ºä¿DOMè¼‰å…¥å¾Œå†åŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', () => {
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ - å¢åŠ æ›´å¤šçš„æª¢æŸ¥æ¢ä»¶
        const isLoggedIn = username || localStorage.getItem('username') || document.cookie.includes('refreshToken');
        const loginPrompt = document.getElementById('login-prompt');
        const loginOverlay = document.getElementById('login-overlay');
        const editorContainer = document.getElementById('editor-container');
        const saveIndicator = document.getElementById('save-indicator');

        // å¦‚æœæ²’æœ‰ç™»å…¥ï¼Œé¡¯ç¤ºé®ç½©å±¤ä¸¦ç¦ç”¨ç·¨è¼¯å™¨
        if (!isLoggedIn) {
            if (loginPrompt) loginPrompt.style.display = 'block';
            if (loginOverlay) loginOverlay.classList.remove('hidden');
            if (editorContainer) editorContainer.classList.add('not-logged-in');
            if (saveIndicator) saveIndicator.style.display = 'none';

            // è¨­ç½®ç™»å…¥é€£çµçš„redirectåƒæ•¸
            const loginLink = document.getElementById('login-link');
            if (loginLink) {
                const currentPath = window.location.pathname + window.location.search;
                loginLink.href = `/tymultiverse/login?redirect=${encodeURIComponent(currentPath)}`;
            }
        } else {
            if (loginPrompt) loginPrompt.style.display = 'none';
            if (loginOverlay) loginOverlay.classList.add('hidden');
        }
        
        // ç›´æ¥ä½¿ç”¨ Astro æä¾›çš„ hostUrl è®Šæ•¸
        const API_BASE_URL = hostUrl;
        
        // é…ç½® axios å¯¦ä¾‹
        const apiClient = axios.create({
            baseURL: API_BASE_URL,
            timeout: 10000,
            headers: { 'Content-Type': 'application/json' },
            auth: { username: 'admin', password: 'admin' }
        });
        
        // Base64 ä¸Šå‚³é©é…å™¨ - ç›´æ¥å°‡åœ–ç‰‡è½‰æ›ç‚º base64 è€Œä¸ä¸Šå‚³åˆ°æœå‹™å™¨
        class Base64UploadAdapter {
            constructor(loader) { this.loader = loader; }
            upload() {
                return this.loader.file
                    .then(file => new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.addEventListener('load', () => { resolve({ default: reader.result }); });
                        reader.addEventListener('error', err => { reject(err); });
                        reader.readAsDataURL(file);
                    }));
            }
            abort() { /* ä¸éœ€è¦å¯¦ç¾ */ }
        }
        function Base64UploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => new Base64UploadAdapter(loader);
        }
        
        // ç‹€æ…‹æç¤ºå‡½æ•¸
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('editor-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = type;
                statusEl.style.opacity = '1';
            }
            setTimeout(() => { if (statusEl) statusEl.style.opacity = '0'; }, 5000);
        }

        // å¾å¾Œç«¯ç²å–ç·¨è¼¯å™¨å…§å®¹
        async function fetchContent() {
            try {
                showStatus('æ­£åœ¨è¼‰å…¥å…§å®¹...', 'loading');
                const response = await apiClient.post('/ckeditor/get-content', { editor: EDITOR_ID });
                showStatus('å…§å®¹è¼‰å…¥æˆåŠŸ', 'success');
                return response.data.content || '';
            } catch (error) {
                console.error('ç²å–å…§å®¹å¤±æ•—:', error);
                if (error.response) showStatus(`ç²å–å…§å®¹å¤±æ•—: ä¼ºæœå™¨éŒ¯èª¤ ${error.response.status}`, 'error');
                else if (error.request) showStatus('ç²å–å…§å®¹å¤±æ•—: æœªæ”¶åˆ°ä¼ºæœå™¨éŸ¿æ‡‰', 'error');
                else showStatus(`ç²å–å…§å®¹å¤±æ•—: ${error.message}`, 'error');
                return localStorage.getItem('editorContent') || '';
            }
        }

        // æ›´æ–°å„²å­˜æŒ‡ç¤ºå™¨
        function updateSaveIndicator(isSaved) {
            const indicator = document.getElementById('save-indicator');
            if (!indicator) return;
            if (!isLoggedIn) { indicator.style.display = 'none'; return; }
            if (isSaved) { indicator.textContent = 'å·²å„²å­˜'; indicator.className = 'saved'; }
            else { indicator.textContent = 'æœªå„²å­˜'; indicator.className = 'unsaved'; }
        }

        // å„²å­˜å…§å®¹
        async function saveContent(content) {
            if (!isLoggedIn) { showStatus('è«‹å…ˆç™»å…¥å¾Œå†å„²å­˜', 'warning'); return false; }
            try {
                showStatus('æ­£åœ¨å„²å­˜...', 'loading');
                const response = await apiClient.post('/ckeditor/save-content', { editor: EDITOR_ID, content });
                const currentTime = new Date().toLocaleTimeString();
                showStatus(`å…§å®¹å·²å„²å­˜ (${currentTime})`, 'success');
                updateSaveIndicator(true);
                localStorage.setItem('editorContent', content);
                return true;
            } catch (error) {
                console.error('ä¿å­˜å…§å®¹å¤±æ•—:', error);
                if (error.response) {
                    if (error.response.status === 401) showStatus('å„²å­˜å¤±æ•—: æœªæˆæ¬Šè¨ªå•ã€‚åªå„²å­˜åˆ°æœ¬åœ°ï¼Œå¯å…ˆç™»å…¥å¾Œå†è©¦è©¦', 'warning');
                    else showStatus(`å„²å­˜å¤±æ•—: ä¼ºæœå™¨éŒ¯èª¤ ${error.response.status}ã€‚å·²å‚™ä»½åˆ°æœ¬åœ°`, 'error');
                } else if (error.request) showStatus('å„²å­˜å¤±æ•—: æœªæ”¶åˆ°ä¼ºæœå™¨éŸ¿æ‡‰ã€‚å·²å‚™ä»½åˆ°æœ¬åœ°', 'error');
                else showStatus(`å„²å­˜å¤±æ•—: ${error.message}ã€‚å·²å‚™ä»½åˆ°æœ¬åœ°`, 'error');
                localStorage.setItem('editorContent', content);
                return false;
            }
        }
        
        // åˆå§‹åŒ–ç·¨è¼¯å™¨
        const editorElement = document.getElementById('editor');
        if (!editorElement) return;
        
        ClassicEditor.create(editorElement, {
            extraPlugins: [Base64UploadAdapterPlugin],
            // å·¥å…·æ¬„é…ç½® - åªåœ¨ç™»å…¥æ™‚é¡¯ç¤º
            toolbar: isLoggedIn ? [
                'heading','|','fontSize','fontColor','fontBackgroundColor','|','bold','italic','link','bulletedList','numberedList','|','outdent','indent','|','blockQuote','insertTable','imageUpload','undo','redo'
            ] : [],
            // æœªç™»å…¥æ™‚ç§»é™¤æ‰€æœ‰æ’ä»¶
            removePlugins: isLoggedIn ? [] : ['toolbar','heading','fontSize','fontColor','fontBackgroundColor','bold','italic','link','bulletedList','numberedList','outdent','indent','blockQuote','insertTable','imageUpload','undo','redo'],
            // é…ç½®å­—é«”å¤§å°é¸é …
            fontSize: { options: ['tiny','small','default','big','huge'], supportAllValues: true },
            // é¡è‰²
            fontColor: { colors: [ { color: '#f44336', label: 'ç´…è‰²' }, { color: '#ff9800', label: 'æ©™è‰²' }, { color: '#ffeb3b', label: 'é»ƒè‰²' }, { color: '#4caf50', label: 'ç¶ è‰²' }, { color: '#2196f3', label: 'è—è‰²' }, { color: '#9c27b0', label: 'ç´«è‰²' }, { color: '#e0e0e0', label: 'ç™½è‰²' }, { color: '#bdbdbd', label: 'æ·ºç°' }, { color: '#757575', label: 'ç°è‰²' } ] },
            fontBackgroundColor: { colors: [ { color: '#f443361a', label: 'æ·¡ç´…' }, { color: '#ff98001a', label: 'æ·¡æ©™' }, { color: '#ffeb3b1a', label: 'æ·¡é»ƒ' }, { color: '#4caf501a', label: 'æ·¡ç¶ ' }, { color: '#2196f31a', label: 'æ·¡è—' }, { color: '#9c27b01a', label: 'æ·¡ç´«' }, { color: '#2a2a2a', label: 'èƒŒæ™¯è‰²' }, { color: '#3a3a3a', label: 'æ·ºæš—' }, { color: '#111111', label: 'æ·±æš—' } ] },
            image: { toolbar: ['imageTextAlternative','imageStyle:inline','imageStyle:block','imageStyle:side'] },
            ui: { viewportOffset: { top: 10, right: 10, bottom: 10, left: 10 } }
        }).then(async (editor) => {
            // ç¢ºä¿ CKEditor æ ¹å…ƒç´ åœ¨ #editor-container ä¸­
            try {
                const container = document.getElementById('editor-container');
                const editorRoot = (editor && editor.ui && editor.ui.view && editor.ui.view.element) || null;
                if (container && editorRoot && !container.contains(editorRoot)) {
                    container.appendChild(editorRoot);
                }
            } catch (_) {}

            // æ ¹æ“šç™»å…¥ç‹€æ…‹è¨­ç½®ç·¨è¼¯å™¨çš„å¯ç·¨è¼¯æ€§
            if (!isLoggedIn) {
                editor.enableReadOnlyMode('login-required');
            }
            
            // é¡å¤–æ·»åŠ å¼·åˆ¶æ‡‰ç”¨é»‘è‰²ä¸»é¡Œçš„ä»£ç¢¼
            try {
                // å¼·åˆ¶è¨­ç½®èƒŒæ™¯è‰²
                const editorMain = document.querySelector('.ck.ck-editor__main');
                if (editorMain) {
                    editorMain.style.backgroundColor = '#2a2a2a';
                    editorMain.style.color = '#e0e0e0';
                }
                const editorArea = document.querySelector('.ck.ck-editor__editable');
                if (editorArea) {
                    editorArea.style.backgroundColor = '#2a2a2a';
                    editorArea.style.color = '#e0e0e0';
                }
            } catch (e) {
                console.error('è¨­ç½®é»‘è‰²ä¸»é¡Œæ™‚å‡ºéŒ¯:', e);
            }
            
            // åˆå§‹åŒ–å…§å®¹
            const initialContent = await fetchContent();
            if (initialContent) {
                editor.setData(initialContent);
            }

            // ç›£è½å…§å®¹è®ŠåŒ–
            let saveTimeout;
            editor.model.document.on('change:data', () => {
                if (!isLoggedIn) {
                    showStatus('è«‹å…ˆç™»å…¥å¾Œå†ç·¨è¼¯', 'warning');
                    editor.setData(initialContent); // æ¢å¾©åŸå§‹å…§å®¹
                    return;
                }
                updateSaveIndicator(false);
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    const data = editor.getData();
                    saveContent(data);
                }, 2000);
            });
            
            // é›¢é–‹é é¢æ™‚å„²å­˜å…§å®¹
            window.addEventListener('beforeunload', (event) => {
                if (saveTimeout) {
                    const data = editor.getData();
                    localStorage.setItem('editorContent', data);
                    event.preventDefault();
                    event.returnValue = 'æœ‰æœªå„²å­˜çš„æ›´æ”¹ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
                }
            });
            
            updateSaveIndicator(true);
            showStatus('ç·¨è¼¯å™¨æº–å‚™å°±ç·’', 'success');
        }).catch(error => {
            console.error('ç·¨è¼¯å™¨åˆå§‹åŒ–å¤±æ•—:', error);
            showStatus(`ç·¨è¼¯å™¨åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
            
            // å¦‚æœæ²’æœ‰ç·¨è¼¯å™¨å®¹å™¨ï¼Œå‰‡è¿”å›
            const editorContainer = document.getElementById('editor-container');
            if (!editorContainer) return;
            
            // å¦‚æœæ²’æœ‰ç·¨è¼¯å™¨ï¼Œå‰‡é¡¯ç¤ºå‚™ç”¨ç·¨è¼¯å™¨
            const storedContent = localStorage.getItem('editorContent') || '';
            editorContainer.innerHTML = `
                <textarea id="fallback-editor" style="width: 100%; min-height: 300px; padding: 10px; color: #e0e0e0; background-color: #2a2a2a; border: 1px solid #444;">${storedContent}</textarea>
                <button id="save-fallback" style="margin-top: 10px; padding: 5px 10px; background-color: #333; color: #e0e0e0; border: 1px solid #555;">å„²å­˜å…§å®¹</button>
            `;
            
            // å„²å­˜æŒ‰éˆ•
            const saveButton = document.getElementById('save-fallback');
            if (saveButton) {
                saveButton.addEventListener('click', () => {
                    const textArea = document.getElementById('fallback-editor');
                    if (textArea instanceof HTMLTextAreaElement) {
                        const content = textArea.value;
                        localStorage.setItem('editorContent', content);
                        saveContent(content);
                    }
                });
            }
        });
    });
</script>