---
// API æ¸¬è©¦çµ„ä»¶
---

<div id="api-test" style="
  position: fixed;
  top: 20px;
  left: 20px;
  background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 20px;
  border-radius: 10px;
  font-size: 12px;
  z-index: 1000;
  max-width: 400px;
  max-height: 300px;
  overflow-y: auto;
">
  <h3>ğŸ”§ API æ¸¬è©¦</h3>
  <div id="test-results">è¼‰å…¥ä¸­...</div>
  <button id="test-api-btn" style="
    margin-top: 10px;
    padding: 8px 16px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  ">æ¸¬è©¦ API</button>
</div>

<script>
  async function testAPI() {
    const resultsDiv = document.getElementById('test-results');
    if (!resultsDiv) return;
    
    resultsDiv.innerHTML = '<div>ğŸ”„ æ¸¬è©¦ä¸­...</div>';
    
    try {
      // æª¢æŸ¥ç’°å¢ƒè®Šé‡
      const baseUrl = import.meta.env.PUBLIC_TYMB_URL;
      console.log('ğŸŒ ç’°å¢ƒè®Šé‡ PUBLIC_TYMB_URL:', baseUrl);
      
      if (!baseUrl) {
        resultsDiv.innerHTML = '<div style="color: #ff4757;">âŒ PUBLIC_TYMB_URL æœªè¨­ç½®</div>';
        return;
      }
      
      resultsDiv.innerHTML = `
        <div style="color: #2ed573;">âœ… ç’°å¢ƒè®Šé‡: ${baseUrl}</div>
        <div>ğŸ”„ æ¸¬è©¦ API èª¿ç”¨...</div>
      `;
      
      // æ¸¬è©¦ API èª¿ç”¨
      const token = localStorage.getItem('token');
      const headers = {
        "Content-Type": "application/json",
        "Accept": "application/json"
      };
      
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      console.log('ğŸ“¤ ç™¼é€æ¸¬è©¦è«‹æ±‚åˆ°:', `${baseUrl}/people/get-all`);
      console.log('ğŸ“‹ è«‹æ±‚é ­:', headers);
      
      const response = await fetch(`${baseUrl}/people/get-all`, {
        method: "POST",
        headers,
        credentials: 'include'
      });
      
      console.log('ğŸ“¡ æ¸¬è©¦éŸ¿æ‡‰:', response.status, response.statusText);
      
      if (!response.ok) {
        const errorText = await response.text();
        resultsDiv.innerHTML = `
          <div style="color: #ff4757;">âŒ API éŒ¯èª¤: ${response.status}</div>
          <div style="font-size: 10px; color: #ddd;">${errorText}</div>
        `;
        return;
      }
      
      const data = await response.json();
      console.log('ğŸ“¥ æ¸¬è©¦æ•¸æ“š:', data);
      
      if (data.status === 'processing' || data.requestId) {
        resultsDiv.innerHTML = `
          <div style="color: #2ed573;">âœ… API æ­£å¸¸ï¼Œæ”¶åˆ° RequestId</div>
          <div style="font-size: 10px; color: #ddd;">RequestId: ${data.requestId}</div>
          <div>ğŸ”„ é–‹å§‹è¼ªè©¢æ¸¬è©¦...</div>
        `;
        
        // æ¸¬è©¦è¼ªè©¢
        await testPolling(data.requestId, baseUrl, resultsDiv);
      } else if (Array.isArray(data)) {
        resultsDiv.innerHTML = `
          <div style="color: #2ed573;">âœ… API æ­£å¸¸ï¼Œç›´æ¥è¿”å›æ•¸æ“š</div>
          <div style="font-size: 10px; color: #ddd;">è§’è‰²æ•¸é‡: ${data.length}</div>
        `;
      } else {
        resultsDiv.innerHTML = `
          <div style="color: #ffa502;">âš ï¸ æœªçŸ¥éŸ¿æ‡‰æ ¼å¼</div>
          <div style="font-size: 10px; color: #ddd;">${JSON.stringify(data, null, 2)}</div>
        `;
      }
      
    } catch (error) {
      console.error('âŒ API æ¸¬è©¦å¤±æ•—:', error);
      resultsDiv.innerHTML = `
        <div style="color: #ff4757;">âŒ æ¸¬è©¦å¤±æ•—</div>
        <div style="font-size: 10px; color: #ddd;">${error.message}</div>
      `;
    }
  }
  
  async function testPolling(requestId, baseUrl, resultsDiv) {
    try {
      for (let attempt = 1; attempt <= 5; attempt++) {
        resultsDiv.innerHTML += `<div>ğŸ”„ è¼ªè©¢å˜—è©¦ ${attempt}/5...</div>`;
        
        // æª¢æŸ¥çµæœæ˜¯å¦å­˜åœ¨
        const existsResponse = await fetch(`${baseUrl}/people/result/${requestId}/exists`, {
          credentials: 'include'
        });
        
        if (existsResponse.ok) {
          const existsData = await existsResponse.json();
          
          if (existsData.exists) {
            // ç²å–çµæœ
            const resultResponse = await fetch(`${baseUrl}/people/result/${requestId}`, {
              credentials: 'include'
            });
            
            if (resultResponse.ok) {
              const result = await resultResponse.json();
              resultsDiv.innerHTML += `
                <div style="color: #2ed573;">âœ… è¼ªè©¢æˆåŠŸï¼</div>
                <div style="font-size: 10px; color: #ddd;">è§’è‰²æ•¸é‡: ${(result.data || result).length}</div>
              `;
              return;
            }
          }
        }
        
        // ç­‰å¾… 1 ç§’
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      resultsDiv.innerHTML += `<div style="color: #ff4757;">âŒ è¼ªè©¢è¶…æ™‚</div>`;
      
    } catch (error) {
      resultsDiv.innerHTML += `<div style="color: #ff4757;">âŒ è¼ªè©¢å¤±æ•—: ${error.message}</div>`;
    }
  }
  
  // æ¸¬è©¦å‚·å®³è¨ˆç®— API
  async function testDamageAPI() {
    const resultsDiv = document.getElementById('test-results');
    if (!resultsDiv) return;
    
    resultsDiv.innerHTML += '<div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 10px;">';
    resultsDiv.innerHTML += '<h4>ğŸ—¡ï¸ å‚·å®³è¨ˆç®—æ¸¬è©¦</h4>';
    
    try {
      const baseUrl = import.meta.env.PUBLIC_TYMB_URL;
      if (!baseUrl) {
        resultsDiv.innerHTML += '<div style="color: #ff4757;">âŒ ç’°å¢ƒè®Šé‡æœªè¨­ç½®</div>';
        return;
      }
      
      // æ¸¬è©¦å‚·å®³è¨ˆç®— API
      const testCharacter = 'Wavo';
      const response = await fetch(`${baseUrl}/people/damageWithWeapon?name=${testCharacter}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        credentials: 'include'
      });
      
      if (!response.ok) {
        resultsDiv.innerHTML += `<div style="color: #ff4757;">âŒ å‚·å®³è¨ˆç®— API éŒ¯èª¤: ${response.status}</div>`;
        return;
      }
      
      const data = await response.json();
      resultsDiv.innerHTML += `<div style="color: #2ed573;">âœ… å‚·å®³è¨ˆç®— API æ­£å¸¸</div>`;
      resultsDiv.innerHTML += `<div style="font-size: 10px; color: #ddd;">éŸ¿æ‡‰: ${JSON.stringify(data)}</div>`;
      
      if (data.status === 'processing' && data.requestId) {
        resultsDiv.innerHTML += `<div>ğŸ”„ é–‹å§‹è¼ªè©¢å‚·å®³çµæœ...</div>`;
        
        // æ¸¬è©¦å‚·å®³è¼ªè©¢
        for (let attempt = 1; attempt <= 5; attempt++) {
          resultsDiv.innerHTML += `<div>ğŸ”„ å‚·å®³è¼ªè©¢å˜—è©¦ ${attempt}/5...</div>`;
          
          const existsResponse = await fetch(`${baseUrl}/people/result/${data.requestId}/exists`, {
            credentials: 'include'
          });
          
          if (existsResponse.ok) {
            const existsData = await existsResponse.json();
            
            if (existsData.exists) {
              const resultResponse = await fetch(`${baseUrl}/people/result/${data.requestId}`, {
                credentials: 'include'
              });
              
              if (resultResponse.ok) {
                const result = await resultResponse.json();
                resultsDiv.innerHTML += `<div style="color: #2ed573;">âœ… å‚·å®³è¨ˆç®—æˆåŠŸï¼</div>`;
                resultsDiv.innerHTML += `<div style="font-size: 10px; color: #ddd;">çµæœ: ${JSON.stringify(result)}</div>`;
                return;
              }
            }
          }
          
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        resultsDiv.innerHTML += `<div style="color: #ff4757;">âŒ å‚·å®³è¨ˆç®—è¼ªè©¢è¶…æ™‚</div>`;
      }
      
    } catch (error) {
      resultsDiv.innerHTML += `<div style="color: #ff4757;">âŒ å‚·å®³è¨ˆç®—æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
    }
  }

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    const testBtn = document.getElementById('test-api-btn');
    if (testBtn) {
      testBtn.addEventListener('click', async () => {
        await testAPI();
        await testDamageAPI();
      });
    }
    
    // è‡ªå‹•é‹è¡Œä¸€æ¬¡æ¸¬è©¦
    setTimeout(async () => {
      await testAPI();
      await testDamageAPI();
    }, 1000);
  });
</script>
