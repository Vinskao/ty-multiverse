---
import '../styles/levellist.css';

// 檢查登入狀態
const url = new URL(Astro.request.url);
const username = url.searchParams.get('username');
const token = url.searchParams.get('token');

// 如果未登入，重定向到首頁
if (!username || !token) {
  return Astro.redirect('/tymultiverse/');
}
---

<div id="level-container"></div>

<script>
  import { applyWeaponDamage } from "../scripts/weapon";
  
  const TYMB_URL = import.meta.env.PUBLIC_TYMB_URL;
  const PEOPLE_IMAGE_URL = import.meta.env.PUBLIC_PEOPLE_IMAGE_URL;
  
  // 定義基本戰力等級
  const BASE_POWER_LEVELS = [
    { name: "Level S", min: 2600, max: 3599, color: "#FFD700" },
    { name: "Level A", min: 1600, max: 2599, color: "#00FF00" },
    { name: "Level B", min: 900, max: 1599, color: "#00FFFF" },
    { name: "Level C", min: 400, max: 899, color: "#0000FF" },
    { name: "Level D", min: 50, max: 399, color: "#800080" },
    { name: "Level F", min: 0, max: 49, color: "#808080" }
  ];

  // 定義軍隊顏色映射
  const ARMY_COLORS = {
    "八食": "#46A3FF",      
    "初桑": "#FFA500",      
    "Buse": "#AD5A5A",      
    "Phénix": "#FFFF00",    
    "姦閥": "#808080",      
    "姦囚": "#FFC0CB",      
    "Regalos": "#00FF00",   
    "天際女孩": "#00BFFF",  
    "外界": "#000080",      
    "王": "#FF0000",        
    "Intouchable": "#8B4513",
    "塵民": "#008080",      
    "獄族": "#800080",      
    "Default": "#FFFFFF"    
  };

  // 刷新 token 的函數
  async function refreshToken() {
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const refreshToken = urlParams.get('refresh_token');
      
      if (!refreshToken) {
        console.error('No refresh token available');
        window.location.href = '/tymultiverse/login';
        return false;
      }

      const response = await fetch(`${TYMB_URL}/keycloak/refresh`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({ refresh_token: refreshToken }),
        credentials: 'include'
      });

      if (!response.ok) {
        console.error('Token refresh failed:', response.status);
        window.location.href = '/tymultiverse/login';
        return false;
      }

      const data = await response.json();
      if (data.token) {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('token', data.token);
        if (data.refresh_token) {
          currentUrl.searchParams.set('refresh_token', data.refresh_token);
        }
        window.history.replaceState({}, '', currentUrl.toString());
        return true;
      }
      return false;
    } catch (error) {
      console.error('Error refreshing token:', error);
      window.location.href = '/tymultiverse/login';
      return false;
    }
  }

  // 驗證 token 是否有效
  async function verifyToken(token) {
    try {
      const response = await fetch(`${TYMB_URL}/keycloak/introspect?token=${token}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
        },
        credentials: 'include'
      });

      if (response.ok) {
        const data = await response.json();
        return data.active;
      }
      return false;
    } catch (error) {
      console.error('Token verification failed:', error);
      return false;
    }
  }

  // 獲取有效的 token
  async function getValidToken() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
      console.error('No token available');
      window.location.href = '/tymultiverse/login';
      return null;
    }

    const isValid = await verifyToken(token);
    if (isValid) {
      return token;
    }

    const refreshed = await refreshToken();
    if (!refreshed) {
      return null;
    }

    const newUrlParams = new URLSearchParams(window.location.search);
    return newUrlParams.get('token');
  }

  // 檢查圖片是否存在
  async function checkImageExists(imagePath) {
    try {
      const response = await fetch(imagePath);
      return response.ok;
    } catch {
      return false;
    }
  }

  // 創建角色卡片
  function createCharacterCard(character, levelColor) {
    const characterContainer = document.createElement('div');
    characterContainer.style.cssText = 'display:inline-block;width:200px;height:300px;text-align:center;margin-left:-100px;position:relative;z-index:1;';

    const img = document.createElement('img');
    img.style.cssText = 'width:200px;height:300px;display:block;object-fit:contain;margin:0 auto;padding:0;border:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2;transition:opacity 0.5s ease-in-out;';
    img.src = `${PEOPLE_IMAGE_URL}/${character.name || 'default'}.png`;
    img.alt = character.nameOriginal;
    img.onerror = function() {
      this.src = `${PEOPLE_IMAGE_URL}/default.png`;
    };

    // 檢查戰鬥圖片
    checkImageExists(`${PEOPLE_IMAGE_URL}/${character.name || 'default'}Fighting.png`).then(hasFightingImage => {
      if (hasFightingImage) {
        const fightingImg = document.createElement('img');
        fightingImg.style.cssText = img.style.cssText + 'opacity:0;';
        fightingImg.src = `${PEOPLE_IMAGE_URL}/${character.name || 'default'}Fighting.png`;
        fightingImg.alt = `${character.nameOriginal} Fighting`;
        characterContainer.appendChild(fightingImg);

        let isRegularImage = true;
        setInterval(() => {
          img.style.opacity = isRegularImage ? '0' : '1';
          fightingImg.style.opacity = isRegularImage ? '1' : '0';
          isRegularImage = !isRegularImage;
        }, 2000);
      }
    });

    // 添加懸停事件
    img.addEventListener('mouseover', () => {
      (img as HTMLImageElement).style.zIndex = '3';
      if (img.nextElementSibling?.tagName === 'IMG') {
        (img.nextElementSibling as HTMLImageElement).style.zIndex = '3';
      }
    });
    img.addEventListener('mouseout', () => {
      (img as HTMLImageElement).style.zIndex = '2';
      if (img.nextElementSibling?.tagName === 'IMG') {
        (img.nextElementSibling as HTMLImageElement).style.zIndex = '2';
      }
    });

    // 創建信息容器
    const infoContainer = document.createElement('div');
    infoContainer.style.cssText = 'padding:5px;color:#fff;text-shadow:0 0 2px rgba(0,0,0,0.5);width:200px;position:absolute;bottom:-40px;left:0;overflow:hidden;font-size:12px;z-index:4;background-color:transparent;border-radius:5px;';

    // 添加名稱
    const nameText = document.createElement('p');
    nameText.textContent = character.nameOriginal;
    nameText.style.cssText = 'margin:0;font-weight:bold;font-size:clamp(12px,1.2vw,14px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
    const armyName = character.armyName || "Default";
    nameText.style.color = ARMY_COLORS[armyName] || ARMY_COLORS["Default"];
    nameText.style.textShadow = '0 0 2px rgba(0,0,0,0.5)';

    // 添加屬性
    const attributesText = document.createElement('p');
    attributesText.textContent = `Attributes: ${character.attributes}`;
    attributesText.style.cssText = 'margin:0;font-size:clamp(6px,0.8vw,8px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
    if (character.hasBonus) {
      const bonusBadge = document.createElement('span');
      bonusBadge.textContent = '⚔️';
      bonusBadge.style.cssText = 'margin-left:5px;font-size:clamp(6px,0.8vw,8px);';
      attributesText.appendChild(bonusBadge);
    }

    // 添加戰力
    const powerText = document.createElement('p');
    powerText.textContent = `Total Power: ${character.totalPower}`;
    powerText.style.cssText = 'margin:0;font-size:clamp(12px,0.8vw,14px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
    powerText.style.color = levelColor;

    infoContainer.appendChild(nameText);
    infoContainer.appendChild(attributesText);
    infoContainer.appendChild(powerText);
    characterContainer.appendChild(img);
    characterContainer.appendChild(infoContainer);
    return characterContainer;
  }

  // 創建等級容器
  function createLevelContainer(level, characters) {
    const levelContainer = document.createElement('div');
    levelContainer.className = 'level-container';
    levelContainer.style.marginTop = '50px';
    levelContainer.style.borderColor = level.color;

    const levelTitle = document.createElement('h2');
    levelTitle.className = 'level-title';
    levelTitle.textContent = level.name;
    levelTitle.style.marginBottom = '15px';
    levelTitle.style.color = level.color;

    const levelBadge = document.createElement('div');
    levelBadge.className = 'level-badge';
    levelBadge.style.backgroundColor = level.color;
    levelBadge.style.width = '100%';
    levelBadge.style.textAlign = 'center';
    levelBadge.textContent = `戰力: ${level.min} - ${level.max}`;
    levelBadge.style.color = level.color.includes('rgb') ? '#FFFFFF' : 
      (parseInt(level.color.substr(1, 2), 16) * 299 + 
       parseInt(level.color.substr(3, 2), 16) * 587 + 
       parseInt(level.color.substr(5, 2), 16) * 114) / 1000 > 128 ? '#000000' : '#FFFFFF';

    const charactersGrid = document.createElement('div');
    charactersGrid.className = 'box-container';
    charactersGrid.style.margin = '0 auto';

    characters.forEach(character => {
      charactersGrid.appendChild(createCharacterCard(character, level.color));
    });

    levelContainer.appendChild(levelTitle);
    levelContainer.appendChild(levelBadge);
    levelContainer.appendChild(charactersGrid);
    return levelContainer;
  }

  // 主函數
  document.addEventListener("DOMContentLoaded", async function () {
    try {
      const token = await getValidToken();
      if (!token) return;

      const response = await fetch(`${TYMB_URL}/people/get-all`, {
        method: "POST", 
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
          "Accept": "application/json"
        },
        credentials: 'include'
      });
      
      if (!response.ok) throw new Error('Failed to fetch character list');
      
      const data = await response.json();
      
      // 計算每個角色的總戰力並獲取武器資訊
      const charactersWithPower = await Promise.all(
        data.map(async (character) => {
          try {
            const weaponName = character.name?.toLowerCase() || '';
            const weaponResponse = await fetch(`${TYMB_URL}/weapons/${weaponName}`, {
              method: "GET",
              headers: { 
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
                "Accept": "application/json"
              },
              credentials: 'include'
            });

            let totalUtilityPower = parseInt(String(character.utilityPower || 0), 10);
            let hasBonus = false;
            
            if (weaponResponse.ok) {
              const weaponData = await weaponResponse.json();
              const { character: updatedCharacter, hasBonus: bonusApplied } = applyWeaponDamage(character, weaponData);
              totalUtilityPower = updatedCharacter.utilityPower;
              hasBonus = bonusApplied;
            }

            const physicPower = parseInt(String(character?.physicPower || 0), 10);
            const magicPower = parseInt(String(character?.magicPower || 0), 10);
            const totalPower = physicPower + magicPower + totalUtilityPower;

            return {
              ...character,
              totalPower,
              physicPower,
              magicPower,
              utilityPower: totalUtilityPower,
              hasBonus
            };
          } catch (error) {
            console.error(`Error fetching weapon info for ${character.name}:`, error);
            return {
              ...character,
              totalPower: parseInt(String(character.physicPower || 0), 10) + 
                          parseInt(String(character.magicPower || 0), 10) + 
                          parseInt(String(character.utilityPower || 0), 10),
              physicPower: parseInt(String(character.physicPower || 0), 10),
              magicPower: parseInt(String(character.magicPower || 0), 10),
              utilityPower: parseInt(String(character.utilityPower || 0), 10),
              hasBonus: false
            };
          }
        })
      );

      // 過濾掉戰力為0的角色和沒有圖片的角色
      const validCharacters = await Promise.all(
        charactersWithPower.filter(char => char.totalPower > 0).map(async (character) => {
          const imagePath = `${PEOPLE_IMAGE_URL}/${character.name || 'default'}.png`;
          const hasImage = await checkImageExists(imagePath);
          return hasImage ? character : null;
        })
      );
      
      const filteredCharacters = validCharacters.filter(char => char !== null);
      filteredCharacters.sort((a, b) => b.totalPower - a.totalPower);

      // 動態生成SS及以上等級
      const POWER_LEVELS = [...BASE_POWER_LEVELS];
      const maxPower = filteredCharacters.length > 0 ? filteredCharacters[0].totalPower : 0;
      let currentMin = 3600;
      let levelIndex = 1;
      let multiplier = 1.0;
      
      while (currentMin <= maxPower) {
        multiplier *= 1.2;
        const levelSize = Math.floor(1000 * multiplier);
        const levelMax = currentMin + levelSize - 1;
        const levelName = "Level " + "S".repeat(levelIndex + 1);
        const redValue = Math.max(50, 255 - (levelIndex * 20));
        const color = `rgb(${redValue}, 0, 0)`;
        
        POWER_LEVELS.unshift({
          name: levelName,
          min: currentMin,
          max: levelMax,
          color: color
        });
        
        currentMin = levelMax + 1;
        levelIndex++;
      }

      // 將角色分配到各個等級
      const levelGroups = {};
      POWER_LEVELS.forEach(level => {
        levelGroups[level.name] = [];
      });

      filteredCharacters.forEach(character => {
        for (let i = 0; i < POWER_LEVELS.length; i++) {
          if (character.totalPower >= POWER_LEVELS[i].min && character.totalPower <= POWER_LEVELS[i].max) {
            levelGroups[POWER_LEVELS[i].name].push(character);
            break;
          }
        }
      });

      // 創建 UI
      const mainContainer = document.createElement('div');
      mainContainer.className = 'level-groups';

      // 從低到高顯示等級，跳過沒有角色的等級
      POWER_LEVELS.reverse().forEach(level => {
        const characters = levelGroups[level.name];
        if (characters.length === 0) return;
        mainContainer.appendChild(createLevelContainer(level, characters));
      });

      const container = document.getElementById('level-container');
      if (container) {
        container.appendChild(mainContainer);
      }
    } catch (error) {
      console.error('Error:', error);
    }
  });
</script>
