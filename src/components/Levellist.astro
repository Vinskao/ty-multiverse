---
import '../styles/levellist.css';
---

<div id="power-list-container">
  <h2>åŠ›è¡¨</h2>
  
  <!-- åŒæ­¥å…¨éƒ¨æŒ‰éˆ• -->
  <div style="margin-bottom: 30px; text-align: center;">
    <button id="sync-all-btn" style="
      padding: 8px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      min-width: 140px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin-right: 15px;
    ">
      <span>åŒæ­¥å…¨éƒ¨</span>
      <div style="
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
      "></div>
    </button>
    
    <button id="export-btn" style="
      padding: 8px 20px;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.35);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      min-width: 140px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    ">
      <span>åŒ¯å‡ºè¡¨æ ¼</span>
      <div style="
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
      "></div>
    </button>
  </div>
  
  <!-- æˆ°åŠ›çµ±è¨ˆ -->
  <div id="power-stats" style="
    margin-bottom: 20px;
    padding: 15px;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  ">
    <h3 style="
      margin: 0 0 15px 0;
      text-align: center;
      color: var(--text-primary);
      font-size: 18px;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    ">é™£ç‡Ÿæˆ°åŠ›çµ±è¨ˆ</h3>
    <div style="
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
    ">
      <div class="faction-stat" style="
        text-align: center;
        padding: 12px 20px;
        background: linear-gradient(135deg, rgba(255, 182, 193, 0.2) 0%, rgba(255, 182, 193, 0.1) 100%);
        border-radius: 8px;
        border: 1px solid rgba(255, 182, 193, 0.3);
        min-width: 150px;
      ">
        <div style="
          font-size: 14px;
          font-weight: 600;
          color: #FF69B4;
          margin-bottom: 5px;
          text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        ">Lily Palais</div>
        <div id="lily-palais-total" style="
          font-size: 20px;
          font-weight: bold;
          color: #FF1493;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        ">è¨ˆç®—ä¸­...</div>
        <div id="lily-palais-count" style="
          font-size: 12px;
          color: var(--text-secondary);
          margin-top: 3px;
        ">æˆ°å£«æ•¸: 0</div>
      </div>
      
      <div class="faction-stat" style="
        text-align: center;
        padding: 12px 20px;
        background: linear-gradient(135deg, rgba(255, 255, 224, 0.2) 0%, rgba(255, 255, 224, 0.1) 100%);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 224, 0.3);
        min-width: 150px;
      ">
        <div style="
          font-size: 14px;
          font-weight: 600;
          color: #FFD700;
          margin-bottom: 5px;
          text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        ">Libertad</div>
        <div id="libertad-total" style="
          font-size: 20px;
          font-weight: bold;
          color: #FFA500;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        ">è¨ˆç®—ä¸­...</div>
        <div id="libertad-count" style="
          font-size: 12px;
          color: var(--text-secondary);
          margin-top: 3px;
        ">æˆ°å£«æ•¸: 0</div>
      </div>
      
      <div class="faction-stat" style="
        text-align: center;
        padding: 12px 20px;
        background: linear-gradient(135deg, rgba(144, 238, 144, 0.2) 0%, rgba(144, 238, 144, 0.1) 100%);
        border-radius: 8px;
        border: 1px solid rgba(144, 238, 144, 0.3);
        min-width: 150px;
      ">
        <div style="
          font-size: 14px;
          font-weight: 600;
          color: #32CD32;
          margin-bottom: 5px;
          text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        ">Jardin des Dieux</div>
        <div id="jardin-total" style="
          font-size: 20px;
          font-weight: bold;
          color: #228B22;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        ">è¨ˆç®—ä¸­...</div>
        <div id="jardin-count" style="
          font-size: 12px;
          color: var(--text-secondary);
          margin-top: 3px;
        ">æˆ°å£«æ•¸: 0</div>
      </div>
    </div>
  </div>
  
  <div id="power-list"></div>
</div>

<div id="level-container"></div>

<!-- å¼•å…¥ SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- å¼•å…¥ SheetJS ç”¨æ–¼ xlsx åŒ¯å‡º -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // æª¢æŸ¥ç’°å¢ƒè®Šé‡
  if (!import.meta.env.PUBLIC_TYMB_URL) {
    throw new Error('PUBLIC_TYMB_URL ç’°å¢ƒè®Šé‡æœªè¨­ç½®');
  }
  if (!import.meta.env.PUBLIC_PEOPLE_IMAGE_URL) {
    throw new Error('PUBLIC_PEOPLE_IMAGE_URL ç’°å¢ƒè®Šé‡æœªè¨­ç½®');
  }
  
  // no longer require weapon calculation helper here
  
  const TYMB_URL = import.meta.env.PUBLIC_TYMB_URL;
  const PEOPLE_IMAGE_URL = import.meta.env.PUBLIC_PEOPLE_IMAGE_URL;
  
  // å®šç¾©åŸºæœ¬æˆ°åŠ›ç­‰ç´š
  const BASE_POWER_LEVELS = [
    { name: "Level S", min: 2600, max: 3599, color: "#FFD700" },
    { name: "Level A", min: 1600, max: 2599, color: "#00FF00" },
    { name: "Level B", min: 900, max: 1599, color: "#00FFFF" },
    { name: "Level C", min: 400, max: 899, color: "#0000FF" },
    { name: "Level D", min: 50, max: 399, color: "#800080" },
    { name: "Level F", min: 0, max: 49, color: "#808080" }
  ];

  // å®šç¾©è»éšŠé¡è‰²æ˜ å°„
  const ARMY_COLORS = {
    "å…«é£Ÿ": "#46A3FF",      
    "åˆæ¡‘": "#FFA500",      
    "Buse": "#AD5A5A",      
    "PhÃ©nix": "#FFFF00",    
    "å§¦é–¥": "#808080",      
    "å§¦å›š": "#FFC0CB",      
    "Regalos": "#00FF00",   
    "å¤©éš›å¥³å­©": "#00BFFF",  
    "å¤–ç•Œ": "#000080",      
    "ç‹": "#FF0000",        
    "Intouchable": "#8B4513",
    "å¡µæ°‘": "#008080",      
    "ç„æ—": "#800080",      
    "Default": "#FFFFFF"    
  };

  // é¡¯ç¤ºæç¤ºè¨Šæ¯çš„å‡½æ•¸
  function showAlert(title, icon = 'success', timer = 1000) {
    // æª¢æŸ¥ SweetAlert2 æ˜¯å¦å·²è¼‰å…¥
    if (typeof (window as any).Swal !== 'undefined') {
      (window as any).Swal.fire({
        title: title,
        icon: icon,
        timer: timer,
        showConfirmButton: false
      });
    } else {
      // å¦‚æœ SweetAlert2 æœªè¼‰å…¥ï¼Œä½¿ç”¨åŸç”Ÿ alert
      alert(title);
    }
  }

  // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦å­˜åœ¨ - æ·»åŠ ç·©å­˜å’Œæ›´å¥½çš„éŒ¯èª¤è™•ç†
  const imageCache = new Map();
  
  async function checkImageExists(imagePath) {
    // æª¢æŸ¥ç·©å­˜
    if (imageCache.has(imagePath)) {
      return imageCache.get(imagePath);
    }
    
    try {
      const response = await fetch(imagePath, { 
        method: 'HEAD', // åªæª¢æŸ¥é ­éƒ¨ï¼Œä¸ä¸‹è¼‰åœ–ç‰‡
        cache: 'no-cache' // é¿å…ç€è¦½å™¨ç·©å­˜
      });
      const exists = response.ok;
      imageCache.set(imagePath, exists);
      return exists;
    } catch {
      imageCache.set(imagePath, false);
      return false;
    }
  }

  // å‰µå»ºè§’è‰²å¡ç‰‡
  function createCharacterCard(character, levelColor) {
    const characterContainer = document.createElement('div');
    // ä½¿ç”¨ CSS é¡åˆ¥ï¼Œä¸éœ€è¦å…§è¯æ¨£å¼
    characterContainer.className = 'character-card';

    const img = document.createElement('img');
    img.src = `${PEOPLE_IMAGE_URL}/${character.name || 'default'}.png`;
    img.alt = character.nameOriginal;
    img.onerror = function() {
      this.src = `${PEOPLE_IMAGE_URL}/default.png`;
    };

    // åœ–ç‰‡åŠ è¼‰å®Œæˆå¾Œè¨­ç½®å®¹å™¨å¯¬åº¦
    img.onload = function() {
      const imgElement = this as HTMLImageElement;
      const aspectRatio = imgElement.naturalWidth / imgElement.naturalHeight;
      // æ ¹æ“šè¢å¹•å°ºå¯¸æ±ºå®šé«˜åº¦
      let targetHeight = 300; // æ¡Œé¢ç‰ˆ
      if (window.innerWidth <= 480) {
        targetHeight = 200; // å°è¢å¹•
      } else if (window.innerWidth <= 768) {
        targetHeight = 250; // æ‰‹æ©Ÿç‰ˆ
      }
      const containerWidth = targetHeight * aspectRatio;
      characterContainer.style.width = `${containerWidth}px`;
    };

    // æª¢æŸ¥æˆ°é¬¥åœ–ç‰‡å’Œæ¯€å£åœ–ç‰‡
    Promise.all([
      checkImageExists(`${PEOPLE_IMAGE_URL}/${character.name || 'default'}Fighting.png`),
      checkImageExists(`${PEOPLE_IMAGE_URL}/${character.name || 'default'}Ruined.png`)
    ]).then(([hasFightingImage, hasRuinedImage]) => {
      const images = [img];
      let currentImageIndex = 0;
      
      if (hasFightingImage) {
        const fightingImg = document.createElement('img');
        fightingImg.src = `${PEOPLE_IMAGE_URL}/${character.name || 'default'}Fighting.png`;
        fightingImg.alt = `${character.nameOriginal} Fighting`;
        fightingImg.style.opacity = '0';
        
        // æˆ°é¬¥åœ–ç‰‡åŠ è¼‰å®Œæˆå¾Œä¹Ÿè¨­ç½®å®¹å™¨å¯¬åº¦
        fightingImg.onload = function() {
          const imgElement = this as HTMLImageElement;
          const aspectRatio = imgElement.naturalWidth / imgElement.naturalHeight;
          // æ ¹æ“šè¢å¹•å°ºå¯¸æ±ºå®šé«˜åº¦
          let targetHeight = 300; // æ¡Œé¢ç‰ˆ
          if (window.innerWidth <= 480) {
            targetHeight = 200; // å°è¢å¹•
          } else if (window.innerWidth <= 768) {
            targetHeight = 250; // æ‰‹æ©Ÿç‰ˆ
          }
          const containerWidth = targetHeight * aspectRatio;
          characterContainer.style.width = `${containerWidth}px`;
        };
        
        characterContainer.appendChild(fightingImg);
        images.push(fightingImg);
      }
      
      if (hasRuinedImage) {
        const ruinedImg = document.createElement('img');
        ruinedImg.src = `${PEOPLE_IMAGE_URL}/${character.name || 'default'}Ruined.png`;
        ruinedImg.alt = `${character.nameOriginal} Ruined`;
        ruinedImg.style.opacity = '0';
        
        // æ¯€å£åœ–ç‰‡åŠ è¼‰å®Œæˆå¾Œä¹Ÿè¨­ç½®å®¹å™¨å¯¬åº¦
        ruinedImg.onload = function() {
          const imgElement = this as HTMLImageElement;
          const aspectRatio = imgElement.naturalWidth / imgElement.naturalHeight;
          // æ ¹æ“šè¢å¹•å°ºå¯¸æ±ºå®šé«˜åº¦
          let targetHeight = 300; // æ¡Œé¢ç‰ˆ
          if (window.innerWidth <= 480) {
            targetHeight = 200; // å°è¢å¹•
          } else if (window.innerWidth <= 768) {
            targetHeight = 250; // æ‰‹æ©Ÿç‰ˆ
          }
          const containerWidth = targetHeight * aspectRatio;
          characterContainer.style.width = `${containerWidth}px`;
        };
        
        characterContainer.appendChild(ruinedImg);
        images.push(ruinedImg);
      }
      
      // å¦‚æœæœ‰å¤šå¼µåœ–ç‰‡ï¼Œé–‹å§‹å¾ªç’°é¡¯ç¤º
      if (images.length > 1) {
        setInterval(() => {
          // éš±è—æ‰€æœ‰åœ–ç‰‡
          images.forEach(img => {
            (img as HTMLImageElement).style.opacity = '0';
          });
          
          // é¡¯ç¤ºç•¶å‰åœ–ç‰‡
          (images[currentImageIndex] as HTMLImageElement).style.opacity = '1';
          
          // æ›´æ–°ç´¢å¼•
          currentImageIndex = (currentImageIndex + 1) % images.length;
        }, 2000);
      }
    });

    // æ·»åŠ æ‡¸åœäº‹ä»¶
    img.addEventListener('mouseover', () => {
      (img as HTMLImageElement).style.zIndex = '20';
      // æå‡æ‰€æœ‰å…„å¼Ÿåœ–ç‰‡å…ƒç´ çš„ z-index
      const siblingImages = characterContainer.querySelectorAll('img');
      siblingImages.forEach(siblingImg => {
        (siblingImg as HTMLImageElement).style.zIndex = '20';
      });
    });
    img.addEventListener('mouseout', () => {
      (img as HTMLImageElement).style.zIndex = '10';
      // é‡ç½®æ‰€æœ‰å…„å¼Ÿåœ–ç‰‡å…ƒç´ çš„ z-index
      const siblingImages = characterContainer.querySelectorAll('img');
      siblingImages.forEach(siblingImg => {
        (siblingImg as HTMLImageElement).style.zIndex = '10';
      });
    });

    // å‰µå»ºä¿¡æ¯å®¹å™¨
    const infoContainer = document.createElement('div');
    infoContainer.style.cssText = 'padding:5px;color:#fff;text-shadow:0 0 2px rgba(0,0,0,0.5);width:100%;position:absolute;bottom:-40px;left:0;overflow:hidden;font-size:12px;z-index:4;background-color:transparent;border-radius:5px;';

    // æ·»åŠ åç¨±
    const nameText = document.createElement('p');
    nameText.textContent = character.nameOriginal;
    nameText.style.cssText = 'margin:0;font-weight:bold;font-size:clamp(12px,1.2vw,14px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
    const armyName = character.armyName || "Default";
    nameText.style.color = ARMY_COLORS[armyName] || ARMY_COLORS["Default"];
    nameText.style.textShadow = '0 0 2px rgba(0,0,0,0.5)';

    // æ·»åŠ å±¬æ€§
    const attributesText = document.createElement('p');
    attributesText.textContent = `Attributes: ${character.attributes}`;
    attributesText.style.cssText = 'margin:0;font-size:clamp(6px,0.8vw,8px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
    if (character.hasBonus) {
      const bonusBadge = document.createElement('span');
      bonusBadge.textContent = ` (+${character.weaponBonus || 0})`;
      bonusBadge.style.cssText = 'margin-left:5px;font-size:clamp(6px,0.8vw,8px);color:#FFD700;';
      attributesText.appendChild(bonusBadge);
    }

    // æ·»åŠ æˆ°åŠ›
    const powerText = document.createElement('p');
    powerText.textContent = `Total Power: ${character.totalPower}`;
    powerText.style.cssText = 'margin:0;font-size:clamp(12px,0.8vw,14px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
    powerText.style.color = levelColor;
    
    // ä½¿ç”¨èˆ‡åŠ›è¡¨ç›¸åŒçš„ API ç²å–æœ€æ–°æˆ°åŠ›
    const fetchLatestPower = async () => {
      try {
        // ä½¿ç”¨æ–°çš„å‚·å®³è¨ˆç®—æœå‹™
        const damageService = (await import('../services/damageService')).default.getInstance();
        const damageValue = await damageService.getCharacterDamage(character.name);
        if (damageValue > 0) {
          powerText.textContent = `Total Power: ${damageValue}`;
          console.log(`âœ… ${character.name} æœ€æ–°æˆ°åŠ›: ${damageValue}`);
        }
      } catch (e) {
        console.error(`âŒ ${character.name} ç²å–æœ€æ–°æˆ°åŠ›å¤±æ•—:`, e);
      }
    };
    
    // ç«‹å³ç²å–æœ€æ–°æˆ°åŠ› - ä½¿ç”¨å»¶é²é¿å…ä¸¦ç™¼éå¤š
    setTimeout(() => {
      fetchLatestPower();
    }, Math.random() * 3000 + 1000); // éš¨æ©Ÿå»¶é² 1-4 ç§’ï¼Œé¿å… 429

    infoContainer.appendChild(nameText);
    infoContainer.appendChild(attributesText);
    infoContainer.appendChild(powerText);
    characterContainer.appendChild(img);
    characterContainer.appendChild(infoContainer);
    return characterContainer;
  }

  // å‰µå»ºç­‰ç´šå®¹å™¨
  function createLevelContainer(level, characters) {
    const levelContainer = document.createElement('div');
    levelContainer.className = 'level-container';
    levelContainer.style.marginTop = '50px';
    levelContainer.style.borderColor = level.color;

    const levelTitle = document.createElement('h2');
    levelTitle.className = 'level-title';
    levelTitle.textContent = level.name;
    levelTitle.style.marginBottom = '15px';
    levelTitle.style.color = level.color;

    const levelBadge = document.createElement('div');
    levelBadge.className = 'level-badge';
    levelBadge.style.backgroundColor = level.color;
    levelBadge.style.width = '100%';
    levelBadge.style.textAlign = 'center';
    levelBadge.textContent = `æˆ°åŠ›: ${level.min} - ${level.max}`;
    levelBadge.style.color = level.color.includes('rgb') ? '#FFFFFF' : 
      (parseInt(level.color.substr(1, 2), 16) * 299 + 
       parseInt(level.color.substr(3, 2), 16) * 587 + 
       parseInt(level.color.substr(5, 2), 16) * 114) / 1000 > 128 ? '#000000' : '#FFFFFF';

    const charactersGrid = document.createElement('div');
    charactersGrid.className = 'box-container';
    charactersGrid.style.margin = '0 auto';

    characters.forEach(character => {
      charactersGrid.appendChild(createCharacterCard(character, level.color));
    });

    levelContainer.appendChild(levelTitle);
    levelContainer.appendChild(levelBadge);
    levelContainer.appendChild(charactersGrid);
    return levelContainer;
  }

  // æ ¹æ“šæ•¸å€¼ç¯„åœè¿”å›é¡è‰²ï¼ˆè¶Šé«˜è€…è¶Šç´…ï¼Œä½æ–¼ä¸­ä½æ•¸ç„¡ç‰¹æ®Šè™•ç†ï¼‰
  function getColorByRange(value, min, max) {
    if (max === min) return 'transparent'; // å¦‚æœæ‰€æœ‰å€¼éƒ½ç›¸åŒï¼Œè¿”å›é€æ˜
    
    const percentage = (value - min) / (max - min);
    
    // ä½æ–¼ä¸­ä½æ•¸ï¼ˆ50%ï¼‰ä¸ç‰¹æ®Šè™•ç†
    if (percentage <= 0.5) {
      return 'transparent';
    }
    
    // é«˜æ–¼ä¸­ä½æ•¸çš„éƒ¨åˆ†åˆ†æˆ5å€‹å€é–“ï¼Œå¾æ·ºç´…åˆ°æ·±ç´…
    const adjustedPercentage = (percentage - 0.5) * 2; // å°‡0.5-1æ˜ å°„åˆ°0-1
    const range = Math.floor(adjustedPercentage * 5); // åˆ†æˆ5å€‹å€é–“
    
    // é¡è‰²æ¼¸è®Šï¼šå¾æ·ºç´…åˆ°æ·±ç´…
    const colors = [
      '#FFE6E6', // 50-60%  æ·ºç²‰ç´…
      '#FFCCCC', // 60-70%  ç²‰ç´…
      '#FFB3B3', // 70-80%  æ·ºç´…
      '#FF8080', // 80-90%  ç´…
      '#FF0000'  // 90-100% æœ€ç´…
    ];
    
    return colors[Math.min(range, 4)]; // ç¢ºä¿ä¸æœƒè¶…å‡ºé™£åˆ—ç¯„åœ
  }

  // æ›´æ–°æˆ°åŠ›çµ±è¨ˆ
  function updatePowerStats(characters) {
    const stats = {
      'Lily Palais': { total: 0, count: 0 },
      'Libertad': { total: 0, count: 0 },
      'Jardin des Dieux': { total: 0, count: 0 }
    };
    
    characters.forEach(character => {
      const faction = character.faction || '';
      const totalPower = parseInt(character.totalPower) || 0;
      
      if (faction.includes('Lily Palais')) {
        stats['Lily Palais'].total += totalPower;
        stats['Lily Palais'].count++;
      } else if (faction.includes('Libertad')) {
        stats['Libertad'].total += totalPower;
        stats['Libertad'].count++;
      } else if (faction.includes('Jardin des Dieux')) {
        stats['Jardin des Dieux'].total += totalPower;
        stats['Jardin des Dieux'].count++;
      }
    });
    
    // æ›´æ–°é¡¯ç¤º
    const lilyTotal = document.getElementById('lily-palais-total');
    const lilyCount = document.getElementById('lily-palais-count');
    const libertadTotal = document.getElementById('libertad-total');
    const libertadCount = document.getElementById('libertad-count');
    const jardinTotal = document.getElementById('jardin-total');
    const jardinCount = document.getElementById('jardin-count');
    
    if (lilyTotal) lilyTotal.textContent = stats['Lily Palais'].total.toLocaleString();
    if (lilyCount) lilyCount.textContent = `è§’è‰²æ•¸: ${stats['Lily Palais'].count}`;
    if (libertadTotal) libertadTotal.textContent = stats['Libertad'].total.toLocaleString();
    if (libertadCount) libertadCount.textContent = `è§’è‰²æ•¸: ${stats['Libertad'].count}`;
    if (jardinTotal) jardinTotal.textContent = stats['Jardin des Dieux'].total.toLocaleString();
    if (jardinCount) jardinCount.textContent = `è§’è‰²æ•¸: ${stats['Jardin des Dieux'].count}`;
    
    console.log('ğŸ“Š æˆ°åŠ›çµ±è¨ˆæ›´æ–°:', stats);
  }

  // é€šç”¨ API èª¿ç”¨å‡½æ•¸ï¼ŒåŒ…å«é‡è©¦æ©Ÿåˆ¶
  async function apiCallWithRetry(url: string, options: RequestInit = {}, maxRetries = 3, delayMs = 1000) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ™‚
        
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response;
      } catch (error) {
        console.warn(`API èª¿ç”¨å¤±æ•— (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
        
        if (attempt === maxRetries) {
          throw error;
        }
        
        // ç­‰å¾…å¾Œé‡è©¦
        await new Promise(resolve => setTimeout(resolve, delayMs * attempt));
      }
    }
  }

  // æ‰¹æ¬¡è™•ç† API èª¿ç”¨ï¼Œé™åˆ¶ä¸¦ç™¼æ•¸
  async function batchFetchPowerData(characters: any[], batchSize = 5, delayMs = 1000) {
    const results: Array<{name: string, power: number} | null> = [];
    
    for (let i = 0; i < characters.length; i += batchSize) {
      const batch = characters.slice(i, i + batchSize);
      
      // ä¸¦ç™¼è™•ç†ç•¶å‰æ‰¹æ¬¡
      const batchPromises = batch.map(async (character) => {
        try {
          const resp = await apiCallWithRetry(
            `${TYMB_URL}/people/damageWithWeapon?name=${encodeURIComponent(character.name)}`,
            { method: 'GET' },
            2, // æœ€å¤šé‡è©¦ 2 æ¬¡
            500 // 500ms å»¶é²
          );
          
          if (resp) {
            const text = await resp.text();
            const dmgInt = parseInt(text, 10);
            if (!isNaN(dmgInt) && dmgInt > 0) {
              return { name: character.name, power: dmgInt };
            }
          }
        } catch (e) {
          console.error(`âŒ ${character.name} ç²å–æœ€æ–°æˆ°åŠ›å¤±æ•—:`, e);
        }
        return null;
      });
      
      // ç­‰å¾…ç•¶å‰æ‰¹æ¬¡å®Œæˆ
      const batchResults = await Promise.all(batchPromises);
      results.push(...batchResults.filter(r => r !== null));
      
      // æ‰¹æ¬¡é–“å»¶é²ï¼Œé¿å…å°å¾Œç«¯é€ æˆéå¤§å£“åŠ›
      if (i + batchSize < characters.length) {
        await new Promise(resolve => setTimeout(resolve, delayMs));
      }
    }
    
    return results;
  }

  // å…¨å±€è®Šé‡ä¾†å­˜å„²è§’è‰²æ•¸æ“š
  let characterPowerMap = new Map();
  let characterFactionMap = new Map();

  // å‰µå»ºæˆ°åŠ›åˆ—è¡¨
  function createPowerList(characters) {
    const powerListContainer = document.getElementById('power-list');
    if (!powerListContainer) return;
    
    // æ›´æ–°æˆ°åŠ›çµ±è¨ˆ
    updatePowerStats(characters);
    
    // è¨ˆç®—å„æ¬„ä½çš„æœ€å¤§å€¼å’Œæœ€å°å€¼
    const physicPowers = characters.map(c => parseInt(c.physicPower) || 0);
    const magicPowers = characters.map(c => parseInt(c.magicPower) || 0);
    const utilityPowers = characters.map(c => parseInt(c.originalUtilityPower) || 0);
    const weaponBonuses = characters.map(c => parseInt(c.weaponBonus) || 0);
    
    const physicMin = Math.min(...physicPowers);
    const physicMax = Math.max(...physicPowers);
    const magicMin = Math.min(...magicPowers);
    const magicMax = Math.max(...magicPowers);
    const utilityMin = Math.min(...utilityPowers);
    const utilityMax = Math.max(...utilityPowers);
    const weaponMin = Math.min(...weaponBonuses);
    const weaponMax = Math.max(...weaponBonuses);
    
    // å‰µå»ºä¸€å€‹å¯æ»¾å‹•çš„å®¹å™¨
    const scrollContainer = document.createElement('div');
    scrollContainer.style.width = '100%';
    scrollContainer.style.overflowX = 'auto';
    scrollContainer.style.marginBottom = '20px';
    scrollContainer.style.position = 'relative'; // æ·»åŠ ç›¸å°å®šä½
    scrollContainer.style.maxWidth = '100%'; // ç¢ºä¿å®¹å™¨ä¸æœƒè¶…å‡ºçˆ¶å…ƒç´ 
    
    // å‰µå»ºè¡¨æ ¼
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    // å–æ¶ˆå›ºå®šè¡¨æ ¼å¯¬åº¦èˆ‡ä½ˆå±€ï¼Œè®“æ¬„ä½å¯¬åº¦å¯ä¾å…§å®¹è‡ªé©æ‡‰
    // table.style.tableLayout é è¨­ç‚º 'auto'
    table.style.fontSize = '12px'; // å­—é«”å°ä¸€é»
    
    // å‰µå»ºè¡¨é ­
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    const headers = ['æ’è¡Œ', 'è§’è‰²åç¨±', 'ç‰©ç†æˆ°åŠ›', 'é­”æ³•æˆ°åŠ›', 'æ­¦å™¨æˆ°åŠ›', 'æ­¦å™¨åŠ æˆ', 'ç¸½æˆ°åŠ›', 'æ“ä½œ'];
    headers.forEach(headerText => {
      const th = document.createElement('th');
      th.textContent = headerText;
      th.style.padding = '4px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      th.style.border = '1px solid #ddd';
      th.style.backgroundColor = '#f2f2f2';
      th.style.textAlign = 'left';
      th.style.whiteSpace = 'nowrap'; // é˜²æ­¢è¡¨é ­æ›è¡Œ
      th.style.overflow = 'hidden'; // é˜²æ­¢å…§å®¹æº¢å‡º
      th.style.textOverflow = 'ellipsis'; // è¶…å‡ºé¡¯ç¤ºçœç•¥è™Ÿ
      th.style.color = '#FF4500'; // è¡¨é ­å­—é«”é¡è‰²è¨­ç‚ºé®®è±”çš„æ©™ç´…è‰²
      th.style.fontWeight = 'bold'; // è¡¨é ­å­—é«”åŠ ç²—
      th.style.fontSize = '14px'; // è¡¨é ­å­—é«”ç¨å¤§
      th.style.textShadow = '0 0 1px rgba(0,0,0,0.3)'; // æ·»åŠ æ–‡å­—é™°å½±å¢åŠ å°æ¯”åº¦
      headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // å‰µå»ºè¡¨æ ¼å…§å®¹
    const tbody = document.createElement('tbody');
    
    // æŒ‰ç¸½æˆ°åŠ›æ’åº
    const sortedCharacters = [...characters].sort((a, b) => b.totalPower - a.totalPower);
    
    // é‡ç½®å…¨å±€ Map
    characterPowerMap = new Map();
    characterFactionMap = new Map();
    
    sortedCharacters.forEach((character, index) => {
      const row = document.createElement('tr');
      
      // æ ¹æ“š faction è¨­ç½®è¡ŒèƒŒæ™¯è‰²
      const faction = character.faction || '';
      if (faction.includes('Lily Palais')) {
        row.style.backgroundColor = 'rgba(255, 182, 193, 0.2)'; // æ·¡ç²‰ç´… 10%é€æ˜åº¦
      } else if (faction.includes('Libertad')) {
      } else if (faction.includes('Jardin des Dieux')) {
        row.style.backgroundColor = 'rgba(144, 238, 144, 0.2)'; // æ·¡ç¶  10%é€æ˜åº¦
      }
      
      // æ’è¡Œ
      const rankCell = document.createElement('td');
      rankCell.textContent = `${index + 1}`;
      rankCell.style.padding = '4px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      rankCell.style.border = '1px solid #ddd';
      rankCell.style.textAlign = 'center'; // ç½®ä¸­å°é½Š
      rankCell.style.fontWeight = 'bold'; // åŠ ç²—
      
      // æ ¹æ“šæ’åè¨­ç½®ä¸åŒé¡è‰²
      if (index < 3) {
        rankCell.style.color = '#FF4500'; // å‰ä¸‰åç”¨ç´…è‰²
      } else if (index < 10) {
        rankCell.style.color = '#FF8C00'; // 4-10åç”¨æ©™è‰²
      } else if (index < 20) {
        rankCell.style.color = '#FFD700'; // 11-20åç”¨é‡‘è‰²
      } else if (index < 30) {
        rankCell.style.color = '#32CD32'; // 21-30åç”¨ç¶ è‰²
      } else if (index < 40) {
        rankCell.style.color = '#1E90FF'; // 31-40åç”¨è—è‰²
      } else if (index < 50) {
        rankCell.style.color = '#9370DB'; // 41-50åç”¨ç´«è‰²
      } else if (index < 60) {
        rankCell.style.color = '#FF69B4'; // 51-60åç”¨ç²‰è‰²
      } else if (index < 70) {
        rankCell.style.color = '#20B2AA'; // 61-70åç”¨æ·ºæµ·ç¶ 
      } else if (index < 80) {
        rankCell.style.color = '#FF6347'; // 71-80åç”¨ç•ªèŒ„ç´…
      } else if (index < 90) {
        rankCell.style.color = '#7B68EE'; // 81-90åç”¨ä¸­ç´«è‰²
      } else {
        rankCell.style.color = '#A0522D'; // 91åä»¥ä¸Šç”¨æ£•è‰²
      }
      
      row.appendChild(rankCell);
      
      // è§’è‰²åç¨±
      const nameCell = document.createElement('td');
      nameCell.textContent = character.nameOriginal || character.name || 'Unknown';
      nameCell.style.padding = '4px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      nameCell.style.border = '1px solid #ddd';
      nameCell.style.whiteSpace = 'nowrap'; // é˜²æ­¢æ–‡å­—æ›è¡Œ
      nameCell.style.overflow = 'hidden'; // é˜²æ­¢å…§å®¹æº¢å‡º
      nameCell.style.textOverflow = 'ellipsis'; // è¶…å‡ºé¡¯ç¤ºçœç•¥è™Ÿ
      row.appendChild(nameCell);
      
      // ç‰©ç†æˆ°åŠ›
      const physicCell = document.createElement('td');
      const physicInput = document.createElement('input');
      physicInput.type = 'number';
      physicInput.style.webkitAppearance = 'none';
      physicInput.style.appearance = 'textfield';
      physicInput.style.setProperty('--webkit-inner-spin-button', 'none');
      physicInput.style.setProperty('--webkit-outer-spin-button', 'none');
      physicInput.value = character.physicPower || '0';
      physicInput.style.minWidth = '50px'; // æœ€å°å¯¬åº¦
      physicInput.style.width = 'auto'; // è‡ªå‹•èª¿æ•´å¯¬åº¦
      physicInput.style.padding = '2px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      physicInput.dataset.originalValue = character.physicPower || '0';
      // æ ¹æ“šæ•¸å€¼è¨­å®šå­—é«”é¡è‰²
      const physicValue = parseInt(character.physicPower) || 0;
      const physicColor = getColorByRange(physicValue, physicMin, physicMax);
      physicCell.style.backgroundColor = 'transparent';
      // è¨­å®šå­—é«”é¡è‰²å’Œç²—ç´°
      if (physicColor !== 'transparent') {
        physicInput.style.color = physicColor;
        physicInput.style.fontWeight = 'bold';
      } else {
        physicInput.style.color = 'var(--text-primary)';
        physicInput.style.fontWeight = 'normal';
      }
      // æ·»åŠ è¼¸å…¥äº‹ä»¶ä¾†èª¿æ•´å¯¬åº¦
      physicInput.addEventListener('input', function() {
        this.style.width = `${Math.max(50, this.value.length * 10)}px`;
      });
      // åˆå§‹åŒ–å¯¬åº¦
      physicInput.style.width = `${Math.max(50, (character.physicPower || '0').toString().length * 10)}px`;
      physicCell.appendChild(physicInput);
      physicCell.style.padding = '4px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      physicCell.style.border = '1px solid #ddd';
      row.appendChild(physicCell);
      
      // é­”æ³•æˆ°åŠ›
      const magicCell = document.createElement('td');
      const magicInput = document.createElement('input');
      magicInput.type = 'number';
      magicInput.style.webkitAppearance = 'none';
      magicInput.style.appearance = 'textfield';
      magicInput.style.setProperty('--webkit-inner-spin-button', 'none');
      magicInput.style.setProperty('--webkit-outer-spin-button', 'none');
      magicInput.value = character.magicPower || '0';
      magicInput.style.minWidth = '50px'; // æœ€å°å¯¬åº¦
      magicInput.style.width = 'auto'; // è‡ªå‹•èª¿æ•´å¯¬åº¦
      magicInput.style.padding = '2px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      magicInput.dataset.originalValue = character.magicPower || '0';
      // æ ¹æ“šæ•¸å€¼è¨­å®šå­—é«”é¡è‰²
      const magicValue = parseInt(character.magicPower) || 0;
      const magicColor = getColorByRange(magicValue, magicMin, magicMax);
      magicCell.style.backgroundColor = 'transparent';
      // è¨­å®šå­—é«”é¡è‰²å’Œç²—ç´°
      if (magicColor !== 'transparent') {
        magicInput.style.color = magicColor;
        magicInput.style.fontWeight = 'bold';
      } else {
        magicInput.style.color = 'var(--text-primary)';
        magicInput.style.fontWeight = 'normal';
      }
      // æ·»åŠ è¼¸å…¥äº‹ä»¶ä¾†èª¿æ•´å¯¬åº¦
      magicInput.addEventListener('input', function() {
        this.style.width = `${Math.max(50, this.value.length * 10)}px`;
      });
      // åˆå§‹åŒ–å¯¬åº¦
      magicInput.style.width = `${Math.max(50, (character.magicPower || '0').toString().length * 10)}px`;
      magicCell.appendChild(magicInput);
      magicCell.style.padding = '4px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      magicCell.style.border = '1px solid #ddd';
      row.appendChild(magicCell);
      
      // æ­¦å™¨æˆ°åŠ› (å¯ç·¨è¼¯)
      const utilityCell = document.createElement('td');
      const utilityInput = document.createElement('input');
      utilityInput.type = 'number';
      utilityInput.style.webkitAppearance = 'none';
      utilityInput.style.appearance = 'textfield';
      utilityInput.style.setProperty('--webkit-inner-spin-button', 'none');
      utilityInput.style.setProperty('--webkit-outer-spin-button', 'none');
      utilityInput.value = character.originalUtilityPower || '0';
      utilityInput.style.minWidth = '50px'; // æœ€å°å¯¬åº¦
      utilityInput.style.width = 'auto'; // è‡ªå‹•èª¿æ•´å¯¬åº¦
      utilityInput.style.padding = '2px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      utilityInput.dataset.originalValue = character.originalUtilityPower || '0';
      // æ ¹æ“šæ•¸å€¼è¨­å®šå­—é«”é¡è‰²
      const utilityValue = parseInt(character.originalUtilityPower) || 0;
      const utilityColor = getColorByRange(utilityValue, utilityMin, utilityMax);
      utilityCell.style.backgroundColor = 'transparent';
      // è¨­å®šå­—é«”é¡è‰²å’Œç²—ç´°
      if (utilityColor !== 'transparent') {
        utilityInput.style.color = utilityColor;
        utilityInput.style.fontWeight = 'bold';
      } else {
        utilityInput.style.color = 'var(--text-primary)';
        utilityInput.style.fontWeight = 'normal';
      }
      // ç§»é™¤ disabled å±¬æ€§ï¼Œå…è¨±ç·¨è¼¯
      // æ·»åŠ è¼¸å…¥äº‹ä»¶ä¾†èª¿æ•´å¯¬åº¦
      utilityInput.addEventListener('input', function() {
        this.style.width = `${Math.max(50, this.value.length * 10)}px`;
      });
      // åˆå§‹åŒ–å¯¬åº¦
      utilityInput.style.width = `${Math.max(50, (character.originalUtilityPower || '0').toString().length * 10)}px`;
      utilityCell.appendChild(utilityInput);
      utilityCell.style.padding = '4px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      utilityCell.style.border = '1px solid #ddd';
      row.appendChild(utilityCell);
      
      // æ­¦å™¨åŠ æˆ (ä¸å¯ç·¨è¼¯ï¼Œé¡¯ç¤ºæ­¦å™¨åŠ æˆå€¼)
      const totalUtilityCell = document.createElement('td');
      // é¡¯ç¤ºæ­¦å™¨åŠ æˆå€¼
      totalUtilityCell.textContent = character.hasBonus ? 
        `${character.weaponBonus || '0'}` : 
        '0';
      // æ ¹æ“šæ•¸å€¼è¨­å®šå­—é«”é¡è‰²
      const weaponValue = parseInt(character.weaponBonus) || 0;
      const weaponColor = getColorByRange(weaponValue, weaponMin, weaponMax);
      totalUtilityCell.style.backgroundColor = 'transparent';
      // è¨­å®šå­—é«”é¡è‰²å’Œç²—ç´°
      if (weaponColor !== 'transparent') {
        totalUtilityCell.style.color = weaponColor;
        totalUtilityCell.style.fontWeight = 'bold';
      } else {
        totalUtilityCell.style.color = 'var(--text-primary)';
        totalUtilityCell.style.fontWeight = 'normal';
      }
      totalUtilityCell.style.padding = '4px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      totalUtilityCell.style.border = '1px solid #ddd';
      totalUtilityCell.style.whiteSpace = 'nowrap'; // é˜²æ­¢æ–‡å­—æ›è¡Œ
      totalUtilityCell.style.overflow = 'hidden'; // é˜²æ­¢å…§å®¹æº¢å‡º
      totalUtilityCell.style.textOverflow = 'ellipsis'; // è¶…å‡ºé¡¯ç¤ºçœç•¥è™Ÿ
      row.appendChild(totalUtilityCell);
      
      // ç¸½æˆ°åŠ›
      const totalCell = document.createElement('td');
      totalCell.textContent = character.totalPower || '0';
      totalCell.style.padding = '4px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      totalCell.style.border = '1px solid #ddd';
      totalCell.style.fontWeight = 'bold';
      totalCell.style.whiteSpace = 'nowrap'; // é˜²æ­¢æ–‡å­—æ›è¡Œ
      totalCell.style.overflow = 'hidden'; // é˜²æ­¢å…§å®¹æº¢å‡º
      totalCell.style.textOverflow = 'ellipsis'; // è¶…å‡ºé¡¯ç¤ºçœç•¥è™Ÿ
      row.appendChild(totalCell);
      
      // æ“ä½œæŒ‰éˆ•
      const actionCell = document.createElement('td');
      actionCell.style.padding = '4px'; // ä¸Šä¸‹é–“è·å¯†é›†ä¸€é»
      actionCell.style.border = '1px solid #ddd';
      actionCell.style.whiteSpace = 'nowrap'; // é˜²æ­¢æ–‡å­—æ›è¡Œ
      
      const updateButton = document.createElement('button');
      updateButton.textContent = 'æ›´æ–°';
      updateButton.style.cssText = `
        padding: 4px 8px;
        background: linear-gradient(145deg, #4CAF50, #45a049);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      `;
      
      // æ·»åŠ æ‡¸åœæ•ˆæœ
      updateButton.addEventListener('mouseover', () => {
        updateButton.style.background = 'linear-gradient(145deg, #45a049, #4CAF50)';
        updateButton.style.transform = 'translateY(-1px)';
        updateButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
      });
      
      updateButton.addEventListener('mouseout', () => {
        updateButton.style.background = 'linear-gradient(145deg, #4CAF50, #45a049)';
        updateButton.style.transform = 'translateY(0)';
        updateButton.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
      });
      
      // å„²å­˜åŸå§‹å€¼
      const originalData = {
        id: character.id || 0,
        name: character.name || '',
        baseAttributes: character.baseAttributes || '',
        bonusAttributes: character.bonusAttributes || '',
        stateAttributes: character.stateAttributes || '',
        nameOriginal: character.nameOriginal || '',
        codeName: character.codeName || '',
        physicPower: character.physicPower || 0,
        magicPower: character.magicPower || 0,
        utilityPower: character.utilityPower || 0,
        dob: character.dob || '',
        race: character.race || '',
        attributes: character.attributes || '',
        gender: character.gender || '',
        assSize: character.assSize || '',
        boobsSize: character.boobsSize || '',
        heightCm: character.heightCm || 0,
        weightKg: character.weightKg || 0,
        profession: character.profession || '',
        combat: character.combat || '',
        favoriteFoods: character.favoriteFoods || '',
        job: character.job || '',
        physics: character.physics || '',
        knownAs: character.knownAs || '',
        personally: character.personally || '',
        interest: character.interest || '',
        likes: character.likes || '',
        dislikes: character.dislikes || '',
        concubine: character.concubine || '',
        faction: character.faction || '',
        armyId: character.armyId || 0,
        armyName: character.armyName || '',
        deptId: character.deptId || 0,
        deptName: character.deptName || '',
        originArmyId: character.originArmyId || 0,
        originArmyName: character.originArmyName || '',
        gaveBirth: character.gaveBirth || false,
        email: character.email || '',
        age: character.age || 0,
        proxy: character.proxy || '',
        hei: character.hei || '',
        physicsFallout4: character.physicsFallout4 || '',
        version: character.version || 0,
        hrratio: character.hrratio || '',
        hasBonus: character.hasBonus || false,
        weaponBonus: character.weaponBonus || 0
      };
      
      // åˆå§‹åŒ–è§’è‰²æˆ°åŠ›æ˜ å°„
      characterPowerMap.set(character.name, {
        physicPower: character.physicPower || 0,
        magicPower: character.magicPower || 0,
        utilityPower: character.originalUtilityPower || 0,
        weaponBonus: character.weaponBonus || 0,
        hasBonus: character.hasBonus || false,
        totalPower: character.totalPower || 0,
        attributes: character.attributes || '',
        weaponData: character.weaponData || null
      });
      
      // å­˜å„² faction ä¿¡æ¯
      characterFactionMap.set(character.name, character.faction || '');
      
      // helper function to fetch latest total power and update UI/mapping for this row
      const fetchAndApplyTotalPower = async (shouldReorder = false) => {
        console.log(`ğŸ”„ æŸ¥è©¢ ${character.name} çš„æœ€æ–°ç¸½æˆ°åŠ›...`);
        try {
          // ä½¿ç”¨æ–°çš„å‚·å®³è¨ˆç®—æœå‹™
          const damageService = (await import('../services/damageService')).default.getInstance();
          const damageValue = await damageService.getCharacterDamage(character.name);
          
          if (damageValue > 0) {
            const mapData = characterPowerMap.get(character.name);
            mapData.totalPower = damageValue;
            const weaponBonus = damageValue - (mapData.physicPower + mapData.magicPower + mapData.utilityPower);
            mapData.weaponBonus = weaponBonus;
            mapData.hasBonus   = weaponBonus > 0;
            totalCell.textContent = String(damageValue);
            totalUtilityCell.textContent = mapData.hasBonus ? `${weaponBonus}` : '0';
            console.log(`âœ… ${character.name} ç¸½æˆ°åŠ›æ›´æ–°ç‚º ${damageValue}`);
            if (shouldReorder) {
              updateRankings();
            }
          } else {
            console.warn(`âš ï¸ ${character.name} API è¿”å›ç„¡æ•ˆæ•¸å€¼: ${damageValue}`);
          }
        } catch (e) {
          console.error(`âŒ ${character.name} API èª¿ç”¨å¤±æ•—:`, e);
        }
      };

      //  æ·»åŠ è¼¸å…¥äº‹ä»¶ç›£è½å™¨ï¼Œå¯¦ç¾å‹•æ…‹è¨ˆç®—ç¸½æˆ°åŠ›
      const updateTotalPower = async () => {
        const currentData = characterPowerMap.get(character.name);
        const physicPower = parseInt(physicInput.value) || 0;
        const magicPower = parseInt(magicInput.value) || 0;
        const utilityPower = parseInt(utilityInput.value) || 0;
        currentData.physicPower = physicPower;
        currentData.magicPower  = magicPower;
        currentData.utilityPower = utilityPower;
        await fetchAndApplyTotalPower(false);
        saveToLocalStorage(character.name, currentData);
      };
      
      // æ·»åŠ å¤±ç„¦äº‹ä»¶ç›£è½å™¨ï¼Œåœ¨è¼¸å…¥å®Œæˆå¾Œæ›´æ–°æ’è¡Œ
      const updateRankingsOnBlur = () => {
        row.classList.remove('editing');
        console.log(`ğŸ“Š å¤±ç„¦äº‹ä»¶: é‡æ–°æ’åºè¡¨æ ¼`);
        updateRankings();
      };
      
      // ç‚ºæ¯å€‹è¼¸å…¥æ¡†æ·»åŠ äº‹ä»¶ç›£è½å™¨ï¼Œå¯¦ç¾å‹•æ…‹è¨ˆç®—ç¸½æˆ°åŠ›
      physicInput.addEventListener('input', updateTotalPower);
      magicInput.addEventListener('input', updateTotalPower);
      utilityInput.addEventListener('input', updateTotalPower); // å•Ÿç”¨æ­¦å™¨æˆ°åŠ›è¼¸å…¥äº‹ä»¶
      
      // æ·»åŠ å¤±ç„¦äº‹ä»¶ç›£è½å™¨ï¼Œåœ¨è¼¸å…¥å®Œæˆå¾Œæ›´æ–°æ’è¡Œ
      physicInput.addEventListener('blur', updateRankingsOnBlur);
      magicInput.addEventListener('blur', updateRankingsOnBlur);
      utilityInput.addEventListener('blur', updateRankingsOnBlur); // å•Ÿç”¨æ­¦å™¨æˆ°åŠ›å¤±ç„¦äº‹ä»¶
      
      // æ›´æ–°æŒ‰éˆ•é»æ“Šäº‹ä»¶
      updateButton.addEventListener('click', async () => {
    try {
          
          // ç²å–ç•¶å‰è¼¸å…¥å€¼
          const currentData = {
            id: 0, // ç›´æ¥è¨­ç½® ID ç‚º 0
            name: character.name || '',
            baseAttributes: character.baseAttributes || '',
            bonusAttributes: character.bonusAttributes || '',
            stateAttributes: character.stateAttributes || '',
            nameOriginal: character.nameOriginal || '',
            codeName: character.codeName || '',
            physicPower: parseInt(physicInput.value) || 0,
            magicPower: parseInt(magicInput.value) || 0,
            utilityPower: parseInt(utilityInput.value) || 0, // ç¾åœ¨åŒ…å«æ­¦å™¨æˆ°åŠ›çš„ç·¨è¼¯å€¼
            dob: character.dob || '',
            race: character.race || '',
            attributes: character.attributes || '',
            gender: character.gender || '',
            assSize: character.assSize || '',
            boobsSize: character.boobsSize || '',
            heightCm: character.heightCm || 0,
            weightKg: character.weightKg || 0,
            profession: character.profession || '',
            combat: character.combat || '',
            favoriteFoods: character.favoriteFoods || '',
            job: character.job || '',
            physics: character.physics || '',
            knownAs: character.knownAs || '',
            personally: character.personally || '',
            interest: character.interest || '',
            likes: character.likes || '',
            dislikes: character.dislikes || '',
            concubine: character.concubine || '',
            faction: character.faction || '',
            armyId: character.armyId || 0,
            armyName: character.armyName || '',
            deptId: character.deptId || 0,
            deptName: character.deptName || '',
            originArmyId: character.originArmyId || 0,
            originArmyName: character.originArmyName || '',
            gaveBirth: character.gaveBirth || false,
            email: character.email || '',
            age: character.age || 0,
            proxy: character.proxy || '',
            hei: character.hei || '',
            physicsFallout4: character.physicsFallout4 || '',
            version: character.version || 1, // ç¢ºä¿ version ä¸ç‚º null
            hrratio: character.hrratio || '',
            // æ–°å¢æ¬„ä½ä»¥ä¾›å¾ŒçºŒæ›´æ–°æˆ°åŠ›ä½¿ç”¨
            totalPower: 0,
            weaponBonus: 0,
            hasBonus: false
          };
          
          // ç™¼é€æ›´æ–°è«‹æ±‚åˆ°æ–°çš„ API è·¯ç”±
          const response = await fetch('/api/people/update', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(currentData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            
            // ç‰¹æ®Šè™•ç†ç‰ˆæœ¬è¡çªéŒ¯èª¤
            if (errorData.error === 'VERSION_CONFLICT') {
              if (typeof (window as any).Swal !== 'undefined') {
                (window as any).Swal.fire({
                  title: 'ç‰ˆæœ¬è¡çª',
                  text: errorData.message,
                  icon: 'warning',
                  confirmButtonText: 'é‡æ–°è¼‰å…¥',
                  showCancelButton: true,
                  cancelButtonText: 'å–æ¶ˆ'
                }).then((result) => {
                  if (result.isConfirmed) {
                    // é‡æ–°è¼‰å…¥é é¢æˆ–é‡æ–°ç²å–æ•¸æ“š
                    location.reload();
                  }
                });
              }
              return;
            }
            
            // ç‰¹æ®Šè™•ç†ä¸»éµè¡çªéŒ¯èª¤
            if (errorData.error === 'DUPLICATE_KEY') {
              if (typeof (window as any).Swal !== 'undefined') {
                (window as any).Swal.fire({
                  title: 'å¾Œç«¯é‚è¼¯éŒ¯èª¤',
                  html: `
                    <div style="text-align: left;">
                      <p><strong>éŒ¯èª¤é¡å‹ï¼š</strong>ä¸»éµè¡çª</p>
                      <p><strong>å•é¡Œï¼š</strong>å¾Œç«¯å˜—è©¦æ’å…¥å·²å­˜åœ¨çš„è§’è‰²</p>
                      <p><strong>å»ºè­°ï¼š</strong>${errorData.suggestion || 'è¯ç¹«å¾Œç«¯é–‹ç™¼è€…ä¿®å¾©'}</p>
                      <hr>
                      <p><small>è©³ç´°éŒ¯èª¤ï¼š${errorData.details?.substring(0, 200)}...</small></p>
                    </div>
                  `,
                  icon: 'error',
                  confirmButtonText: 'ç¢ºå®š',
                  width: '600px'
                });
              }
              return;
            }
            
            throw new Error(`æ›´æ–°å¤±æ•—: ${response.status} - ${errorData.message || 'æœªçŸ¥éŒ¯èª¤'}`);
          }
          
          const result = await response.json();
          
          // ä½¿ç”¨ SweetAlert2 é¡¯ç¤ºæˆåŠŸè¨Šæ¯
          if (typeof (window as any).Swal !== 'undefined') {
            (window as any).Swal.fire({
              title: 'æ›´æ–°æˆåŠŸï¼',
              icon: 'success',
              timer: 1500,
              showConfirmButton: false
            });
          }
          
          // æ›´æ–°åŸå§‹å€¼
          originalData.physicPower = currentData.physicPower;
          originalData.magicPower = currentData.magicPower;
          originalData.utilityPower = currentData.utilityPower;
          
          // æ›´æ–°è¼¸å…¥æ¡†çš„åŸå§‹å€¼
          physicInput.dataset.originalValue = String(currentData.physicPower);
          magicInput.dataset.originalValue = String(currentData.magicPower);
          utilityInput.dataset.originalValue = String(currentData.utilityPower); // æ›´æ–°æ­¦å™¨æˆ°åŠ›åŸå§‹å€¼
          
          // æ·»åŠ æˆåŠŸé–ƒçˆæ•ˆæœ
          row.classList.add('save-success');
          setTimeout(() => {
            row.classList.remove('save-success');
          }, 1000);

          // ç«‹å³å‘å¾Œç«¯æŸ¥è©¢æœ€æ–°ç¸½æˆ°åŠ›ä¸¦æ›´æ–°ç•«é¢
          await fetchAndApplyTotalPower(true);
          
          // æ›´æ–°æˆ°åŠ›çµ±è¨ˆ
          const tbody = document.querySelector('#power-list table tbody');
          if (tbody) {
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const characters = rows.map(row => {
              const nameCell = row.querySelector('td:nth-child(2)');
              const totalPowerCell = row.querySelector('td:nth-child(7)');
              const name = nameCell ? nameCell.textContent : '';
              const totalPower = totalPowerCell ? parseInt(totalPowerCell.textContent || '0') : 0;
              const faction = characterFactionMap.get(name) || '';
              return { name, totalPower, faction };
            });
            updatePowerStats(characters);
          }
          
        } catch (error) {
          console.error('æ›´æ–°è§’è‰²èƒ½åŠ›æ™‚å‡ºéŒ¯:', error);
          if (typeof (window as any).Swal !== 'undefined') {
            (window as any).Swal.fire({
              title: 'æ›´æ–°å¤±æ•—: ' + error.message,
              icon: 'error',
              timer: 0,
              showConfirmButton: true
            });
          }
        }
      });
      
      actionCell.appendChild(updateButton);
      row.appendChild(actionCell);
      
      tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    scrollContainer.appendChild(table);
    powerListContainer.appendChild(scrollContainer);
  }

  // ä¿å­˜åˆ° localStorage
  function saveToLocalStorage(characterName, data) {
    try {
      // ç²å–ç¾æœ‰çš„æš«å­˜æ•¸æ“š
      const storageKey = 'character_power_cache';
      let cachedData = JSON.parse(localStorage.getItem(storageKey) || '{}');
      
      // æ›´æ–°ç‰¹å®šè§’è‰²çš„æ•¸æ“š
      cachedData[characterName] = data;
      
      // ä¿å­˜å› localStorage
      localStorage.setItem(storageKey, JSON.stringify(cachedData));
      
      console.log(`å·²æš«å­˜ ${characterName} çš„æˆ°åŠ›æ•¸æ“š`);
    } catch (error) {
      console.error('æš«å­˜æˆ°åŠ›æ•¸æ“šæ™‚å‡ºéŒ¯:', error);
    }
  }

  // å¾ localStorage ç²å–æš«å­˜æ•¸æ“š
  function getFromLocalStorage(characterName) {
    try {
      const storageKey = 'character_power_cache';
      const cachedData = JSON.parse(localStorage.getItem(storageKey) || '{}');
      return cachedData[characterName] || null;
    } catch (error) {
      console.error('ç²å–æš«å­˜æˆ°åŠ›æ•¸æ“šæ™‚å‡ºéŒ¯:', error);
      return null;
    }
  }

  // æ›´æ–°æ’è¡Œ
  function updateRankings() {
    const tbody = document.querySelector('#power-list table tbody');
    if (!tbody) return;
    
    // ç²å–æ‰€æœ‰è¡Œ
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // æ ¹æ“šç¸½æˆ°åŠ›æ’åºè¡Œ
    rows.sort((a, b) => {
      const aTotalPowerCell = a.querySelector('td:nth-child(7)');
      const bTotalPowerCell = b.querySelector('td:nth-child(7)');
      
      const aTotalPower = aTotalPowerCell ? parseInt(aTotalPowerCell.textContent || '0') : 0;
      const bTotalPower = bTotalPowerCell ? parseInt(bTotalPowerCell.textContent || '0') : 0;
      
      return bTotalPower - aTotalPower;
    });
    
    // æ¸…ç©ºè¡¨æ ¼
    while (tbody.firstChild) {
      tbody.removeChild(tbody.firstChild);
    }
    
    // é‡æ–°æ·»åŠ æ’åºå¾Œçš„è¡Œ
    rows.forEach((row, index) => {
      // æ›´æ–°æ’è¡Œ
      const rankCell = row.querySelector('td:first-child');
      if (rankCell) {
        rankCell.textContent = `${index + 1}`;
        if (rankCell instanceof HTMLElement) {
          // æ ¹æ“šæ’åè¨­ç½®ä¸åŒé¡è‰²
          if (index < 3) {
            rankCell.style.color = '#FF4500'; // å‰ä¸‰åç”¨ç´…è‰²
          } else if (index < 10) {
            rankCell.style.color = '#FF8C00'; // 4-10åç”¨æ©™è‰²
          } else if (index < 20) {
            rankCell.style.color = '#FFD700'; // 11-20åç”¨é‡‘è‰²
          } else if (index < 30) {
            rankCell.style.color = '#32CD32'; // 21-30åç”¨ç¶ è‰²
          } else if (index < 40) {
            rankCell.style.color = '#1E90FF'; // 31-40åç”¨è—è‰²
          } else if (index < 50) {
            rankCell.style.color = '#9370DB'; // 41-50åç”¨ç´«è‰²
          } else if (index < 60) {
            rankCell.style.color = '#FF69B4'; // 51-60åç”¨ç²‰è‰²
          } else if (index < 70) {
            rankCell.style.color = '#20B2AA'; // 61-70åç”¨æ·ºæµ·ç¶ 
          } else if (index < 80) {
            rankCell.style.color = '#FF6347'; // 71-80åç”¨ç•ªèŒ„ç´…
          } else if (index < 90) {
            rankCell.style.color = '#7B68EE'; // 81-90åç”¨ä¸­ç´«è‰²
          } else {
            rankCell.style.color = '#A0522D'; // 91åä»¥ä¸Šç”¨æ£•è‰²
          }
        }
      }
      
      // æ·»åŠ è¡Œåˆ°è¡¨æ ¼
      tbody.appendChild(row);
    });
    
    // æ›´æ–°æˆ°åŠ›çµ±è¨ˆ
    const characters = Array.from(rows).map(row => {
      const nameCell = row.querySelector('td:nth-child(2)');
      const totalPowerCell = row.querySelector('td:nth-child(7)');
      const name = nameCell ? nameCell.textContent : '';
      const totalPower = totalPowerCell ? parseInt(totalPowerCell.textContent || '0') : 0;
      
      // å¾ characterFactionMap ç²å– faction ä¿¡æ¯
      const faction = characterFactionMap.get(name) || '';
      return {
        name,
        totalPower,
        faction
      };
    });
    
    updatePowerStats(characters);
  }

  // åŒæ­¥å…¨éƒ¨åŠŸèƒ½
  async function syncAllCharacters() {
    const syncBtn = document.getElementById('sync-all-btn') as HTMLButtonElement;
    if (!syncBtn) return;
    
    // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    syncBtn.disabled = true;
    syncBtn.innerHTML = `
      <span>åŒæ­¥ä¸­...</span>
      <div style="
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s ease;
      "></div>
    `;
    syncBtn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
    syncBtn.style.transform = 'scale(0.95)';
    syncBtn.style.boxShadow = '0 4px 15px rgba(255, 107, 107, 0.5)';
    
    try {
      console.log('ğŸ”„ é–‹å§‹åŒæ­¥æ‰€æœ‰è§’è‰²æ•¸æ“š...');
      
      // 1. ä½¿ç”¨å…±ç”¨çš„è§’è‰²æœå‹™ç²å–æ‰€æœ‰è§’è‰²æ•¸æ“š
      const characterService = (await import('../services/characterService')).default.getInstance();
      const characters = await characterService.refreshCharacters(); // å¼·åˆ¶åˆ·æ–°
      console.log(`âœ… æˆåŠŸç²å– ${characters.length} å€‹è§’è‰²æ•¸æ“š`);
      
      // 2. é€éä»£ç†ç«¯é»ç™¼é€åˆ° Google Apps Script - æ·»åŠ è¶…æ™‚æ©Ÿåˆ¶
      const basePath = window.location.pathname.includes('/tymultiverse') ? '/tymultiverse' : '';
      const syncResponse = await fetch(`${basePath}/api/sync-characters`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(characters),
        signal: AbortSignal.timeout(60000) // 60ç§’è¶…æ™‚
      });
      
      if (!syncResponse.ok) {
        throw new Error(`åŒæ­¥å¤±æ•—: ${syncResponse.status}`);
      }
      
      const syncResult = await syncResponse.json();
      console.log('âœ… åŒæ­¥çµæœ:', syncResult);
      
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      showAlert(`åŒæ­¥æˆåŠŸï¼å·²åŒæ­¥ ${syncResult.characterCount} å€‹è§’è‰²`, 'success', 2000);
      
      // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°æˆ°åŠ›çµ±è¨ˆ
      setTimeout(() => {
        window.location.reload();
      }, 2000);
      
    } catch (error) {
      console.error('âŒ åŒæ­¥å¤±æ•—:', error);
      showAlert(`åŒæ­¥å¤±æ•—: ${error.message}`, 'error', 3000);
    } finally {
      // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
      syncBtn.disabled = false;
      syncBtn.innerHTML = `
        <span>åŒæ­¥å…¨éƒ¨</span>
        <div style="
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
          transition: left 0.5s ease;
        "></div>
      `;
      syncBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      syncBtn.style.transform = 'translateY(0) scale(1)';
      syncBtn.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.4)';
    }
  }

  // åŒ¯å‡ºè¡¨æ ¼åŠŸèƒ½
  function exportToExcel() {
    const exportBtn = document.getElementById('export-btn') as HTMLButtonElement;
    if (!exportBtn) return;
    
    // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    exportBtn.disabled = true;
    exportBtn.innerHTML = `
      <span>åŒ¯å‡ºä¸­...</span>
      <div style="
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s ease;
      "></div>
    `;
    exportBtn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
    exportBtn.style.transform = 'scale(0.95)';
    exportBtn.style.boxShadow = '0 4px 15px rgba(255, 107, 107, 0.5)';
    
    try {
      console.log('ğŸ“Š é–‹å§‹åŒ¯å‡ºè¡¨æ ¼...');
      
      // æª¢æŸ¥ SheetJS æ˜¯å¦å·²è¼‰å…¥
      if (typeof (window as any).XLSX === 'undefined') {
        throw new Error('SheetJS åº«æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
      }
      
      // ç²å–è¡¨æ ¼å…ƒç´ 
      const table = document.querySelector('#power-list table');
      if (!table) {
        throw new Error('æ‰¾ä¸åˆ°è¡¨æ ¼å…ƒç´ ');
      }
      
      // ç²å–è¡¨é ­
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent?.trim() || '');
      
      // ç²å–è¡¨æ ¼æ•¸æ“š
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      const data = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        return cells.map(cell => {
          // å¦‚æœæ˜¯è¼¸å…¥æ¡†ï¼Œç²å–å…¶å€¼
          const input = cell.querySelector('input');
          if (input) {
            return input.value;
          }
          // å¦å‰‡ç²å–æ–‡å­—å…§å®¹
          return cell.textContent?.trim() || '';
        });
      });
      
      // å‰µå»ºå·¥ä½œç°¿
      const wb = (window as any).XLSX.utils.book_new();
      
      // å‰µå»ºä¸»è¦æ•¸æ“šå·¥ä½œè¡¨
      const wsData = [headers, ...data];
      const ws = (window as any).XLSX.utils.aoa_to_sheet(wsData);
      
      // è¨­ç½®åˆ—å¯¬
      const colWidths = headers.map(header => ({ wch: Math.max(header.length, 10) }));
      ws['!cols'] = colWidths;
      
      // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
      (window as any).XLSX.utils.book_append_sheet(wb, ws, 'åŠ›è¡¨æ•¸æ“š');
      
      // å‰µå»ºçµ±è¨ˆå·¥ä½œè¡¨
      const powerRanges = {
        '0-999': 0,
        '1000-1999': 0,
        '2000-2999': 0,
        '3000-3999': 0,
        '4000+': 0
      };
      
      data.forEach(row => {
        const totalPower = parseInt(row[6]) || 0; // ç¸½æˆ°åŠ›åœ¨ç¬¬7åˆ—
        if (totalPower < 1000) powerRanges['0-999']++;
        else if (totalPower < 2000) powerRanges['1000-1999']++;
        else if (totalPower < 3000) powerRanges['2000-2999']++;
        else if (totalPower < 4000) powerRanges['3000-3999']++;
        else powerRanges['4000+']++;
      });
      
      const statsData = [
        ['æˆ°åŠ›ç¯„åœ', 'è§’è‰²æ•¸é‡'],
        ...Object.entries(powerRanges).map(([range, count]) => [range, count])
      ];
      
      const wsStats = (window as any).XLSX.utils.aoa_to_sheet(statsData);
      wsStats['!cols'] = [{ wch: 15 }, { wch: 10 }];
      (window as any).XLSX.utils.book_append_sheet(wb, wsStats, 'çµ±è¨ˆä¿¡æ¯');
      
      // å‰µå»ºæ‘˜è¦å·¥ä½œè¡¨
      const summaryData = [
        ['åŠ›è¡¨åŒ¯å‡ºå ±å‘Š'],
        [''],
        ['åŒ¯å‡ºæ™‚é–“', new Date().toLocaleString('zh-TW')],
        ['ç¸½è§’è‰²æ•¸', data.length],
        [''],
        ['æˆ°åŠ›çµ±è¨ˆ'],
        ['æœ€é«˜æˆ°åŠ›', Math.max(...data.map(row => parseInt(row[6]) || 0))],
        ['æœ€ä½æˆ°åŠ›', Math.min(...data.map(row => parseInt(row[6]) || 0))],
        ['å¹³å‡æˆ°åŠ›', Math.round(data.reduce((sum, row) => sum + (parseInt(row[6]) || 0), 0) / data.length)],
        [''],
        ['è»éšŠåˆ†å¸ƒ'],
        ...Object.entries(
          data.reduce((acc, row) => {
            const armyName = row[1] || 'æœªçŸ¥'; // å‡è¨­è»éšŠåç¨±åœ¨ç¬¬2åˆ—
            acc[armyName] = (acc[armyName] || 0) + 1;
            return acc;
          }, {} as Record<string, number>)
        ).sort((a, b) => b[1] - a[1])
      ];
      
      const wsSummary = (window as any).XLSX.utils.aoa_to_sheet(summaryData);
      wsSummary['!cols'] = [{ wch: 20 }, { wch: 15 }];
      (window as any).XLSX.utils.book_append_sheet(wb, wsSummary, 'æ‘˜è¦å ±å‘Š');
      
      // ç”Ÿæˆ xlsx æ–‡ä»¶ä¸¦ä¸‹è¼‰
      const fileName = `åŠ›è¡¨_${new Date().toISOString().slice(0, 10)}.xlsx`;
      (window as any).XLSX.writeFile(wb, fileName);
      
      console.log('âœ… è¡¨æ ¼åŒ¯å‡ºæˆåŠŸ');
      showAlert('è¡¨æ ¼åŒ¯å‡ºæˆåŠŸï¼', 'success', 2000);
      
    } catch (error) {
      console.error('âŒ åŒ¯å‡ºå¤±æ•—:', error);
      showAlert(`åŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error', 3000);
    } finally {
      // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
      exportBtn.disabled = false;
      exportBtn.innerHTML = `
        <span>åŒ¯å‡ºè¡¨æ ¼</span>
        <div style="
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
          transition: left 0.5s ease;
        "></div>
      `;
      exportBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
      exportBtn.style.transform = 'translateY(0) scale(1)';
      exportBtn.style.boxShadow = '0 8px 25px rgba(40, 167, 69, 0.4)';
    }
  }

  // ä¸»å‡½æ•¸
  document.addEventListener("DOMContentLoaded", async function () {
    // ç¶å®šåŒæ­¥æŒ‰éˆ•äº‹ä»¶
    const syncBtn = document.getElementById('sync-all-btn') as HTMLButtonElement;
    if (syncBtn) {
      syncBtn.addEventListener('click', syncAllCharacters);
      
      // æ·»åŠ æ‡¸åœæ•ˆæœ
      syncBtn.addEventListener('mouseover', () => {
        if (!syncBtn.disabled) {
          syncBtn.style.background = 'linear-gradient(135deg, #764ba2 0%, #667eea 100%)';
          syncBtn.style.transform = 'translateY(-2px) scale(1.04)';
          syncBtn.style.boxShadow = '0 12px 35px rgba(102, 126, 234, 0.6)';
          
          // å•Ÿå‹•é–ƒå…‰æ•ˆæœ
          const shine = syncBtn.querySelector('div') as HTMLElement;
          if (shine) {
            shine.style.left = '100%';
          }
          
          // æ—‹è½‰åœ–æ¨™
          const icon = syncBtn.querySelector('span') as HTMLElement;
          if (icon) {
            // icon.style.transform = 'rotate(180deg)';
          }
        }
      });
      
      syncBtn.addEventListener('mouseout', () => {
        if (!syncBtn.disabled) {
          syncBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          syncBtn.style.transform = 'translateY(0) scale(1)';
          syncBtn.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.4)';
          
          // é‡ç½®é–ƒå…‰æ•ˆæœ
          const shine = syncBtn.querySelector('div') as HTMLElement;
          if (shine) {
            shine.style.left = '-100%';
          }
          
          // é‡ç½®åœ–æ¨™
          const icon = syncBtn.querySelector('span') as HTMLElement;
          if (icon) {
            // icon.style.transform = 'rotate(0deg)';
          }
        }
      });
      
      // æ·»åŠ é»æ“Šæ•ˆæœ
      syncBtn.addEventListener('mousedown', () => {
        if (!syncBtn.disabled) {
          syncBtn.style.transform = 'translateY(-1px) scale(0.98)';
        }
      });
      
      syncBtn.addEventListener('mouseup', () => {
        if (!syncBtn.disabled) {
          syncBtn.style.transform = 'translateY(-3px) scale(1.05)';
        }
      });
    }
    
    // ç¶å®šåŒ¯å‡ºæŒ‰éˆ•äº‹ä»¶
    const exportBtn = document.getElementById('export-btn') as HTMLButtonElement;
    if (exportBtn) {
      exportBtn.addEventListener('click', exportToExcel);
      
      // æ·»åŠ æ‡¸åœæ•ˆæœ
      exportBtn.addEventListener('mouseover', () => {
        if (!exportBtn.disabled) {
          exportBtn.style.background = 'linear-gradient(135deg, #20c997 0%, #19a77d 100%)';
          exportBtn.style.transform = 'translateY(-2px) scale(1.04)';
          exportBtn.style.boxShadow = '0 12px 35px rgba(32, 201, 151, 0.6)';
          
          // å•Ÿå‹•é–ƒå…‰æ•ˆæœ
          const shine = exportBtn.querySelector('div') as HTMLElement;
          if (shine) {
            shine.style.left = '100%';
          }
          
          // æ—‹è½‰åœ–æ¨™
          const icon = exportBtn.querySelector('span') as HTMLElement;
          if (icon) {
            // icon.style.transform = 'rotate(180deg)';
          }
        }
      });
      
      exportBtn.addEventListener('mouseout', () => {
        if (!exportBtn.disabled) {
          exportBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
          exportBtn.style.transform = 'translateY(0) scale(1)';
          exportBtn.style.boxShadow = '0 8px 25px rgba(40, 167, 69, 0.4)';
          
          // é‡ç½®é–ƒå…‰æ•ˆæœ
          const shine = exportBtn.querySelector('div') as HTMLElement;
          if (shine) {
            shine.style.left = '-100%';
          }
          
          // é‡ç½®åœ–æ¨™
          const icon = exportBtn.querySelector('span') as HTMLElement;
          if (icon) {
            // icon.style.transform = 'rotate(0deg)';
          }
        }
      });
      
      // æ·»åŠ é»æ“Šæ•ˆæœ
      exportBtn.addEventListener('mousedown', () => {
        if (!exportBtn.disabled) {
          exportBtn.style.transform = 'translateY(-1px) scale(0.98)';
        }
      });
      
      exportBtn.addEventListener('mouseup', () => {
        if (!exportBtn.disabled) {
          exportBtn.style.transform = 'translateY(-3px) scale(1.05)';
        }
      });
    }
    
    // è‡ªå‹•æ¸…ç†æš«å­˜ï¼Œç¢ºä¿æ¯æ¬¡è¼‰å…¥éƒ½æ˜¯æœ€æ–°è³‡æ–™
    try {
      const storageKey = 'character_power_cache';
      if (localStorage.getItem(storageKey)) {
        console.log('ğŸ§¹ æ¸…é™¤èˆŠçš„ character_power_cache');
        localStorage.removeItem(storageKey);
      }
    } catch (e) {
      console.warn('ç„¡æ³•æ¸…é™¤ localStorage æš«å­˜:', e);
    }
    try {
      // æ·»åŠ  CSS æ¨£å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes saveSuccess {
          0% { background-color: transparent; }
          30% { background-color: rgba(76, 175, 80, 0.3); }
          100% { background-color: transparent; }
        }
        
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        
        .save-success {
          animation: saveSuccess 1s ease-in-out;
        }

        /* æ­£åœ¨ç·¨è¼¯æ™‚çš„è¡Œé«˜äº® */
        .editing {
          background-color: rgba(255, 223, 0, 0.2);
        }

        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ */
        #power-list input[type="number"]::-webkit-outer-spin-button,
        #power-list input[type="number"]::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }

        #power-list input[type="number"] {
          -moz-appearance: textfield;
        }

        /* é™ä½åœ–ç‰‡è§£æåº¦ä½†ä¿æŒé¡¯ç¤ºå¤§å° */
        #level-container img {
          image-rendering: optimizeSpeed;
          image-rendering: -moz-crisp-edges;
          image-rendering: -webkit-optimize-contrast;
          image-rendering: optimize-contrast;
          image-rendering: pixelated;
          -ms-interpolation-mode: nearest-neighbor;
        }
      `;
      document.head.appendChild(style);
      // ä½¿ç”¨å…±ç”¨çš„è§’è‰²æœå‹™
      const characterService = (await import('../services/characterService')).default.getInstance();
      const data = await characterService.getCharacters();
      
      // è¨ˆç®—æ¯å€‹è§’è‰²çš„ç¸½æˆ°åŠ›ä¸¦ç²å–æ­¦å™¨è³‡è¨Š
      const charactersWithPower = await Promise.all(
        data.map(async (character, index) => {
          try {
            // æª¢æŸ¥æ˜¯å¦æœ‰æš«å­˜çš„æˆ°åŠ›æ•¸æ“š
            const cachedData = getFromLocalStorage(character.name);
            if (cachedData) {
              console.log(`ä½¿ç”¨æš«å­˜çš„æˆ°åŠ›æ•¸æ“š: ${character.name}`);
              return {
                ...character,
                totalPower: cachedData.totalPower,
                physicPower: cachedData.physicPower,
                magicPower: cachedData.magicPower,
                utilityPower: cachedData.utilityPower + (cachedData.hasBonus ? cachedData.weaponBonus : 0),
                originalUtilityPower: cachedData.utilityPower,
                weaponBonus: cachedData.weaponBonus,
                hasBonus: cachedData.hasBonus,
                weaponData: cachedData.weaponData
              };
            }
            
            // åŸºæœ¬èƒ½åŠ›å€¼
            const physicPower = parseInt(String(character?.physicPower || 0), 10);
            const magicPower  = parseInt(String(character?.magicPower  || 0), 10);
            const utilityPower = parseInt(String(character.utilityPower || 0), 10); // ç›´æ¥ä½¿ç”¨è³‡æ–™åº«ä¸­çš„ utility
            const originalUtilityPower = utilityPower;

            // é€é damageWithWeapon API å–å¾—ç¸½æˆ°åŠ›
            const ownerName = character.name || '';
            let totalPower = physicPower + magicPower + utilityPower;
            
            // æ·»åŠ å»¶é²ä»¥é¿å… 429 éŒ¯èª¤
            if (index > 0) {
              await new Promise(resolve => setTimeout(resolve, 100 * index)); // æ¯å€‹è«‹æ±‚é–“éš” 100ms
            }
            
            try {
              // ä½¿ç”¨æ–°çš„å‚·å®³è¨ˆç®—æœå‹™
              const damageService = (await import('../services/damageService')).default.getInstance();
              const damageValue = await damageService.getCharacterDamage(ownerName);
              if (damageValue > 0) {
                totalPower = damageValue;
              }
            } catch (e) {
              console.error(`damageWithWeapon API error for ${ownerName}:`, e);
            }

            // è¨ˆç®—æ­¦å™¨åŠ æˆ
            const weaponBonus = totalPower - (physicPower + magicPower + utilityPower);
            const hasBonus = weaponBonus > 0;

            return {
              ...character,
              totalPower,
              physicPower,
              magicPower,
              utilityPower,          // ç›´æ¥ç”¨ utility ä½œç‚ºæ­¦å™¨æˆ°åŠ›
              originalUtilityPower,
              weaponBonus,
              hasBonus,
              weaponData: null
            };
          } catch (error) {
            console.error(`Error fetching weapon info for ${character.name}:`, error);
            const originalUtilityPower = parseInt(String(character.utilityPower || 0), 10);
            return {
              ...character,
              totalPower: parseInt(String(character.physicPower || 0), 10) + 
                          parseInt(String(character.magicPower || 0), 10) + 
                          parseInt(String(character.utilityPower || 0), 10),
              physicPower: parseInt(String(character.physicPower || 0), 10),
              magicPower: parseInt(String(character.magicPower || 0), 10),
              utilityPower: parseInt(String(character.utilityPower || 0), 10),
              originalUtilityPower, // ä¿å­˜åŸå§‹æ­¦å™¨æˆ°åŠ›å€¼
              weaponBonus: 0, // ç„¡æ­¦å™¨åŠ æˆ
              hasBonus: false,
              weaponData: null
            };
          }
        })
      );

      // éæ¿¾æ‰æˆ°åŠ›ç‚º0çš„è§’è‰²å’Œæ²’æœ‰åœ–ç‰‡çš„è§’è‰²
      const validCharacters = await Promise.all(
        charactersWithPower.filter(char => char.totalPower > 0).map(async (character) => {
            const imagePath = `${PEOPLE_IMAGE_URL}/${character.name || 'default'}.png`;
          const hasImage = await checkImageExists(imagePath);
          return hasImage ? character : null;
        })
      );
      
      const filteredCharacters = validCharacters.filter(char => char !== null);
      filteredCharacters.sort((a, b) => b.totalPower - a.totalPower);

      // å‰µå»ºæˆ°åŠ›åˆ—è¡¨
      createPowerList(charactersWithPower);

      // å‹•æ…‹ç”ŸæˆSSåŠä»¥ä¸Šç­‰ç´š
      const POWER_LEVELS = [...BASE_POWER_LEVELS];
      const maxPower = filteredCharacters.length > 0 ? filteredCharacters[0].totalPower : 0;
      let currentMin = 3600;
      let levelIndex = 1;
      let multiplier = 1.0;
      
      while (currentMin <= maxPower) {
        multiplier *= 1.2;
        const levelSize = Math.floor(1000 * multiplier);
        const levelMax = currentMin + levelSize - 1;
        const levelName = "Level " + "S".repeat(levelIndex + 1);
        const redValue = Math.max(50, 255 - (levelIndex * 20));
        const color = `rgb(${redValue}, 0, 0)`;
        
        POWER_LEVELS.unshift({
          name: levelName,
          min: currentMin,
          max: levelMax,
          color: color
        });
        
        currentMin = levelMax + 1;
        levelIndex++;
      }

      // å°‡è§’è‰²åˆ†é…åˆ°å„å€‹ç­‰ç´š
      const levelGroups = {};
      POWER_LEVELS.forEach(level => {
        levelGroups[level.name] = [];
      });

      filteredCharacters.forEach(character => {
        for (let i = 0; i < POWER_LEVELS.length; i++) {
          if (character.totalPower >= POWER_LEVELS[i].min && character.totalPower <= POWER_LEVELS[i].max) {
            levelGroups[POWER_LEVELS[i].name].push(character);
            break;
          }
        }
      });

      // å‰µå»º UI
      const mainContainer = document.createElement('div');
      mainContainer.className = 'level-groups';

      // å¾ä½åˆ°é«˜é¡¯ç¤ºç­‰ç´šï¼Œè·³éæ²’æœ‰è§’è‰²çš„ç­‰ç´š
      POWER_LEVELS.reverse().forEach(level => {
        const characters = levelGroups[level.name];
        if (characters.length === 0) return;
        mainContainer.appendChild(createLevelContainer(level, characters));
      });

      const container = document.getElementById('level-container');
      if (container) {
        container.appendChild(mainContainer);
      }
    } catch (error) {
      console.error('Error loading Levellist:', error);
      
      // é¡¯ç¤ºç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤è¨Šæ¯
      if (typeof (window as any).Swal !== 'undefined') {
        (window as any).Swal.fire({
          title: 'è¼‰å…¥å¤±æ•—',
          text: `ç„¡æ³•è¼‰å…¥è§’è‰²æ•¸æ“š: ${error.message}`,
          icon: 'error',
          confirmButtonText: 'é‡æ–°æ•´ç†',
          showCancelButton: true,
          cancelButtonText: 'å–æ¶ˆ'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.reload();
          }
        });
      } else {
        alert(`è¼‰å…¥å¤±æ•—: ${error.message}`);
      }
    }
  });
</script>
