<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>People Info</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
    />
    <style>
      .table {
        background-color: #000; /* 黑色背景 */
        color: #fff; /* 白色文本 */
      }

      .table th, .table td {
        border: 1px solid #444; 
        color: #fff;
      }

      .table thead th {
        background-color: #222; /* 表头背景颜色 */
      }

      .table-striped tbody tr:nth-of-type(odd) {
        background-color: #111; /* 奇数行背景颜色 */
      }

      .table-striped tbody tr:nth-of-type(even) {
        background-color: #000; /* 偶数行背景颜色 */
      }

      /* 可选：自定义按钮样式 */
      button {
        margin: 5px;
      }
    </style>
  </head>

  <body>
    <div class="content mt-3">
      <div class="animated fadeIn">
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header">
                <strong class="card-title">Palais</strong>
                <div class="container">
                  <div class="mainbox">
                    <div class="iconContainer">
                        <path
                          d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"
                        ></path>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body" style="overflow-x: auto; -webkit-overflow-scrolling: touch; max-width: 85%; background-color: black;">
                <table
                  id="bootstrap-data-table"
                  class="table table-striped table-bordered"
                  style="width: 100%;"
                >
                  <thead>
                    <tr>
                        <th>Name</th>
                        <th>Original Name</th>
                        <th>Code Name</th>
                        <th>Physical Power</th>
                        <th>Magic Power</th>
                        <th>Utility Power</th>
                        <th>Date of Birth</th>
                        <th>Race</th>
                        <th>Attributes</th>
                        <th>Gender</th>
                        <th>Ass Size</th>
                        <th>Boobs Size</th>
                        <th>Height (cm)</th>
                        <th>Weight (kg)</th>
                        <th>Profession</th>
                        <th>Combat</th>
                        <th>Favorite Foods</th>
                        <th>Job</th>
                        <th>Physics</th>
                        <th>Known As</th>
                        <th>Personally</th>
                        <th>Main Weapon</th>
                        <th>Sub Weapon</th>
                        <th>Interest</th>
                        <th>Likes</th>
                        <th>Dislikes</th>
                        <th>Concubine</th>
                        <th>Faction</th>
                        <th>Army ID</th>
                        <th>Army Name</th>
                        <th>Department ID</th>
                        <th>Department Name</th>
                        <th>Origin Army ID</th>
                        <th>Origin Army Name</th>
                        <th>Gave Birth</th>
                        <th>Email</th>
                        <th>Age</th>
                        <th>Proxy</th>
                        <th>Hei</th>
                        <th>Physics Fallout 4</th>
                        <th>HR Ratio</th>
                    </tr>
                  </thead>
                  <tbody id="peopleTableBody">
                    <!-- Data rows will be inserted here -->
                  </tbody>
                </table>

              </div>
            </div>
            <!-- 定義儲存與編輯及新增按鈕 -->
            <button id="save-button-edit" disabled>Save Edit</button>
            <button id="edit-button">Edit</button>
            <button id="save-button-add" disabled>Save Add</button>
            <button id="add-button">Add</button>
          </div>
        </div>
      </div>
      <!-- .animated -->
    </div>
    <!-- .content -->

    <!-- Script -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript">
      async function findPeople() {
        if ($.fn.DataTable && $.fn.DataTable.isDataTable("#bootstrap-data-table")) {
            $("#bootstrap-data-table").DataTable().destroy();
        }
        const url = "https://peoplesystem.tatdvsonorth.com/people/get-all";
        try {
          const response = await axios.post(url);
          const people  = response.data;
          const tableBody = document.getElementById("peopleTableBody");
          tableBody.innerHTML = "";

          people.forEach((people) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.name}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.nameOriginal}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.codeName}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.physicPower}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.magicPower}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.utilityPower}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.dob}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.race}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.attributes}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.gender}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.assSize}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.boobsSize}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.heightCm}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.weightKg}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.profession}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.combat}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.favoriteFoods}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.job}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.physics}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.knownAs}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.personally}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.mainWeapon}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.subWeapon}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.interest}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.likes}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.dislikes}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.concubine}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.faction}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.armyId}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.armyName}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.deptId}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.deptName}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.originArmyId}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.originArmyName}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.gaveBirth}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.email}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.age}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.proxy}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.hei}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.physicsFallout4}</td>
              <td style="background-color: rgba(255, 255, 255, 0.3); color: #fff; position: relative;">${people.hrratio}</td>
            `;
            tableBody.appendChild(row);
          });
          $("#bootstrap-data-table").DataTable({
            paging: true,
            searching: true,
            lengthChange: true,
          });
        } catch (error) {
          console.error("Error fetching people data:", error);
        }
      }

      let editMode = false;
      let editedRow = null;
      let newRowAdded = false;

      // 切換編輯模式的函數
      function toggleEditMode() {
        const table = document.querySelector("table");
        if (editMode) {
          document.getElementById("save-button-edit").disabled = false;
          document.getElementById("edit-button").disabled = true;
          document.getElementById("save-button-add").disabled = true;
          document.getElementById("add-button").disabled = true;
        } else {
          document.getElementById("save-button-edit").disabled = true;
          document.getElementById("edit-button").disabled = false;
          document.getElementById("save-button-add").disabled = false;
          document.getElementById("add-button").disabled = false;
          if (editedRow) {
            const cells = editedRow.querySelectorAll("td");
            cells.forEach((cell) => {
              cell.contentEditable = false;
              if (!cell.classList.contains("deptInfo")) {
                cell.classList.remove("editable");
              }
            });
            editedRow = null;
          }
        }
      }

      // 儲存修改按鈕點擊事件的處理函數
      document
        .getElementById("save-button-edit")
        .addEventListener("click", () => {
          const table = document.querySelector("table");
          if (editedRow) {
            const cells = editedRow.querySelectorAll("td");
            const headers = Array.from(table.querySelectorAll("thead th")).map(
              (th) => th.textContent
            );
            const rowData = {};
            cells.forEach((cell, i) => {
              if (i > 0) {
                rowData[headers[i]] = cell.textContent;
              }
            });
            console.log(JSON.stringify(rowData, null, 2));
            console.log(rowData);
            Promise.all([
              axios.post(
                "https://peoplesystem.tatdvsonorth.com/people/update",
                rowData
              ),
            ])
              .then((responses) => {
                console.log(responses[0].data);
                editMode = false;
                const allCells = table.querySelectorAll("td");
                allCells.forEach((cell) => {
                  cell.contentEditable = false;
                  if (!cell.classList.contains("deptInfo")) {
                    cell.classList.remove("editable");
                  }
                });
                document.getElementById("edit-button").disabled = false;
                document.getElementById("add-button").disabled = false;
                toggleEditMode();
                window.location.reload();
              })
              .catch((error) => {
                console.error("Error saving data:", error);
              });
          }
        });

      // 儲存新增按鈕點擊事件的處理函數
      document
        .getElementById("save-button-add")
        .addEventListener("click", () => {
          const table = document.querySelector("table");
          if (newRowAdded) {
            const newRow = table.querySelector("tbody tr:last-child");
            const cells = newRow.querySelectorAll("td");
            const headers = Array.from(table.querySelectorAll("thead th")).map(
              (th) => th.textContent
            );
            const rowData = {};
            cells.forEach((cell, i) => {
              if (i > 0) {
                rowData[headers[i]] = cell.textContent;
              }
            });
            console.log(JSON.stringify(rowData, null, 2));
            console.log(rowData);
            Promise.all([
              axios.post(
                "https://peoplesystem.tatdvsonorth.com/people/insert",
                rowData
              ),
            ])
              .then((responses) => {
                console.log(responses[0].data);
                newRowAdded = false;
                editMode = false;
                const allCells = table.querySelectorAll("td");
                allCells.forEach((cell) => {
                  cell.contentEditable = false;
                  if (!cell.classList.contains("deptInfo")) {
                    cell.classList.remove("editable");
                  }
                });
                document.getElementById("edit-button").disabled = false;
                document.getElementById("add-button").disabled = false;
                toggleEditMode();
                window.location.reload();
              })
              .catch((error) => {
                console.error("Error saving data:", error);
              });
          }
        });

      // 新增按鈕點擊事件的處理函數
      document.getElementById("add-button").addEventListener("click", () => {
        const table = document.querySelector("table");
        const newRow = table.insertRow(-1);
        newRow.innerHTML =
          '<td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>';
        newRowAdded = true;
        editMode = true;
        document.getElementById("save-button-add").disabled = false;
        document.getElementById("edit-button").disabled = true;
        document.getElementById("save-button-edit").disabled = true;
        document.getElementById("add-button").disabled = true;
      });

      document.getElementById("edit-button").addEventListener("click", () => {
        if (editMode) {
          toggleEditMode();
        } else {
          const table = document.querySelector("table");
          const allCells = table.querySelectorAll("td");
          allCells.forEach((cell) => {
            if (!cell.classList.contains("deptInfo")) {
              cell.contentEditable = true;
              cell.classList.add("editable");
            }
          });
          editMode = true;
          toggleEditMode();
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        findPeople();
      });

      // 表格儲存格點擊事件的處理函數
      document.querySelector('table').addEventListener('click', (event) => {
        if (event.target.tagName === 'TD' && editMode) {
          if (editedRow && editedRow !== event.target.parentElement) {
            const previousCells = editedRow.querySelectorAll('td');
            previousCells.forEach(cell => {
              cell.contentEditable = false;
            });

            if (newRowAdded) {
              editedRow.remove();
              newRowAdded = false;
            }
          }
          editedRow = event.target.parentElement;
          const cells = editedRow.querySelectorAll('td');
          cells.forEach((cell, index) => {
              if (index > 0) {
                cell.contentEditable = true;
              }
          });
        }
      });

      // 點擊表格以外的地方時，恢復按鈕狀態
      document.addEventListener('click', (event) => {
        const table = document.querySelector('table');
        const tbody = table.querySelector('tbody');
        const target = event.target;
        if (editMode && !tbody.contains(target) && !['BUTTON'].includes(target.tagName)) {
          if (editMode) {
            if (editedRow) {
              const cells = editedRow.querySelectorAll('td');
              cells.forEach(cell => {
                cell.contentEditable = false; 
              });
              editedRow = null;
            }
            editMode = false;
          }

          // 如果新行已添加，移除新增行
          if (newRowAdded) {
            const lastRow = tbody.querySelector('tr:last-child');
            if (lastRow) {
              lastRow.remove();
            }
            newRowAdded = false;
          }
          // 恢復按鈕狀態為僅允許 "Save Edit" 和 "Save Add" 可點擊
          document.getElementById('save-button-edit').disabled = true;
          document.getElementById('edit-button').disabled = false;
          document.getElementById('save-button-add').disabled = true;
          document.getElementById('add-button').disabled = false;
        }
      });

    </script>
  </body>
</html>
