---
import { } from 'astro';
import '../styles/qabotv2.css';
---

<!-- v2 æ§åˆ¶åˆ—ï¼šæ’å…¥å…±ç”¨ qa-bot-container ä¸­ï¼ˆheader ä¸‹æ–¹å³å¯ï¼‰ -->
<div class="control-row" id="qaV2Controls" style="display:none">
  <label>
    Model
    <select id="v2Model"></select>
  </label>
  <label style="display:flex;align-items:center;gap:6px;">
    <input type="checkbox" id="v2UseKb" checked /> TY çŸ¥è­˜åº«
  </label>
</div>

<script>
  import { getApiBaseUrl, getOrCreateUserId, escapeHtml } from '../scripts/qabotShared';

  class QABotV2 {
    private messagesEl: HTMLElement;
    private inputEl: HTMLInputElement;
    private sendBtn: HTMLButtonElement;
    private modelSel: HTMLSelectElement;
    private kbEl: HTMLInputElement;
    private userId: string;
    private apiBase: string;
    private pollingTasks: Map<string, NodeJS.Timeout> = new Map();

    constructor() {
      // å°‡æ§åˆ¶åˆ—ç§»åˆ° header åº•ä¸‹ï¼ˆè‹¥å°šæœªåœ¨æ­£ç¢ºä½ç½®ï¼‰
      const container = document.getElementById('qaBotContainer') as HTMLElement;
      const header = container?.querySelector('.chat-header') as HTMLElement | null;
      const controls = document.getElementById('qaV2Controls') as HTMLElement;
      if (container && header && controls && controls.parentElement !== container) {
        container.insertBefore(controls, container.children[1]);
      }

      this.messagesEl = document.getElementById('chatMessages') as HTMLElement;
      this.inputEl = document.getElementById('userInput') as HTMLInputElement;
      this.sendBtn = document.getElementById('sendButton') as HTMLButtonElement;
      this.modelSel = document.getElementById('v2Model') as HTMLSelectElement;
      this.kbEl = document.getElementById('v2UseKb') as HTMLInputElement;
      this.userId = getOrCreateUserId('qabot_user_id');
      this.apiBase = getApiBaseUrl();

      this.bindEvents();
      this.loadModels();
    }

    private bindEvents() {
      this.sendBtn.addEventListener('click', () => this.ask());
      this.inputEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if ((window as any).qabotMode === 'v2') this.ask();
        }
      });
    }

    public show() { (document.getElementById('qaV2Controls') as HTMLElement).style.display = 'flex'; }
    public hide() { (document.getElementById('qaV2Controls') as HTMLElement).style.display = 'none'; }

    private appendMessage(html: string) {
      const div = document.createElement('div');
      div.innerHTML = html;
      this.messagesEl.appendChild(div);
      this.messagesEl.scrollTop = this.messagesEl.scrollHeight;
    }

    private async loadModels() {
      try {
        const resp = await fetch(`${this.apiBase}/maya-v2/available-models/`, { credentials: 'include' });
        if (!resp.ok) throw new Error(`models ${resp.status}`);
        const data = await resp.json();
        
        console.log('Models API response:', data);
        
        // è§£æ API å›æ‡‰æ ¼å¼ - æ”¯æ´ {models: [...]} å’Œç›´æ¥é™£åˆ—å…©ç¨®æ ¼å¼
        const models = data?.models || (Array.isArray(data) ? data : []);
        const activeModels = models.filter((m: any) => m.is_active === true);
        
        console.log('Active models:', activeModels);
        
        this.modelSel.innerHTML = '';
        activeModels.forEach((m: any) => {
          const opt = document.createElement('option');
          opt.value = m.model_id || m.name; // å„ªå…ˆä½¿ç”¨ model_idï¼Œå¦å‰‡ä½¿ç”¨ name
          opt.textContent = m.name;
          this.modelSel.appendChild(opt);
          console.log('Added model option:', m.name, 'with value:', opt.value);
        });
        
        // è¨­å®šé è¨­é¸é …
        if (!this.modelSel.value && activeModels.length > 0) {
          this.modelSel.value = activeModels[0].model_id || activeModels[0].name;
          console.log('Set default model:', this.modelSel.value);
        }
      } catch (e) {
        console.error('Failed to load models:', e);
        this.modelSel.innerHTML = '<option value="">ç„¡æ³•è¼‰å…¥æ¨¡å‹</option>';
      }
    }

    private async ask() {
      const q = this.inputEl.value.trim();
      if (!q) return;
      this.inputEl.value = '';
      
      // é¡¯ç¤ºç”¨æˆ¶æ¶ˆæ¯
      this.appendMessage(`<div class=\"message user-message\"><div class=\"message-content\"><p>${escapeHtml(q)}</p></div></div>`);
      
      // é¡¯ç¤ºç­‰å¾…UI
      this.showLoadingMessage();
      
      try {
        const payload = {
          question: q,
          model_name: this.modelSel.value,
          sync: false, // ä½¿ç”¨ç•°æ­¥è™•ç†
          use_knowledge_base: !!this.kbEl.checked
        };
        
        const resp = await fetch(`${this.apiBase}/maya-v2/ask-with-model/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          credentials: 'include'
        });
        
        if (!resp.ok) throw new Error(`ask ${resp.status}`);
        const data = await resp.json();
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ task_id
        if (data.task_id) {
          // é–‹å§‹è¼ªè©¢ä»»å‹™ç‹€æ…‹
          this.startPollingTask(data.task_id, q);
        } else {
          throw new Error('æœªæ”¶åˆ°ä»»å‹™ID');
        }
      } catch (e) {
        // éš±è—ç­‰å¾…UI
        this.hideLoadingMessage();
        this.appendMessage(`<div class=\"message bot-message\"><div class=\"message-content\"><p style=\"color:#b91c1c\">âŒ ${escapeHtml((e as Error).message)}</p></div></div>`);
      }
    }

    private startPollingTask(taskId: string, originalQuestion: string) {
      // æ¸…é™¤ä¹‹å‰çš„è¼ªè©¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (this.pollingTasks.has(taskId)) {
        clearTimeout(this.pollingTasks.get(taskId)!);
      }

      const pollTask = async () => {
        try {
          const resp = await fetch(`${this.apiBase}/maya-v2/task-status/${taskId}`, {
            credentials: 'include'
          });
          
          if (!resp.ok) throw new Error(`task status ${resp.status}`);
          const data = await resp.json();
          
          // èª¿è©¦ä¿¡æ¯
          console.log('Task status response:', data);
          
          switch (data.status) {
            case 'SUCCESS':
              // ä»»å‹™å®Œæˆ
              console.log('Task completed successfully:', data);
              this.hideLoadingMessage();
              this.displayAIResponse(data);
              this.pollingTasks.delete(taskId);
              break;
              
            case 'FAILURE':
              // ä»»å‹™å¤±æ•—
              console.log('Task failed:', data);
              this.hideLoadingMessage();
              const errorMsg = data.error || 'ä»»å‹™è™•ç†å¤±æ•—';
              this.appendMessage(`<div class=\"message bot-message\"><div class=\"message-content\"><p style=\"color:#b91c1c\">âŒ ${escapeHtml(errorMsg)}</p></div></div>`);
              this.pollingTasks.delete(taskId);
              break;
              
            case 'PENDING':
            case 'STARTED':
              // ä»»å‹™ä»åœ¨è™•ç†ä¸­ï¼Œç¹¼çºŒè¼ªè©¢
              console.log('Task still processing:', data.status);
              this.updateLoadingMessage(data.status === 'STARTED' ? 'è™•ç†ä¸­...' : 'ç­‰å¾…ä¸­...');
              this.pollingTasks.set(taskId, setTimeout(pollTask, 2000)); // 2ç§’å¾Œå†æ¬¡æª¢æŸ¥
              break;
              
            default:
              // æœªçŸ¥ç‹€æ…‹
              console.log('Unknown task status:', data.status);
              this.hideLoadingMessage();
              this.appendMessage(`<div class=\"message bot-message\"><div class=\"message-content\"><p style=\"color:#b91c1c\">âŒ æœªçŸ¥ä»»å‹™ç‹€æ…‹: ${data.status}</p></div></div>`);
              this.pollingTasks.delete(taskId);
          }
        } catch (e) {
          // è¼ªè©¢éŒ¯èª¤
          console.error('Polling error:', e);
          this.hideLoadingMessage();
          this.appendMessage(`<div class=\"message bot-message\"><div class=\"message-content\"><p style=\"color:#b91c1c\">âŒ è¼ªè©¢ä»»å‹™ç‹€æ…‹å¤±æ•—: ${escapeHtml((e as Error).message)}</p></div></div>`);
          this.pollingTasks.delete(taskId);
        }
      };

      // é–‹å§‹è¼ªè©¢
      this.pollingTasks.set(taskId, setTimeout(pollTask, 1000)); // 1ç§’å¾Œé–‹å§‹ç¬¬ä¸€æ¬¡æª¢æŸ¥
    }

    private showLoadingMessage() {
      const loadingEl = document.getElementById('loadingMessage') as HTMLElement;
      if (loadingEl) {
        const clone = loadingEl.cloneNode(true) as HTMLElement;
        clone.style.display = 'block';
        clone.id = 'v2LoadingMessage';
        this.messagesEl.appendChild(clone);
        this.messagesEl.scrollTop = this.messagesEl.scrollHeight;
      }
    }

    private updateLoadingMessage(message: string) {
      const loadingEl = document.getElementById('v2LoadingMessage');
      if (loadingEl) {
        const messageEl = loadingEl.querySelector('.loading-text');
        if (messageEl) {
          messageEl.textContent = message;
        }
      }
    }

    private hideLoadingMessage() {
      const loadingEl = document.getElementById('v2LoadingMessage');
      if (loadingEl) {
        loadingEl.remove();
      }
    }

    private displayAIResponse(data: any) {
      try {
        // å»ºç«‹ä¸»è¦çš„AIå›æ‡‰å®¹å™¨
        const aiResponse = data.ai_response || data.text || data.answer || '';
        const modelInfo = data.ai_model || {};
        const knowledgeUsed = data.knowledge_used || false;
        const citations = data.knowledge_citations || [];

        // åˆ†å‰²AIå›æ‡‰ä»¥æå–ä¸»è¦å…§å®¹å’ŒçŸ¥è­˜åº«å…§å®¹
        const responseText = this.formatAIResponse(aiResponse);
        
        // å»ºç«‹å®Œæ•´çš„å›æ‡‰HTML
        let responseHTML = `
          <div class=\"message bot-message\">
            <div class=\"message-content-wrapper\">
              <div class=\"message-header\">
                <span class=\"ai-name\">${escapeHtml(modelInfo.name || 'AI')}</span>
                ${knowledgeUsed ? '<span class=\"knowledge-badge\">ğŸ§  çŸ¥è­˜åº«</span>' : ''}
              </div>
              <div class=\"message-content\">
                ${responseText}
              </div>
              ${citations.length > 0 ? this.buildCitationsHTML(citations) : ''}
            </div>
          </div>
        `;
        
        this.appendMessage(responseHTML);
      } catch (e) {
        console.error('Error displaying AI response:', e);
        this.appendMessage(`<div class=\"message bot-message\"><div class=\"message-content\"><p style=\"color:#b91c1c\">âŒ å›æ‡‰æ ¼å¼éŒ¯èª¤</p></div></div>`);
      }
    }

    private formatAIResponse(response: string): string {
      if (!response) return '<p>ç„¡å›æ‡‰å…§å®¹</p>';
      
      // åˆ†å‰²ä¸»è¦å›æ‡‰å’ŒçŸ¥è­˜åº«å…§å®¹
      const parts = response.split(/ç›¸é—œçŸ¥è­˜åº«å…§å®¹ï¼š|çŸ¥è­˜åº«å…§å®¹ï¼š/);
      const mainContent = parts[0].trim();
      
      // æ ¼å¼åŒ–ä¸»è¦å…§å®¹
      const formattedContent = mainContent
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/### (.+?)(\n|$)/g, '<h4>$1</h4>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/- (.+?)(\n|$)/g, '<li>$1</li>');
      
      // åŒ…è£åœ¨æ®µè½æ¨™ç±¤ä¸­
      const wrappedContent = formattedContent.includes('<li>') 
        ? formattedContent.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>')
        : `<p>${formattedContent}</p>`;
      
      return wrappedContent;
    }

    private buildCitationsHTML(citations: any[]): string {
      if (!citations || citations.length === 0) return '';
      
      const citationsList = citations.map((citation, index) => {
        const source = citation.source || '';
        const filePath = citation.file_path || '';
        const sourceUrl = citation.source_url || '';
        const title = citation.title || filePath || source;
        const content = citation.content || '';
        
        // å»ºç«‹é€£çµï¼Œå¦‚æœæœ‰ source_url å°±ä½¿ç”¨ï¼Œå¦å‰‡å»ºç«‹ç›¸å°é€£çµ
        const linkUrl = sourceUrl || `/work/${filePath}`;
        const linkText = filePath || source;
        
        return `
          <div class=\"citation-item\">
            <span class=\"citation-number\">${index + 1}</span>
            <div class=\"citation-content\">
              <div class=\"citation-source\">
                <span class=\"citation-id\">${escapeHtml(source)}</span>
                ${linkUrl ? `<a href=\"${linkUrl}\" target=\"_blank\" class=\"citation-link\">ğŸ“„ ${escapeHtml(linkText)}</a>` : ''}
              </div>
              ${content ? `<div class=\"citation-text\">${escapeHtml(content)}</div>` : ''}
              ${citation.relevance_score ? `<div class=\"citation-score\">ç›¸é—œåº¦: ${(citation.relevance_score * 100).toFixed(1)}%</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      return `
        <div class=\"knowledge-citations\">
          <div class=\"citations-header\">
            <span class=\"citations-icon\">ğŸ“š</span>
            <span class=\"citations-title\">åƒè€ƒè³‡æ–™</span>
          </div>
          <div class=\"citations-list\">
            ${citationsList}
          </div>
        </div>
      `;
    }

    // æ¸…ç†æ–¹æ³•ï¼Œç”¨æ–¼åœæ­¢æ‰€æœ‰è¼ªè©¢
    public cleanup() {
      this.pollingTasks.forEach((timeout) => {
        clearTimeout(timeout);
      });
      this.pollingTasks.clear();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const v2 = new QABotV2();
    // ç›£è½å…¨åŸŸæ¨¡å¼åˆ‡æ›
    window.addEventListener('qabot:switch', (e: any) => {
      const mode = e?.detail?.mode;
      const v1 = document.getElementById('qaBotContainer');
      if (mode === 'v2') {
        if (v1 && !v1.classList.contains('show')) v1.classList.add('show');
        v2.show();
      } else if (mode === 'v1') {
        v2.hide();
      }
    });

    // é é¢å¸è¼‰æ™‚æ¸…ç†è¼ªè©¢
    window.addEventListener('beforeunload', () => {
      v2.cleanup();
    });
  });
</script>


