---
import { } from 'astro';
import '../styles/qabotv2.css';
---

<!-- v2 æ§åˆ¶åˆ—ï¼šæ’å…¥å…±ç”¨ qa-bot-container ä¸­ï¼ˆheader ä¸‹æ–¹å³å¯ï¼‰ -->
<div class="control-row" id="qaV2Controls" style="display:none">
  <label>
    Model
    <select id="v2Model"></select>
  </label>
  <label style="display:flex;align-items:center;gap:6px;">
    <input type="checkbox" id="v2UseKb" checked /> TY çŸ¥è­˜åº«
  </label>
</div>

<script>
  import { getApiBaseUrl, getOrCreateUserId, escapeHtml } from '../scripts/qabotShared';

  class QABotV2 {
    private messagesEl: HTMLElement;
    private inputEl: HTMLInputElement;
    private sendBtn: HTMLButtonElement;
    private modelSel: HTMLSelectElement;
    private kbEl: HTMLInputElement;
    private userId: string;
    private apiBase: string;

    constructor() {
      // å°‡æ§åˆ¶åˆ—ç§»åˆ° header åº•ä¸‹ï¼ˆè‹¥å°šæœªåœ¨æ­£ç¢ºä½ç½®ï¼‰
      const container = document.getElementById('qaBotContainer') as HTMLElement;
      const header = container?.querySelector('.chat-header') as HTMLElement | null;
      const controls = document.getElementById('qaV2Controls') as HTMLElement;
      if (container && header && controls && controls.parentElement !== container) {
        container.insertBefore(controls, container.children[1]);
      }

      this.messagesEl = document.getElementById('chatMessages') as HTMLElement;
      this.inputEl = document.getElementById('userInput') as HTMLInputElement;
      this.sendBtn = document.getElementById('sendButton') as HTMLButtonElement;
      this.modelSel = document.getElementById('v2Model') as HTMLSelectElement;
      this.kbEl = document.getElementById('v2UseKb') as HTMLInputElement;
      this.userId = getOrCreateUserId('qabot_user_id');
      this.apiBase = getApiBaseUrl();

      this.bindEvents();
      this.loadModels();
    }

    private bindEvents() {
      this.sendBtn.addEventListener('click', () => this.ask());
      this.inputEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if ((window as any).qabotMode === 'v2') this.ask();
        }
      });
    }

    public show() { (document.getElementById('qaV2Controls') as HTMLElement).style.display = 'flex'; }
    public hide() { (document.getElementById('qaV2Controls') as HTMLElement).style.display = 'none'; }

    private appendMessage(html: string) {
      const div = document.createElement('div');
      div.innerHTML = html;
      this.messagesEl.appendChild(div);
      this.messagesEl.scrollTop = this.messagesEl.scrollHeight;
    }

    private async loadModels() {
      try {
        const resp = await fetch(`${this.apiBase}/maya-v2/available-models/`, { credentials: 'include' });
        if (!resp.ok) throw new Error(`models ${resp.status}`);
        const data = await resp.json();
        
        // è§£æ API å›æ‡‰æ ¼å¼
        const models = data?.models || [];
        const activeModels = models.filter((m: any) => m.is_active === true);
        
        this.modelSel.innerHTML = '';
        activeModels.forEach((m: any) => {
          const opt = document.createElement('option');
          opt.value = m.model_id;
          opt.textContent = m.name;
          this.modelSel.appendChild(opt);
        });
        
        // è¨­å®šé è¨­é¸é …
        if (!this.modelSel.value && activeModels.length > 0) {
          this.modelSel.value = activeModels[0].model_id;
        }
      } catch (e) {
        console.error('Failed to load models:', e);
        this.modelSel.innerHTML = '<option value="">ç„¡æ³•è¼‰å…¥æ¨¡å‹</option>';
      }
    }

    private async ask() {
      const q = this.inputEl.value.trim();
      if (!q) return;
      this.inputEl.value = '';
      
      // é¡¯ç¤ºç”¨æˆ¶æ¶ˆæ¯
      this.appendMessage(`<div class=\"message user-message\"><div class=\"message-content\"><p>${escapeHtml(q)}</p></div></div>`);
      
      // é¡¯ç¤ºç­‰å¾…UI
      this.showLoadingMessage();
      
      try {
        const payload = {
          question: q,
          model_name: this.modelSel.value,
          sync: true,
          use_knowledge_base: !!this.kbEl.checked,
          user_id: this.userId
        };
        const resp = await fetch(`${this.apiBase}/maya-v2/ask-with-model/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          credentials: 'include'
        });
        if (!resp.ok) throw new Error(`ask ${resp.status}`);
        const data = await resp.json();
        
        // éš±è—ç­‰å¾…UI
        this.hideLoadingMessage();
        
        // ä½¿ç”¨æ–°çš„æ ¼å¼åŒ–æ–¹æ³•é¡¯ç¤º AI å›æ‡‰
        this.displayAIResponse(data);
      } catch (e) {
        // éš±è—ç­‰å¾…UI
        this.hideLoadingMessage();
        this.appendMessage(`<div class=\"message bot-message\"><div class=\"message-content\"><p style=\"color:#b91c1c\">âŒ ${escapeHtml((e as Error).message)}</p></div></div>`);
      }
    }

    private showLoadingMessage() {
      const loadingEl = document.getElementById('loadingMessage') as HTMLElement;
      if (loadingEl) {
        const clone = loadingEl.cloneNode(true) as HTMLElement;
        clone.style.display = 'block';
        clone.id = 'v2LoadingMessage';
        this.messagesEl.appendChild(clone);
        this.messagesEl.scrollTop = this.messagesEl.scrollHeight;
      }
    }

    private hideLoadingMessage() {
      const loadingEl = document.getElementById('v2LoadingMessage');
      if (loadingEl) {
        loadingEl.remove();
      }
    }

    private displayAIResponse(data: any) {
      try {
        // å»ºç«‹ä¸»è¦çš„AIå›æ‡‰å®¹å™¨
        const aiResponse = data.ai_response || data.text || data.answer || '';
        const modelInfo = data.ai_model || {};
        const knowledgeUsed = data.knowledge_used || false;
        const citations = data.knowledge_citations || [];

        // åˆ†å‰²AIå›æ‡‰ä»¥æå–ä¸»è¦å…§å®¹å’ŒçŸ¥è­˜åº«å…§å®¹
        const responseText = this.formatAIResponse(aiResponse);
        
        // å»ºç«‹å®Œæ•´çš„å›æ‡‰HTML
        let responseHTML = `
          <div class=\"message bot-message\">
            <div class=\"message-content-wrapper\">
              <div class=\"message-header\">
                <span class=\"ai-name\">${escapeHtml(modelInfo.name || 'AI')}</span>
                ${knowledgeUsed ? '<span class=\"knowledge-badge\">ğŸ§  çŸ¥è­˜åº«</span>' : ''}
              </div>
              <div class=\"message-content\">
                ${responseText}
              </div>
              ${citations.length > 0 ? this.buildCitationsHTML(citations) : ''}
            </div>
          </div>
        `;
        
        this.appendMessage(responseHTML);
      } catch (e) {
        console.error('Error displaying AI response:', e);
        this.appendMessage(`<div class=\"message bot-message\"><div class=\"message-content\"><p style=\"color:#b91c1c\">âŒ å›æ‡‰æ ¼å¼éŒ¯èª¤</p></div></div>`);
      }
    }

    private formatAIResponse(response: string): string {
      if (!response) return '<p>ç„¡å›æ‡‰å…§å®¹</p>';
      
      // åˆ†å‰²ä¸»è¦å›æ‡‰å’ŒçŸ¥è­˜åº«å…§å®¹
      const parts = response.split(/ç›¸é—œçŸ¥è­˜åº«å…§å®¹ï¼š|çŸ¥è­˜åº«å…§å®¹ï¼š/);
      const mainContent = parts[0].trim();
      
      // æ ¼å¼åŒ–ä¸»è¦å…§å®¹
      const formattedContent = mainContent
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/### (.+?)(\n|$)/g, '<h4>$1</h4>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/- (.+?)(\n|$)/g, '<li>$1</li>');
      
      // åŒ…è£åœ¨æ®µè½æ¨™ç±¤ä¸­
      const wrappedContent = formattedContent.includes('<li>') 
        ? formattedContent.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>')
        : `<p>${formattedContent}</p>`;
      
      return wrappedContent;
    }

    private buildCitationsHTML(citations: any[]): string {
      if (!citations || citations.length === 0) return '';
      
      const citationsList = citations.map((citation, index) => {
        const provider = citation.provider || '';
        
        // åŸºæ–¼ file_path æ§‹å»ºæ­£ç¢ºçš„ URL æ ¼å¼
        let url = '#';
        let displayName = 'æœªçŸ¥æ–‡ä»¶';
        
        if (citation.file_path) {
          // ç§»é™¤ .md å‰¯æª”åä½œç‚ºé¡¯ç¤ºåç¨±
          displayName = citation.file_path.replace(/\.md$/, '');
          
          // æ ¹æ“šç’°å¢ƒæ§‹å»º URL
          if ((import.meta as any).env.DEV) {
            url = `http://localhost:4321/tymultiverse/work/${displayName}`;
          } else {
            url = `https://peoplesystem.tatdvsonorth.com/tymultiverse/work/${displayName}`;
          }
        }
        
        return `
          <div class=\"citation-item\">
            <span class=\"citation-number\">${index + 1}</span>
            <div class=\"citation-content\">
              <a href=\"${escapeHtml(url)}\" target=\"_blank\" class=\"citation-link\">
                ${escapeHtml(displayName)}
              </a>
              ${provider ? `<span class=\"citation-provider\">${escapeHtml(provider)}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      return `
        <div class=\"knowledge-citations\">
          <div class=\"citations-header\">
            <span class=\"citations-icon\">ğŸ“š</span>
            <span class=\"citations-title\">åƒè€ƒè³‡æ–™</span>
          </div>
          <div class=\"citations-list\">
            ${citationsList}
          </div>
        </div>
      `;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const v2 = new QABotV2();
    // ç›£è½å…¨åŸŸæ¨¡å¼åˆ‡æ›
    window.addEventListener('qabot:switch', (e: any) => {
      const mode = e?.detail?.mode;
      const v1 = document.getElementById('qaBotContainer');
      if (mode === 'v2') {
        if (v1 && !v1.classList.contains('show')) v1.classList.add('show');
        v2.show();
      } else if (mode === 'v1') {
        v2.hide();
      }
    });
  });
</script>


