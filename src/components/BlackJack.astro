---
import { config } from '../services/core/config';
import '../styles/bj.css';
import MaintenanceOverlay from './MaintenanceOverlay.astro';
const deckOfCardsUrl = import.meta.env.PUBLIC_DECKOFCARDS_URL;
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack Game</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .game-container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <MaintenanceOverlay id="maintenance-overlay" show={true} title="ğŸ› ï¸ ç¶­è­·ä¸­" message="æœå‹™æ­£åœ¨ç¶­è­·ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼" icon="ğŸ°" />
        
        <div class="game-content" id="game-content" style="display: none;">
            <h1 class="centered-title">Black Jack</h1>
            <div class="game-sections">
                <div class="player-section">
                    <h3 class="centered-subtitle">You</h3>
                    <div id="player-cards" class="cards"></div>
                </div>

                <div class="dealer-section">
                    <h3 class="centered-subtitle">Dealer</h3>
                    <div id="dealer-cards" class="cards"></div>
                </div>
            </div>

            <div class="button-group">
                <button onclick="startGame()">New Game</button>
                <button onclick="hit()">Hit</button>
                <button onclick="stand()">Stand</button>
            </div>

            <div id="game-status"></div>
        </div>
    </div>

    <script type="module" define:vars={{ deckOfCardsUrl, config }}>
        const axios = window.axios; // ä½¿ç”¨å…¨å±€ Axios
        const API_BASE_URL = (window.ENV?.API_BASE_URL || deckOfCardsUrl) + '/blackjack';
        const PEOPLE_IMAGE_URL = config.resources.peopleImageUrl;

        // Use deckOfCardsUrl for asset paths
        const BASE_URL = deckOfCardsUrl || '/';
        
        // æª¢æŸ¥ API æ˜¯å¦å¯ç”¨
        async function checkApiAvailability() {
            try {
                const response = await axios.get(`${API_BASE_URL}/status`);
                // API å¯ç”¨ï¼Œé¡¯ç¤ºéŠæˆ²å…§å®¹
                document.getElementById('maintenance-overlay').style.display = 'none';
                document.getElementById('game-content').style.display = 'block';
                getGameStatus();
            } catch (error) {
                // API ä¸å¯ç”¨ï¼Œé¡¯ç¤ºç¶­è­·è¨Šæ¯
                console.log('Black Jack API not available, showing maintenance message');
            }
        }
        
        // é–‹å§‹æ–°éŠæˆ²çš„å‡½æ•¸
        async function startGame() {
            try {
                const playerCardsDiv = document.getElementById('player-cards');
                const dealerCardsDiv = document.getElementById('dealer-cards');
                playerCardsDiv.innerHTML = 'Player Cards: ';
                dealerCardsDiv.innerHTML = 'Dealer Cards: ';

                const response = await axios.post(`${API_BASE_URL}/start`);
                updateGameDisplay(response.data);

                const hitButton = document.querySelector('button[onclick="hit()"]');
                const standButton = document.querySelector('button[onclick="stand()"]');
                hitButton.disabled = false;
                standButton.disabled = false;
            } catch (error) {
                showError(error);
            }
        }

        // ç©å®¶é¸æ“‡è¦ç‰Œçš„å‡½æ•¸
        async function hit() {
            try {
                const response = await axios.post(`${API_BASE_URL}/hit`);
                updateGameDisplay(response.data);
            } catch (error) {
                showError(error);
            }
        }

        // ç©å®¶é¸æ“‡åœç‰Œçš„å‡½æ•¸
        async function stand() {
            try {
                const response = await axios.post(`${API_BASE_URL}/stand`);
                updateGameDisplay(response.data);

                const hitButton = document.querySelector('button[onclick="hit()"]');
                const standButton = document.querySelector('button[onclick="stand()"]');
                hitButton.disabled = true;
                standButton.disabled = true;
            } catch (error) {
                showError(error);
            }
        }

        // ç²å–ç•¶å‰éŠæˆ²ç‹€æ…‹çš„å‡½æ•¸
        async function getGameStatus() {
            try {
                const response = await axios.get(`${API_BASE_URL}/status`);
                updateGameDisplay(response.data);
            } catch (error) {
                showError(error);
            }
        }

        // æ›´æ–°éŠæˆ²é¡¯ç¤ºçš„å‡½æ•¸
        function updateGameDisplay(gameData) {
            // console.log('gameData:', gameData);
            
            // çµ±ä¸€è™•ç†éŠæˆ²æ•¸æ“šçµæ§‹
            let playerHand, dealerHand, playerScore, dealerScore, gameState, message;
            
            // æª¢æŸ¥æ•¸æ“šçµæ§‹ä¸¦é©ç•¶æå–æ•¸æ“š
            if (gameData.gameState) {
                // æ–°çš„APIçµæ§‹
                playerHand = { cards: gameData.gameState.playerCards || [] };
                dealerHand = { cards: gameData.gameState.dealerCards || [] };
                playerScore = gameData.gameState.playerScore || 0;
                dealerScore = gameData.gameState.dealerScore || 0;
                gameState = gameData.gameState.gameState || 'IN_PROGRESS';
                message = gameData.message || gameData.gameState.message || 'é€²è¡Œä¸­';
            } else {
                // èˆŠçš„APIçµæ§‹
                playerHand = gameData.playerHand || {};
                dealerHand = gameData.dealerHand || {};
                playerScore = gameData.playerScore || 0;
                dealerScore = gameData.dealerScore || 0;
                gameState = gameData.state || 'PLAYER_TURN';
                message = gameData.messageText || gameData.message || 'é€²è¡Œä¸­';
            }

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const hitButton = document.querySelector('button[onclick="hit()"]');
            const standButton = document.querySelector('button[onclick="stand()"]');
            
            // å¦‚æœéŠæˆ²çµæŸï¼Œç¦ç”¨æŒ‰éˆ•
            if (gameState !== 'IN_PROGRESS' && gameState !== 'PLAYER_TURN') {
                hitButton.disabled = true;
                standButton.disabled = true;
            } else {
                hitButton.disabled = false;
                standButton.disabled = false;
            }

            // æ›´æ–°ç©å®¶å¡ç‰Œ
            const playerCardsDiv = document.getElementById('player-cards');
            playerCardsDiv.innerHTML = `
                <div class="card-container">
                    ${(playerHand.cards || []).map(card => {
                        const suitIndex = ['SPADES', 'HEARTS', 'DIAMONDS', 'CLUBS'].indexOf(card.suit);
                        const rankIndex = ['ACE', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'JACK', 'QUEEN', 'KING'].indexOf(card.rank);
                        const imageIndex = suitIndex * 13 + rankIndex;
                        return `<img src="/tymultiverse/assets/poker/${imageIndex}.jpg" alt="${card.rank} of ${card.suit}" class="card-image">`;
                    }).join('')}
                </div>
                <br><p>Total: ${playerScore}</p>
            `;

            // æ›´æ–°èŠå®¶å¡ç‰Œ
            const dealerCardsDiv = document.getElementById('dealer-cards');
            dealerCardsDiv.innerHTML = `
                <div class="card-container">
                    ${(dealerHand.cards || []).map((card, index) => {
                        // å¦‚æœæ˜¯ç¬¬ä¸€å¼µç‰Œä¸”éŠæˆ²é€²è¡Œä¸­ï¼Œé¡¯ç¤ºèƒŒé¢
                        if (index === 0 && (gameState === 'IN_PROGRESS' || gameState === 'PLAYER_TURN')) {
                            return `<img src="${PEOPLE_IMAGE_URL}/Ashe.png" alt="Hidden Card" class="card-image">`;
                        } else {
                            const suitIndex = ['SPADES', 'HEARTS', 'DIAMONDS', 'CLUBS'].indexOf(card.suit);
                            const rankIndex = ['ACE', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'JACK', 'QUEEN', 'KING'].indexOf(card.rank);
                            const imageIndex = suitIndex * 13 + rankIndex;
                            return `<img src="/tymultiverse/assets/poker/${imageIndex}.jpg" alt="${card.rank} of ${card.suit}" class="card-image">`;
                        }
                    }).join('')}
                </div>
                <br><p>Total: ${gameState === 'IN_PROGRESS' || gameState === 'PLAYER_TURN' ? '?' : dealerScore}</p>
            `;

            // æ›´æ–°éŠæˆ²ç‹€æ…‹è¨Šæ¯
            let gameStatusDiv = document.getElementById('game-status');
            gameStatusDiv.textContent = message;
        }

        // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯çš„å‡½æ•¸
        function showError(error) {
            const gameStatusDiv = document.getElementById('game-status');
            gameStatusDiv.textContent = `Error: ${error.response?.data || error.message}`;
            const hitButton = document.querySelector('button[onclick="hit()"]');
            const standButton = document.querySelector('button[onclick="stand()"]');
            hitButton.disabled = true;
            standButton.disabled = true;
        }
        
        window.onload = checkApiAvailability;
        
        // Expose functions to global scope so they're accessible from HTML onclick attributes
        window.startGame = startGame;
        window.hit = hit;
        window.stand = stand;
    </script>
</body>
</html>