---
// 檢查登入狀態
const url = new URL(Astro.request.url);
const username = url.searchParams.get('username');
const token = url.searchParams.get('token');

// 如果未登入，重定向到首頁
if (!username || !token) {
  return Astro.redirect('/tymultiverse/');
}
---

<div id="group-container"></div>

<style>
  #group-container {
    margin: 5%;
    padding: 0;
    max-width: 100%;
  }

  .army-container {
    margin: 20px 0;
    padding: 15px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .army-title {
    font-size: 24px;
    font-weight: bold;
    color: #fff;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
  }

  .character-info {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    padding: 20px;
    border-radius: 15px;
    color: white;
    z-index: 1000;
    max-width: 80%;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }

  .character-info.show {
    display: block;
  }

  .character-info img {
    width: 300px;
    height: auto;
    float: right;
    margin-left: 20px;
    border-radius: 8px;
  }

  .character-info p {
    margin: 5px 0;
    font-size: 16px;
  }

  .character-info .name {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #ffd700;
  }

  .character-info .army {
    font-size: 20px;
    color: #ffa500;
    margin-bottom: 10px;
  }

  .close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 5px 10px;
  }

  .close-button:hover {
    color: #ffd700;
  }
</style>

<script>
  const TYMB_URL = import.meta.env.PUBLIC_TYMB_URL;
  document.addEventListener("DOMContentLoaded", function () {
    fetch(`${TYMB_URL}/people/get-all`, {
      method: "POST", 
      headers: {
        "Content-Type": "application/json"
      },
      credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
      const armyGroups = {};
      (data as any[]).forEach(character => {
        const army = character.armyName || 'Unknown Army';
        if (!armyGroups[army]) {
          armyGroups[army] = [];
        }
        armyGroups[army].push(character);
      });

      const mainContainer = document.createElement('div');
      mainContainer.className = 'army-groups';

      Object.entries(armyGroups).forEach(([army, characters]) => {
        const armyContainer = document.createElement('div');
        armyContainer.className = 'army-container';
        armyContainer.style.marginTop = '50px';

        const armyTitle = document.createElement('h2');
        armyTitle.className = 'army-title';
        armyTitle.textContent = army;
        armyTitle.style.marginBottom = '15px';

        const charactersGrid = document.createElement('div');
        charactersGrid.className = 'box-container';
        charactersGrid.style.margin = '0 auto';

        (characters as any[]).forEach(character => {
            const characterContainer = document.createElement('div');
            characterContainer.style.display = 'inline-block';
            characterContainer.style.width = '200px';
            characterContainer.style.height = '300px';
            characterContainer.style.textAlign = 'center';
            characterContainer.style.marginLeft = '-100px';
            characterContainer.style.position = 'relative';
            characterContainer.style.zIndex = '1';

            const img = document.createElement('img');
            img.style.width = '200px';
            img.style.height = '300px';
            img.style.display = 'block';
            img.style.objectFit = 'contain';
            img.style.margin = '0 auto';
            img.style.padding = '0';
            img.style.border = 'none';
            img.style.position = 'absolute';
            img.style.top = '50%';
            img.style.left = '50%';
            img.style.transform = 'translate(-50%, -50%)';
            img.style.zIndex = '2';
            img.src = `${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/${character.name || 'default'}.png`;
            img.alt = character.nameOriginal;
            img.onerror = function() {
              this.src = `${import.meta.env.PUBLIC_PEOPLE_IMAGE_URL}/default.png`;
            };
            img.addEventListener('mouseover', () => {
              img.style.zIndex = '3';
              showCharacterInfo(character);
            });
            img.addEventListener('mouseout', () => {
              img.style.zIndex = '2';
            });

            const infoContainer = document.createElement('div');
            infoContainer.style.padding = '2px';
            infoContainer.style.color = '#fff';
            infoContainer.style.textShadow = '0 0 2px rgba(0,0,0,0.5)';
            infoContainer.style.width = '200px';
            infoContainer.style.position = 'absolute';
            infoContainer.style.bottom = '-40px';
            infoContainer.style.left = '0';
            infoContainer.style.overflow = 'hidden';
            infoContainer.style.fontSize = '12px';
            infoContainer.style.zIndex = '4';
            infoContainer.style.backgroundColor = 'transparent';
            infoContainer.style.padding = '5px';
            infoContainer.style.borderRadius = '5px';

            const nameText = document.createElement('p');
            nameText.textContent = character.nameOriginal;
            nameText.style.margin = '0';
            nameText.style.fontWeight = 'bold';
            nameText.style.fontSize = 'clamp(8px, 1.2vw, 10px)';
            nameText.style.whiteSpace = 'nowrap';
            nameText.style.overflow = 'hidden';
            nameText.style.textOverflow = 'ellipsis';

            const attributesText = document.createElement('p');
            attributesText.textContent = `Attributes: ${character.attributes}`;
            attributesText.style.margin = '0';
            attributesText.style.fontSize = 'clamp(6px, 0.8vw, 8px)';
            attributesText.style.whiteSpace = 'nowrap';
            attributesText.style.overflow = 'hidden';
            attributesText.style.textOverflow = 'ellipsis';

            const sizeText = document.createElement('p');
            sizeText.textContent = `${character.heightCm}cm / ${character.weightKg}kg`;
            sizeText.style.margin = '0';
            sizeText.style.fontSize = 'clamp(6px, 0.8vw, 8px)';
            sizeText.style.whiteSpace = 'nowrap';
            sizeText.style.overflow = 'hidden';
            sizeText.style.textOverflow = 'ellipsis';

            infoContainer.appendChild(nameText);
            infoContainer.appendChild(attributesText);
            infoContainer.appendChild(sizeText);
            characterContainer.appendChild(img);
            characterContainer.appendChild(infoContainer);
            charactersGrid.appendChild(characterContainer);
        });

        armyContainer.appendChild(armyTitle);
        armyContainer.appendChild(charactersGrid);
        mainContainer.appendChild(armyContainer);
      });

      const container = document.getElementById('group-container');
      if (container) {
        container.appendChild(mainContainer);
      }
    })
    .catch(error => console.error('Error fetching data:', error));
  });

  function showCharacterInfo(character) {
    let infoContainer = document.querySelector('.character-info');
    if (!infoContainer) {
      infoContainer = document.createElement('div');
      infoContainer.className = 'character-info';
      document.getElementById('group-container').appendChild(infoContainer);
    }

    const imageName = character.name || 'default';
    const infoContent = document.createElement('div');
    infoContent.className = 'info-content';
    infoContent.innerHTML = `
      <button class="close-button">&times;</button>
      <p class="name">${character.nameOriginal}</p>
      <p class="army">Army: ${character.originArmyName} => ${character.armyName}</p>
      <p>Physic Power: ${character.physicPower}</p>
      <p>Magic Power: ${character.magicPower}</p>
      <p>Utility Power: ${character.utilityPower}</p>
      <p>Attributes: ${character.attributes}</p>
      <p>Ass Size: ${character.assSize}</p>
      <p>Boobs Size: ${character.boobsSize}</p>
      <p>${character.heightCm}(cm)</p>
      <p>${character.weightKg}(kg)</p>
      <p>${character.profession}</p>
      <p>Job: ${character.job}</p>
      <p>Combat: ${character.combat}</p>
      <p>Concubine: ${character.concubine}</p>
      <p>Main Weapon: ${character.mainWeapon}</p>
      <p>Sub Weapon: ${character.subWeapon}</p>
      <p>Dept: ${character.deptName}</p>
      <p>Faction: ${character.faction}</p>
      <p>Gave Birth: ${character.gaveBirth}</p>
    `;

    infoContainer.innerHTML = '';
    infoContainer.appendChild(infoContent);
    infoContainer.classList.add('show');

    const closeButton = infoContainer.querySelector('.close-button');
    closeButton.addEventListener('click', () => {
      infoContainer.classList.remove('show');
    });

    document.addEventListener('click', function closeInfo(e) {
      if (!infoContainer.contains(e.target as Node)) {
        infoContainer.classList.remove('show');
        document.removeEventListener('click', closeInfo);
      }
    });
  }
</script>
