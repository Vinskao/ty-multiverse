---
import { Icon } from "./Icon";
// import { ThemeToggle } from './ThemeToggle';
import type { iconPaths } from "./IconPaths";
import '../styles/nav.css';

// ç²å– URL åƒæ•¸
const url = new URL(Astro.request.url);
const username = url.searchParams.get('username');
const token = url.searchParams.get('token');
const refreshToken = url.searchParams.get('refresh_token');

// æª¢æŸ¥ç™»å…¥ç‹€æ…‹
const isLoggedIn = !!username;

// æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡ - å°‡åœ¨å‰ç«¯å‹•æ…‹é©—è­‰
const isAdmin = false; // åˆå§‹å€¼ï¼Œå°‡åœ¨å‰ç«¯ JavaScript ä¸­å‹•æ…‹æ›´æ–°

// ç²å–ç•¶å‰è·¯å¾‘
const currentPath = Astro.url.pathname;

/** Main menu items */
const textLinks: { label: string; href: string; isActive: boolean; adminOnly?: boolean }[] = [
  { 
    label: "Home", 
    href: isLoggedIn ? `/tymultiverse/?username=${username}&token=${token}&refresh_token=${refreshToken}` : "/tymultiverse/", 
    isActive: currentPath === "/tymultiverse/" || currentPath === "/tymultiverse/index.html"
  },
  { 
    label: isLoggedIn ? "Logout" : "Login", 
    href: isLoggedIn ? "#" : `/tymultiverse/login?redirect=${encodeURIComponent(Astro.url.pathname + Astro.url.search)}`,
    isActive: currentPath === "/tymultiverse/login"
  },
  { 
    label: "Work", 
    href: isLoggedIn ? `/tymultiverse/work/?username=${username}&token=${token}` : "/tymultiverse/work/", 
    isActive: currentPath.startsWith("/tymultiverse/work")
  },
  { 
    label: "About", 
    href: isLoggedIn ? `/tymultiverse/about/?username=${username}&token=${token}` : "/tymultiverse/about/", 
    isActive: currentPath.startsWith("/tymultiverse/about")
  },
  ...(isLoggedIn ? [
    { 
      label: "Control", 
      href: `/tymultiverse/control/?username=${username}&token=${token}`,
      isActive: currentPath.startsWith("/tymultiverse/control")
    },
    // Wildland å’Œ Palais å§‹çµ‚æ¸²æŸ“ï¼ˆå¦‚æœå·²ç™»å…¥ï¼‰ï¼Œä½†ç”±å‰ç«¯ JavaScript æ§åˆ¶é¡¯ç¤ºï¼ˆåŸºæ–¼ admin æ¬Šé™ï¼‰
    { 
      label: "Wildland", 
      adminOnly: true, 
      href: `/tymultiverse/wildland/?username=${username}&token=${token}&refresh_token=${refreshToken || ''}`,
      isActive: currentPath.startsWith("/tymultiverse/wildland")
    },
    { 
      label: "Palais", 
      adminOnly: true, 
      href: `/tymultiverse/palais/?username=${username}&token=${token}&refresh_token=${refreshToken || ''}`,
      isActive: currentPath.startsWith("/tymultiverse/palais")
    }
  ] : [])
];

const iconLinks: { label: string; href: string; icon: keyof typeof iconPaths; isActive: boolean }[] = [
  {
    label: "Twitter",
    href: "https://twitter.com/wawiking",
    icon: "twitter-logo",
    isActive: false
  },
  {
    label: "GitHub",
    href: "https://github.com/Vinskao",
    icon: "github-logo",
    isActive: false
  }
];
---

<nav>
  <div class="menu-header">
    <a href="/tymultiverse" class="site-title" onclick="localStorage.removeItem('lastVisitedPath');">
      <Icon
        icon="terminal-window"
        color="var(--accent-regular)"
        size="1.6em"
        gradient
      />
      TY Multiverse
    </a>
    <menu-button>
      <template>
        <button class="menu-button" aria-expanded="false">
          <span class="sr-only">Menu</span>
          <Icon icon="list" />
        </button>
      </template>
    </menu-button>
  </div>
  <noscript>
    <ul class="nav-items">
      {
        textLinks.map(({ label, href, isActive, adminOnly }) => (
          <li class:list={[{ 'admin-only': adminOnly }]}>
            <a
              aria-current={isActive ? "page" : "false"}
              class:list={[
                "link",
                {
                  active: isActive
                },
              ]}
              href={href}
            >
              {label}
            </a>
          </li>
        ))
      }
    </ul>
  </noscript>
  <noscript>
    <div class="menu-footer">
      <div class="socials">
        {
          iconLinks.map(({ href, icon, label }) => (
            <a href={href} class="social">
              <span class="sr-only">{label}</span>
              <Icon icon={icon} />
            </a>
          ))
        }
      </div>
    </div>
  </noscript>
  <div id="menu-content" hidden>
    <ul class="nav-items">
      {
        textLinks.map(({ label, href, isActive, adminOnly }) => (
          <li class:list={[{ 'admin-only': adminOnly }]}>
            <a
              aria-current={isActive ? "page" : "false"}
              class:list={[
                "link",
                {
                  active: isActive
                },
              ]}
              href={href}
            >
              {label}
            </a>
          </li>
        ))
      }
    </ul>
    <div class="menu-footer">
      <div class="socials">
        {
          iconLinks.map(({ href, icon, label }) => (
            <a href={href} class="social">
              <span class="sr-only">{label}</span>
              <Icon icon={icon} />
            </a>
          ))
        }
      </div>
    </div>
  </div>
</nav>

<script>
  import { storageService } from '../services/core/storageService';
  import { verifyToken, startTokenVerification, stopTokenVerification, logout } from '../services/api/auth';

  // å®šç¾©å…¨å±€é¡å‹
  declare global {
    interface Window {
      storageService: typeof storageService;
    }
  }

  // å°‡ storageService æ›è¼‰åˆ° window å°è±¡ä¸Š
  window.storageService = storageService;

  // é é¢è¨ªå•è¿½è¹¤åŠŸèƒ½
  class PageTracker {
    private static readonly STORAGE_KEY = 'lastVisitedTymultiverseUrl';
    private static readonly REFERER_KEY = 'tymultiverseReferer';

    constructor() {
      this.initializePageTracking();
    }

    private initializePageTracking(): void {
      // è¨˜éŒ„ç•¶å‰é é¢
      this.saveCurrentUrl();

      // ç›£è½æ‰€æœ‰éˆæ¥é»æ“Š
      this.trackLinkClicks();

      // æª¢æŸ¥æ˜¯å¦éœ€è¦å¾ localStorage è·³è½‰
      this.checkAndRedirectFromStorage();

      // ç›£è½é é¢å¸è¼‰ï¼Œä¿å­˜æœ€å¾Œè¨ªå•çš„ URL
      window.addEventListener('beforeunload', () => {
        this.saveCurrentUrl();
      });

      // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          this.saveCurrentUrl();
        }
      });
    }

    private saveCurrentUrl(): void {
      const currentUrl = window.location.href;

      // åªä¿å­˜ /tymultiverse é–‹é ­çš„ URL
      if (currentUrl.includes('/tymultiverse')) {
        try {
          // æ¸…ç† URLï¼Œç§»é™¤èªè­‰åƒæ•¸
          const urlObj = new URL(currentUrl);
          urlObj.searchParams.delete('username');
          urlObj.searchParams.delete('token');
          urlObj.searchParams.delete('refresh_token');
          urlObj.searchParams.delete('refreshToken');
          urlObj.searchParams.delete('email');
          urlObj.searchParams.delete('name');
          urlObj.searchParams.delete('firstName');
          urlObj.searchParams.delete('lastName');
          const cleanUrl = urlObj.pathname + urlObj.search;
          localStorage.setItem(PageTracker.STORAGE_KEY, cleanUrl);
          console.log('ğŸ“ å·²ä¿å­˜ç•¶å‰ TY Multiverse é é¢:', cleanUrl);
        } catch (e) {
          console.warn('ä¿å­˜ URL å¤±æ•—:', e);
        }
      }
    }

    private trackLinkClicks(): void {
      // ä½¿ç”¨äº‹ä»¶å§”æ´¾ç›£è½æ‰€æœ‰éˆæ¥é»æ“Š
      document.addEventListener('click', (event) => {
        const target = event.target as HTMLElement;

        // æ‰¾åˆ°æœ€è¿‘çš„éˆæ¥å…ƒç´ 
        const linkElement = target.closest('a') as HTMLAnchorElement;
        if (linkElement && linkElement.href) {
          const href = linkElement.href;

          // å¦‚æœæ˜¯å…§éƒ¨ TY Multiverse éˆæ¥ï¼Œä¿å­˜ç•¶å‰é é¢
          if (href.includes('/tymultiverse') && !href.includes('#')) {
            // å»¶é²ä¸€é»æ™‚é–“ä¿å­˜ï¼Œå› ç‚ºé é¢é‚„æ²’è·³è½‰
            setTimeout(() => {
              this.saveCurrentUrl();
            }, 100);
          }
        }
      });
    }

    private checkAndRedirectFromStorage(): void {
      // ç¦ç”¨ Nav çš„é‡å®šå‘é‚è¼¯ï¼Œå› ç‚º BaseLayout å·²ç¶“è™•ç†äº†é‡å®šå‘
      // é¿å…å…©å€‹é‡å®šå‘é‚è¼¯è¡çªå°è‡´ç„¡é™å¾ªç’°
      // BaseLayout çš„é‡å®šå‘é‚è¼¯æ›´å®Œå–„ï¼ŒåŒ…å«å¾ªç’°æª¢æ¸¬å’Œåƒæ•¸æ¸…ç†
      return;
      
      // ä»¥ä¸‹ä»£ç¢¼å·²ç¦ç”¨ï¼Œåƒ…ä¿ç•™ä½œç‚ºåƒè€ƒ
      /*
      const REDIRECT_FLAG = 'nav_redirecting';
      
      // æª¢æŸ¥æ˜¯å¦æ­£åœ¨é‡å®šå‘ä¸­ï¼Œé˜²æ­¢ç„¡é™å¾ªç’°
      if (sessionStorage.getItem(REDIRECT_FLAG)) {
        console.log('ğŸ›‘ Nav: æª¢æ¸¬åˆ°é‡å®šå‘æ¨™èªŒï¼Œæ¸…é™¤ä»¥é¿å…å¾ªç’°');
        sessionStorage.removeItem(REDIRECT_FLAG);
        return;
      }
      
      const currentUrl = window.location.href;
      const savedUrl = localStorage.getItem(PageTracker.STORAGE_KEY);
      const savedReferer = localStorage.getItem(PageTracker.REFERER_KEY);

      // ä¿å­˜ç•¶å‰ refererï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
      if (document.referrer) {
        localStorage.setItem(PageTracker.REFERER_KEY, document.referrer);
      }

      // æª¢æŸ¥æ˜¯å¦éœ€è¦è·³è½‰çš„æ¢ä»¶ï¼š
      // 1. æœ‰ä¿å­˜çš„ URL
      // 2. ç•¶å‰ URL æ˜¯ TY Multiverse çš„æ ¹é é¢æˆ–é¦–é 
      // 3. Referer ä¸æ˜¯ TY Multiverse å…§éƒ¨çš„é é¢ï¼ˆè¡¨ç¤ºå¾å¤–éƒ¨è·³è½‰éä¾†ï¼‰
      if (savedUrl && savedUrl !== currentUrl) {
        // æ¸…ç†ä¿å­˜çš„ URLï¼Œç§»é™¤èªè­‰åƒæ•¸ä»¥é¿å…å¾ªç’°
        try {
          const savedUrlObj = new URL(savedUrl);
          savedUrlObj.searchParams.delete('username');
          savedUrlObj.searchParams.delete('token');
          savedUrlObj.searchParams.delete('refresh_token');
          savedUrlObj.searchParams.delete('refreshToken');
          savedUrlObj.searchParams.delete('email');
          savedUrlObj.searchParams.delete('name');
          savedUrlObj.searchParams.delete('firstName');
          savedUrlObj.searchParams.delete('lastName');
          const cleanedSavedUrl = savedUrlObj.pathname + savedUrlObj.search;
          
          const currentUrlObj = new URL(currentUrl);
          currentUrlObj.searchParams.delete('username');
          currentUrlObj.searchParams.delete('token');
          currentUrlObj.searchParams.delete('refresh_token');
          currentUrlObj.searchParams.delete('refreshToken');
          currentUrlObj.searchParams.delete('email');
          currentUrlObj.searchParams.delete('name');
          currentUrlObj.searchParams.delete('firstName');
          currentUrlObj.searchParams.delete('lastName');
          const cleanedCurrentUrl = currentUrlObj.pathname + currentUrlObj.search;
          
          // å¦‚æœæ¸…ç†å¾Œçš„ URL ç›¸åŒï¼Œä¸éœ€è¦é‡å®šå‘
          if (cleanedSavedUrl === cleanedCurrentUrl) {
            return;
          }
          
          const isHomePage = currentUrl === `${window.location.origin}/tymultiverse/` ||
                            currentUrl === `${window.location.origin}/tymultiverse/index.html` ||
                            currentUrl.endsWith('/tymultiverse');

          const isFromExternal = savedReferer && !savedReferer.includes('/tymultiverse');

          if (isHomePage && isFromExternal) {
            console.log('ğŸ”„ å¾å¤–éƒ¨è·³è½‰å›ä¾†ï¼Œè·³è½‰åˆ°ä¸Šæ¬¡è¨ªå•çš„é é¢:', cleanedSavedUrl);

            // è¨­ç½®é‡å®šå‘æ¨™èªŒï¼Œé˜²æ­¢å¾ªç’°
            sessionStorage.setItem(REDIRECT_FLAG, 'true');
            
            // æ·»åŠ ä¸€å€‹å°çš„å»¶é²ï¼Œç¢ºä¿é é¢å®Œå…¨åŠ è¼‰
            setTimeout(() => {
              window.location.href = cleanedSavedUrl;
            }, 500);

            return;
          }
        } catch (e) {
          console.warn('Nav: è§£æä¿å­˜çš„ URL å¤±æ•—:', e);
          // å¦‚æœè§£æå¤±æ•—ï¼Œæ¸…é™¤ç„¡æ•ˆçš„ URL
          localStorage.removeItem(PageTracker.STORAGE_KEY);
        }
      }

      // å¦‚æœæ²’æœ‰è·³è½‰æ¢ä»¶ï¼Œæ¸…é™¤èˆŠçš„ referer
      if (savedReferer && savedReferer.includes('/tymultiverse')) {
        localStorage.removeItem(PageTracker.REFERER_KEY);
      }
      */
    }

    // æ‰‹å‹•ä¿å­˜ç•¶å‰ URLï¼ˆå¯ä»¥ç”¨æ–¼ç‰¹æ®Šæƒ…æ³ï¼‰
    public static saveCurrentUrl(): void {
      const currentUrl = window.location.href;
      if (currentUrl.includes('/tymultiverse')) {
        try {
          // æ¸…ç† URLï¼Œç§»é™¤èªè­‰åƒæ•¸
          const urlObj = new URL(currentUrl);
          urlObj.searchParams.delete('username');
          urlObj.searchParams.delete('token');
          urlObj.searchParams.delete('refresh_token');
          urlObj.searchParams.delete('refreshToken');
          urlObj.searchParams.delete('email');
          urlObj.searchParams.delete('name');
          urlObj.searchParams.delete('firstName');
          urlObj.searchParams.delete('lastName');
          const cleanUrl = urlObj.pathname + urlObj.search;
          localStorage.setItem(PageTracker.STORAGE_KEY, cleanUrl);
          console.log('ğŸ“ æ‰‹å‹•ä¿å­˜ç•¶å‰ TY Multiverse é é¢:', cleanUrl);
        } catch (e) {
          console.warn('ä¿å­˜ URL å¤±æ•—:', e);
        }
      }
    }

    // ç²å–ä¿å­˜çš„ URL
    public static getSavedUrl(): string | null {
      return localStorage.getItem(PageTracker.STORAGE_KEY);
    }

    // æ¸…é™¤ä¿å­˜çš„ URL
    public static clearSavedUrl(): void {
      localStorage.removeItem(PageTracker.STORAGE_KEY);
      localStorage.removeItem(PageTracker.REFERER_KEY);
      console.log('ğŸ—‘ï¸ å·²æ¸…é™¤ä¿å­˜çš„é é¢è¨˜éŒ„');
    }
  }

  // åˆå§‹åŒ–é é¢è¿½è¹¤å™¨
  const pageTracker = new PageTracker();

  // å°‡ PageTracker çš„éœæ…‹æ–¹æ³•æ›è¼‰åˆ° window å°è±¡ä¸Š
  declare global {
    interface Window {
      pageTracker: {
        saveCurrentUrl: () => void;
        getSavedUrl: () => string | null;
        clearSavedUrl: () => void;
      };
    }
  }

  window.pageTracker = {
    saveCurrentUrl: PageTracker.saveCurrentUrl,
    getSavedUrl: PageTracker.getSavedUrl,
    clearSavedUrl: PageTracker.clearSavedUrl
  };

  // ç‚º site-title æ·»åŠ é›™æ“Šæ¸…é™¤åŠŸèƒ½
  const siteTitle = document.querySelector('.site-title') as HTMLAnchorElement;
  if (siteTitle) {
    siteTitle.addEventListener('dblclick', (e) => {
      e.preventDefault();
      if (confirm('è¦æ¸…é™¤ä¿å­˜çš„é é¢è¨˜éŒ„å—ï¼Ÿ\né€™å°‡æ¸…é™¤æ‚¨ä¸Šæ¬¡è¨ªå•çš„é é¢ï¼Œä¸‹æ¬¡å¾å¤–éƒ¨è·³è½‰å›ä¾†æ™‚ä¸æœƒè‡ªå‹•è·³è½‰ã€‚')) {
        PageTracker.clearSavedUrl();
        alert('âœ… å·²æ¸…é™¤ä¿å­˜çš„é é¢è¨˜éŒ„');
      }
    });

    // æ·»åŠ æç¤ºä¿¡æ¯
    siteTitle.title = 'é›™æ“Šæ¸…é™¤ä¿å­˜çš„é é¢è¨˜éŒ„';
  }
  
  class MenuButton extends HTMLElement {
    constructor() {
      super();

      // Inject menu toggle button when JS runs.
      this.appendChild(this.querySelector("template")!.content.cloneNode(true));
      const btn = this.querySelector("button")!;

      // Hide menu (shown by default to support no-JS browsers).
      const menu = document.getElementById("menu-content")!;
      menu.hidden = true;
      // Add "menu-content" class in JS to avoid covering content in non-JS browsers.
      menu.classList.add("menu-content");

      /** Set whether the menu is currently expanded or collapsed. */
      const setExpanded = (expand: boolean) => {
        btn.setAttribute("aria-expanded", expand ? "true" : "false");
        menu.hidden = !expand;
      };

      // Toggle menu visibility when the menu button is clicked.
      btn.addEventListener("click", () => setExpanded(menu.hidden));

      // Hide menu button for large screens.
      const handleViewports = (e: MediaQueryList | MediaQueryListEvent) => {
        setExpanded(e.matches);
        btn.hidden = e.matches;
      };
      const mediaQueries = window.matchMedia("(min-width: 50em)");
      handleViewports(mediaQueries);
      mediaQueries.addEventListener("change", handleViewports);
    }
  }
  customElements.define("menu-button", MenuButton);
</script>

<script>
  import { initNav } from '../scripts/NavScript';
  
  // åˆå§‹åŒ– Nav æ§åˆ¶å™¨
  initNav();
</script>
