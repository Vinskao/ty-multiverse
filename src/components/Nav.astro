---
import { Icon } from "./Icon";
// import { ThemeToggle } from './ThemeToggle';
import type { iconPaths } from "./IconPaths";
import '../styles/nav.css';

// 獲取 URL 參數
const url = new URL(Astro.request.url);
const username = url.searchParams.get('username');
const token = url.searchParams.get('token');
const refreshToken = url.searchParams.get('refresh_token');

// 檢查登入狀態
const isLoggedIn = !!username;

// 檢查是否為管理員 - 將在前端動態驗證
const isAdmin = false; // 初始值，將在前端 JavaScript 中動態更新

// 獲取當前路徑
const currentPath = Astro.url.pathname;

/** Main menu items */
const textLinks: { label: string; href: string; isActive: boolean; adminOnly?: boolean }[] = [
  { 
    label: "Home", 
    href: isLoggedIn ? `/tymultiverse/?username=${username}&token=${token}&refresh_token=${refreshToken}` : "/tymultiverse/", 
    isActive: currentPath === "/tymultiverse/" || currentPath === "/tymultiverse/index.html"
  },
  { 
    label: isLoggedIn ? "Logout" : "Login", 
    href: isLoggedIn ? "#" : `/tymultiverse/login?redirect=${encodeURIComponent(Astro.url.pathname + Astro.url.search)}`,
    isActive: currentPath === "/tymultiverse/login"
  },
  { 
    label: "Work", 
    href: isLoggedIn ? `/tymultiverse/work/?username=${username}&token=${token}` : "/tymultiverse/work/", 
    isActive: currentPath.startsWith("/tymultiverse/work")
  },
  { 
    label: "About", 
    href: isLoggedIn ? `/tymultiverse/about/?username=${username}&token=${token}` : "/tymultiverse/about/", 
    isActive: currentPath.startsWith("/tymultiverse/about")
  },
  ...(isLoggedIn ? [
    { 
      label: "Control", 
      href: `/tymultiverse/control/?username=${username}&token=${token}`,
      isActive: currentPath.startsWith("/tymultiverse/control")
    },
    { 
      label: "Wildland", 
      adminOnly: true, 
      href: `/tymultiverse/wildland/?username=${username}&token=${token}&refresh_token=${refreshToken}`,
      isActive: currentPath.startsWith("/tymultiverse/wildland")
    },
    { 
      label: "Palais", 
      adminOnly: true, 
      href: `/tymultiverse/palais/?username=${username}&token=${token}&refresh_token=${refreshToken}`,
      isActive: currentPath.startsWith("/tymultiverse/palais")
    }
  ] : [])
];

const iconLinks: { label: string; href: string; icon: keyof typeof iconPaths; isActive: boolean }[] = [
  {
    label: "Twitter",
    href: "https://twitter.com/wawiking",
    icon: "twitter-logo",
    isActive: false
  },
  {
    label: "GitHub",
    href: "https://github.com/Vinskao",
    icon: "github-logo",
    isActive: false
  }
];
---

<nav>
  <div class="menu-header">
    <a href="/tymultiverse" class="site-title" onclick="localStorage.removeItem('lastVisitedPath');">
      <Icon
        icon="terminal-window"
        color="var(--accent-regular)"
        size="1.6em"
        gradient
      />
      TY Multiverse
    </a>
    <menu-button>
      <template>
        <button class="menu-button" aria-expanded="false">
          <span class="sr-only">Menu</span>
          <Icon icon="list" />
        </button>
      </template>
    </menu-button>
  </div>
  <noscript>
    <ul class="nav-items">
      {
        textLinks.map(({ label, href, isActive, adminOnly }) => (
          <li class:list={[{ 'admin-only': adminOnly }]}>
            <a
              aria-current={isActive ? "page" : "false"}
              class:list={[
                "link",
                {
                  active: isActive
                },
              ]}
              href={href}
            >
              {label}
            </a>
          </li>
        ))
      }
    </ul>
  </noscript>
  <noscript>
    <div class="menu-footer">
      <div class="socials">
        {
          iconLinks.map(({ href, icon, label }) => (
            <a href={href} class="social">
              <span class="sr-only">{label}</span>
              <Icon icon={icon} />
            </a>
          ))
        }
      </div>
    </div>
  </noscript>
  <div id="menu-content" hidden>
    <ul class="nav-items">
      {
        textLinks.map(({ label, href, isActive, adminOnly }) => (
          <li class:list={[{ 'admin-only': adminOnly }]}>
            <a
              aria-current={isActive ? "page" : "false"}
              class:list={[
                "link",
                {
                  active: isActive
                },
              ]}
              href={href}
            >
              {label}
            </a>
          </li>
        ))
      }
    </ul>
    <div class="menu-footer">
      <div class="socials">
        {
          iconLinks.map(({ href, icon, label }) => (
            <a href={href} class="social">
              <span class="sr-only">{label}</span>
              <Icon icon={icon} />
            </a>
          ))
        }
      </div>
    </div>
  </div>
</nav>

<script>
  import { storageService } from '../services/storageService';
  import { verifyToken, startTokenVerification, stopTokenVerification, logout } from '../services/auth';
  
  // 定義全局類型
  declare global {
    interface Window {
      storageService: typeof storageService;
    }
  }
  
  // 將 storageService 掛載到 window 對象上
  window.storageService = storageService;
  
  class MenuButton extends HTMLElement {
    constructor() {
      super();

      // Inject menu toggle button when JS runs.
      this.appendChild(this.querySelector("template")!.content.cloneNode(true));
      const btn = this.querySelector("button")!;

      // Hide menu (shown by default to support no-JS browsers).
      const menu = document.getElementById("menu-content")!;
      menu.hidden = true;
      // Add "menu-content" class in JS to avoid covering content in non-JS browsers.
      menu.classList.add("menu-content");

      /** Set whether the menu is currently expanded or collapsed. */
      const setExpanded = (expand: boolean) => {
        btn.setAttribute("aria-expanded", expand ? "true" : "false");
        menu.hidden = !expand;
      };

      // Toggle menu visibility when the menu button is clicked.
      btn.addEventListener("click", () => setExpanded(menu.hidden));

      // Hide menu button for large screens.
      const handleViewports = (e: MediaQueryList | MediaQueryListEvent) => {
        setExpanded(e.matches);
        btn.hidden = e.matches;
      };
      const mediaQueries = window.matchMedia("(min-width: 50em)");
      handleViewports(mediaQueries);
      mediaQueries.addEventListener("change", handleViewports);
    }
  }
  customElements.define("menu-button", MenuButton);
</script>

<script>
  import { initNav } from '../scripts/NavScript';
  
  // 初始化 Nav 控制器
  initNav();
</script>
