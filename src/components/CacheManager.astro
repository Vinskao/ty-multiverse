---
// ç·©å­˜ç®¡ç†çµ„ä»¶
---

<div id="cache-manager" style="
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 15px;
  border-radius: 10px;
  font-size: 12px;
  z-index: 1000;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  min-width: 200px;
">
  <div style="margin-bottom: 10px; font-weight: bold;">ğŸ“¦ ç·©å­˜ç‹€æ…‹</div>
  <div id="cache-status">è¼‰å…¥ä¸­...</div>
  <button id="clear-cache-btn" style="
    margin-top: 10px;
    padding: 5px 10px;
    background: #ff4757;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.3s ease;
  ">æ¸…é™¤ç·©å­˜</button>
  <button id="refresh-cache-btn" style="
    margin-top: 5px;
    padding: 5px 10px;
    background: #2ed573;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.3s ease;
    width: 100%;
  ">åˆ·æ–°æ•¸æ“š</button>
</div>

<script>
  // ç·©å­˜ç®¡ç†åŠŸèƒ½
  async function updateCacheStatus() {
    try {
      const characterService = (await import('../services/characterService')).default.getInstance();
      const status = characterService.getCacheStatus();
      
      const statusElement = document.getElementById('cache-status');
      if (statusElement) {
        if (status.hasCache && status.expiryTime) {
          const remainingTime = Math.max(0, status.expiryTime - Date.now());
          const minutes = Math.floor(remainingTime / 60000);
          const seconds = Math.floor((remainingTime % 60000) / 1000);
          
          statusElement.innerHTML = `
            <div style="color: #2ed573;">âœ… å·²ç·©å­˜</div>
            <div style="font-size: 10px; color: #ddd;">
              å‰©é¤˜æ™‚é–“: ${minutes}:${seconds.toString().padStart(2, '0')}
            </div>
          `;
        } else {
          statusElement.innerHTML = `
            <div style="color: #ff4757;">âŒ ç„¡ç·©å­˜</div>
            <div style="font-size: 10px; color: #ddd;">éœ€è¦é‡æ–°è¼‰å…¥</div>
          `;
        }
      }
    } catch (error) {
      console.error('æ›´æ–°ç·©å­˜ç‹€æ…‹å¤±æ•—:', error);
    }
  }

  // æ¸…é™¤ç·©å­˜
  async function clearCache() {
    try {
      const characterService = (await import('../services/characterService')).default.getInstance();
      characterService.clearCache();
      
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      const btn = document.getElementById('clear-cache-btn');
      if (btn) {
        const originalText = btn.textContent;
        btn.textContent = 'âœ… å·²æ¸…é™¤';
        btn.style.background = '#2ed573';
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '#ff4757';
        }, 2000);
      }
      
      updateCacheStatus();
    } catch (error) {
      console.error('æ¸…é™¤ç·©å­˜å¤±æ•—:', error);
    }
  }

  // åˆ·æ–°æ•¸æ“š
  async function refreshData() {
    try {
      const btn = document.getElementById('refresh-cache-btn');
      if (btn) {
        btn.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';
        btn.disabled = true;
      }
      
      const characterService = (await import('../services/characterService')).default.getInstance();
      await characterService.refreshCharacters();
      
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      if (btn) {
        btn.textContent = 'âœ… å·²åˆ·æ–°';
        btn.style.background = '#2ed573';
        
        setTimeout(() => {
          btn.textContent = 'åˆ·æ–°æ•¸æ“š';
          btn.style.background = '#2ed573';
          btn.disabled = false;
        }, 2000);
      }
      
      updateCacheStatus();
      
      // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°æ‰€æœ‰çµ„ä»¶
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } catch (error) {
      console.error('åˆ·æ–°æ•¸æ“šå¤±æ•—:', error);
      
      const btn = document.getElementById('refresh-cache-btn');
      if (btn) {
        btn.textContent = 'âŒ å¤±æ•—';
        btn.style.background = '#ff4757';
        
        setTimeout(() => {
          btn.textContent = 'åˆ·æ–°æ•¸æ“š';
          btn.style.background = '#2ed573';
          btn.disabled = false;
        }, 2000);
      }
    }
  }

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    // æ›´æ–°åˆå§‹ç‹€æ…‹
    updateCacheStatus();
    
    // æ¯ç§’æ›´æ–°ç‹€æ…‹
    setInterval(updateCacheStatus, 1000);
    
    // ç¶å®šæŒ‰éˆ•äº‹ä»¶
    const clearBtn = document.getElementById('clear-cache-btn');
    const refreshBtn = document.getElementById('refresh-cache-btn');
    
    if (clearBtn) {
      clearBtn.addEventListener('click', clearCache);
    }
    
    if (refreshBtn) {
      refreshBtn.addEventListener('click', refreshData);
    }
  });
</script>
